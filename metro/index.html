<!DOCTYPE html>
<html lang="en">

<head>
  <!-- Global site tag (gtag.js) - Google Analytics -- szekelydata -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-57335320-4"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());

    gtag('config', 'UA-57335320-4');
  </script>

  <!-- Use correct character set. -->
  <meta charset="utf-8">
  <!-- Tell IE to use the latest, best version. -->
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <!-- Make the application on mobile take up the full browser screen and disable user scaling. -->
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">
  <title>Most congested cities of the world | Kontext</title>
  <meta name="description"
    content="Most congested cities of the world ðŸš— based on TomTom's 2019 Traffic Index #dataviz #cesiumjs #cesium #tomtom @csaladenes" />
  <meta name="keywords"
    content="csaladenes, d3.js, data visualization, infographic, d3plus, d3, cesium, cesiumjs, map, interactivemap, data visualization, mit oec, mit, mit atlas, macro connections, tomtom, gps, congestion, global cities, city, population" />
  <meta property="og:image" content="https://blog.csaladen.es/tomtom/tomtom.png" />
  <meta property="og:image:width" content="807px" />
  <meta property="og:image:height" content="665px" />
  <meta property="twitter:image" content="https://blog.csaladen.es/tomtom/tomtom.png" />
  <meta property="og:description"
    content="Most congested cities of the world ðŸš— based on TomTom's 2019 Traffic Index #dataviz #cesiumjs #cesium #tomtom @csaladenes" />
  <meta property="twitter:description"
    content="Most congested cities of the world ðŸš— based on TomTom's 2019 Traffic Index #dataviz #cesiumjs #cesium #tomtom @csaladenes" />
  <meta property="og:title" content="Most congested cities of the world | Kontext" />
  <meta property="twitter:title" content="Most congested cities of the world | Kontext" />
  <meta http-equiv="content-Type" content="text/html; charset=utf-8" />
  <meta property="og:url" content="https://blog.csaladen.es/tomtom" />
  <meta property="twitter:url" content="https://blog.csaladen.es/tomtom" />
  <meta property="og:site_name" content="Kontext" />
  <meta property="fb:admins" content="100943737036023614165" />
  <link rel="shortcut icon" href="https://blog.csaladen.es/favicon.ico" />
  <link rel="publisher" href="https://plus.google.com/106181965793093327960" />


  <script src="https://cesium.com/downloads/cesiumjs/releases/1.63/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.63/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script src="https://d3js.org/d3-collection.v1.min.js"></script>
  <script src="https://d3js.org/d3-selection.v1.min.js"></script>
  <script src="https://d3js.org/d3-dispatch.v1.min.js"></script>
  <script src="https://d3js.org/d3-dsv.v1.min.js"></script>
  <script src="https://d3js.org/d3-request.v1.min.js"></script>
  <script src="https://d3js.org/d3-color.v1.min.js"></script>
  <script src="https://d3js.org/d3-interpolate.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
  <script src="https://d3js.org/d3-scale.v3.min.js"></script>


  <script src="jszip.min.js"></script>
  <script src="JSZipUtils.min.js"></script>

  <style>
    html,
    body,
    #cesiumContainer {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
    }

    /* .cesium-infoBox {
      min-width: 300px !important;
    } */
  </style>
</head>

<body>
  <div id="cesiumContainer"></div>
  <script>
    Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJiZWYxMTQwMC1iZjRiLTQ2ZmQtYTk0MS0zNGI3MjI1MzRlZTYiLCJpZCI6MTY5MjcsInNjb3BlcyI6WyJhc3IiLCJnYyJdLCJpYXQiOjE1NzEzMjU3ODd9.InYGD_zyuB-tFLaIahXGyU5SoYyd5tjI3EaInQ5zrOs';
    var mobile = (!(window.matchMedia("(any-pointer:coarse)").matches));
    JSZipUtils.getBinaryContent("metrosg.zip", function (err, rawdata) {
      var zip = new JSZip(rawdata);
      var qdata = JSON.parse(zip.files["metrosg.json"].asText());
      var metros = Object.values(qdata)

      // console.log(metros)

      var dark = true;
      var opaque = 255;

      var czml = [{
        "id": "document",
        "name": "Metros",
        "version": "1.0"
      }];

      function color(mlines, slines, sbranches) {
        e = []
        if (slines.length > 1)
          c = (dark) ? '#eeeeee' : '#aaaaaa'
        else {
          c = '#888888'
          mlines.forEach(function (line) {
            if (line.name == slines[0]) {
              c = line.color.toLowerCase()
              sbranches.forEach(function (branch) {
                if (line.id == branch) {
                  e.push(line.branch)
                }
              })
            }
          })
        }
        return [c, e]
      }

      function hexToRgb(hex) {
        var result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        return result ? {
          r: parseInt(result[1], 16),
          g: parseInt(result[2], 16),
          b: parseInt(result[3], 16)
        } : null;
      }

      function degrees(path) {
        points = [];
        path.forEach(function (point) {
          points.push(point.lng)
          points.push(point.lat)
          points.push(0)
        })
        return points
      }

      function central(stations) {
        maxStations = 0
        coords = []
        stations.forEach(function (station) {
          if (station.lines.length > maxStations) {
            maxStations = station.lines.length
            coords = [station.lat, station.lon]
          }
        })
        return coords
      }

      function colored(station, mlines, slines, sbranches) {
        r = ''
        slines.forEach(function (line) {
          r = r + '<tr><td style="text-align:center;padding:3px;background-color:' +
            color(mlines, [line], sbranches)[0] + '";>' +
            line + '</td><td style="padding-left:3px;">' +
            branches(color(mlines, [line], sbranches)[1]) +
            '</tr></td>'
        })
        return r
      }

      function branches(branches) {
        r = '';
        branches.forEach(function (branch) {
          r = r + '<div>' + branch + '</div>';
        })
        return r
      }

      metros.forEach(function (metro, i) {
        if ((['Budapest Metro', 'Bucharest Metro', 'Vienna U-Bahn', 'London Underground and DLR'].indexOf(metro.name) > -1)) {
          // if (true) {

          coords = central(metro.stations)

          czml.push({
            "id": metro.url,
            "name": metro.name,
            "description": '<a style="text-decoration:none;" target="_blank" href="' + metro.url + '"><table><tr><td>' +
              metro.desc + '</td></tr></table></a>',
            "position": {
              "cartographicDegrees": [coords[1], coords[0], 100]
            },
            "label": {
              "fillColor": { "rgba": (dark) ? [241, 241, 241, 255] : [14, 14, 14, 255] },
              "font": "14pt Arial",
              "horizontalOrigin": "CENTER",
              "translucencyByDistance": {
                "nearFarScalar": [50000, 0, 100000, 1]
              },
              "style": "FILL",
              "text": metro.name
            }
          });

          metro.stations.forEach(function (station, i) {

            radius = (station.lines.length > 1) ? 150 : 100;
            height = (station.lines.length > 1) ? 120 : 100;
            opacity = (station.lines.length > 1) ? opaque : 255;
            station.color = [hexToRgb(color(metro.lines, station.lines, station.branches)[0]).r,
            hexToRgb(color(metro.lines, station.lines, station.branches)[0]).g,
            hexToRgb(color(metro.lines, station.lines, station.branches)[0]).b, opacity]
            czml.push({
              "id": metro.name + ' | ' + station.name,
              "name": station.name,
              "description": '<a style="text-decoration:none;" target="_blank" href="' + station.url + '"><table>' +
                colored(station.name, metro.lines, station.lines, station.branches) +
                '</table></a>',
              "position": {
                "cartographicDegrees": [station.lon, station.lat, 40]
              },
              "cylinder": {
                // "show": false,
                "length": height,
                "topRadius": radius,
                "bottomRadius": radius,
                "material": {
                  "solidColor": {
                    "color": {
                      'rgba': station.color
                    }
                  }
                }
              }
            });
            czml.push({
              "id": metro.name + ' | ' + station.name + '2',
              "name": station.name,
              "description": '<a style="text-decoration:none;" target="_blank" href="' + station.url + '"><table>' +
                colored(station.name, metro.lines, station.lines, station.branches) +
                '</table></a>',
              "position": {
                "cartographicDegrees": [station.lon, station.lat, 140]
              },
              "label": {
                // "fillColor": { "rgba": station.color },
                "fillColor": { "rgba": (dark) ? [241, 241, 241, 255] : [14, 14, 14, 255] },
                "font": ((station.lines.length > 1) ? 14 : 12) + "pt Open Sans",
                "horizontalOrigin": "CENTER",
                "pixelOffset": {
                  "cartesian2": [0, 0]
                },
                "translucencyByDistance": {
                  "nearFarScalar": [10000, 1, 13000, 0]
                },
                "outlineColor": { "rgba": (dark) ? [0, 0, 0, 255] : [255, 255, 255, 255] },
                "outlineWidth": ((station.lines.length > 1) ? 2 : 2),
                "style": "FILL_AND_OUTLINE",
                "text": station.name
              }
            })
          });
          metro.lines.forEach(function (line, i) {
            czml.push({
              "id": metro.name + ' | ' + line.id,
              "name": line.name,
              "description": '<table><tr><td style="text-align:center;padding:3px;background-color:' +
                color(metro.lines, [line.name], [line.id])[0] + '";>' +
                line.name + '</td><td style="padding-left:3px;">' +
                branches(color(metro.lines, [line.name], [line.id])[1]) +
                '</tr></td></table>',
              "corridor": {
                "positions": {
                  "cartographicDegrees": degrees(line.path)
                },
                "material": {
                  "solidColor": {
                    "color": {
                      "rgba": [hexToRgb(line.color).r,
                      hexToRgb(line.color).g,
                      hexToRgb(line.color).b, opaque]
                    }
                  },
                },
                "width": 60,
                "extrudedHeight": 60,
                "height": 20,
                "clampToGround": true,
                "cornerType": "MITERED"
              }
            })
          })
        }
      })

      var viewer = new Cesium.Viewer('cesiumContainer', {
        imageryProvider: new Cesium.OpenStreetMapImageryProvider({
          url: (dark) ? 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/'
            : 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/'
        }),
        baseLayerPicker: false,
        shouldAnimate: true,
        animation: false,
        // geocoder: false,
        homeButton: false,
        timeline: false,
        navigationInstructionsInitiallyVisible: false
      });

      //Enable lighting based on sun/moon positions
      // viewer.scene.globe.enableLighting = true;
      // viewer.clock.clockRange = Cesium.ClockRange.LOOP_STOP; //Loop at the end
      // viewer.clock.multiplier = 1000;
      // viewer.infoBox.frame.sandbox = "allow-same-origin allow-top-navigation allow-pointer-lock allow-popups allow-forms allow-scripts";

      // imageryProvider: new Cesium.UrlTemplateImageryProvider({
      //     url: 'https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png?lang=hu'
      //   }),

      var dataSourcePromise = Cesium.CzmlDataSource.load(czml);
      viewer.dataSources.add(dataSourcePromise);
      // viewer.zoomTo('4');
      // viewer.camera.flyTo({
      //   // destination: Cesium.Cartesian3.fromDegrees(19.1, 47.42, 20000.0),
      //   destination: Cesium.Cartesian3.fromDegrees(0, 47.42, 20000.0),
      //   orientation: {
      //     heading: Cesium.Math.toRadians(0.0),
      //     pitch: Cesium.Math.toRadians(-60.0),
      //     roll: 0.0
      //   }
      // });

      // function degrees2(path) {
      //   points = [];
      //   path.forEach(function (point) {
      //     points.push(point.lng)
      //     points.push(point.lat)
      //   })
      //   return points
      // }

      // function computeCircle(radius) {
      //   var positions = [];
      //   for (var i = 0; i < 360; i++) {
      //     var radians = Cesium.Math.toRadians(i);
      //     positions.push(new Cesium.Cartesian2(radius * Math.cos(radians), radius * Math.sin(radians)));
      //   }
      //   return positions;
      // }

      // metros.forEach(function (metro, i) {
      //   if ((['Budapest Metro', 'Bucharest Metro', 'Vienna U-Bahn', 'London Underground and DLR'].indexOf(metro.name) > -1)) {
      //     // if (true) {

      //     coords = central(metro.stations)

      //     metro.lines.forEach(function (line, i) {
      //       viewer.entities.add({
      //         name: line.name + 'p',
      //         polylineVolume: {
      //           positions: Cesium.Cartesian3.fromDegreesArray(degrees2(line.path)),
      //           shape: computeCircle(60.0),
      //           material: Cesium.Color.RED
      //         }
      //       })
      //     })
      //   }
      // })

      function fly(id) {
        console.log(id)
        setTimeout(function () {
          // viewer.selectedEntity = viewer.dataSources.get([0]).entities.getById(id)
        }, 1000)
        data = qdata[id]
        console.log(data)
        k = 0
        i = 0
        // for (var i = 0; i < 6; i++) {
        // setInterval(function () {
        //   i = i + 1
        //   if (i == data.lines[k].path.length - 1) i = 0
        // viewer.camera.flyToBoundingSphere({
        //   center: Cesium.Cartesian3.fromDegrees(
        //     data.lines[k].path[i].lng,
        //     data.lines[k].path[i].lat,
        //     100.0),
        //   radius: 3000
        // },
        //   {
        //     duration: 1,
        //     easingFunction: Cesium.EasingFunction.LINEAR_NONE
        //   }
        // );
        // var center = Cesium.Cartesian3.fromDegrees(data.lines[k].path[i].lng, data.lines[k].path[i].lat);
        // viewer.camera.lookAt(center, new Cesium.Cartesian3(0.0, -2000, 10000));

        // }, 1000)
        // }
      }

      fly('https://www.metrolinemap.com/metro/bucharest/')

      d3.select(".cesium-widget-credits").insert("a", ":first-child")
        .attr("class", "cesium-credit-imageContainer")
        .text('fd')
        .attr("href", "https://szekelydata.csaladen.es")
        .attr("target", "_blank")
        .html("<img style='margin-bottom:-8px;margin-left:8px;height:40px;' src='//szekelydata.csaladen.es/klima/szd_logo.png' alt='szÃ©kelydata' title='szÃ©kelydata' />")
      d3.select(".cesium-widget-credits").insert("a", ":first-child")
        .attr("class", "cesium-credit-imageContainer")
        .text('fd')
        .attr("href", "https://blog.csaladen.es")
        .attr("target", "_blank")
        .html("<img style='height:32px;margin-bottom:-2px;margin-left:8px;' src='https://blog.csaladen.es/favicon.ico' alt='Kontext blog' title='Kontext blog' />")
      d3.select(".cesium-widget-credits").insert("a", ":first-child")
        .attr("class", "cesium-credit-imageContainer")
        .text('fd')
        .attr("rel", "author")
        .attr("href", "https://csaladen.es")
        .attr("target", "_blank")
        .html("<img style='margin-bottom:-2px;margin-left:8px;height:30px;' src='https://csaladen.es/favicon.ico' alt='by DÃ©nes Csala' title='by DÃ©nes Csala' />")
      d3.select(".cesium-viewer-toolbar").insert("div")
        .attr("class", "cesium-button cesium-toolbar-button material-icons")
        .style("padding-left", "0px")
        .style("padding-top", "0px")
        .append('a')
        .text("")
        .attr('target', '_blank')
        .attr("title", "Help - TomTom 2019 Traffic Index")
        .style('font-size', '20px')
        // .attr('href', 'https://www.tomtom.com/en_gb/traffic-index/ranking/')
        .on('click', function () { fly('https://www.metrolinemap.com/metro/bucharest/') })
        .append('img')
        .attr('src', 'https://www.tomtom.com/favicon.ico')
        .attr('width', '30px')
      d3.select(".cesium-viewer-toolbar").insert("div")
        .attr("class", "cesium-button cesium-toolbar-button material-icons")
        .style("padding-left", "0px")
        .style("padding-top", "0px")
        .append('a')
        .text("")
        .attr('target', '_blank')
        .attr("title", "Help - TomTom 2019 Traffic Index")
        .style('font-size', '20px')
        // .attr('href', 'https://www.tomtom.com/en_gb/traffic-index/ranking/')
        .on('click', function () { fly('https://www.metrolinemap.com/metro/budapest/') })
        .append('img')
        .attr('src', 'https://www.tomtom.com/favicon.ico')
        .attr('width', '30px')
      d3.select(".cesium-viewer-cesiumWidgetContainer").append("div")
        .style("position", "absolute")
        .style("top", "10px")
        .style("left", "10px")
        .style("width", "400px")
        .style("color", "#eee")
        .attr("id", "subs")
      d3.select("#subs").append("div")
        .attr("class", "cesium-viewer-cesiumWidgetContainer")
        .html('<div style="font-size:20px;">Most congested ' +
          ((!(mobile)) ? '<br>' : '') +
          'cities of the world</div>' +
          '<div style="font-size:15px;margin-top:5px;">ðŸš— based on <b>TomTom' + "'s " +
          '<a style="color:#eee;text-decoration:none" href="https://www.tomtom.com/en_gb/traffic-index/ranking/">2019 Traffic Index</a></b></div>' +
          '<div>' +
          '<svg height="20" width="300"><line x1="0" y1="15" x2="300" y2="15" style="stroke:#eee;stroke-width:1" />' +
          '</div>' +
          '<div>' +
          '<svg height="45" width="25"><circle cx="15" cy="20" r="5" stroke="#ccc" stroke-width="0" fill="#eee" /></svg>' +
          '<svg height="45" width="40"><circle cx="20" cy="20" r="10" stroke="#ccc" stroke-width="0" fill="#eee" /></svg>' +
          '<svg height="45" width="40"><circle cx="20" cy="20" r="15" stroke="#ccc" stroke-width="0" fill="#eee" /></svg>' +
          '<div style="font-size:15px;margin-top:-35px;margin-left:120px">larger population</div>' +
          '</div>' +
          '<div>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#2aabee" stroke-width="0" fill="#2aabee" /></svg>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#6afd6a" stroke-width="0" fill="#6afd6a" /></svg>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#feb927" stroke-width="0" fill="#feb927" /></svg>' +
          '<svg height="50" width="26"><circle cx="13" cy="30" r="10" stroke="#c2270a" stroke-width="0" fill="#c2270a" /></svg>' +
          '<div style="font-size:15px;margin-top:-31px;margin-left:120px">more congestion</div>' +
          '</div>')
    })

    // ["#6e40aa","#b83cb0","#f6478d","#ff6956","#f59f30","#c4d93e","#83f557","#38f17a","#19d3b5","#29a0dd","#5069d9","#6e40aa"]
    // ["#23171b","#4860e6","#2aabee","#2ee5ae","#6afd6a","#c0ee3d","#feb927","#fe6e1a","#c2270a","#900c00"]

  </script>
</body>

</html>