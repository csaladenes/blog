(function(){var e=this;var t=e._;var i={};var s=Array.prototype,n=Object.prototype,r=Function.prototype;var a=s.push,o=s.slice,l=s.concat,u=n.toString,d=n.hasOwnProperty;var h=s.forEach,c=s.map,f=s.reduce,_=s.reduceRight,p=s.filter,m=s.every,g=s.some,S=s.indexOf,w=s.lastIndexOf,v=Array.isArray,M=Object.keys,y=r.bind;var b=function(e){if(e instanceof b)return e;if(!(this instanceof b))return new b(e);this._wrapped=e};if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports){exports=module.exports=b}exports._=b}else{e._=b}b.VERSION="1.4.4";var D=b.each=b.forEach=function(e,t,s){if(e==null)return;if(h&&e.forEach===h){e.forEach(t,s)}else if(e.length===+e.length){for(var n=0,r=e.length;n<r;n++){if(t.call(s,e[n],n,e)===i)return}}else{for(var a in e){if(b.has(e,a)){if(t.call(s,e[a],a,e)===i)return}}}};b.map=b.collect=function(e,t,i){var s=[];if(e==null)return s;if(c&&e.map===c)return e.map(t,i);D(e,function(e,n,r){s[s.length]=t.call(i,e,n,r)});return s};var C="Reduce of empty array with no initial value";b.reduce=b.foldl=b.inject=function(e,t,i,s){var n=arguments.length>2;if(e==null)e=[];if(f&&e.reduce===f){if(s)t=b.bind(t,s);return n?e.reduce(t,i):e.reduce(t)}D(e,function(e,r,a){if(!n){i=e;n=true}else{i=t.call(s,i,e,r,a)}});if(!n)throw new TypeError(C);return i};b.reduceRight=b.foldr=function(e,t,i,s){var n=arguments.length>2;if(e==null)e=[];if(_&&e.reduceRight===_){if(s)t=b.bind(t,s);return n?e.reduceRight(t,i):e.reduceRight(t)}var r=e.length;if(r!==+r){var a=b.keys(e);r=a.length}D(e,function(o,l,u){l=a?a[--r]:--r;if(!n){i=e[l];n=true}else{i=t.call(s,i,e[l],l,u)}});if(!n)throw new TypeError(C);return i};b.find=b.detect=function(e,t,i){var s;E(e,function(e,n,r){if(t.call(i,e,n,r)){s=e;return true}});return s};b.filter=b.select=function(e,t,i){var s=[];if(e==null)return s;if(p&&e.filter===p)return e.filter(t,i);D(e,function(e,n,r){if(t.call(i,e,n,r))s[s.length]=e});return s};b.reject=function(e,t,i){return b.filter(e,function(e,s,n){return!t.call(i,e,s,n)},i)};b.every=b.all=function(e,t,s){t||(t=b.identity);var n=true;if(e==null)return n;if(m&&e.every===m)return e.every(t,s);D(e,function(e,r,a){if(!(n=n&&t.call(s,e,r,a)))return i});return!!n};var E=b.some=b.any=function(e,t,s){t||(t=b.identity);var n=false;if(e==null)return n;if(g&&e.some===g)return e.some(t,s);D(e,function(e,r,a){if(n||(n=t.call(s,e,r,a)))return i});return!!n};b.contains=b.include=function(e,t){if(e==null)return false;if(S&&e.indexOf===S)return e.indexOf(t)!=-1;return E(e,function(e){return e===t})};b.invoke=function(e,t){var i=o.call(arguments,2);var s=b.isFunction(t);return b.map(e,function(e){return(s?t:e[t]).apply(e,i)})};b.pluck=function(e,t){return b.map(e,function(e){return e[t]})};b.where=function(e,t,i){if(b.isEmpty(t))return i?null:[];return b[i?"find":"filter"](e,function(e){for(var i in t){if(t[i]!==e[i])return false}return true})};b.findWhere=function(e,t){return b.where(e,t,true)};b.max=function(e,t,i){if(!t&&b.isArray(e)&&e[0]===+e[0]&&e.length<65535){return Math.max.apply(Math,e)}if(!t&&b.isEmpty(e))return-Infinity;var s={computed:-Infinity,value:-Infinity};D(e,function(e,n,r){var a=t?t.call(i,e,n,r):e;a>=s.computed&&(s={value:e,computed:a})});return s.value};b.min=function(e,t,i){if(!t&&b.isArray(e)&&e[0]===+e[0]&&e.length<65535){return Math.min.apply(Math,e)}if(!t&&b.isEmpty(e))return Infinity;var s={computed:Infinity,value:Infinity};D(e,function(e,n,r){var a=t?t.call(i,e,n,r):e;a<s.computed&&(s={value:e,computed:a})});return s.value};b.shuffle=function(e){var t;var i=0;var s=[];D(e,function(e){t=b.random(i++);s[i-1]=s[t];s[t]=e});return s};var x=function(e){return b.isFunction(e)?e:function(t){return t[e]}};b.sortBy=function(e,t,i){var s=x(t);return b.pluck(b.map(e,function(e,t,n){return{value:e,index:t,criteria:s.call(i,e,t,n)}}).sort(function(e,t){var i=e.criteria;var s=t.criteria;if(i!==s){if(i>s||i===void 0)return 1;if(i<s||s===void 0)return-1}return e.index<t.index?-1:1}),"value")};var V=function(e,t,i,s){var n={};var r=x(t||b.identity);D(e,function(t,a){var o=r.call(i,t,a,e);s(n,o,t)});return n};b.groupBy=function(e,t,i){return V(e,t,i,function(e,t,i){(b.has(e,t)?e[t]:e[t]=[]).push(i)})};b.countBy=function(e,t,i){return V(e,t,i,function(e,t){if(!b.has(e,t))e[t]=0;e[t]++})};b.sortedIndex=function(e,t,i,s){i=i==null?b.identity:x(i);var n=i.call(s,t);var r=0,a=e.length;while(r<a){var o=r+a>>>1;i.call(s,e[o])<n?r=o+1:a=o}return r};b.toArray=function(e){if(!e)return[];if(b.isArray(e))return o.call(e);if(e.length===+e.length)return b.map(e,b.identity);return b.values(e)};b.size=function(e){if(e==null)return 0;return e.length===+e.length?e.length:b.keys(e).length};b.first=b.head=b.take=function(e,t,i){if(e==null)return void 0;return t!=null&&!i?o.call(e,0,t):e[0]};b.initial=function(e,t,i){return o.call(e,0,e.length-(t==null||i?1:t))};b.last=function(e,t,i){if(e==null)return void 0;if(t!=null&&!i){return o.call(e,Math.max(e.length-t,0))}else{return e[e.length-1]}};b.rest=b.tail=b.drop=function(e,t,i){return o.call(e,t==null||i?1:t)};b.compact=function(e){return b.filter(e,b.identity)};var T=function(e,t,i){D(e,function(e){if(b.isArray(e)){t?a.apply(i,e):T(e,t,i)}else{i.push(e)}});return i};b.flatten=function(e,t){return T(e,t,[])};b.without=function(e){return b.difference(e,o.call(arguments,1))};b.uniq=b.unique=function(e,t,i,s){if(b.isFunction(t)){s=i;i=t;t=false}var n=i?b.map(e,i,s):e;var r=[];var a=[];D(n,function(i,s){if(t?!s||a[a.length-1]!==i:!b.contains(a,i)){a.push(i);r.push(e[s])}});return r};b.union=function(){return b.uniq(l.apply(s,arguments))};b.intersection=function(e){var t=o.call(arguments,1);return b.filter(b.uniq(e),function(e){return b.every(t,function(t){return b.indexOf(t,e)>=0})})};b.difference=function(e){var t=l.apply(s,o.call(arguments,1));return b.filter(e,function(e){return!b.contains(t,e)})};b.zip=function(){var e=o.call(arguments);var t=b.max(b.pluck(e,"length"));var i=new Array(t);for(var s=0;s<t;s++){i[s]=b.pluck(e,""+s)}return i};b.object=function(e,t){if(e==null)return{};var i={};for(var s=0,n=e.length;s<n;s++){if(t){i[e[s]]=t[s]}else{i[e[s][0]]=e[s][1]}}return i};b.indexOf=function(e,t,i){if(e==null)return-1;var s=0,n=e.length;if(i){if(typeof i=="number"){s=i<0?Math.max(0,n+i):i}else{s=b.sortedIndex(e,t);return e[s]===t?s:-1}}if(S&&e.indexOf===S)return e.indexOf(t,i);for(;s<n;s++)if(e[s]===t)return s;return-1};b.lastIndexOf=function(e,t,i){if(e==null)return-1;var s=i!=null;if(w&&e.lastIndexOf===w){return s?e.lastIndexOf(t,i):e.lastIndexOf(t)}var n=s?i:e.length;while(n--)if(e[n]===t)return n;return-1};b.range=function(e,t,i){if(arguments.length<=1){t=e||0;e=0}i=arguments[2]||1;var s=Math.max(Math.ceil((t-e)/i),0);var n=0;var r=new Array(s);while(n<s){r[n++]=e;e+=i}return r};b.bind=function(e,t){if(e.bind===y&&y)return y.apply(e,o.call(arguments,1));var i=o.call(arguments,2);return function(){return e.apply(t,i.concat(o.call(arguments)))}};b.partial=function(e){var t=o.call(arguments,1);return function(){return e.apply(this,t.concat(o.call(arguments)))}};b.bindAll=function(e){var t=o.call(arguments,1);if(t.length===0)t=b.functions(e);D(t,function(t){e[t]=b.bind(e[t],e)});return e};b.memoize=function(e,t){var i={};t||(t=b.identity);return function(){var s=t.apply(this,arguments);return b.has(i,s)?i[s]:i[s]=e.apply(this,arguments)}};b.delay=function(e,t){var i=o.call(arguments,2);return setTimeout(function(){return e.apply(null,i)},t)};b.defer=function(e){return b.delay.apply(b,[e,1].concat(o.call(arguments,1)))};b.throttle=function(e,t){var i,s,n,r;var a=0;var o=function(){a=new Date;n=null;r=e.apply(i,s)};return function(){var l=new Date;var u=t-(l-a);i=this;s=arguments;if(u<=0){clearTimeout(n);n=null;a=l;r=e.apply(i,s)}else if(!n){n=setTimeout(o,u)}return r}};b.debounce=function(e,t,i){var s,n;return function(){var r=this,a=arguments;var o=function(){s=null;if(!i)n=e.apply(r,a)};var l=i&&!s;clearTimeout(s);s=setTimeout(o,t);if(l)n=e.apply(r,a);return n}};b.once=function(e){var t=false,i;return function(){if(t)return i;t=true;i=e.apply(this,arguments);e=null;return i}};b.wrap=function(e,t){return function(){var i=[e];a.apply(i,arguments);return t.apply(this,i)}};b.compose=function(){var e=arguments;return function(){var t=arguments;for(var i=e.length-1;i>=0;i--){t=[e[i].apply(this,t)]}return t[0]}};b.after=function(e,t){if(e<=0)return t();return function(){if(--e<1){return t.apply(this,arguments)}}};b.keys=M||function(e){if(e!==Object(e))throw new TypeError("Invalid object");var t=[];for(var i in e)if(b.has(e,i))t[t.length]=i;return t};b.values=function(e){var t=[];for(var i in e)if(b.has(e,i))t.push(e[i]);return t};b.pairs=function(e){var t=[];for(var i in e)if(b.has(e,i))t.push([i,e[i]]);return t};b.invert=function(e){var t={};for(var i in e)if(b.has(e,i))t[e[i]]=i;return t};b.functions=b.methods=function(e){var t=[];for(var i in e){if(b.isFunction(e[i]))t.push(i)}return t.sort()};b.extend=function(e){D(o.call(arguments,1),function(t){if(t){for(var i in t){e[i]=t[i]}}});return e};b.pick=function(e){var t={};var i=l.apply(s,o.call(arguments,1));D(i,function(i){if(i in e)t[i]=e[i]});return t};b.omit=function(e){var t={};var i=l.apply(s,o.call(arguments,1));for(var n in e){if(!b.contains(i,n))t[n]=e[n]}return t};b.defaults=function(e){D(o.call(arguments,1),function(t){if(t){for(var i in t){if(e[i]==null)e[i]=t[i]}}});return e};b.clone=function(e){if(!b.isObject(e))return e;return b.isArray(e)?e.slice():b.extend({},e)};b.tap=function(e,t){t(e);return e};var A=function(e,t,i,s){if(e===t)return e!==0||1/e==1/t;if(e==null||t==null)return e===t;if(e instanceof b)e=e._wrapped;if(t instanceof b)t=t._wrapped;var n=u.call(e);if(n!=u.call(t))return false;switch(n){case"[object String]":return e==String(t);case"[object Number]":return e!=+e?t!=+t:e==0?1/e==1/t:e==+t;case"[object Date]":case"[object Boolean]":return+e==+t;case"[object RegExp]":return e.source==t.source&&e.global==t.global&&e.multiline==t.multiline&&e.ignoreCase==t.ignoreCase}if(typeof e!="object"||typeof t!="object")return false;var r=i.length;while(r--){if(i[r]==e)return s[r]==t}i.push(e);s.push(t);var a=0,o=true;if(n=="[object Array]"){a=e.length;o=a==t.length;if(o){while(a--){if(!(o=A(e[a],t[a],i,s)))break}}}else{var l=e.constructor,d=t.constructor;if(l!==d&&!(b.isFunction(l)&&l instanceof l&&b.isFunction(d)&&d instanceof d)){return false}for(var h in e){if(b.has(e,h)){a++;if(!(o=b.has(t,h)&&A(e[h],t[h],i,s)))break}}if(o){for(h in t){if(b.has(t,h)&&!a--)break}o=!a}}i.pop();s.pop();return o};b.isEqual=function(e,t){return A(e,t,[],[])};b.isEmpty=function(e){if(e==null)return true;if(b.isArray(e)||b.isString(e))return e.length===0;for(var t in e)if(b.has(e,t))return false;return true};b.isElement=function(e){return!!(e&&e.nodeType===1)};b.isArray=v||function(e){return u.call(e)=="[object Array]"};b.isObject=function(e){return e===Object(e)};D(["Arguments","Function","String","Number","Date","RegExp"],function(e){b["is"+e]=function(t){return u.call(t)=="[object "+e+"]"}});if(!b.isArguments(arguments)){b.isArguments=function(e){return!!(e&&b.has(e,"callee"))}}if(typeof/./!=="function"){b.isFunction=function(e){return typeof e==="function"}}b.isFinite=function(e){return isFinite(e)&&!isNaN(parseFloat(e))};b.isNaN=function(e){return b.isNumber(e)&&e!=+e};b.isBoolean=function(e){return e===true||e===false||u.call(e)=="[object Boolean]"};b.isNull=function(e){return e===null};b.isUndefined=function(e){return e===void 0};b.has=function(e,t){return d.call(e,t)};b.noConflict=function(){e._=t;return this};b.identity=function(e){return e};b.times=function(e,t,i){var s=Array(e);for(var n=0;n<e;n++)s[n]=t.call(i,n);return s};b.random=function(e,t){if(t==null){t=e;e=0}return e+Math.floor(Math.random()*(t-e+1))};var R={escape:{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#x27;","/":"&#x2F;"}};R.unescape=b.invert(R.escape);var I={escape:new RegExp("["+b.keys(R.escape).join("")+"]","g"),unescape:new RegExp("("+b.keys(R.unescape).join("|")+")","g")};b.each(["escape","unescape"],function(e){b[e]=function(t){if(t==null)return"";return(""+t).replace(I[e],function(t){return R[e][t]})}});b.result=function(e,t){if(e==null)return null;var i=e[t];return b.isFunction(i)?i.call(e):i};b.mixin=function(e){D(b.functions(e),function(t){var i=b[t]=e[t];b.prototype[t]=function(){var e=[this._wrapped];a.apply(e,arguments);return N.call(this,i.apply(b,e))}})};var k=0;b.uniqueId=function(e){var t=++k+"";return e?e+t:t};b.templateSettings={evaluate:/<%([\s\S]+?)%>/g,interpolate:/<%=([\s\S]+?)%>/g,escape:/<%-([\s\S]+?)%>/g};var L=/(.)^/;var P={"'":"'","\\":"\\","\r":"r","\n":"n","	":"t","\u2028":"u2028","\u2029":"u2029"};var O=/\\|'|\r|\n|\t|\u2028|\u2029/g;b.template=function(e,t,i){var s;i=b.defaults({},i,b.templateSettings);var n=new RegExp([(i.escape||L).source,(i.interpolate||L).source,(i.evaluate||L).source].join("|")+"|$","g");var r=0;var a="__p+='";e.replace(n,function(t,i,s,n,o){a+=e.slice(r,o).replace(O,function(e){return"\\"+P[e]});if(i){a+="'+\n((__t=("+i+"))==null?'':_.escape(__t))+\n'"}if(s){a+="'+\n((__t=("+s+"))==null?'':__t)+\n'"}if(n){a+="';\n"+n+"\n__p+='"}r=o+t.length;return t});a+="';\n";if(!i.variable)a="with(obj||{}){\n"+a+"}\n";a="var __t,__p='',__j=Array.prototype.join,"+"print=function(){__p+=__j.call(arguments,'');};\n"+a+"return __p;\n";try{s=new Function(i.variable||"obj","_",a)}catch(o){o.source=a;throw o}if(t)return s(t,b);var l=function(e){return s.call(this,e,b)};l.source="function("+(i.variable||"obj")+"){\n"+a+"}";return l};b.chain=function(e){return b(e).chain()};var N=function(e){return this._chain?b(e).chain():e};b.mixin(b);D(["pop","push","reverse","shift","sort","splice","unshift"],function(e){var t=s[e];b.prototype[e]=function(){var i=this._wrapped;t.apply(i,arguments);if((e=="shift"||e=="splice")&&i.length===0)delete i[0];return N.call(this,i)}});D(["concat","join","slice"],function(e){var t=s[e];b.prototype[e]=function(){return N.call(this,t.apply(this._wrapped,arguments))}});b.extend(b.prototype,{chain:function(){this._chain=true;return this},value:function(){return this._wrapped}})}).call(this);(function(e,t){var i=[],s=[],n=[];var r={gsub:function(e,t,i){var s=new RegExp(t.source||t,"gi");return s.test(e)?e.replace(s,i):null},plural:function(e,t){i.unshift([e,t])},pluralize:function(s,r,a){var o;if(r!==t){r=Math.round(r);o=r===1?this.singularize(s):this.pluralize(s);o=a?[r,o].join(" "):o}else{if(e(n).include(s)){return s}o=s;e(i).detect(function(e){var t=this.gsub(s,e[0],e[1]);return t?o=t:false},this)}return o},singular:function(e,t){s.unshift([e,t])},singularize:function(t){if(e(n).include(t)){return t}var i=t;e(s).detect(function(e){var s=this.gsub(t,e[0],e[1]);return s?i=s:false},this);return i},irregular:function(e,t){this.plural("\\b"+e+"\\b",t);this.singular("\\b"+t+"\\b",e)},uncountable:function(e){n.unshift(e)},resetInflections:function(){i=[];s=[];n=[];this.plural(/$/,"s");this.plural(/s$/,"s");this.plural(/(ax|test)is$/,"$1es");this.plural(/(octop|vir)us$/,"$1i");this.plural(/(octop|vir)i$/,"$1i");this.plural(/(alias|status)$/,"$1es");this.plural(/(bu)s$/,"$1ses");this.plural(/(buffal|tomat)o$/,"$1oes");this.plural(/([ti])um$/,"$1a");this.plural(/([ti])a$/,"$1a");this.plural(/sis$/,"ses");this.plural(/(?:([^f])fe|([lr])f)$/,"$1$2ves");this.plural(/(hive)$/,"$1s");this.plural(/([^aeiouy]|qu)y$/,"$1ies");this.plural(/(x|ch|ss|sh)$/,"$1es");this.plural(/(matr|vert|ind)(?:ix|ex)$/,"$1ices");this.plural(/([m|l])ouse$/,"$1ice");this.plural(/([m|l])ice$/,"$1ice");this.plural(/^(ox)$/,"$1en");this.plural(/^(oxen)$/,"$1");this.plural(/(quiz)$/,"$1zes");this.singular(/s$/,"");this.singular(/(n)ews$/,"$1ews");this.singular(/([ti])a$/,"$1um");this.singular(/((a)naly|(b)a|(d)iagno|(p)arenthe|(p)rogno|(s)ynop|(t)he)ses$/,"$1$2sis");this.singular(/(^analy)ses$/,"$1sis");this.singular(/([^f])ves$/,"$1fe");this.singular(/(hive)s$/,"$1");this.singular(/(tive)s$/,"$1");this.singular(/([lr])ves$/,"$1f");this.singular(/([^aeiouy]|qu)ies$/,"$1y");this.singular(/(s)eries$/,"$1eries");this.singular(/(m)ovies$/,"$1ovie");this.singular(/(x|ch|ss|sh)es$/,"$1");this.singular(/([m|l])ice$/,"$1ouse");this.singular(/(bus)es$/,"$1");this.singular(/(o)es$/,"$1");this.singular(/(shoe)s$/,"$1");this.singular(/(cris|ax|test)es$/,"$1is");this.singular(/(octop|vir)i$/,"$1us");this.singular(/(alias|status)es$/,"$1");this.singular(/^(ox)en/,"$1");this.singular(/(vert|ind)ices$/,"$1ex");this.singular(/(matr)ices$/,"$1ix");this.singular(/(quiz)zes$/,"$1");this.singular(/(database)s$/,"$1");this.irregular("person","people");this.irregular("man","men");this.irregular("child","children");this.irregular("sex","sexes");this.irregular("move","moves");this.irregular("cow","kine");e("equipment information rice money species series fish sheep jeans".split(/\s+/)).each(function(e){this.uncountable(e)},this);return this}};e.mixin(r.resetInflections())})(_);(function(){_.sum=function(e){return _.reduce(e,function(e,t){return e+t},0)}})();!function(e,t){"use strict";var i=t.prototype.trim;var s=t.prototype.trimRight;var n=t.prototype.trimLeft;var r=function(e){return e*1||0};var a=function(e,t){if(t<1)return"";var i="";while(t>0){if(t&1)i+=e;t>>=1,e+=e}return i};var o=[].slice;var l=function(e){if(e==null)return"\\s";else if(e.source)return e.source;else return"["+_.escapeRegExp(e)+"]"};function u(e,t){var i,s,n=e.toLowerCase();t=[].concat(t);for(i=0;i<t.length;i+=1){s=t[i];if(!s)continue;if(s.test&&s.test(e))return true;if(s.toLowerCase()===n)return true}}var d={lt:"<",gt:">",quot:'"',amp:"&",apos:"'"};var h={};for(var c in d)h[d[c]]=c;h["'"]="#39";var f=function(){function e(e){return Object.prototype.toString.call(e).slice(8,-1).toLowerCase()}var i=a;var s=function(){if(!s.cache.hasOwnProperty(arguments[0])){s.cache[arguments[0]]=s.parse(arguments[0])}return s.format.call(null,s.cache[arguments[0]],arguments)};s.format=function(s,n){var r=1,a=s.length,o="",l,u=[],d,h,c,_,p,m;for(d=0;d<a;d++){o=e(s[d]);if(o==="string"){u.push(s[d])}else if(o==="array"){c=s[d];if(c[2]){l=n[r];for(h=0;h<c[2].length;h++){if(!l.hasOwnProperty(c[2][h])){throw new Error(f('[_.sprintf] property "%s" does not exist',c[2][h]))}l=l[c[2][h]]}}else if(c[1]){l=n[c[1]]}else{l=n[r++]}if(/[^s]/.test(c[8])&&e(l)!="number"){throw new Error(f("[_.sprintf] expecting number but found %s",e(l)))}switch(c[8]){case"b":l=l.toString(2);break;case"c":l=t.fromCharCode(l);break;case"d":l=parseInt(l,10);break;case"e":l=c[7]?l.toExponential(c[7]):l.toExponential();break;case"f":l=c[7]?parseFloat(l).toFixed(c[7]):parseFloat(l);break;case"o":l=l.toString(8);break;case"s":l=(l=t(l))&&c[7]?l.substring(0,c[7]):l;break;case"u":l=Math.abs(l);break;case"x":l=l.toString(16);break;case"X":l=l.toString(16).toUpperCase();break}l=/[def]/.test(c[8])&&c[3]&&l>=0?"+"+l:l;p=c[4]?c[4]=="0"?"0":c[4].charAt(1):" ";m=c[6]-t(l).length;_=c[6]?i(p,m):"";u.push(c[5]?l+_:_+l)}}return u.join("")};s.cache={};s.parse=function(e){var t=e,i=[],s=[],n=0;while(t){if((i=/^[^\x25]+/.exec(t))!==null){s.push(i[0])}else if((i=/^\x25{2}/.exec(t))!==null){s.push("%")}else if((i=/^\x25(?:([1-9]\d*)\$|\(([^\)]+)\))?(\+)?(0|'[^$])?(-)?(\d+)?(?:\.(\d+))?([b-fosuxX])/.exec(t))!==null){if(i[2]){n|=1;var r=[],a=i[2],o=[];if((o=/^([a-z_][a-z_\d]*)/i.exec(a))!==null){r.push(o[1]);while((a=a.substring(o[0].length))!==""){if((o=/^\.([a-z_][a-z_\d]*)/i.exec(a))!==null){r.push(o[1])}else if((o=/^\[(\d+)\]/.exec(a))!==null){r.push(o[1])}else{throw new Error("[_.sprintf] huh?")}}}else{throw new Error("[_.sprintf] huh?")}i[2]=r}else{n|=2}if(n===3){throw new Error("[_.sprintf] mixing positional and named placeholders is not (yet) supported")}s.push(i)}else{throw new Error("[_.sprintf] huh?")}t=t.substring(i[0].length)}return s};return s}();var _={VERSION:"2.3.0",isBlank:function(e){if(e==null)e="";return/^\s*$/.test(e)},stripTags:function(e){if(e==null)return"";return t(e).replace(/<\/?[^>]+>/g,"")},capitalize:function(e){e=e==null?"":t(e);return e.charAt(0).toUpperCase()+e.slice(1)},chop:function(e,i){if(e==null)return[];e=t(e);i=~~i;return i>0?e.match(new RegExp(".{1,"+i+"}","g")):[e]},clean:function(e){return _.strip(e).replace(/\s+/g," ")},count:function(e,i){if(e==null||i==null)return 0;e=t(e);i=t(i);var s=0,n=0,r=i.length;while(true){n=e.indexOf(i,n);if(n===-1)break;s++;n+=r}return s},chars:function(e){if(e==null)return[];return t(e).split("")},swapCase:function(e){if(e==null)return"";return t(e).replace(/\S/g,function(e){return e===e.toUpperCase()?e.toLowerCase():e.toUpperCase()})},escapeHTML:function(e){if(e==null)return"";return t(e).replace(/[&<>"']/g,function(e){return"&"+h[e]+";"})},unescapeHTML:function(e){if(e==null)return"";return t(e).replace(/\&([^;]+);/g,function(e,i){var s;if(i in d){return d[i]}else if(s=i.match(/^#x([\da-fA-F]+)$/)){return t.fromCharCode(parseInt(s[1],16))}else if(s=i.match(/^#(\d+)$/)){return t.fromCharCode(~~s[1])}else{return e}})},escapeRegExp:function(e){if(e==null)return"";return t(e).replace(/([.*+?^=!:${}()|[\]\/\\])/g,"\\$1")},splice:function(e,t,i,s){var n=_.chars(e);n.splice(~~t,~~i,s);return n.join("")},insert:function(e,t,i){return _.splice(e,t,0,i)},include:function(e,i){if(i==="")return true;if(e==null)return false;return t(e).indexOf(i)!==-1},join:function(){var e=o.call(arguments),t=e.shift();if(t==null)t="";return e.join(t)},lines:function(e){if(e==null)return[];return t(e).split("\n")},reverse:function(e){return _.chars(e).reverse().join("")},startsWith:function(e,i){if(i==="")return true;if(e==null||i==null)return false;e=t(e);i=t(i);return e.length>=i.length&&e.slice(0,i.length)===i},endsWith:function(e,i){if(i==="")return true;if(e==null||i==null)return false;e=t(e);i=t(i);return e.length>=i.length&&e.slice(e.length-i.length)===i},succ:function(e){if(e==null)return"";e=t(e);return e.slice(0,-1)+t.fromCharCode(e.charCodeAt(e.length-1)+1)},titleize:function(e){if(e==null)return"";e=t(e).toLowerCase();return e.replace(/(?:^|\s|-)\S/g,function(e){return e.toUpperCase()})},camelize:function(e){return _.trim(e).replace(/[-_\s]+(.)?/g,function(e,t){return t?t.toUpperCase():""})},underscored:function(e){return _.trim(e).replace(/([a-z\d])([A-Z]+)/g,"$1_$2").replace(/[-\s]+/g,"_").toLowerCase()},dasherize:function(e){return _.trim(e).replace(/([A-Z])/g,"-$1").replace(/[-_\s]+/g,"-").toLowerCase()},classify:function(e){return _.titleize(t(e).replace(/[\W_]/g," ")).replace(/\s/g,"")},humanize:function(e){return _.capitalize(_.underscored(e).replace(/_id$/,"").replace(/_/g," "))},trim:function(e,s){if(e==null)return"";if(!s&&i)return i.call(e);s=l(s);return t(e).replace(new RegExp("^"+s+"+|"+s+"+$","g"),"")},ltrim:function(e,i){if(e==null)return"";if(!i&&n)return n.call(e);i=l(i);return t(e).replace(new RegExp("^"+i+"+"),"")},rtrim:function(e,i){if(e==null)return"";if(!i&&s)return s.call(e);i=l(i);return t(e).replace(new RegExp(i+"+$"),"")},truncate:function(e,i,s){if(e==null)return"";e=t(e);s=s||"...";i=~~i;return e.length>i?e.slice(0,i)+s:e},prune:function(e,i,s){if(e==null)return"";e=t(e);i=~~i;s=s!=null?t(s):"...";if(e.length<=i)return e;var n=function(e){return e.toUpperCase()!==e.toLowerCase()?"A":" "},r=e.slice(0,i+1).replace(/.(?=\W*\w*$)/g,n);if(r.slice(r.length-2).match(/\w\w/))r=r.replace(/\s*\S+$/,"");else r=_.rtrim(r.slice(0,r.length-1));return(r+s).length>e.length?e:e.slice(0,r.length)+s},words:function(e,t){if(_.isBlank(e))return[];return _.trim(e,t).split(t||/\s+/)},pad:function(e,i,s,n){e=e==null?"":t(e);i=~~i;var r=0;if(!s)s=" ";else if(s.length>1)s=s.charAt(0);switch(n){case"right":r=i-e.length;return e+a(s,r);case"both":r=i-e.length;return a(s,Math.ceil(r/2))+e+a(s,Math.floor(r/2));default:r=i-e.length;return a(s,r)+e}},lpad:function(e,t,i){return _.pad(e,t,i)},rpad:function(e,t,i){return _.pad(e,t,i,"right")},lrpad:function(e,t,i){return _.pad(e,t,i,"both")},sprintf:f,vsprintf:function(e,t){t.unshift(e);return f.apply(null,t)},toNumber:function(e,t){if(!e)return 0;e=_.trim(e);if(!e.match(/^-?\d+(?:\.\d+)?$/))return NaN;return r(r(e).toFixed(~~t))},numberFormat:function(e,t,i,s){if(isNaN(e)||e==null)return"";e=e.toFixed(~~t);s=typeof s=="string"?s:",";var n=e.split("."),r=n[0],a=n[1]?(i||".")+n[1]:"";return r.replace(/(\d)(?=(?:\d{3})+$)/g,"$1"+s)+a},strRight:function(e,i){if(e==null)return"";e=t(e);i=i!=null?t(i):i;var s=!i?-1:e.indexOf(i);return~s?e.slice(s+i.length,e.length):e},strRightBack:function(e,i){if(e==null)return"";e=t(e);i=i!=null?t(i):i;var s=!i?-1:e.lastIndexOf(i);return~s?e.slice(s+i.length,e.length):e},strLeft:function(e,i){if(e==null)return"";e=t(e);i=i!=null?t(i):i;var s=!i?-1:e.indexOf(i);return~s?e.slice(0,s):e},strLeftBack:function(e,t){if(e==null)return"";e+="";t=t!=null?""+t:t;var i=e.lastIndexOf(t);return~i?e.slice(0,i):e},toSentence:function(e,t,i,s){t=t||", ";i=i||" and ";var n=e.slice(),r=n.pop();if(e.length>2&&s)i=_.rtrim(t)+i;return n.length?n.join(t)+i+r:r},toSentenceSerial:function(){var e=o.call(arguments);e[3]=true;return _.toSentence.apply(_,e)},slugify:function(e){if(e==null)return"";var i="\u0105\xe0\xe1\xe4\xe2\xe3\xe5\xe6\u0103\u0107\u0119\xe8\xe9\xeb\xea\xec\xed\xef\xee\u0142\u0144\xf2\xf3\xf6\xf4\xf5\xf8\u015b\u0219\u021b\xf9\xfa\xfc\xfb\xf1\xe7\u017c\u017a",s="aaaaaaaaaceeeeeiiiilnoooooosstuuuunczz",n=new RegExp(l(i),"g");e=t(e).toLowerCase().replace(n,function(e){var t=i.indexOf(e);return s.charAt(t)||"-"});return _.dasherize(e.replace(/[^\w\s-]/g,""))},surround:function(e,t){return[t,e,t].join("")},quote:function(e,t){return _.surround(e,t||'"')},unquote:function(e,t){t=t||'"';if(e[0]===t&&e[e.length-1]===t)return e.slice(1,e.length-1);else return e},exports:function(){var e={};for(var t in this){if(!this.hasOwnProperty(t)||t.match(/^(?:include|contains|reverse)$/))continue;e[t]=this[t]}return e},repeat:function(e,i,s){if(e==null)return"";i=~~i;if(s==null)return a(t(e),i);for(var n=[];i>0;n[--i]=e){}return n.join(s)},naturalCmp:function(e,i){if(e==i)return 0;if(!e)return-1;if(!i)return 1;var s=/(\.\d+)|(\d+)|(\D+)/g,n=t(e).toLowerCase().match(s),r=t(i).toLowerCase().match(s),a=Math.min(n.length,r.length);for(var o=0;o<a;o++){var l=n[o],u=r[o];if(l!==u){var d=parseInt(l,10);if(!isNaN(d)){var h=parseInt(u,10);if(!isNaN(h)&&d-h)return d-h}return l<u?-1:1}}if(n.length===r.length)return n.length-r.length;return e<i?-1:1},levenshtein:function(e,i){if(e==null&&i==null)return 0;if(e==null)return t(i).length;if(i==null)return t(e).length;e=t(e);i=t(i);var s=[],n,r;for(var a=0;a<=i.length;a++)for(var o=0;o<=e.length;o++){if(a&&o)if(e.charAt(o-1)===i.charAt(a-1))r=n;else r=Math.min(s[o],s[o-1],n)+1;else r=a+o;n=s[o];s[o]=r}return s.pop()},toBoolean:function(e,t,i){if(typeof e==="number")e=""+e;if(typeof e!=="string")return!!e;e=_.trim(e);if(u(e,t||["true","1"]))return true;if(u(e,i||["false","0"]))return false}};_.strip=_.trim;_.lstrip=_.ltrim;_.rstrip=_.rtrim;_.center=_.lrpad;_.rjust=_.lpad;_.ljust=_.rpad;_.contains=_.include;_.q=_.quote;_.toBool=_.toBoolean;if(typeof exports!=="undefined"){if(typeof module!=="undefined"&&module.exports)module.exports=_;exports._s=_}if(typeof define==="function"&&define.amd)define("underscore.string",[],function(){return _});e._=e._||{};e._.string=e._.str=_}(this,String);(function(e){var t,i="2.4.0",s=Math.round,n,r=0,a=1,o=2,l=3,u=4,d=5,h=6,c={},f=typeof module!=="undefined"&&module.exports,_=/^\/?Date\((\-?\d+)/i,p=/(\-)?(?:(\d*)\.)?(\d+)\:(\d+)(?:\:(\d+)\.?(\d{3})?)?/,m=/^(-)?P(?:(?:([0-9,.]*)Y)?(?:([0-9,.]*)M)?(?:([0-9,.]*)D)?(?:T(?:([0-9,.]*)H)?(?:([0-9,.]*)M)?(?:([0-9,.]*)S)?)?|([0-9,.]*)W)$/,g=/(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|YYYYY|YYYY|YY|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|mm?|ss?|S{1,4}|X|zz?|ZZ?|.)/g,S=/(\[[^\[]*\])|(\\)?(LT|LL?L?L?|l{1,4})/g,w=/\d\d?/,v=/\d{1,3}/,M=/\d{3}/,y=/\d{1,4}/,b=/[+\-]?\d{1,6}/,D=/\d+/,C=/[0-9]*['a-z\u00A0-\u05FF\u0700-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+|[\u0600-\u06FF\/]+(\s*?[\u0600-\u06FF]+){1,2}/i,E=/Z|[\+\-]\d\d:?\d\d/i,x=/T/i,V=/[\+\-]?\d+(\.\d{1,3})?/,T=/^\s*\d{4}-(?:(\d\d-\d\d)|(W\d\d$)|(W\d\d-\d)|(\d\d\d))((T| )(\d\d(:\d\d(:\d\d(\.\d+)?)?)?)?([\+\-]\d\d:?\d\d|Z)?)?$/,A="YYYY-MM-DDTHH:mm:ssZ",R=["YYYY-MM-DD","GGGG-[W]WW","GGGG-[W]WW-E","YYYY-DDD"],I=[["HH:mm:ss.SSSS",/(T| )\d\d:\d\d:\d\d\.\d{1,3}/],["HH:mm:ss",/(T| )\d\d:\d\d:\d\d/],["HH:mm",/(T| )\d\d:\d\d/],["HH",/(T| )\d\d/]],k=/([\+\-]|\d\d)/gi,L="Date|Hours|Minutes|Seconds|Milliseconds".split("|"),P={Milliseconds:1,Seconds:1e3,Minutes:6e4,Hours:36e5,Days:864e5,Months:2592e6,Years:31536e6},O={ms:"millisecond",s:"second",m:"minute",h:"hour",d:"day",D:"date",w:"week",W:"isoWeek",M:"month",y:"year",DDD:"dayOfYear",e:"weekday",E:"isoWeekday",gg:"weekYear",GG:"isoWeekYear"},N={dayofyear:"dayOfYear",isoweekday:"isoWeekday",isoweek:"isoWeek",weekyear:"weekYear",isoweekyear:"isoWeekYear"},$={},B="DDD w W M D d".split(" "),z="M D H h m s w W".split(" "),q={M:function(){return this.month()+1},MMM:function(e){return this.lang().monthsShort(this,e)},MMMM:function(e){return this.lang().months(this,e)},D:function(){return this.date()},DDD:function(){return this.dayOfYear()},d:function(){return this.day()},dd:function(e){return this.lang().weekdaysMin(this,e)},ddd:function(e){return this.lang().weekdaysShort(this,e)},dddd:function(e){return this.lang().weekdays(this,e)},w:function(){return this.week()},W:function(){return this.isoWeek()},YY:function(){return W(this.year()%100,2)},YYYY:function(){return W(this.year(),4)},YYYYY:function(){return W(this.year(),5)},gg:function(){return W(this.weekYear()%100,2)},gggg:function(){return this.weekYear()},ggggg:function(){return W(this.weekYear(),5)},GG:function(){return W(this.isoWeekYear()%100,2)},GGGG:function(){return this.isoWeekYear()},GGGGG:function(){return W(this.isoWeekYear(),5)},e:function(){return this.weekday()},E:function(){return this.isoWeekday()},a:function(){return this.lang().meridiem(this.hours(),this.minutes(),true)},A:function(){return this.lang().meridiem(this.hours(),this.minutes(),false)},H:function(){return this.hours()},h:function(){return this.hours()%12||12},m:function(){return this.minutes()},s:function(){return this.seconds()},S:function(){return ne(this.milliseconds()/100)},SS:function(){return W(ne(this.milliseconds()/10),2)},SSS:function(){return W(this.milliseconds(),3)},SSSS:function(){return W(this.milliseconds(),3)},Z:function(){var e=-this.zone(),t="+";if(e<0){e=-e;t="-"}return t+W(ne(e/60),2)+":"+W(ne(e)%60,2)},ZZ:function(){var e=-this.zone(),t="+";if(e<0){e=-e;t="-"}return t+W(ne(10*e/6),4)},z:function(){return this.zoneAbbr()},zz:function(){return this.zoneName()},X:function(){return this.unix()}},F=["months","monthsShort","weekdays","weekdaysShort","weekdaysMin"];function Q(e,t){return function(i){return W(e.call(this,i),t)}}function H(e,t){return function(i){return this.lang().ordinal(e.call(this,i),t)}}while(B.length){n=B.pop();q[n+"o"]=H(q[n],n)}while(z.length){n=z.pop();q[n+n]=Q(q[n],2)}q.DDDD=Q(q.DDD,3);function G(){}function U(e){le(e);J(this,e)}function j(e){var t=ie(e),i=t.year||0,s=t.month||0,n=t.week||0,r=t.day||0,a=t.hour||0,o=t.minute||0,l=t.second||0,u=t.millisecond||0;this._input=e;this._milliseconds=+u+l*1e3+o*6e4+a*36e5;this._days=+r+n*7;this._months=+s+i*12;this._data={};this._bubble()}function J(e,t){for(var i in t){if(t.hasOwnProperty(i)){e[i]=t[i]}}if(t.hasOwnProperty("toString")){e.toString=t.toString}if(t.hasOwnProperty("valueOf")){e.valueOf=t.valueOf}return e}function Y(e){if(e<0){return Math.ceil(e)}else{return Math.floor(e)}}function W(e,t){var i=e+"";while(i.length<t){i="0"+i}return i}function K(e,i,s,n){var r=i._milliseconds,a=i._days,o=i._months,l,u;if(r){e._d.setTime(+e._d+r*s)}if(a||o){l=e.minute();u=e.hour()}if(a){e.date(e.date()+a*s)}if(o){e.month(e.month()+o*s)}if(r&&!n){t.updateOffset(e)}if(a||o){e.minute(l);e.hour(u)}}function X(e){return Object.prototype.toString.call(e)==="[object Array]"}function Z(e){return Object.prototype.toString.call(e)==="[object Date]"||e instanceof Date}function ee(e,t,i){var s=Math.min(e.length,t.length),n=Math.abs(e.length-t.length),r=0,a;for(a=0;a<s;a++){if(i&&e[a]!==t[a]||!i&&ne(e[a])!==ne(t[a])){r++}}return r+n}function te(e){
if(e){var t=e.toLowerCase().replace(/(.)s$/,"$1");e=O[e]||N[t]||t}return e}function ie(e){var t={},i,s,n;for(s in e){if(e.hasOwnProperty(s)){i=te(s);if(i){t[i]=e[s]}}}return t}function se(i){var s,n;if(i.indexOf("week")===0){s=7;n="day"}else if(i.indexOf("month")===0){s=12;n="month"}else{return}t[i]=function(r,a){var o,l,u=t.fn._lang[i],d=[];if(typeof r==="number"){a=r;r=e}l=function(e){var i=t().utc().set(n,e);return u.call(t.fn._lang,i,r||"")};if(a!=null){return l(a)}else{for(o=0;o<s;o++){d.push(l(o))}return d}}}function ne(e){var t=+e,i=0;if(t!==0&&isFinite(t)){if(t>=0){i=Math.floor(t)}else{i=Math.ceil(t)}}return i}function re(e,t){return new Date(Date.UTC(e,t+1,0)).getUTCDate()}function ae(e){return oe(e)?366:365}function oe(e){return e%4===0&&e%100!==0||e%400===0}function le(e){var t;if(e._a&&e._pf.overflow===-2){t=e._a[a]<0||e._a[a]>11?a:e._a[o]<1||e._a[o]>re(e._a[r],e._a[a])?o:e._a[l]<0||e._a[l]>23?l:e._a[u]<0||e._a[u]>59?u:e._a[d]<0||e._a[d]>59?d:e._a[h]<0||e._a[h]>999?h:-1;if(e._pf._overflowDayOfYear&&(t<r||t>o)){t=o}e._pf.overflow=t}}function ue(e){e._pf={empty:false,unusedTokens:[],unusedInput:[],overflow:-2,charsLeftOver:0,nullInput:false,invalidMonth:null,invalidFormat:false,userInvalidated:false,iso:false}}function de(e){if(e._isValid==null){e._isValid=!isNaN(e._d.getTime())&&e._pf.overflow<0&&!e._pf.empty&&!e._pf.invalidMonth&&!e._pf.nullInput&&!e._pf.invalidFormat&&!e._pf.userInvalidated;if(e._strict){e._isValid=e._isValid&&e._pf.charsLeftOver===0&&e._pf.unusedTokens.length===0}}return e._isValid}function he(e){return e?e.toLowerCase().replace("_","-"):e}J(G.prototype,{set:function(e){var t,i;for(i in e){t=e[i];if(typeof t==="function"){this[i]=t}else{this["_"+i]=t}}},_months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),months:function(e){return this._months[e.month()]},_monthsShort:"Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),monthsShort:function(e){return this._monthsShort[e.month()]},monthsParse:function(e){var i,s,n;if(!this._monthsParse){this._monthsParse=[]}for(i=0;i<12;i++){if(!this._monthsParse[i]){s=t.utc([2e3,i]);n="^"+this.months(s,"")+"|^"+this.monthsShort(s,"");this._monthsParse[i]=new RegExp(n.replace(".",""),"i")}if(this._monthsParse[i].test(e)){return i}}},_weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),weekdays:function(e){return this._weekdays[e.day()]},_weekdaysShort:"Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),weekdaysShort:function(e){return this._weekdaysShort[e.day()]},_weekdaysMin:"Su_Mo_Tu_We_Th_Fr_Sa".split("_"),weekdaysMin:function(e){return this._weekdaysMin[e.day()]},weekdaysParse:function(e){var i,s,n;if(!this._weekdaysParse){this._weekdaysParse=[]}for(i=0;i<7;i++){if(!this._weekdaysParse[i]){s=t([2e3,1]).day(i);n="^"+this.weekdays(s,"")+"|^"+this.weekdaysShort(s,"")+"|^"+this.weekdaysMin(s,"");this._weekdaysParse[i]=new RegExp(n.replace(".",""),"i")}if(this._weekdaysParse[i].test(e)){return i}}},_longDateFormat:{LT:"h:mm A",L:"MM/DD/YYYY",LL:"MMMM D YYYY",LLL:"MMMM D YYYY LT",LLLL:"dddd, MMMM D YYYY LT"},longDateFormat:function(e){var t=this._longDateFormat[e];if(!t&&this._longDateFormat[e.toUpperCase()]){t=this._longDateFormat[e.toUpperCase()].replace(/MMMM|MM|DD|dddd/g,function(e){return e.slice(1)});this._longDateFormat[e]=t}return t},isPM:function(e){return(e+"").toLowerCase().charAt(0)==="p"},_meridiemParse:/[ap]\.?m?\.?/i,meridiem:function(e,t,i){if(e>11){return i?"pm":"PM"}else{return i?"am":"AM"}},_calendar:{sameDay:"[Today at] LT",nextDay:"[Tomorrow at] LT",nextWeek:"dddd [at] LT",lastDay:"[Yesterday at] LT",lastWeek:"[Last] dddd [at] LT",sameElse:"L"},calendar:function(e,t){var i=this._calendar[e];return typeof i==="function"?i.apply(t):i},_relativeTime:{future:"in %s",past:"%s ago",s:"a few seconds",m:"a minute",mm:"%d minutes",h:"an hour",hh:"%d hours",d:"a day",dd:"%d days",M:"a month",MM:"%d months",y:"a year",yy:"%d years"},relativeTime:function(e,t,i,s){var n=this._relativeTime[i];return typeof n==="function"?n(e,t,i,s):n.replace(/%d/i,e)},pastFuture:function(e,t){var i=this._relativeTime[e>0?"future":"past"];return typeof i==="function"?i(t):i.replace(/%s/i,t)},ordinal:function(e){return this._ordinal.replace("%d",e)},_ordinal:"%d",preparse:function(e){return e},postformat:function(e){return e},week:function(e){return Oe(e,this._week.dow,this._week.doy).week},_week:{dow:0,doy:6},_invalidDate:"Invalid date",invalidDate:function(){return this._invalidDate}});function ce(e,t){t.abbr=e;if(!c[e]){c[e]=new G}c[e].set(t);return c[e]}function fe(e){delete c[e]}function _e(e){var i=0,s,n,r,a,o=function(e){if(!c[e]&&f){try{require("./lang/"+e)}catch(t){}}return c[e]};if(!e){return t.fn._lang}if(!X(e)){n=o(e);if(n){return n}e=[e]}while(i<e.length){a=he(e[i]).split("-");s=a.length;r=he(e[i+1]);r=r?r.split("-"):null;while(s>0){n=o(a.slice(0,s).join("-"));if(n){return n}if(r&&r.length>=s&&ee(a,r,true)>=s-1){break}s--}i++}return t.fn._lang}function pe(e){if(e.match(/\[[\s\S]/)){return e.replace(/^\[|\]$/g,"")}return e.replace(/\\/g,"")}function me(e){var t=e.match(g),i,s;for(i=0,s=t.length;i<s;i++){if(q[t[i]]){t[i]=q[t[i]]}else{t[i]=pe(t[i])}}return function(n){var r="";for(i=0;i<s;i++){r+=t[i]instanceof Function?t[i].call(n,e):t[i]}return r}}function ge(e,t){if(!e.isValid()){return e.lang().invalidDate()}t=Se(t,e.lang());if(!$[t]){$[t]=me(t)}return $[t](e)}function Se(e,t){var i=5;function s(e){return t.longDateFormat(e)||e}S.lastIndex=0;while(i>=0&&S.test(e)){e=e.replace(S,s);S.lastIndex=0;i-=1}return e}function we(e,t){var i;switch(e){case"DDDD":return M;case"YYYY":case"GGGG":case"gggg":return y;case"YYYYY":case"GGGGG":case"ggggg":return b;case"S":case"SS":case"SSS":case"DDD":return v;case"MMM":case"MMMM":case"dd":case"ddd":case"dddd":return C;case"a":case"A":return _e(t._l)._meridiemParse;case"X":return V;case"Z":case"ZZ":return E;case"T":return x;case"SSSS":return D;case"MM":case"DD":case"YY":case"GG":case"gg":case"HH":case"hh":case"mm":case"ss":case"M":case"D":case"d":case"H":case"h":case"m":case"s":case"w":case"ww":case"W":case"WW":case"e":case"E":return w;default:i=new RegExp(xe(Ee(e.replace("\\","")),"i"));return i}}function ve(e){var t=(E.exec(e)||[])[0],i=(t+"").match(k)||["-",0,0],s=+(i[1]*60)+ne(i[2]);return i[0]==="+"?-s:s}function Me(e,t,i){var s,n=i._a;switch(e){case"M":case"MM":if(t!=null){n[a]=ne(t)-1}break;case"MMM":case"MMMM":s=_e(i._l).monthsParse(t);if(s!=null){n[a]=s}else{i._pf.invalidMonth=t}break;case"D":case"DD":if(t!=null){n[o]=ne(t)}break;case"DDD":case"DDDD":if(t!=null){i._dayOfYear=ne(t)}break;case"YY":n[r]=ne(t)+(ne(t)>68?1900:2e3);break;case"YYYY":case"YYYYY":n[r]=ne(t);break;case"a":case"A":i._isPm=_e(i._l).isPM(t);break;case"H":case"HH":case"h":case"hh":n[l]=ne(t);break;case"m":case"mm":n[u]=ne(t);break;case"s":case"ss":n[d]=ne(t);break;case"S":case"SS":case"SSS":case"SSSS":n[h]=ne(("0."+t)*1e3);break;case"X":i._d=new Date(parseFloat(t)*1e3);break;case"Z":case"ZZ":i._useUTC=true;i._tzm=ve(t);break;case"w":case"ww":case"W":case"WW":case"d":case"dd":case"ddd":case"dddd":case"e":case"E":e=e.substr(0,1);case"gg":case"gggg":case"GG":case"GGGG":case"GGGGG":e=e.substr(0,2);if(t){i._w=i._w||{};i._w[e]=t}break}}function ye(e){var i,s,n=[],d,h,c,f,_,p,m,g;if(e._d){return}d=De(e);if(e._w&&e._a[o]==null&&e._a[a]==null){c=function(i){return i?i.length<3?parseInt(i,10)>68?"19"+i:"20"+i:i:e._a[r]==null?t().weekYear():e._a[r]};f=e._w;if(f.GG!=null||f.W!=null||f.E!=null){_=Ne(c(f.GG),f.W||1,f.E,4,1)}else{p=_e(e._l);m=f.d!=null?ke(f.d,p):f.e!=null?parseInt(f.e,10)+p._week.dow:0;g=parseInt(f.w,10)||1;if(f.d!=null&&m<p._week.dow){g++}_=Ne(c(f.gg),g,m,p._week.doy,p._week.dow)}e._a[r]=_.year;e._dayOfYear=_.dayOfYear}if(e._dayOfYear){h=e._a[r]==null?d[r]:e._a[r];if(e._dayOfYear>ae(h)){e._pf._overflowDayOfYear=true}s=Ie(h,0,e._dayOfYear);e._a[a]=s.getUTCMonth();e._a[o]=s.getUTCDate()}for(i=0;i<3&&e._a[i]==null;++i){e._a[i]=n[i]=d[i]}for(;i<7;i++){e._a[i]=n[i]=e._a[i]==null?i===2?1:0:e._a[i]}n[l]+=ne((e._tzm||0)/60);n[u]+=ne((e._tzm||0)%60);e._d=(e._useUTC?Ie:Re).apply(null,n)}function be(e){var t;if(e._d){return}t=ie(e._i);e._a=[t.year,t.month,t.day,t.hour,t.minute,t.second,t.millisecond];ye(e)}function De(e){var t=new Date;if(e._useUTC){return[t.getUTCFullYear(),t.getUTCMonth(),t.getUTCDate()]}else{return[t.getFullYear(),t.getMonth(),t.getDate()]}}function Ce(e){e._a=[];e._pf.empty=true;var t=_e(e._l),i=""+e._i,s,n,r,a,o,u=i.length,d=0;r=Se(e._f,t).match(g)||[];for(s=0;s<r.length;s++){a=r[s];n=(we(a,e).exec(i)||[])[0];if(n){o=i.substr(0,i.indexOf(n));if(o.length>0){e._pf.unusedInput.push(o)}i=i.slice(i.indexOf(n)+n.length);d+=n.length}if(q[a]){if(n){e._pf.empty=false}else{e._pf.unusedTokens.push(a)}Me(a,n,e)}else if(e._strict&&!n){e._pf.unusedTokens.push(a)}}e._pf.charsLeftOver=u-d;if(i.length>0){e._pf.unusedInput.push(i)}if(e._isPm&&e._a[l]<12){e._a[l]+=12}if(e._isPm===false&&e._a[l]===12){e._a[l]=0}ye(e);le(e)}function Ee(e){return e.replace(/\\(\[)|\\(\])|\[([^\]\[]*)\]|\\(.)/g,function(e,t,i,s,n){return t||i||s||n})}function xe(e){return e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")}function Ve(e){var t,i,s,n,r;if(e._f.length===0){e._pf.invalidFormat=true;e._d=new Date(NaN);return}for(n=0;n<e._f.length;n++){r=0;t=J({},e);ue(t);t._f=e._f[n];Ce(t);if(!de(t)){continue}r+=t._pf.charsLeftOver;r+=t._pf.unusedTokens.length*10;t._pf.score=r;if(s==null||r<s){s=r;i=t}}J(e,i||t)}function Te(e){var t,i=e._i,s=T.exec(i);if(s){e._pf.iso=true;for(t=4;t>0;t--){if(s[t]){e._f=R[t-1]+(s[6]||" ");break}}for(t=0;t<4;t++){if(I[t][1].exec(i)){e._f+=I[t][0];break}}if(E.exec(i)){e._f+="Z"}Ce(e)}else{e._d=new Date(i)}}function Ae(t){var i=t._i,s=_.exec(i);if(i===e){t._d=new Date}else if(s){t._d=new Date(+s[1])}else if(typeof i==="string"){Te(t)}else if(X(i)){t._a=i.slice(0);ye(t)}else if(Z(i)){t._d=new Date(+i)}else if(typeof i==="object"){be(t)}else{t._d=new Date(i)}}function Re(e,t,i,s,n,r,a){var o=new Date(e,t,i,s,n,r,a);if(e<1970){o.setFullYear(e)}return o}function Ie(e){var t=new Date(Date.UTC.apply(null,arguments));if(e<1970){t.setUTCFullYear(e)}return t}function ke(e,t){if(typeof e==="string"){if(!isNaN(e)){e=parseInt(e,10)}else{e=t.weekdaysParse(e);if(typeof e!=="number"){return null}}}return e}function Le(e,t,i,s,n){return n.relativeTime(t||1,!!i,e,s)}function Pe(e,t,i){var n=s(Math.abs(e)/1e3),r=s(n/60),a=s(r/60),o=s(a/24),l=s(o/365),u=n<45&&["s",n]||r===1&&["m"]||r<45&&["mm",r]||a===1&&["h"]||a<22&&["hh",a]||o===1&&["d"]||o<=25&&["dd",o]||o<=45&&["M"]||o<345&&["MM",s(o/30)]||l===1&&["y"]||["yy",l];u[2]=t;u[3]=e>0;u[4]=i;return Le.apply({},u)}function Oe(e,i,s){var n=s-i,r=s-e.day(),a;if(r>n){r-=7}if(r<n-7){r+=7}a=t(e).add("d",r);return{week:Math.ceil(a.dayOfYear()/7),year:a.year()}}function Ne(e,t,i,s,n){var r=new Date(Date.UTC(e,0)).getUTCDay(),a,o;i=i!=null?i:n;a=n-r+(r>s?7:0);o=7*(t-1)+(i-n)+a+1;return{year:o>0?e:e-1,dayOfYear:o>0?o:ae(e-1)+o}}function $e(e){var i=e._i,s=e._f;if(typeof e._pf==="undefined"){ue(e)}if(i===null){return t.invalid({nullInput:true})}if(typeof i==="string"){e._i=i=_e().preparse(i)}if(t.isMoment(i)){e=J({},i);e._d=new Date(+i._d)}else if(s){if(X(s)){Ve(e)}else{Ce(e)}}else{Ae(e)}return new U(e)}t=function(t,i,s,n){if(typeof s==="boolean"){n=s;s=e}return $e({_i:t,_f:i,_l:s,_strict:n,_isUTC:false})};t.utc=function(t,i,s,n){var r;if(typeof s==="boolean"){n=s;s=e}r=$e({_useUTC:true,_isUTC:true,_l:s,_i:t,_f:i,_strict:n}).utc();return r};t.unix=function(e){return t(e*1e3)};t.duration=function(e,i){var s=t.isDuration(e),n=typeof e==="number",r=s?e._input:n?{}:e,a=null,c,f,_,g,S;if(n){if(i){r[i]=e}else{r.milliseconds=e}}else if(!!(a=p.exec(e))){c=a[1]==="-"?-1:1;r={y:0,d:ne(a[o])*c,h:ne(a[l])*c,m:ne(a[u])*c,s:ne(a[d])*c,ms:ne(a[h])*c}}else if(!!(a=m.exec(e))){c=a[1]==="-"?-1:1;_=function(e){var t=e&&parseFloat(e.replace(",","."));return(isNaN(t)?0:t)*c};r={y:_(a[2]),M:_(a[3]),d:_(a[4]),h:_(a[5]),m:_(a[6]),s:_(a[7]),w:_(a[8])}}f=new j(r);if(s&&e.hasOwnProperty("_lang")){f._lang=e._lang}return f};t.version=i;t.defaultFormat=A;t.updateOffset=function(){};t.lang=function(e,i){var s;if(!e){return t.fn._lang._abbr}if(i){ce(he(e),i)}else if(i===null){fe(e);e="en"}else if(!c[e]){_e(e)}s=t.duration.fn._lang=t.fn._lang=_e(e);return s._abbr};t.langData=function(e){if(e&&e._lang&&e._lang._abbr){e=e._lang._abbr}return _e(e)};t.isMoment=function(e){return e instanceof U};t.isDuration=function(e){return e instanceof j};for(n=F.length-1;n>=0;--n){se(F[n])}t.normalizeUnits=function(e){return te(e)};t.invalid=function(e){var i=t.utc(NaN);if(e!=null){J(i._pf,e)}else{i._pf.userInvalidated=true}return i};t.parseZone=function(e){return t(e).parseZone()};J(t.fn=U.prototype,{clone:function(){return t(this)},valueOf:function(){return+this._d+(this._offset||0)*6e4},unix:function(){return Math.floor(+this/1e3)},toString:function(){return this.clone().lang("en").format("ddd MMM DD YYYY HH:mm:ss [GMT]ZZ")},toDate:function(){return this._offset?new Date(+this):this._d},toISOString:function(){return ge(t(this).utc(),"YYYY-MM-DD[T]HH:mm:ss.SSS[Z]")},toArray:function(){var e=this;return[e.year(),e.month(),e.date(),e.hours(),e.minutes(),e.seconds(),e.milliseconds()]},isValid:function(){return de(this)},isDSTShifted:function(){if(this._a){return this.isValid()&&ee(this._a,(this._isUTC?t.utc(this._a):t(this._a)).toArray())>0}return false},parsingFlags:function(){return J({},this._pf)},invalidAt:function(){return this._pf.overflow},utc:function(){return this.zone(0)},local:function(){this.zone(0);this._isUTC=false;return this},format:function(e){var i=ge(this,e||t.defaultFormat);return this.lang().postformat(i)},add:function(e,i){var s;if(typeof e==="string"){s=t.duration(+i,e)}else{s=t.duration(e,i)}K(this,s,1);return this},subtract:function(e,i){var s;if(typeof e==="string"){s=t.duration(+i,e)}else{s=t.duration(e,i)}K(this,s,-1);return this},diff:function(e,i,s){var n=this._isUTC?t(e).zone(this._offset||0):t(e).local(),r=(this.zone()-n.zone())*6e4,a,o;i=te(i);if(i==="year"||i==="month"){a=(this.daysInMonth()+n.daysInMonth())*432e5;o=(this.year()-n.year())*12+(this.month()-n.month());o+=(this-t(this).startOf("month")-(n-t(n).startOf("month")))/a;o-=(this.zone()-t(this).startOf("month").zone()-(n.zone()-t(n).startOf("month").zone()))*6e4/a;if(i==="year"){o=o/12}}else{a=this-n;o=i==="second"?a/1e3:i==="minute"?a/6e4:i==="hour"?a/36e5:i==="day"?(a-r)/864e5:i==="week"?(a-r)/6048e5:a}return s?o:Y(o)},from:function(e,i){return t.duration(this.diff(e)).lang(this.lang()._abbr).humanize(!i)},fromNow:function(e){return this.from(t(),e)},calendar:function(){var e=this.diff(t().zone(this.zone()).startOf("day"),"days",true),i=e<-6?"sameElse":e<-1?"lastWeek":e<0?"lastDay":e<1?"sameDay":e<2?"nextDay":e<7?"nextWeek":"sameElse";return this.format(this.lang().calendar(i,this))},isLeapYear:function(){return oe(this.year())},isDST:function(){return this.zone()<this.clone().month(0).zone()||this.zone()<this.clone().month(5).zone()},day:function(e){var t=this._isUTC?this._d.getUTCDay():this._d.getDay();if(e!=null){e=ke(e,this.lang());return this.add({d:e-t})}else{return t}},month:function(e){var i=this._isUTC?"UTC":"",s;if(e!=null){if(typeof e==="string"){e=this.lang().monthsParse(e);if(typeof e!=="number"){return this}}s=this.date();this.date(1);this._d["set"+i+"Month"](e);this.date(Math.min(s,this.daysInMonth()));t.updateOffset(this);return this}else{return this._d["get"+i+"Month"]()}},startOf:function(e){e=te(e);switch(e){case"year":this.month(0);case"month":this.date(1);case"week":case"isoWeek":case"day":this.hours(0);case"hour":this.minutes(0);case"minute":this.seconds(0);case"second":this.milliseconds(0)}if(e==="week"){this.weekday(0)}else if(e==="isoWeek"){this.isoWeekday(1)}return this},endOf:function(e){e=te(e);return this.startOf(e).add(e==="isoWeek"?"week":e,1).subtract("ms",1)},isAfter:function(e,i){i=typeof i!=="undefined"?i:"millisecond";return+this.clone().startOf(i)>+t(e).startOf(i)},isBefore:function(e,i){i=typeof i!=="undefined"?i:"millisecond";return+this.clone().startOf(i)<+t(e).startOf(i)},isSame:function(e,i){i=typeof i!=="undefined"?i:"millisecond";return+this.clone().startOf(i)===+t(e).startOf(i)},min:function(e){e=t.apply(null,arguments);return e<this?this:e},max:function(e){e=t.apply(null,arguments);return e>this?this:e},zone:function(e){var i=this._offset||0;if(e!=null){if(typeof e==="string"){e=ve(e)}if(Math.abs(e)<16){e=e*60}this._offset=e;this._isUTC=true;if(i!==e){K(this,t.duration(i-e,"m"),1,true)}}else{return this._isUTC?i:this._d.getTimezoneOffset()}return this},zoneAbbr:function(){return this._isUTC?"UTC":""},zoneName:function(){return this._isUTC?"Coordinated Universal Time":""},parseZone:function(){if(typeof this._i==="string"){this.zone(this._i)}return this},hasAlignedHourOffset:function(e){if(!e){e=0}else{e=t(e).zone()}return(this.zone()-e)%60===0},daysInMonth:function(){return re(this.year(),this.month())},dayOfYear:function(e){var i=s((t(this).startOf("day")-t(this).startOf("year"))/864e5)+1;return e==null?i:this.add("d",e-i)},weekYear:function(e){var t=Oe(this,this.lang()._week.dow,this.lang()._week.doy).year;return e==null?t:this.add("y",e-t)},isoWeekYear:function(e){var t=Oe(this,1,4).year;return e==null?t:this.add("y",e-t)},week:function(e){var t=this.lang().week(this);return e==null?t:this.add("d",(e-t)*7)},isoWeek:function(e){var t=Oe(this,1,4).week;return e==null?t:this.add("d",(e-t)*7)},weekday:function(e){var t=(this.day()+7-this.lang()._week.dow)%7;return e==null?t:this.add("d",e-t)},isoWeekday:function(e){return e==null?this.day()||7:this.day(this.day()%7?e:e-7)},get:function(e){e=te(e);return this[e]()},set:function(e,t){e=te(e);if(typeof this[e]==="function"){this[e](t)}return this},lang:function(t){if(t===e){return this._lang}else{this._lang=_e(t);return this}}});function Be(e,i){t.fn[e]=t.fn[e+"s"]=function(e){var s=this._isUTC?"UTC":"";if(e!=null){this._d["set"+s+i](e);t.updateOffset(this);return this}else{return this._d["get"+s+i]()}}}for(n=0;n<L.length;n++){Be(L[n].toLowerCase().replace(/s$/,""),L[n])}Be("year","FullYear");t.fn.days=t.fn.day;t.fn.months=t.fn.month;t.fn.weeks=t.fn.week;t.fn.isoWeeks=t.fn.isoWeek;t.fn.toJSON=t.fn.toISOString;J(t.duration.fn=j.prototype,{_bubble:function(){var e=this._milliseconds,t=this._days,i=this._months,s=this._data,n,r,a,o;s.milliseconds=e%1e3;n=Y(e/1e3);s.seconds=n%60;r=Y(n/60);s.minutes=r%60;a=Y(r/60);s.hours=a%24;t+=Y(a/24);s.days=t%30;i+=Y(t/30);s.months=i%12;o=Y(i/12);s.years=o},weeks:function(){return Y(this.days()/7)},valueOf:function(){return this._milliseconds+this._days*864e5+this._months%12*2592e6+ne(this._months/12)*31536e6},humanize:function(e){var t=+this,i=Pe(t,!e,this.lang());if(e){i=this.lang().pastFuture(t,i)}return this.lang().postformat(i)},add:function(e,i){var s=t.duration(e,i);this._milliseconds+=s._milliseconds;this._days+=s._days;this._months+=s._months;this._bubble();return this},subtract:function(e,i){var s=t.duration(e,i);this._milliseconds-=s._milliseconds;this._days-=s._days;this._months-=s._months;this._bubble();return this},get:function(e){e=te(e);return this[e.toLowerCase()+"s"]()},as:function(e){e=te(e);return this["as"+e.charAt(0).toUpperCase()+e.slice(1)+"s"]()},lang:t.fn.lang,toIsoString:function(){var e=Math.abs(this.years()),t=Math.abs(this.months()),i=Math.abs(this.days()),s=Math.abs(this.hours()),n=Math.abs(this.minutes()),r=Math.abs(this.seconds()+this.milliseconds()/1e3);if(!this.asSeconds()){return"P0D"}return(this.asSeconds()<0?"-":"")+"P"+(e?e+"Y":"")+(t?t+"M":"")+(i?i+"D":"")+(s||n||r?"T":"")+(s?s+"H":"")+(n?n+"M":"")+(r?r+"S":"")}});function ze(e){t.duration.fn[e]=function(){return this._data[e]}}function qe(e,i){t.duration.fn["as"+e]=function(){return+this/i}}for(n in P){if(P.hasOwnProperty(n)){qe(n,P[n]);ze(n.toLowerCase())}}qe("Weeks",6048e5);t.duration.fn.asMonths=function(){return(+this-this.years()*31536e6)/2592e6+this.years()*12};t.lang("en",{ordinal:function(e){var t=e%10,i=ne(e%100/10)===1?"th":t===1?"st":t===2?"nd":t===3?"rd":"th";return e+i}});function Fe(e){var i=false,s=t;if(typeof ender!=="undefined"){return}if(e){this.moment=function(){if(!i&&console&&console.warn){i=true;console.warn("Accessing Moment through the global scope is "+"deprecated, and will be removed in an upcoming "+"release.")}return s.apply(null,arguments)}}else{this["moment"]=t}}if(f){module.exports=t;Fe(true)}else if(typeof define==="function"&&define.amd){define("moment",function(i,s,n){if(n.config().noGlobal!==true){Fe(n.config().noGlobal===e)}return t})}else{Fe()}}).call(this);(function(e){if(!Array.prototype.forEach){Array.prototype.forEach=function(e,t){for(var i=0,s=this.length;i<s;++i){e.call(t||this,this[i],i,this)}}}function t(e){e=decodeURIComponent(e);e=e.replace("+"," ");return e}function i(e){var t=/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/,i=["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],s=t.exec(e||""),n={};i.forEach(function(e,t){n[e]=s[t]||""});return n}function s(e){var t,i,s,n,r,a,o=[];if(typeof e==="undefined"||e===null||e===""){return o}if(e.indexOf("?")===0){e=e.substring(1)}i=e.toString().split(/[&;]/);for(t=0;t<i.length;t++){s=i[t];n=s.split("=");r=n[0];a=s.indexOf("=")===-1?null:n[1]===null?"":n[1];o.push([r,a])}return o}function n(e){this.uriParts=i(e);this.queryPairs=s(this.uriParts.query);this.hasAuthorityPrefixUserPref=null}["protocol","userInfo","host","port","path","anchor"].forEach(function(e){n.prototype[e]=function(t){if(typeof t!=="undefined"){this.uriParts[e]=t}return this.uriParts[e]}});n.prototype.hasAuthorityPrefix=function(e){if(typeof e!=="undefined"){this.hasAuthorityPrefixUserPref=e}if(this.hasAuthorityPrefixUserPref===null){return this.uriParts.source.indexOf("//")!==-1}else{return this.hasAuthorityPrefixUserPref}};n.prototype.query=function(e){var t="",i,n;if(typeof e!=="undefined"){this.queryPairs=s(e)}for(i=0;i<this.queryPairs.length;i++){n=this.queryPairs[i];if(t.length>0){t+="&"}if(n[1]===null){t+=n[0]}else{t+=n[0];t+="=";if(n[1]){t+=encodeURIComponent(n[1])}}}return t.length>0?"?"+t:t};n.prototype.getQueryParamValue=function(e){var i,s;for(s=0;s<this.queryPairs.length;s++){i=this.queryPairs[s];if(t(e)===t(i[0])){return i[1]}}};n.prototype.getQueryParamValues=function(e){var i=[],s,n;for(s=0;s<this.queryPairs.length;s++){n=this.queryPairs[s];if(t(e)===t(n[0])){i.push(n[1])}}return i};n.prototype.deleteQueryParam=function(e,i){var s=[],n,r,a,o;for(n=0;n<this.queryPairs.length;n++){r=this.queryPairs[n];a=t(r[0])===t(e);o=t(r[1])===t(i);if(arguments.length===1&&!a||arguments.length===2&&!a&&!o){s.push(r)}}this.queryPairs=s;return this};n.prototype.addQueryParam=function(e,t,i){if(arguments.length===3&&i!==-1){i=Math.min(i,this.queryPairs.length);this.queryPairs.splice(i,0,[e,t])}else if(arguments.length>0){this.queryPairs.push([e,t])}return this};n.prototype.replaceQueryParam=function(e,i,s){var n=-1,r,a;if(arguments.length===3){for(r=0;r<this.queryPairs.length;r++){a=this.queryPairs[r];if(t(a[0])===t(e)&&decodeURIComponent(a[1])===t(s)){n=r;break}}this.deleteQueryParam(e,s).addQueryParam(e,i,n)}else{for(r=0;r<this.queryPairs.length;r++){a=this.queryPairs[r];if(t(a[0])===t(e)){n=r;break}}this.deleteQueryParam(e);this.addQueryParam(e,i,n)}return this};["protocol","hasAuthorityPrefix","userInfo","host","port","path","query","anchor"].forEach(function(e){var t="set"+e.charAt(0).toUpperCase()+e.slice(1);n.prototype[t]=function(t){this[e](t);return this}});n.prototype.scheme=function(){var e="";if(this.protocol()){e+=this.protocol();if(this.protocol().indexOf(":")!==this.protocol().length-1){e+=":"}e+="//"}else{if(this.hasAuthorityPrefix()&&this.host()){e+="//"}}return e};n.prototype.origin=function(){var e=this.scheme();if(this.userInfo()&&this.host()){e+=this.userInfo();if(this.userInfo().indexOf("@")!==this.userInfo().length-1){e+="@"}}if(this.host()){e+=this.host();if(this.port()){e+=":"+this.port()}}return e};n.prototype.toString=function(){var e=this.origin();if(this.path()){e+=this.path()}else{if(this.host()&&(this.query().toString()||this.anchor())){e+="/"}}if(this.query().toString()){if(this.query().toString().indexOf("?")!==0){e+="?"}e+=this.query().toString()}if(this.anchor()){if(this.anchor().indexOf("#")!==0){e+="#"}e+=this.anchor()}return e};n.prototype.clone=function(){return new n(this.toString())};if(typeof define==="function"&&define.amd){define(function(){return n})}else if(typeof module!=="undefined"&&typeof module.exports!=="undefined"){module.exports=n}else{e.Uri=n}})(this);var JClipboard=function(){var e,t={moviePath:"JClipboard.swf",trustedOrigins:null,allowScriptAccess:"always",useNoCache:true};function i(){var e=this;e.initialize=function(){e.options=t;e.$el=null;e.isReady=false;e.copyable=null;e.$copyableEl=null;if(i()){$(document.body).append(s().$el)}};e.dispatch=function(e,t){switch(e){case"load":u();break;case"mouseOver":d();break;case"mouseOut":h();break;case"dataRequested":c();break;case"complete":f();break}};e.bindTo=function(t,i){e.copyable=t;e.$copyableEl=i;var s=i.offset(),n=i.outerWidth(),r=i.outerHeight();o(s);l(n,r)};e.unbind=function(){if(e.copyable){e.copyable=e.$copyableEl=null;var t={top:-9999,left:-9999},i=1,s=1;o(t);l(i,s)}};function i(){var e=false;if(typeof ActiveXObject==="function"){try{if(new ActiveXObject("ShockwaveFlash.ShockwaveFlash")){e=true}}catch(t){}}if(!e&&navigator.mimeTypes["application/x-shockwave-flash"]){e=true}return e}function s(){var t="<div id='sm-clipboard-html-bridge' class='global-zeroclipboard-container'></div>";var i=$(t),s=r(e.options),a='<object classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" id="sm-clipboard-flash-bridge" width="100%" height="100%">'+'<param name="movie" value="'+e.options.moviePath+n(e.options.moviePath,e.options)+'"/>'+'<param name="allowScriptAccess" value="'+e.options.allowScriptAccess+'"/>'+'<param name="scale" value="exactfit"/>'+'<param name="loop" value="false"/>'+'<param name="menu" value="false"/>'+'<param name="quality" value="best" />'+'<param name="bgcolor" value="#ffffff"/>'+'<param name="wmode" value="transparent"/>'+'<param name="flashvars" value="'+s+'"/>'+'<embed src="'+e.options.moviePath+n(e.options.moviePath,e.options)+'"loop="false" menu="false" quality="best" bgcolor="#ffffff" width="100%" height="100%"'+'name="sm-clipboard-flash-bridge" allowScriptAccess="always" allowFullScreen="false"'+'type="application/x-shockwave-flash" wmode="transparent"'+'pluginspage="http://www.macromedia.com/go/getflashplayer"'+'flashvars="'+s+'"'+'scale="exactfit"></embed></object>';i.css({position:"absolute",left:0,top:0,width:"10px",height:"100px",zIndex:"9999"});i.html(a);e.$el=i;e.flashBridge=i.find("[name=sm-clipboard-flash-bridge]").get(0);return e}function n(e,t){var i=!(t&&t.useNoCache===false);if(i){return(e.indexOf("?")===-1?"?":"&")+"nocache="+(new Date).getTime()}else{return""}}function r(e){var t=[],i=e.trustedOrigins;if(i){if(!i.length){throw"You must provide an array of domains for trustedOrigins. "+"For example: ['www.example.com', 'staging.example.com']"}t.push("trustedOrigins="+encodeURIComponent(i.join(",")))}return t.join("&")}function a(t){if(e.isReady){e.flashBridge.setText(t)}}function o(t){e.$el.css({top:t.top,left:t.left})}function l(t,i){e.$el.css({width:t,height:i});e.flashBridge.setSize(t,i)}function u(){e.isReady=true;e.flashBridge.setHandCursor(true)}function d(){var t=e.copyable.options.hoverClass;if(t){e.$copyableEl.addClass(t)}}function h(){var t=e.copyable.options.hoverClass;if(t){e.$copyableEl.removeClass(t)}e.unbind()}function c(){var t=e.copyable.getText(e.$copyableEl);a(t)}function f(){e.$copyableEl.trigger("click");e.unbind()}}return{getInstance:function(){if(e===undefined){e=new i;e.initialize();e.constructor=null}return e},init:function(e){$.extend(t,e);window.JClipboard=this.getInstance()}}}();var Copyable=function(e,t){var i=this,s={hoverClass:null,activeClass:null};i.getText=function(e){return i.text(e)};function n(e,t){if(JClipboard.init){throw"You must initialize JClipboard before calling copyable()"}i.$elements=e;i.options=$.extend(true,s,t);i.text=t.text;r()}function r(){i.$elements.on("mouseover",a)}function a(e){var t=$(e.target);JClipboard.bindTo(i,t)}n(e,t)};$.fn["copyable"]=function(e){var t=$(this);new Copyable(t,e)};(function(e,t){var i=0,s=/^ui-id-\d+$/;e.ui=e.ui||{};e.extend(e.ui,{version:"1.10.3",keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38}});e.fn.extend({focus:function(t){return function(i,s){return typeof i==="number"?this.each(function(){var t=this;setTimeout(function(){e(t).focus();if(s){s.call(t)}},i)}):t.apply(this,arguments)}}(e.fn.focus),scrollParent:function(){var t;if(e.ui.ie&&/(static|relative)/.test(this.css("position"))||/absolute/.test(this.css("position"))){t=this.parents().filter(function(){return/(relative|absolute|fixed)/.test(e.css(this,"position"))&&/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0)}else{t=this.parents().filter(function(){return/(auto|scroll)/.test(e.css(this,"overflow")+e.css(this,"overflow-y")+e.css(this,"overflow-x"))}).eq(0)}return/fixed/.test(this.css("position"))||!t.length?e(document):t},zIndex:function(i){if(i!==t){return this.css("zIndex",i)}if(this.length){var s=e(this[0]),n,r;while(s.length&&s[0]!==document){n=s.css("position");if(n==="absolute"||n==="relative"||n==="fixed"){r=parseInt(s.css("zIndex"),10);if(!isNaN(r)&&r!==0){return r}}s=s.parent()}}return 0},uniqueId:function(){return this.each(function(){if(!this.id){this.id="ui-id-"+ ++i}})},removeUniqueId:function(){return this.each(function(){if(s.test(this.id)){e(this).removeAttr("id")}})}});function n(t,i){var s,n,a,o=t.nodeName.toLowerCase();if("area"===o){s=t.parentNode;n=s.name;if(!t.href||!n||s.nodeName.toLowerCase()!=="map"){return false}a=e("img[usemap=#"+n+"]")[0];return!!a&&r(a)}return(/input|select|textarea|button|object/.test(o)?!t.disabled:"a"===o?t.href||i:i)&&r(t)}function r(t){return e.expr.filters.visible(t)&&!e(t).parents().addBack().filter(function(){return e.css(this,"visibility")==="hidden"}).length}e.extend(e.expr[":"],{data:e.expr.createPseudo?e.expr.createPseudo(function(t){return function(i){return!!e.data(i,t)}}):function(t,i,s){return!!e.data(t,s[3])},focusable:function(t){return n(t,!isNaN(e.attr(t,"tabindex")))},tabbable:function(t){var i=e.attr(t,"tabindex"),s=isNaN(i);return(s||i>=0)&&n(t,!s)}});if(!e("<a>").outerWidth(1).jquery){e.each(["Width","Height"],function(i,s){var n=s==="Width"?["Left","Right"]:["Top","Bottom"],r=s.toLowerCase(),a={innerWidth:e.fn.innerWidth,innerHeight:e.fn.innerHeight,outerWidth:e.fn.outerWidth,outerHeight:e.fn.outerHeight};function o(t,i,s,r){e.each(n,function(){i-=parseFloat(e.css(t,"padding"+this))||0;if(s){i-=parseFloat(e.css(t,"border"+this+"Width"))||0}if(r){i-=parseFloat(e.css(t,"margin"+this))||0}});return i}e.fn["inner"+s]=function(i){if(i===t){return a["inner"+s].call(this)}return this.each(function(){e(this).css(r,o(this,i)+"px")})};e.fn["outer"+s]=function(t,i){if(typeof t!=="number"){return a["outer"+s].call(this,t)}return this.each(function(){e(this).css(r,o(this,t,true,i)+"px")})}})}if(!e.fn.addBack){e.fn.addBack=function(e){return this.add(e==null?this.prevObject:this.prevObject.filter(e))}}if(e("<a>").data("a-b","a").removeData("a-b").data("a-b")){e.fn.removeData=function(t){return function(i){if(arguments.length){return t.call(this,e.camelCase(i))}else{return t.call(this)}}}(e.fn.removeData)}e.ui.ie=!!/msie [\w.]+/.exec(navigator.userAgent.toLowerCase());e.support.selectstart="onselectstart"in document.createElement("div");e.fn.extend({disableSelection:function(){return this.bind((e.support.selectstart?"selectstart":"mousedown")+".ui-disableSelection",function(e){
e.preventDefault()})},enableSelection:function(){return this.unbind(".ui-disableSelection")}});e.extend(e.ui,{plugin:{add:function(t,i,s){var n,r=e.ui[t].prototype;for(n in s){r.plugins[n]=r.plugins[n]||[];r.plugins[n].push([i,s[n]])}},call:function(e,t,i){var s,n=e.plugins[t];if(!n||!e.element[0].parentNode||e.element[0].parentNode.nodeType===11){return}for(s=0;s<n.length;s++){if(e.options[n[s][0]]){n[s][1].apply(e.element,i)}}}},hasScroll:function(t,i){if(e(t).css("overflow")==="hidden"){return false}var s=i&&i==="left"?"scrollLeft":"scrollTop",n=false;if(t[s]>0){return true}t[s]=1;n=t[s]>0;t[s]=0;return n}})})(jQuery);(function(e,t){var i=0,s=Array.prototype.slice,n=e.cleanData;e.cleanData=function(t){for(var i=0,s;(s=t[i])!=null;i++){try{e(s).triggerHandler("remove")}catch(r){}}n(t)};e.widget=function(t,i,s){var n,r,a,o,l={},u=t.split(".")[0];t=t.split(".")[1];n=u+"-"+t;if(!s){s=i;i=e.Widget}e.expr[":"][n.toLowerCase()]=function(t){return!!e.data(t,n)};e[u]=e[u]||{};r=e[u][t];a=e[u][t]=function(e,t){if(!this._createWidget){return new a(e,t)}if(arguments.length){this._createWidget(e,t)}};e.extend(a,r,{version:s.version,_proto:e.extend({},s),_childConstructors:[]});o=new i;o.options=e.widget.extend({},o.options);e.each(s,function(t,s){if(!e.isFunction(s)){l[t]=s;return}l[t]=function(){var e=function(){return i.prototype[t].apply(this,arguments)},n=function(e){return i.prototype[t].apply(this,e)};return function(){var t=this._super,i=this._superApply,r;this._super=e;this._superApply=n;r=s.apply(this,arguments);this._super=t;this._superApply=i;return r}}()});a.prototype=e.widget.extend(o,{widgetEventPrefix:r?o.widgetEventPrefix:t},l,{constructor:a,namespace:u,widgetName:t,widgetFullName:n});if(r){e.each(r._childConstructors,function(t,i){var s=i.prototype;e.widget(s.namespace+"."+s.widgetName,a,i._proto)});delete r._childConstructors}else{i._childConstructors.push(a)}e.widget.bridge(t,a)};e.widget.extend=function(i){var n=s.call(arguments,1),r=0,a=n.length,o,l;for(;r<a;r++){for(o in n[r]){l=n[r][o];if(n[r].hasOwnProperty(o)&&l!==t){if(e.isPlainObject(l)){i[o]=e.isPlainObject(i[o])?e.widget.extend({},i[o],l):e.widget.extend({},l)}else{i[o]=l}}}}return i};e.widget.bridge=function(i,n){var r=n.prototype.widgetFullName||i;e.fn[i]=function(a){var o=typeof a==="string",l=s.call(arguments,1),u=this;a=!o&&l.length?e.widget.extend.apply(null,[a].concat(l)):a;if(o){this.each(function(){var s,n=e.data(this,r);if(!n){return e.error("cannot call methods on "+i+" prior to initialization; "+"attempted to call method '"+a+"'")}if(!e.isFunction(n[a])||a.charAt(0)==="_"){return e.error("no such method '"+a+"' for "+i+" widget instance")}s=n[a].apply(n,l);if(s!==n&&s!==t){u=s&&s.jquery?u.pushStack(s.get()):s;return false}})}else{this.each(function(){var t=e.data(this,r);if(t){t.option(a||{})._init()}else{e.data(this,r,new n(a,this))}})}return u}};e.Widget=function(){};e.Widget._childConstructors=[];e.Widget.prototype={widgetName:"widget",widgetEventPrefix:"",defaultElement:"<div>",options:{disabled:false,create:null},_createWidget:function(t,s){s=e(s||this.defaultElement||this)[0];this.element=e(s);this.uuid=i++;this.eventNamespace="."+this.widgetName+this.uuid;this.options=e.widget.extend({},this.options,this._getCreateOptions(),t);this.bindings=e();this.hoverable=e();this.focusable=e();if(s!==this){e.data(s,this.widgetFullName,this);this._on(true,this.element,{remove:function(e){if(e.target===s){this.destroy()}}});this.document=e(s.style?s.ownerDocument:s.document||s);this.window=e(this.document[0].defaultView||this.document[0].parentWindow)}this._create();this._trigger("create",null,this._getCreateEventData());this._init()},_getCreateOptions:e.noop,_getCreateEventData:e.noop,_create:e.noop,_init:e.noop,destroy:function(){this._destroy();this.element.unbind(this.eventNamespace).removeData(this.widgetName).removeData(this.widgetFullName).removeData(e.camelCase(this.widgetFullName));this.widget().unbind(this.eventNamespace).removeAttr("aria-disabled").removeClass(this.widgetFullName+"-disabled "+"ui-state-disabled");this.bindings.unbind(this.eventNamespace);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus")},_destroy:e.noop,widget:function(){return this.element},option:function(i,s){var n=i,r,a,o;if(arguments.length===0){return e.widget.extend({},this.options)}if(typeof i==="string"){n={};r=i.split(".");i=r.shift();if(r.length){a=n[i]=e.widget.extend({},this.options[i]);for(o=0;o<r.length-1;o++){a[r[o]]=a[r[o]]||{};a=a[r[o]]}i=r.pop();if(s===t){return a[i]===t?null:a[i]}a[i]=s}else{if(s===t){return this.options[i]===t?null:this.options[i]}n[i]=s}}this._setOptions(n);return this},_setOptions:function(e){var t;for(t in e){this._setOption(t,e[t])}return this},_setOption:function(e,t){this.options[e]=t;if(e==="disabled"){this.widget().toggleClass(this.widgetFullName+"-disabled ui-state-disabled",!!t).attr("aria-disabled",t);this.hoverable.removeClass("ui-state-hover");this.focusable.removeClass("ui-state-focus")}return this},enable:function(){return this._setOption("disabled",false)},disable:function(){return this._setOption("disabled",true)},_on:function(t,i,s){var n,r=this;if(typeof t!=="boolean"){s=i;i=t;t=false}if(!s){s=i;i=this.element;n=this.widget()}else{i=n=e(i);this.bindings=this.bindings.add(i)}e.each(s,function(s,a){function o(){if(!t&&(r.options.disabled===true||e(this).hasClass("ui-state-disabled"))){return}return(typeof a==="string"?r[a]:a).apply(r,arguments)}if(typeof a!=="string"){o.guid=a.guid=a.guid||o.guid||e.guid++}var l=s.match(/^(\w+)\s*(.*)$/),u=l[1]+r.eventNamespace,d=l[2];if(d){n.delegate(d,u,o)}else{i.bind(u,o)}})},_off:function(e,t){t=(t||"").split(" ").join(this.eventNamespace+" ")+this.eventNamespace;e.unbind(t).undelegate(t)},_delay:function(e,t){function i(){return(typeof e==="string"?s[e]:e).apply(s,arguments)}var s=this;return setTimeout(i,t||0)},_hoverable:function(t){this.hoverable=this.hoverable.add(t);this._on(t,{mouseenter:function(t){e(t.currentTarget).addClass("ui-state-hover")},mouseleave:function(t){e(t.currentTarget).removeClass("ui-state-hover")}})},_focusable:function(t){this.focusable=this.focusable.add(t);this._on(t,{focusin:function(t){e(t.currentTarget).addClass("ui-state-focus")},focusout:function(t){e(t.currentTarget).removeClass("ui-state-focus")}})},_trigger:function(t,i,s){var n,r,a=this.options[t];s=s||{};i=e.Event(i);i.type=(t===this.widgetEventPrefix?t:this.widgetEventPrefix+t).toLowerCase();i.target=this.element[0];r=i.originalEvent;if(r){for(n in r){if(!(n in i)){i[n]=r[n]}}}this.element.trigger(i,s);return!(e.isFunction(a)&&a.apply(this.element[0],[i].concat(s))===false||i.isDefaultPrevented())}};e.each({show:"fadeIn",hide:"fadeOut"},function(t,i){e.Widget.prototype["_"+t]=function(s,n,r){if(typeof n==="string"){n={effect:n}}var a,o=!n?t:n===true||typeof n==="number"?i:n.effect||i;n=n||{};if(typeof n==="number"){n={duration:n}}a=!e.isEmptyObject(n);n.complete=r;if(n.delay){s.delay(n.delay)}if(a&&e.effects&&e.effects.effect[o]){s[t](n)}else if(o!==t&&s[o]){s[o](n.duration,n.easing,r)}else{s.queue(function(i){e(this)[t]();if(r){r.call(s[0])}i()})}}})})(jQuery);(function(e,t){var i=false;e(document).mouseup(function(){i=false});e.widget("ui.mouse",{version:"1.10.3",options:{cancel:"input,textarea,button,select,option",distance:1,delay:0},_mouseInit:function(){var t=this;this.element.bind("mousedown."+this.widgetName,function(e){return t._mouseDown(e)}).bind("click."+this.widgetName,function(i){if(true===e.data(i.target,t.widgetName+".preventClickEvent")){e.removeData(i.target,t.widgetName+".preventClickEvent");i.stopImmediatePropagation();return false}});this.started=false},_mouseDestroy:function(){this.element.unbind("."+this.widgetName);if(this._mouseMoveDelegate){e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate)}},_mouseDown:function(t){if(i){return}this._mouseStarted&&this._mouseUp(t);this._mouseDownEvent=t;var s=this,n=t.which===1,r=typeof this.options.cancel==="string"&&t.target.nodeName?e(t.target).closest(this.options.cancel).length:false;if(!n||r||!this._mouseCapture(t)){return true}this.mouseDelayMet=!this.options.delay;if(!this.mouseDelayMet){this._mouseDelayTimer=setTimeout(function(){s.mouseDelayMet=true},this.options.delay)}if(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)){this._mouseStarted=this._mouseStart(t)!==false;if(!this._mouseStarted){t.preventDefault();return true}}if(true===e.data(t.target,this.widgetName+".preventClickEvent")){e.removeData(t.target,this.widgetName+".preventClickEvent")}this._mouseMoveDelegate=function(e){return s._mouseMove(e)};this._mouseUpDelegate=function(e){return s._mouseUp(e)};e(document).bind("mousemove."+this.widgetName,this._mouseMoveDelegate).bind("mouseup."+this.widgetName,this._mouseUpDelegate);t.preventDefault();i=true;return true},_mouseMove:function(t){if(e.ui.ie&&(!document.documentMode||document.documentMode<9)&&!t.button){return this._mouseUp(t)}if(this._mouseStarted){this._mouseDrag(t);return t.preventDefault()}if(this._mouseDistanceMet(t)&&this._mouseDelayMet(t)){this._mouseStarted=this._mouseStart(this._mouseDownEvent,t)!==false;this._mouseStarted?this._mouseDrag(t):this._mouseUp(t)}return!this._mouseStarted},_mouseUp:function(t){e(document).unbind("mousemove."+this.widgetName,this._mouseMoveDelegate).unbind("mouseup."+this.widgetName,this._mouseUpDelegate);if(this._mouseStarted){this._mouseStarted=false;if(t.target===this._mouseDownEvent.target){e.data(t.target,this.widgetName+".preventClickEvent",true)}this._mouseStop(t)}return false},_mouseDistanceMet:function(e){return Math.max(Math.abs(this._mouseDownEvent.pageX-e.pageX),Math.abs(this._mouseDownEvent.pageY-e.pageY))>=this.options.distance},_mouseDelayMet:function(){return this.mouseDelayMet},_mouseStart:function(){},_mouseDrag:function(){},_mouseStop:function(){},_mouseCapture:function(){return true}})})(jQuery);(function(e,t){function i(e,t,i){return e>t&&e<t+i}function s(e){return/left|right/.test(e.css("float"))||/inline|table-cell/.test(e.css("display"))}e.widget("ui.sortable",e.ui.mouse,{version:"1.10.3",widgetEventPrefix:"sort",ready:false,options:{appendTo:"parent",axis:false,connectWith:false,containment:false,cursor:"auto",cursorAt:false,dropOnEmpty:true,forcePlaceholderSize:false,forceHelperSize:false,grid:false,handle:false,helper:"original",items:"> *",opacity:false,placeholder:false,revert:false,scroll:true,scrollSensitivity:20,scrollSpeed:20,scope:"default",tolerance:"intersect",zIndex:1e3,activate:null,beforeStop:null,change:null,deactivate:null,out:null,over:null,receive:null,remove:null,sort:null,start:null,stop:null,update:null},_create:function(){var e=this.options;this.containerCache={};this.element.addClass("ui-sortable");this.refresh();this.floating=this.items.length?e.axis==="x"||s(this.items[0].item):false;this.offset=this.element.offset();this._mouseInit();this.ready=true},_destroy:function(){this.element.removeClass("ui-sortable ui-sortable-disabled");this._mouseDestroy();for(var e=this.items.length-1;e>=0;e--){this.items[e].item.removeData(this.widgetName+"-item")}return this},_setOption:function(t,i){if(t==="disabled"){this.options[t]=i;this.widget().toggleClass("ui-sortable-disabled",!!i)}else{e.Widget.prototype._setOption.apply(this,arguments)}},_mouseCapture:function(t,i){var s=null,n=false,r=this;if(this.reverting){return false}if(this.options.disabled||this.options.type==="static"){return false}this._refreshItems(t);e(t.target).parents().each(function(){if(e.data(this,r.widgetName+"-item")===r){s=e(this);return false}});if(e.data(t.target,r.widgetName+"-item")===r){s=e(t.target)}if(!s){return false}if(this.options.handle&&!i){e(this.options.handle,s).find("*").addBack().each(function(){if(this===t.target){n=true}});if(!n){return false}}this.currentItem=s;this._removeCurrentsFromItems();return true},_mouseStart:function(t,i,s){var n,r,a=this.options;this.currentContainer=this;this.refreshPositions();this.helper=this._createHelper(t);this._cacheHelperProportions();this._cacheMargins();this.scrollParent=this.helper.scrollParent();this.offset=this.currentItem.offset();this.offset={top:this.offset.top-this.margins.top,left:this.offset.left-this.margins.left};e.extend(this.offset,{click:{left:t.pageX-this.offset.left,top:t.pageY-this.offset.top},parent:this._getParentOffset(),relative:this._getRelativeOffset()});this.helper.css("position","absolute");this.cssPosition=this.helper.css("position");this.originalPosition=this._generatePosition(t);this.originalPageX=t.pageX;this.originalPageY=t.pageY;a.cursorAt&&this._adjustOffsetFromHelper(a.cursorAt);this.domPosition={prev:this.currentItem.prev()[0],parent:this.currentItem.parent()[0]};if(this.helper[0]!==this.currentItem[0]){this.currentItem.hide()}this._createPlaceholder();if(a.containment){this._setContainment()}if(a.cursor&&a.cursor!=="auto"){r=this.document.find("body");this.storedCursor=r.css("cursor");r.css("cursor",a.cursor);this.storedStylesheet=e("<style>*{ cursor: "+a.cursor+" !important; }</style>").appendTo(r)}if(a.opacity){if(this.helper.css("opacity")){this._storedOpacity=this.helper.css("opacity")}this.helper.css("opacity",a.opacity)}if(a.zIndex){if(this.helper.css("zIndex")){this._storedZIndex=this.helper.css("zIndex")}this.helper.css("zIndex",a.zIndex)}if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){this.overflowOffset=this.scrollParent.offset()}this._trigger("start",t,this._uiHash());if(!this._preserveHelperProportions){this._cacheHelperProportions()}if(!s){for(n=this.containers.length-1;n>=0;n--){this.containers[n]._trigger("activate",t,this._uiHash(this))}}if(e.ui.ddmanager){e.ui.ddmanager.current=this}if(e.ui.ddmanager&&!a.dropBehaviour){e.ui.ddmanager.prepareOffsets(this,t)}this.dragging=true;this.helper.addClass("ui-sortable-helper");this._mouseDrag(t);return true},_mouseDrag:function(t){var i,s,n,r,a=this.options,o=false;this.position=this._generatePosition(t);this.positionAbs=this._convertPositionTo("absolute");if(!this.lastPositionAbs){this.lastPositionAbs=this.positionAbs}if(this.options.scroll){if(this.scrollParent[0]!==document&&this.scrollParent[0].tagName!=="HTML"){if(this.overflowOffset.top+this.scrollParent[0].offsetHeight-t.pageY<a.scrollSensitivity){this.scrollParent[0].scrollTop=o=this.scrollParent[0].scrollTop+a.scrollSpeed}else if(t.pageY-this.overflowOffset.top<a.scrollSensitivity){this.scrollParent[0].scrollTop=o=this.scrollParent[0].scrollTop-a.scrollSpeed}if(this.overflowOffset.left+this.scrollParent[0].offsetWidth-t.pageX<a.scrollSensitivity){this.scrollParent[0].scrollLeft=o=this.scrollParent[0].scrollLeft+a.scrollSpeed}else if(t.pageX-this.overflowOffset.left<a.scrollSensitivity){this.scrollParent[0].scrollLeft=o=this.scrollParent[0].scrollLeft-a.scrollSpeed}}else{if(t.pageY-e(document).scrollTop()<a.scrollSensitivity){o=e(document).scrollTop(e(document).scrollTop()-a.scrollSpeed)}else if(e(window).height()-(t.pageY-e(document).scrollTop())<a.scrollSensitivity){o=e(document).scrollTop(e(document).scrollTop()+a.scrollSpeed)}if(t.pageX-e(document).scrollLeft()<a.scrollSensitivity){o=e(document).scrollLeft(e(document).scrollLeft()-a.scrollSpeed)}else if(e(window).width()-(t.pageX-e(document).scrollLeft())<a.scrollSensitivity){o=e(document).scrollLeft(e(document).scrollLeft()+a.scrollSpeed)}}if(o!==false&&e.ui.ddmanager&&!a.dropBehaviour){e.ui.ddmanager.prepareOffsets(this,t)}}this.positionAbs=this._convertPositionTo("absolute");if(!this.options.axis||this.options.axis!=="y"){this.helper[0].style.left=this.position.left+"px"}if(!this.options.axis||this.options.axis!=="x"){this.helper[0].style.top=this.position.top+"px"}for(i=this.items.length-1;i>=0;i--){s=this.items[i];n=s.item[0];r=this._intersectsWithPointer(s);if(!r){continue}if(s.instance!==this.currentContainer){continue}if(n!==this.currentItem[0]&&this.placeholder[r===1?"next":"prev"]()[0]!==n&&!e.contains(this.placeholder[0],n)&&(this.options.type==="semi-dynamic"?!e.contains(this.element[0],n):true)){this.direction=r===1?"down":"up";if(this.options.tolerance==="pointer"||this._intersectsWithSides(s)){this._rearrange(t,s)}else{break}this._trigger("change",t,this._uiHash());break}}this._contactContainers(t);if(e.ui.ddmanager){e.ui.ddmanager.drag(this,t)}this._trigger("sort",t,this._uiHash());this.lastPositionAbs=this.positionAbs;return false},_mouseStop:function(t,i){if(!t){return}if(e.ui.ddmanager&&!this.options.dropBehaviour){e.ui.ddmanager.drop(this,t)}if(this.options.revert){var s=this,n=this.placeholder.offset(),r=this.options.axis,a={};if(!r||r==="x"){a.left=n.left-this.offset.parent.left-this.margins.left+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollLeft)}if(!r||r==="y"){a.top=n.top-this.offset.parent.top-this.margins.top+(this.offsetParent[0]===document.body?0:this.offsetParent[0].scrollTop)}this.reverting=true;e(this.helper).animate(a,parseInt(this.options.revert,10)||500,function(){s._clear(t)})}else{this._clear(t,i)}return false},cancel:function(){if(this.dragging){this._mouseUp({target:null});if(this.options.helper==="original"){this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}for(var t=this.containers.length-1;t>=0;t--){this.containers[t]._trigger("deactivate",null,this._uiHash(this));if(this.containers[t].containerCache.over){this.containers[t]._trigger("out",null,this._uiHash(this));this.containers[t].containerCache.over=0}}}if(this.placeholder){if(this.placeholder[0].parentNode){this.placeholder[0].parentNode.removeChild(this.placeholder[0])}if(this.options.helper!=="original"&&this.helper&&this.helper[0].parentNode){this.helper.remove()}e.extend(this,{helper:null,dragging:false,reverting:false,_noFinalSort:null});if(this.domPosition.prev){e(this.domPosition.prev).after(this.currentItem)}else{e(this.domPosition.parent).prepend(this.currentItem)}}return this},serialize:function(t){var i=this._getItemsAsjQuery(t&&t.connected),s=[];t=t||{};e(i).each(function(){var i=(e(t.item||this).attr(t.attribute||"id")||"").match(t.expression||/(.+)[\-=_](.+)/);if(i){s.push((t.key||i[1]+"[]")+"="+(t.key&&t.expression?i[1]:i[2]))}});if(!s.length&&t.key){s.push(t.key+"=")}return s.join("&")},toArray:function(t){var i=this._getItemsAsjQuery(t&&t.connected),s=[];t=t||{};i.each(function(){s.push(e(t.item||this).attr(t.attribute||"id")||"")});return s},_intersectsWith:function(e){var t=this.positionAbs.left,i=t+this.helperProportions.width,s=this.positionAbs.top,n=s+this.helperProportions.height,r=e.left,a=r+e.width,o=e.top,l=o+e.height,u=this.offset.click.top,d=this.offset.click.left,h=this.options.axis==="x"||s+u>o&&s+u<l,c=this.options.axis==="y"||t+d>r&&t+d<a,f=h&&c;if(this.options.tolerance==="pointer"||this.options.forcePointerForContainers||this.options.tolerance!=="pointer"&&this.helperProportions[this.floating?"width":"height"]>e[this.floating?"width":"height"]){return f}else{return r<t+this.helperProportions.width/2&&i-this.helperProportions.width/2<a&&o<s+this.helperProportions.height/2&&n-this.helperProportions.height/2<l}},_intersectsWithPointer:function(e){var t=this.options.axis==="x"||i(this.positionAbs.top+this.offset.click.top,e.top,e.height),s=this.options.axis==="y"||i(this.positionAbs.left+this.offset.click.left,e.left,e.width),n=t&&s,r=this._getDragVerticalDirection(),a=this._getDragHorizontalDirection();if(!n){return false}return this.floating?a&&a==="right"||r==="down"?2:1:r&&(r==="down"?2:1)},_intersectsWithSides:function(e){var t=i(this.positionAbs.top+this.offset.click.top,e.top+e.height/2,e.height),s=i(this.positionAbs.left+this.offset.click.left,e.left+e.width/2,e.width),n=this._getDragVerticalDirection(),r=this._getDragHorizontalDirection();if(this.floating&&r){return r==="right"&&s||r==="left"&&!s}else{return n&&(n==="down"&&t||n==="up"&&!t)}},_getDragVerticalDirection:function(){var e=this.positionAbs.top-this.lastPositionAbs.top;return e!==0&&(e>0?"down":"up")},_getDragHorizontalDirection:function(){var e=this.positionAbs.left-this.lastPositionAbs.left;return e!==0&&(e>0?"right":"left")},refresh:function(e){this._refreshItems(e);this.refreshPositions();return this},_connectWith:function(){var e=this.options;return e.connectWith.constructor===String?[e.connectWith]:e.connectWith},_getItemsAsjQuery:function(t){var i,s,n,r,a=[],o=[],l=this._connectWith();if(l&&t){for(i=l.length-1;i>=0;i--){n=e(l[i]);for(s=n.length-1;s>=0;s--){r=e.data(n[s],this.widgetFullName);if(r&&r!==this&&!r.options.disabled){o.push([e.isFunction(r.options.items)?r.options.items.call(r.element):e(r.options.items,r.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),r])}}}}o.push([e.isFunction(this.options.items)?this.options.items.call(this.element,null,{options:this.options,item:this.currentItem}):e(this.options.items,this.element).not(".ui-sortable-helper").not(".ui-sortable-placeholder"),this]);for(i=o.length-1;i>=0;i--){o[i][0].each(function(){a.push(this)})}return e(a)},_removeCurrentsFromItems:function(){var t=this.currentItem.find(":data("+this.widgetName+"-item)");this.items=e.grep(this.items,function(e){for(var i=0;i<t.length;i++){if(t[i]===e.item[0]){return false}}return true})},_refreshItems:function(t){this.items=[];this.containers=[this];var i,s,n,r,a,o,l,u,d=this.items,h=[[e.isFunction(this.options.items)?this.options.items.call(this.element[0],t,{item:this.currentItem}):e(this.options.items,this.element),this]],c=this._connectWith();if(c&&this.ready){for(i=c.length-1;i>=0;i--){n=e(c[i]);for(s=n.length-1;s>=0;s--){r=e.data(n[s],this.widgetFullName);if(r&&r!==this&&!r.options.disabled){h.push([e.isFunction(r.options.items)?r.options.items.call(r.element[0],t,{item:this.currentItem}):e(r.options.items,r.element),r]);this.containers.push(r)}}}}for(i=h.length-1;i>=0;i--){a=h[i][1];o=h[i][0];for(s=0,u=o.length;s<u;s++){l=e(o[s]);l.data(this.widgetName+"-item",a);d.push({item:l,instance:a,width:0,height:0,left:0,top:0})}}},refreshPositions:function(t){if(this.offsetParent&&this.helper){this.offset.parent=this._getParentOffset()}var i,s,n,r;for(i=this.items.length-1;i>=0;i--){s=this.items[i];if(s.instance!==this.currentContainer&&this.currentContainer&&s.item[0]!==this.currentItem[0]){continue}n=this.options.toleranceElement?e(this.options.toleranceElement,s.item):s.item;if(!t){s.width=n.outerWidth();s.height=n.outerHeight()}r=n.offset();s.left=r.left;s.top=r.top}if(this.options.custom&&this.options.custom.refreshContainers){this.options.custom.refreshContainers.call(this)}else{for(i=this.containers.length-1;i>=0;i--){r=this.containers[i].element.offset();this.containers[i].containerCache.left=r.left;this.containers[i].containerCache.top=r.top;this.containers[i].containerCache.width=this.containers[i].element.outerWidth();this.containers[i].containerCache.height=this.containers[i].element.outerHeight()}}return this},_createPlaceholder:function(t){t=t||this;var i,s=t.options;if(!s.placeholder||s.placeholder.constructor===String){i=s.placeholder;s.placeholder={element:function(){var s=t.currentItem[0].nodeName.toLowerCase(),n=e("<"+s+">",t.document[0]).addClass(i||t.currentItem[0].className+" ui-sortable-placeholder").removeClass("ui-sortable-helper");if(s==="tr"){t.currentItem.children().each(function(){e("<td>&#160;</td>",t.document[0]).attr("colspan",e(this).attr("colspan")||1).appendTo(n)})}else if(s==="img"){n.attr("src",t.currentItem.attr("src"))}if(!i){n.css("visibility","hidden")}return n},update:function(e,n){if(i&&!s.forcePlaceholderSize){return}if(!n.height()){n.height(t.currentItem.innerHeight()-parseInt(t.currentItem.css("paddingTop")||0,10)-parseInt(t.currentItem.css("paddingBottom")||0,10))}if(!n.width()){n.width(t.currentItem.innerWidth()-parseInt(t.currentItem.css("paddingLeft")||0,10)-parseInt(t.currentItem.css("paddingRight")||0,10))}}}}t.placeholder=e(s.placeholder.element.call(t.element,t.currentItem));t.currentItem.after(t.placeholder);s.placeholder.update(t,t.placeholder)},_contactContainers:function(t){var n,r,a,o,l,u,d,h,c,f,_=null,p=null;for(n=this.containers.length-1;n>=0;n--){if(e.contains(this.currentItem[0],this.containers[n].element[0])){continue}if(this._intersectsWith(this.containers[n].containerCache)){if(_&&e.contains(this.containers[n].element[0],_.element[0])){continue}_=this.containers[n];p=n}else{if(this.containers[n].containerCache.over){this.containers[n]._trigger("out",t,this._uiHash(this));this.containers[n].containerCache.over=0}}}if(!_){return}if(this.containers.length===1){if(!this.containers[p].containerCache.over){this.containers[p]._trigger("over",t,this._uiHash(this));this.containers[p].containerCache.over=1}}else{a=1e4;o=null;f=_.floating||s(this.currentItem);l=f?"left":"top";u=f?"width":"height";d=this.positionAbs[l]+this.offset.click[l];for(r=this.items.length-1;r>=0;r--){if(!e.contains(this.containers[p].element[0],this.items[r].item[0])){continue}if(this.items[r].item[0]===this.currentItem[0]){continue}if(f&&!i(this.positionAbs.top+this.offset.click.top,this.items[r].top,this.items[r].height)){continue}h=this.items[r].item.offset()[l];c=false;if(Math.abs(h-d)>Math.abs(h+this.items[r][u]-d)){c=true;h+=this.items[r][u]}if(Math.abs(h-d)<a){a=Math.abs(h-d);o=this.items[r];this.direction=c?"up":"down"}}if(!o&&!this.options.dropOnEmpty){return}if(this.currentContainer===this.containers[p]){return}o?this._rearrange(t,o,null,true):this._rearrange(t,null,this.containers[p].element,true);this._trigger("change",t,this._uiHash());this.containers[p]._trigger("change",t,this._uiHash(this));this.currentContainer=this.containers[p];this.options.placeholder.update(this.currentContainer,this.placeholder);this.containers[p]._trigger("over",t,this._uiHash(this));this.containers[p].containerCache.over=1}},_createHelper:function(t){var i=this.options,s=e.isFunction(i.helper)?e(i.helper.apply(this.element[0],[t,this.currentItem])):i.helper==="clone"?this.currentItem.clone():this.currentItem;if(!s.parents("body").length){e(i.appendTo!=="parent"?i.appendTo:this.currentItem[0].parentNode)[0].appendChild(s[0])}if(s[0]===this.currentItem[0]){this._storedCSS={width:this.currentItem[0].style.width,height:this.currentItem[0].style.height,position:this.currentItem.css("position"),top:this.currentItem.css("top"),left:this.currentItem.css("left")}}if(!s[0].style.width||i.forceHelperSize){s.width(this.currentItem.width())}if(!s[0].style.height||i.forceHelperSize){s.height(this.currentItem.height())}return s},_adjustOffsetFromHelper:function(t){if(typeof t==="string"){t=t.split(" ")}if(e.isArray(t)){t={left:+t[0],top:+t[1]||0}}if("left"in t){this.offset.click.left=t.left+this.margins.left}if("right"in t){this.offset.click.left=this.helperProportions.width-t.right+this.margins.left}if("top"in t){this.offset.click.top=t.top+this.margins.top}if("bottom"in t){this.offset.click.top=this.helperProportions.height-t.bottom+this.margins.top}},_getParentOffset:function(){this.offsetParent=this.helper.offsetParent();var t=this.offsetParent.offset();if(this.cssPosition==="absolute"&&this.scrollParent[0]!==document&&e.contains(this.scrollParent[0],this.offsetParent[0])){t.left+=this.scrollParent.scrollLeft();t.top+=this.scrollParent.scrollTop()}if(this.offsetParent[0]===document.body||this.offsetParent[0].tagName&&this.offsetParent[0].tagName.toLowerCase()==="html"&&e.ui.ie){t={top:0,left:0}}return{top:t.top+(parseInt(this.offsetParent.css("borderTopWidth"),10)||0),left:t.left+(parseInt(this.offsetParent.css("borderLeftWidth"),10)||0)}},_getRelativeOffset:function(){if(this.cssPosition==="relative"){var e=this.currentItem.position();return{top:e.top-(parseInt(this.helper.css("top"),10)||0)+this.scrollParent.scrollTop(),left:e.left-(parseInt(this.helper.css("left"),10)||0)+this.scrollParent.scrollLeft()}}else{return{top:0,left:0}}},_cacheMargins:function(){this.margins={left:parseInt(this.currentItem.css("marginLeft"),10)||0,top:parseInt(this.currentItem.css("marginTop"),10)||0}},_cacheHelperProportions:function(){this.helperProportions={width:this.helper.outerWidth(),height:this.helper.outerHeight()}},_setContainment:function(){var t,i,s,n=this.options;if(n.containment==="parent"){n.containment=this.helper[0].parentNode}if(n.containment==="document"||n.containment==="window"){this.containment=[0-this.offset.relative.left-this.offset.parent.left,0-this.offset.relative.top-this.offset.parent.top,e(n.containment==="document"?document:window).width()-this.helperProportions.width-this.margins.left,(e(n.containment==="document"?document:window).height()||document.body.parentNode.scrollHeight)-this.helperProportions.height-this.margins.top]}if(!/^(document|window|parent)$/.test(n.containment)){t=e(n.containment)[0];i=e(n.containment).offset();s=e(t).css("overflow")!=="hidden";this.containment=[i.left+(parseInt(e(t).css("borderLeftWidth"),10)||0)+(parseInt(e(t).css("paddingLeft"),10)||0)-this.margins.left,i.top+(parseInt(e(t).css("borderTopWidth"),10)||0)+(parseInt(e(t).css("paddingTop"),10)||0)-this.margins.top,i.left+(s?Math.max(t.scrollWidth,t.offsetWidth):t.offsetWidth)-(parseInt(e(t).css("borderLeftWidth"),10)||0)-(parseInt(e(t).css("paddingRight"),10)||0)-this.helperProportions.width-this.margins.left,i.top+(s?Math.max(t.scrollHeight,t.offsetHeight):t.offsetHeight)-(parseInt(e(t).css("borderTopWidth"),10)||0)-(parseInt(e(t).css("paddingBottom"),10)||0)-this.helperProportions.height-this.margins.top]}},_convertPositionTo:function(t,i){if(!i){i=this.position}var s=t==="absolute"?1:-1,n=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==document&&e.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,r=/(html|body)/i.test(n[0].tagName);return{top:i.top+this.offset.relative.top*s+this.offset.parent.top*s-(this.cssPosition==="fixed"?-this.scrollParent.scrollTop():r?0:n.scrollTop())*s,left:i.left+this.offset.relative.left*s+this.offset.parent.left*s-(this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():r?0:n.scrollLeft())*s}},_generatePosition:function(t){var i,s,n=this.options,r=t.pageX,a=t.pageY,o=this.cssPosition==="absolute"&&!(this.scrollParent[0]!==document&&e.contains(this.scrollParent[0],this.offsetParent[0]))?this.offsetParent:this.scrollParent,l=/(html|body)/i.test(o[0].tagName);if(this.cssPosition==="relative"&&!(this.scrollParent[0]!==document&&this.scrollParent[0]!==this.offsetParent[0])){this.offset.relative=this._getRelativeOffset()}if(this.originalPosition){if(this.containment){if(t.pageX-this.offset.click.left<this.containment[0]){r=this.containment[0]+this.offset.click.left}if(t.pageY-this.offset.click.top<this.containment[1]){a=this.containment[1]+this.offset.click.top}if(t.pageX-this.offset.click.left>this.containment[2]){r=this.containment[2]+this.offset.click.left}if(t.pageY-this.offset.click.top>this.containment[3]){a=this.containment[3]+this.offset.click.top}}if(n.grid){i=this.originalPageY+Math.round((a-this.originalPageY)/n.grid[1])*n.grid[1];a=this.containment?i-this.offset.click.top>=this.containment[1]&&i-this.offset.click.top<=this.containment[3]?i:i-this.offset.click.top>=this.containment[1]?i-n.grid[1]:i+n.grid[1]:i;s=this.originalPageX+Math.round((r-this.originalPageX)/n.grid[0])*n.grid[0];r=this.containment?s-this.offset.click.left>=this.containment[0]&&s-this.offset.click.left<=this.containment[2]?s:s-this.offset.click.left>=this.containment[0]?s-n.grid[0]:s+n.grid[0]:s}}return{top:a-this.offset.click.top-this.offset.relative.top-this.offset.parent.top+(this.cssPosition==="fixed"?-this.scrollParent.scrollTop():l?0:o.scrollTop()),left:r-this.offset.click.left-this.offset.relative.left-this.offset.parent.left+(this.cssPosition==="fixed"?-this.scrollParent.scrollLeft():l?0:o.scrollLeft())}},_rearrange:function(e,t,i,s){i?i[0].appendChild(this.placeholder[0]):t.item[0].parentNode.insertBefore(this.placeholder[0],this.direction==="down"?t.item[0]:t.item[0].nextSibling);this.counter=this.counter?++this.counter:1;var n=this.counter;this._delay(function(){
if(n===this.counter){this.refreshPositions(!s)}})},_clear:function(e,t){this.reverting=false;var i,s=[];if(!this._noFinalSort&&this.currentItem.parent().length){this.placeholder.before(this.currentItem)}this._noFinalSort=null;if(this.helper[0]===this.currentItem[0]){for(i in this._storedCSS){if(this._storedCSS[i]==="auto"||this._storedCSS[i]==="static"){this._storedCSS[i]=""}}this.currentItem.css(this._storedCSS).removeClass("ui-sortable-helper")}else{this.currentItem.show()}if(this.fromOutside&&!t){s.push(function(e){this._trigger("receive",e,this._uiHash(this.fromOutside))})}if((this.fromOutside||this.domPosition.prev!==this.currentItem.prev().not(".ui-sortable-helper")[0]||this.domPosition.parent!==this.currentItem.parent()[0])&&!t){s.push(function(e){this._trigger("update",e,this._uiHash())})}if(this!==this.currentContainer){if(!t){s.push(function(e){this._trigger("remove",e,this._uiHash())});s.push(function(e){return function(t){e._trigger("receive",t,this._uiHash(this))}}.call(this,this.currentContainer));s.push(function(e){return function(t){e._trigger("update",t,this._uiHash(this))}}.call(this,this.currentContainer))}}for(i=this.containers.length-1;i>=0;i--){if(!t){s.push(function(e){return function(t){e._trigger("deactivate",t,this._uiHash(this))}}.call(this,this.containers[i]))}if(this.containers[i].containerCache.over){s.push(function(e){return function(t){e._trigger("out",t,this._uiHash(this))}}.call(this,this.containers[i]));this.containers[i].containerCache.over=0}}if(this.storedCursor){this.document.find("body").css("cursor",this.storedCursor);this.storedStylesheet.remove()}if(this._storedOpacity){this.helper.css("opacity",this._storedOpacity)}if(this._storedZIndex){this.helper.css("zIndex",this._storedZIndex==="auto"?"":this._storedZIndex)}this.dragging=false;if(this.cancelHelperRemoval){if(!t){this._trigger("beforeStop",e,this._uiHash());for(i=0;i<s.length;i++){s[i].call(this,e)}this._trigger("stop",e,this._uiHash())}this.fromOutside=false;return false}if(!t){this._trigger("beforeStop",e,this._uiHash())}this.placeholder[0].parentNode.removeChild(this.placeholder[0]);if(this.helper[0]!==this.currentItem[0]){this.helper.remove()}this.helper=null;if(!t){for(i=0;i<s.length;i++){s[i].call(this,e)}this._trigger("stop",e,this._uiHash())}this.fromOutside=false;return true},_trigger:function(){if(e.Widget.prototype._trigger.apply(this,arguments)===false){this.cancel()}},_uiHash:function(t){var i=t||this;return{helper:i.helper,placeholder:i.placeholder||e([]),position:i.position,originalPosition:i.originalPosition,offset:i.positionAbs,item:i.currentItem,sender:t?t.element:null}}})})(jQuery);SM.Model={__create:function(e){},__validators:undefined,__setters:undefined,__getters:undefined,__counter:0,__defaults:undefined,__initSettings:function(e){var t,i;this.__settings={};if(e){i={};for(t in this.__defaults){if(this.__defaults.hasOwnProperty(t)&&e.hasOwnProperty(t)){i[t]=e[t]}}this.__settings=SM.Object.extend(this.__defaults,i)}else if(this.__defaults){this.__settings=SM.Object.copy(this.__defaults)}},get:function(e,t){var i=this.__getters;if(e===undefined){return}if(i&&i[e]){return i[e](this,t)}else{return this[e]}},set:function(e,t,i){var s=this.__setters,n=this[e],r={notify:false,validate:false},a;if(i){a=SM.Object.extend(r,i)}else{a=r}if(a.validate&&!this.validate(e,t)){return this}if(s&&s[e]){s[e](this,t,a)}else{this[e]=t}if(a.notify){if(t!==n){this._trigger({type:e+".changed",property:e,old:n,value:t})}this._trigger({type:e+".set",property:e,old:n,value:t})}return this},on:function(e,t,i){if(arguments.length<3){throw new Error("model.bind requires three arguments")}else if(!e||!t||!i){throw new Error("model.bind must be passed an event, data, and callback")}this._$.on(e,t,i);return this},off:function(e,t){this._$.off(e,t)},validateKeyValue:function(e,t){var i=this.__validators[e]?this.__validators[e](this,t):{isValid:true};if(!i.isValid){i.property=e;i.value=t;return i}return{isValid:true}},validateGroup:function(e){var t,i,s={isValid:true,invalids:{}};for(t in e){if(!e.hasOwnProperty(t)){continue}i=this.validateKeyValue(t,e[t]);if(!i.isValid){s.isValid=false;s.invalids[t]=i}}return s},validate:function(){var e=this,t=this.__validators,i,s,n,r;if(t){if(arguments.length===0){i=this.validateGroup(this._getValidatables())}else if(arguments.length===1){if(typeof arguments[0]==="string"){s={};r=arguments[0];n=this.state[r];s[r]=n;i=this.validateGroup(s)}else if(typeof arguments[0]==="object"){i=this.validateGroup(arguments[0])}}else if(arguments.length===2){s={};r=arguments[0];n=arguments[1];s[r]=n;i=this.validateGroup(s)}}else{i=this.validateGroup({})}if(!i.isValid){this._trigger({type:"validated",validations:i})}return i},_trigger:function(e){var t={};try{if(e===null||e===undefined){throw new Error("model._trigger: triggering a null or undefined event")}if(typeof e==="string"){t.type=e}else{if(e.type===null||e.type===undefined){throw new Error("model._trigger: triggering a null or undefined event")}t=e}this._$.trigger(t)}catch(i){SM.Error.log(i,"Error model triggering "+t.type)}return this},_getValidatables:function(){var e,t={},i=this.__validators;for(e in i){t[e]=this.get(e)}return t}};SM.Models={_models:{},_types:{},create:function(e,t){var i,s,n;if(e===undefined){throw new Error("a model name is required to create an instance")}s=e+"Model";n=SM[s];if(n===undefined){throw new Error("attempted to create an unregistered model name: "+s)}return this._create(n,t)},register:function(e,t){var i;if(arguments.length!==2){throw new Error("a string model name and model prototype is required to register a model")}if(e===undefined||typeof e!=="string"){throw new Error("a string model name is required to register a model")}i=e+"Model";if(SM[i]!==undefined){throw new Error("a model of this type has already been registered")}SM[i]=SM.Object.extend(SM.Model,t);SM[i].__counter=0;SM[i].__NAME=e;return SM[i]},extend:function(e,t,i){var s=SM.Object.deepExtend(t,i);return this.register(e,s)},_create:function(e,t){var i=SM.Object.create(e);i._$=$({});i.__initSettings(t);i.__uid=e.__counter++;t=t||{};i.__create(t);return i}};SM.log=function(e){if(SM.DEBUG){if(window.console){if(console&&console.log&&console.log.apply){console.log.apply(console,arguments)}else if(console&&console.log){Function.apply.apply(console.log,[null,arguments])}}}};SM.Date={getDaysInMonth:function(e,t){var i=this;return 32-new Date(t,e,32).getDate()},getSimpleDate:function(e){if(!e){return{}}return{month:e.getMonth(),year:e.getFullYear(),day:e.getDate()}},timestamp:function(){return(new Date).getTime()},toISOString:function(e){var t=function(e){return e<10?"0"+e:e};if(!Date.prototype.toISOString){return[this.getUTCFullYear(),"-",t(this.getUTCMonth()+1),"-",t(this.getUTCDate()),"T",t(this.getUTCHours()),":",t(this.getUTCMinutes()),":",t(this.getUTCSeconds()),"Z"].join("")}else{return e.toISOString()}},stdTimezoneOffset:function(){var e=new Date,t=e.getFullYear(),i=new Date(t,0,1),s=new Date(t,6,1);return Math.max(i.getTimezoneOffset(),s.getTimezoneOffset())},utcOffset:function(){return(new Date).getTimezoneOffset()*-6e4},toAge:function(e){var t,i,s,n,r,a,o,l;r=Math.floor(e/1e3);t=r%60;a=Math.floor(r/60);i=a%60;o=Math.floor(a/60);s=o%24;l=Math.floor(o/24);n=l%365;return{seconds:t,minutes:i,hours:s,days:n}},ageToMilliseconds:function(e){var t=e.split(" "),i,s=0,n,r,a,o=0;for(;s<t.length;s++){n=t[s];r=parseInt(n,10),a=n.charAt(n.length-1);a=this._millisecondMap[a];if(a){o+=r*a}}return o},formatDigitalTime:function(e,t,i){var s="";s=this._addDigitalTimeString(s,e)+":";s=this._addDigitalTimeString(s,t)+":";return this._addDigitalTimeString(s,i)},_millisecondMap:{s:1e3,m:1e3*60,h:1e3*60*60,d:1e3*60*60*24,o:1e3*60*60*24*30,y:1e3*60*60*24*365},_addDigitalTimeString:function(e,t){if(t>9){e=e+t}else if(t>0){e=e+"0"+t}else{e=e+"00"}return e}};(function(){var e;jQuery.event.special.leave={add:function(t){var i=t.handler,s=this,n=this;if(!e){e=$(document)}t.handler=function(e){if(e.type===SM.Event.FOCUSIN){if(!SM.DOM.contains(n,e.target)&&e.target.tagName.toLowerCase()!=="body"){i.apply(this,arguments)}}if(e.type===SM.Event.CLICK){if(!SM.DOM.contains(n,e.target)){i.apply(this,arguments)}}};setTimeout(function(){e.on(SM.Event.FOCUSIN+"."+t.guid,t.data,t.handler).on(SM.Event.CLICK+"."+t.guid,t.data,t.handler)},0)},remove:function(t){e.off(SM.Event.FOCUSIN+"."+t.guid).off(SM.Event.CLICK+"."+t.guid)}}})();SM.Cookies={get:function(e){var t=this.getAll();return t[e]},set:function(e,t,i,s){var n,r;s=SM.Object.extend({path:"/"},s);if(typeof i==="string"){r=SM.Date.ageToMilliseconds(i)}else{r=i}n=new Date;n.setTime(n.getTime()+r);i=n.toGMTString();document.cookie=[e+"="+t,"expires="+i,"path="+s.path].join("; ");return this},remove:function(e,t){t=SM.Object.extend({path:"/"},t);return this.set(e,"","-1s",t)},getAll:function(){var e={},t,i=document.cookie.split(";");$.each(i,function(i,s){s=$.trim(s);t=s.split("=");if(t.length===2){e[t[0]]=t[1]}});return e}};(function(e){function t(e){var t=e.split("."),i=t.length,s=0,n=t[i-2],r=[],a;if(i>2){for(;s<i-2;s++){a=t[s];r.push(a)}}return[].concat(n).concat(r)}Uri.prototype.getDomains=function(){this.uriParts.domains=this.uriParts.domains||t(this.uriParts.host);return this.uriParts.domains};Uri.prototype.getRootDomain=function(){var e=this.getDomains();return e[0]};Uri.prototype.getSubDomains=function(){var e=this.getDomains();return e.slice(1,e.length)}})(this);SM.BaseMenu={__NAME:"menu",__defaults:{position:{my:"left top",at:"left bottom",offset:"0 -1"},parentEl:document.body},__init:function(){var e=this;if(this.__settings.menuView){this._menuView=this.__settings.menuView}this.bind("click",this._onClick).bind("keydown",this._onKeydown)},__onClick:function(e){e.preventDefault();if(this._isOpen){this.close()}else{this.open()}},__onClosedKeydown:function(e){var t=e.which;if(t===SM.KeyCodes.ENTER){e.preventDefault();e.stopPropagation();this.$el.click()}},__onWindowResize:function(e){this.position()},__onMenuInit:function(){},__onBeforeMenuOpen:function(){$(window).on(SM.Event.RESIZE+"."+this.__NAME+this.__uid,{self:this},this._onResize);this.subscribe(SM.Event.FOCUSIN,this._onDocumentFocusin).subscribe(SM.Event.CLICK,this._onDocumentClick).subscribe(SM.Event.KEYDOWN,this._onDocumentKeydown)},__onMenuAddedToPage:function(){},__onAfterMenuOpen:function(){},__onClickOutside:function(e){this.close()},__onFocusOutside:function(e){this.close()},__onOpenKeydown:function(e){var t=e.which;if(t===SM.KeyCodes.ESCAPE){e.preventDefault();this.close()}},__onBeforeMenuClose:function(){},__onAfterMenuClose:function(){$(window).off(SM.Event.RESIZE+"."+this.__NAME+this.__uid,this._onResize);this.unsubscribe(SM.Event.FOCUSIN,this._onDocumentFocusin).unsubscribe(SM.Event.KEYDOWN,this._onDocumentKeydown).unsubscribe(SM.Event.CLICK,this._onDocumentClick)},__setters:{position:function(e,t){SM.Object.update(e.__settings.position,t);if(e.isOpen()){e.position()}},parentEl:function(e,t){e.__settings.parentEl=t;if(e.isOpen()){e.position()}}},__getters:{menuView:function(e,t){if(!e._menu){e._initMenu()}return e._menu}},bindMenu:function(e,t){this._menu.$el.on(this._menu.__NAME+"."+e,{self:this},t);return this},open:function(){var e;if(this.$el.hasClass("disabled")){return}e=this.get("menuView");if(this._isOpen){return}this.trigger("beforeOpen");this.__onBeforeMenuOpen();e.$el.on("click",".close-menu-btn",{self:this},this._onCloseMenuClick);e.$el.appendTo(this.__settings.parentEl);this.$el.addClass("open");this.__onMenuAddedToPage();this.position();this._isOpen=true;this.trigger("afterOpen");this.__onAfterMenuOpen()},close:function(){var e;if(!this._isOpen){return}e=this.get("menuView");this.trigger("beforeClose");this.__onBeforeMenuClose();e.$el.off("click",".close-menu-btn",this._onCloseMenuClick);e.$el.detach();this._isOpen=false;this.$el.removeClass("open");this.trigger("afterClose");this.__onAfterMenuClose()},isOpen:function(){return this._isOpen},position:function(){var e;if(!this.__settings.position.of){this.__settings.position.of=this.$el}if(this.__settings.parentEl){this.__settings.position.within=this.__settings.parentEl}e=$.migrationFixPosition({my:this.__settings.position.my,at:this.__settings.position.at,of:this.__settings.position.of,offset:this.__settings.position.offset,within:this.__settings.position.within,collision:this.__settings.position.collision});this._menu.$el.position(e);this.trigger("position")},_initMenu:function(){var e;if(!this._menu){e=SM[this._menuView];if(!e){throw new Error("A menu requires a menuView key")}this._menu=SM.Views.create(e,this.__settings);this._menu.$el.css({top:0,left:0});this.trigger("menuInit");this.__onMenuInit()}return this._menu},__destroy:function(){if(this._menu){this.__onAfterMenuClose();this._isOpen=false;if(this._menu.$el){this._menu.$el.remove()}this._menu=null}this.$el.off("click",this._onClick).off("keydown",this._onKeydown).data(this.__NAME,null)},_menu:null,_menuView:"BaseMenuView",_isOpen:false,_onClick:function(e){var t=e.data.self;t.__onClick(e)},_onKeydown:function(e){var t=e.data.self;if(!t._isOpen){t.__onClosedKeydown(e)}},_onDocumentKeydown:function(e){var t=e.data.self;t.__onOpenKeydown(e)},_onDocumentClick:function(e){var t=e.data.self;if(!t._menuContains(e.target)&&!t._isStepChild(e.target)&&!t._contains(e.target)){t.__onClickOutside(e)}},_onDocumentFocusin:function(e){var t=e.data.self;if(e.target===document){return}if(!t._menuContains(e.target)&&!t._isStepChild(e.target)&&!t._contains(e.target)&&e.target.tagName.toLowerCase()!=="body"){t.__onFocusOutside(e)}},_onResize:function(e){var t=e.data.self;t.__onWindowResize(e)},_menuContains:function(e){return SM.DOM.contains(this._menu.el,e)},_isStepChild:function(e){return false},_onCloseMenuClick:function(e){e.data.self.close()},_contains:function(e){return SM.DOM.contains(this.el,e)}};SM.Menu=SM.Widgets.register(SM.BaseMenu);SM.ActionMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"actionMenu",__defaults:{saveState:false,selectedAction:null},__onMenuInit:function(){this.bindMenu("actionSelected",this._onActionSelected).bindMenu("optionClicked",this._onOptionClicked)},__setters:{selectedAction:function(e,t){var i=e.get("menuView");i.set("selectedAction",t)},actions:function(e,t){var i=e.get("menuView");i.set("actions",t)}},_onOptionClicked:function(e){var t=e.data.self;t.$el.focus();t.close()},hasAction:function(e){var t=this.get("menuView");return t.hasAction(e)},_menuView:"ActionMenuView",_onActionSelected:function(e){var t=e.data.self;if(t.__settings.saveState&&t.__settings.selectedAction===e.action){return}if(t.__settings.saveState){t.__settings.selectedAction=e.action}t.trigger({type:"actionSelected",action:e.action,$action:e.$action})},__onOpenKeydown:function(e){var t=e.which;SM.BaseMenu.__onOpenKeydown.call(this,e);if(t===SM.KeyCodes.DOWN){this._menu.nextCurrent();e.preventDefault()}else if(t===SM.KeyCodes.UP){this._menu.prevCurrent();e.preventDefault()}else if(t===SM.KeyCodes.ENTER){this._menu.selectCurrent();e.preventDefault()}},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);if(this._menu){this._menu.set("currentIndex",-1)}}});SM.SelectMenu=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"selectMenu",__defaults:{selectedValue:null,options:undefined,paginationEnabled:false,numOptionsPerPage:10,searchEnabled:false,loadPage:undefined,loadSearchPage:undefined,selectWidth:"200px",menuMaxWidth:"400px"},__init:function(e){var t,i;SM.BaseMenu.__init.call(this);this.bind("keypress",this._onCloseKeypress);this.$el.addClass("btn select-menu").css("width",this.__settings.selectWidth);t=this.get("menuView");i=t.get("selectedValue");if(i){this.__settings.selectedValue=i;this._setDisplay(t.get("valueText"))}},__onMenuInit:function(){this.bindMenu("change",this._onMenuChange);this.bindMenu("onOptionsLoaded",this._onMenuOptionsLoaded)},__onClosedKeydown:function(e){var t=e.which;SM.BaseMenu.__onClosedKeydown.call(this,e);if(t===SM.KeyCodes.DOWN){this._menu.nextSelect();e.preventDefault()}else if(t===SM.KeyCodes.UP){this._menu.prevSelect();e.preventDefault()}},__onOpenKeydown:function(e){var t=e.which,i=$(e.target),s=i.attr("name")==="searchTerm";SM.BaseMenu.__onOpenKeydown.call(this,e);if(t===SM.KeyCodes.DOWN){this._menu.nextCurrent();e.preventDefault()}else if(t===SM.KeyCodes.UP){this._menu.prevCurrent();e.preventDefault()}else if(t===SM.KeyCodes.TAB){e.stopPropagation()}},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this._setMenuUI();this.subscribe(SM.Event.KEYPRESS,this._onOpenKeypress)},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this.unsubscribe(SM.Event.KEYPRESS,this._onOpenKeypress);this.$el.focus()},__onAfterMenuOpen:function(){SM.BaseMenu.__onAfterMenuOpen.call(this);this._menu.prepareMenuLoad()},__setters:{value:function(e,t){e._menu.set("selectedValue",t)},options:function(e,t){e._menu.set("options",t)}},__getters:{value:function(e,t){return e.__settings.selectedValue}},_menuView:"SelectMenuView",_inlineSearchTerm:undefined,_setDisplay:function(e){this.$el.text(e)},_setMenuUI:function(){var e=this._menu.$el;e.css("min-width",this.__settings.selectWidth);e.css("max-width",this.__settings.menuMaxWidth);if(!this.__settings.paginationEnabled){e.addClass("no-pagination")}},_getNewInlineSearchTerm:function(e){return this._inlineSearchTerm?this._inlineSearchTerm+e:e},_inlineSearchWithSelect:function(e,t){var i,s,n,r=t?"selectedIndex":"currentIndex";if(!e){return}s=this._getNewInlineSearchTerm(e);i=this._menu.inlineSearchOptionsWithSelect(s,t);if(this._inlineSearchTerm&&i===-1){this._inlineSearchTerm=undefined;i=this._menu.inlineSearchOptionsWithSelect(e,t)}if(i!==-1){this._menu.set(r,i);this._inlineSearchTerm=this._getNewInlineSearchTerm(e)}else{this._inlineSearchTerm=undefined}},_getLetter:function(e){var t=e.charCode!==undefined?e.charCode:e.keyCode;return String.fromCharCode(t).toLowerCase()},_onCloseKeypress:function(e){var t=e.data.self,i;if(!t.isOpen()){i=t._getLetter(e);if(e.which===SM.KeyCodes.SPACE){e.preventDefault()}t._inlineSearchWithSelect(i,true)}},_onOpenKeypress:function(e){var t=e.data.self,i=t._getLetter(e),s=$(e.target),n=s.closest(".select-option-item").length>0;if(!n){return}if(e.which===SM.KeyCodes.SPACE){e.preventDefault()}t._inlineSearchWithSelect(i,false)},_onMenuChange:function(e){var t=e.data.self;if(t.__settings.selectedValue===e.value){t.$el.focus();t.close();return}t._setDisplay(e.displayText);t.__settings.selectedValue=e.value;t.trigger({type:"change",value:e.value,displayText:e.displayText});t.$el.focus();t.close()},_onMenuOptionsLoaded:function(e){var t=e.data.self;t.trigger("onOptionsLoaded")}});SM.Autocomplete=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"autocomplete",__defaults:{minLength:2,delay:0,maxResults:50,autocompleteOnPaste:true,source:[],search:function(e){var t=this.__settings.source,i=this.__settings.maxResults,s=0,n;n=$.map(t,function(t,n){var r=t.toLowerCase(),a=e.toLowerCase();if(s>=i){return false}if(r.indexOf(a)!==-1){s++;return{value:t,text:t}}});this.set("results",n)},position:{collision:"none"},enabled:true,setInputOnSelect:true,matchInputWidth:true},_timeout:undefined,__getters:{input:function(e){return e._getInput()},results:function(e){var t=e.get("menuView");return t.get("results")}},__setters:{input:function(e,t){e._setInput(t)},results:function(e,t){var i=e.get("menuView");if(t.length>e.__settings.maxResults){t=t.slice(0,e.__settings.maxResults)}i.set("results",t);if(t.length>0){e.open()}else{e.close()}},enabled:function(e,t){if(t&&!e.__settings.enabled){e._bindEvents()}else if(!t&&e.__settings.enabled){e.close();e.$el.off("keydown",e._onKeydown).off("keyup",e._onKeyup).off("paste",e._onPaste)}e.__settings.enabled=t}},__init:function(e){var t=this.el.tagName.toLowerCase();if(this.__settings.enabled){this._bindEvents()}if(this.__settings.menuView){this._menuView=this.__settings.menuView}this._hasVal=t==="input"||t==="textarea";this._height=this.$el.height();this._width=this.$el.outerWidth()},__onMenuInit:function(){this.bindMenu("selected",this._onOptionSelected)},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this)},__onMenuAddedToPage:function(){SM.BaseMenu.__onMenuAddedToPage.call(this);if(this.__settings.matchInputWidth){this._matchInputSize()}},__onAfterMenuClose:function(){SM.BaseMenu.__onAfterMenuClose.call(this);this._menu.set("currentIndex",-1)},__onWindowResize:function(){this._matchInputSize();SM.BaseMenu.__onWindowResize.call(this)},_matchInputSize:function(){var e=this.get("menuView"),t=this.$el,i=t.outerWidth(),s=parseInt(e.$el.css("border-left-width"),10),n=parseInt(e.$el.css("border-right-width"),10);e.$el.css("width",i-s-n)},_bindEvents:function(){this.bind("keydown",this._onKeydown).bind("keyup",this._onKeyup);if(this.__settings.autocompleteOnPaste){this.bind("paste",this._onPaste)}},_menuView:"AutocompleteMenuView",_pipeInput:function(){var e=this._getInput();if(e.length>=this.__settings.minLength){this._checkHeight();this._checkSearch()}else{this.close()}},_checkHeight:function(){var e=this.$el.height();if(this._height!==e&&this.isOpen()){this.position();this._height=e}},_debounceSearch:function(){var e=this;clearTimeout(e._timeout);e._timeout=setTimeout(function(){e._pipeInput()},e.__settings.delay)},_checkSearch:function(){var e=this._getInput();this.__settings.search.call(this,e)},_getInput:function(){var e=this.$el;return $.trim(this._hasVal?e.val():e.text())},_setInput:function(e){var t=this.$el;if(this._hasVal){t.val(e)}else{t.text(e)}},_onOptionSelected:function(e){var t=e.data.self;if(t.__settings.setInputOnSelect){t._setInput(e.text)}t.trigger({type:"selected",text:e.text,value:e.value});t.close()},_onKeyup:function(e){var t=e.data.self,i=e.which;if(i===SM.KeyCodes.DOWN||i===SM.KeyCodes.UP||i===SM.KeyCodes.ENTER||i===SM.KeyCodes.ESCAPE){e.preventDefault();return}if(i===SM.KeyCodes.SHIFT||i===SM.KeyCodes.CTRL||i===SM.KeyCodes.CAPS||i===SM.KeyCodes.ALT||i===SM.KeyCodes.HOME||i===SM.KeyCodes.END||i===SM.KeyCodes.LEFT||i===SM.KeyCodes.RIGHT||i===SM.KeyCodes.LEFT_WINDOW||i===SM.KeyCodes.RIGHT_WINDOW||i===SM.KeyCodes.RIGHT_WINDOW||i===SM.KeyCodes.SELECT){return}if((e.ctrlKey||e.metaKey)&&i===SM.KeyCodes.V){return}if(t.__settings.delay>0){t._debounceSearch()}else{t._pipeInput()}},_onPaste:function(e){var t=e.data.self;setTimeout(function(){t._pipeInput()},0)},_onKeydown:function(e){var t=e.data.self,i=e.which;if(t.isOpen()){if(i===SM.KeyCodes.DOWN){t._menu.nextCurrent();e.preventDefault()}else if(i===SM.KeyCodes.UP){t._menu.prevCurrent();e.preventDefault()}else if(i===SM.KeyCodes.ENTER){t._menu.selectCurrent();e.preventDefault()}}}});SM.Datepicker=SM.Widgets.deepExtend(SM.BaseMenu,{__NAME:"datepicker",__defaults:{selectedDate:null,minDate:null,maxDate:null,selectMenus:false,dateFormat:"d"},__init:function(e){this.bind("focusin",this._onFocusIn).bind("click",this._onClick).bind("keyup",this._onKeyup).bind("paste",this._onPaste);if(this.$el.siblings(".datepicker-icon").length){this.$icon=this.$el.siblings(".datepicker-icon").first();this.$icon.on("click",{self:this},this._onIconClick)}this._setInitialValue()},__onMenuInit:function(){this.bindMenu("dateSelected",this._onDateSelected)},__onBeforeMenuOpen:function(){SM.BaseMenu.__onBeforeMenuOpen.call(this);this._menu.resetDisplayDate(this.__settings);this._menu.render()},__setters:{selectedDate:function(e,t){e._setSelectedDate(t);e.trigger("dateSelected")},minDate:function(e,t){e._setMinDate(t)},maxDate:function(e,t){e._setMaxDate(t)},selectMenus:function(e,t){e.__settings.selectMenus=t}},_menuView:"CalendarMenuView",_setSelectedDate:function(e){var t=this.__settings;if(e){if(t.minDate&&e<t.minDate){t.selectedDate=new Date(t.minDate)}else if(t.maxDate&&e>t.maxDate){t.selectedDate=new Date(t.maxDate)}else{t.selectedDate=e}this.$el.val(Globalize.format(t.selectedDate,t.dateFormat))}else{t.selectedDate=null;this.$el.val("")}return this},_setMinDate:function(e){var t=this.__settings;if(e){if(t.selectedDate&&e>t.selectedDate){t.minDate=new Date(t.selectedDate)}else if(t.maxDate&&e>t.maxDate){t.minDate=new Date(t.maxDate)}else{t.minDate=e}}else{t.minDate=null}return this},_setMaxDate:function(e){var t=this.__settings;if(e){if(t.selectedDate&&e<t.selectedDate){t.maxDate=new Date(t.selectedDate)}else if(t.minDate&&e<t.minDate){t.maxDate=new Date(t.minDate)}else{t.maxDate=e}}else{t.maxDate=null}return this},_setInitialValue:function(){var e=this.__settings.selectedDate;if(e){this._setSelectedDate(e)}return this},_parseDate:function(e){var t=Globalize.parseDate(e,this.get("dateFormat"));if(t){this.set("selectedDate",t)}else{this.set("selectedDate",null)}},_isStepChild:function(e){return this.$icon&&this.$icon.get(0)===e},_onFocusIn:function(e){var t=e.data.self;t.open()},_onClick:function(e){var t=e.data.self;t.open()},_onDateSelected:function(e){var t=e.data.self;t.set("selectedDate",e.date);t.$el.focus();t.close()},_onKeyup:function(e){var t=e.data.self,i=t.$el.val();t._parseDate(i)},_onPaste:function(e){var t=e.data.self,i=t.$el.val();t._parseDate(i)},_onIconClick:function(e){var t=e.data.self;t.open()}});SM.DateRange=SM.Widgets.register({__NAME:"dateRangePicker",__getters:{startMinDate:function(e){return e._start.get("minDate")},startMaxDate:function(e){return e._start.get("maxDate")},startSelectedDate:function(e){return e._start.get("selectedDate")},endMinDate:function(e){return e._end.get("minDate")},endMaxDate:function(e){return e._end.get("maxDate")},endSelectedDate:function(e){return e._end.get("selectedDate")}},__setters:{startMinDate:function(e,t){e._start.set("minDate",t)},startMaxDate:function(e,t){e._start.set("maxDate",t)},startSelectedDate:function(e,t){e._start.set("selectedDate",t)},endMinDate:function(e,t){e._end.set("minDate",t)},endMaxDate:function(e,t){e._end.set("maxDate",t)},endSelectedDate:function(e,t){e._end.set("selectedDate",t)}},__init:function(e){var t=this.$el.find(".datepicker.date-start"),i=this.$el.find(".datepicker.date-end");if(t.length===0||i.length===0){throw new Error(".date-start or .date-end not found inside daterange element")}t.datepicker({minDate:e.startMinDate,maxDate:e.startMaxDate,selectedDate:e.startSelectedDate,selectMenus:e.selectMenus});i.datepicker({minDate:e.endMinDate,maxDate:e.endMaxDate,selectedDate:e.endSelectedDate,selectMenus:e.selectMenus});this._initStartMaxDate=e.startMaxDate;this._initEndMinDate=e.endMinDate;this._start=t.data("datepicker");this._end=i.data("datepicker");this._start.$el.on("datepicker.beforeOpen",{daterange:this},this._startDateOpen);this._end.$el.on("datepicker.dateSelected",{daterange:this},this._onEndDateSelected).on("datepicker.beforeOpen",{daterange:this},this._endDateOpen)},_start:undefined,_end:undefined,_initStartMaxDate:undefined,_initEndMinDate:undefined,_startDateOpen:function(e){var t=e.data.daterange,i=t._end.get("selectedDate"),s=t._start.get("maxDate"),n=t._end.get("maxDate");if(i&&t._initStartMaxDate&&i<t._initStartMaxDate){t._start.set("maxDate",i)}else if(i&&!t._initStartMaxDate){t._start.set("maxDate",i)}else if(t._initStartMaxDate){t._start.set("maxDate",t._initStartMaxDate)}else if(n){t._start.set("maxDate",n)}},_endDateOpen:function(e){var t=e.data.daterange,i=t._start.get("selectedDate"),s=t._end.get("minDate"),n=t._start.get("minDate");if(i&&t._initEndMinDate&&i>t._initEndMinDate){t._end.set("minDate",i)}else if(i&&!t._initEndMinDate){t._end.set("minDate",i)}else if(t._initEndMinDate){t._end.set("minDate",t._initEndMinDate)}else if(n){t._end.set("minDate",n)}},_onEndDateSelected:function(e){var t=e.datepicker,i=t.get("selectedDate");if(i){i.setMilliseconds(999);i.setSeconds(59);i.setMinutes(59);i.setHours(23);t._setSelectedDate(i)}}});SM.Accordion=SM.Widgets.register({__NAME:"accordion",__defaults:{multiOpen:false,overflowAuto:true},__init:function(){this._cacheData()._bindEvents();if(SM.Browser.isIE8){this.$el.find("div.key > header > h3").prepend('<span class="accordion-arrow"></span>')}},KEY_ATTR:"data-panel-key",close:function(e){var t;e=this._getNormalizedStringPanelkey(e);t=this._panels[e];if(t&&this._openPanels[e]){this._close(t)}return this},open:function(e){var t;e=this._getNormalizedStringPanelkey(e);t=this._panels[e];if(t&&!this._openPanels[e]){if(!this.__settings.multiOpen){this._closeOpenPanels()}this._open(t)}return this},disable:function(e,t){var i;e=this._getNormalizedStringPanelkey(e);i=this.$el.find("#"+e).siblings("header");if(e){if(t){this._disabledPanels[e]=true;i.addClass("disabled")}else{delete this._disabledPanels[e];i.removeClass("disabled")}}return this},isOpen:function(e){e=this._getNormalizedStringPanelkey(e);return!!this._openPanels[e]},isDisabled:function(e){e=this._getNormalizedStringPanelkey(e);return!!this._disabledPanels[e]},_openPanels:undefined,_panels:undefined,_disabledPanels:undefined,_close:function(e){e.$section.css("overflow-y","hidden");this.__trigger({type:"beforeClose",index:e.index,id:e.key});delete this._openPanels[e.key];e.$section.animate({height:0},200,this._onClose)},_open:function(e){var t;e.$panel.addClass("opening");this.__trigger({type:"beforeOpen",index:e.index,id:e.key});this._openPanels[e.key]=true;if(!this.$el.hasClass("static")){t=e.$section.css("height","auto").height();e.$section.css("height",0);this.$el.one("accordion.afterOpen",function(){e.$section.css("height","auto")})}else{e.$panel.addClass("open");t=e.$section.height();e.$panel.removeClass("open")}e.$section.animate({height:t},200,this._onOpen)},_cacheData:function(){var e=0,t,i,s,n,r,a;this._openPanels={};this._panels={};this._disabledPanels={};t=this.$el.children("div.key");r=t.length;for(;e<r;e++){i=t.eq(e);a=i.find("header");s=a.find("a.keyOpener").attr("target").substr(1);n=this.$el.find("#"+s);this._panels[s]={index:e,key:s,$panel:i,$section:n};if(i.hasClass("open")){this._openPanels[s]=true}if(a.hasClass("disabled")){this.disable(s,true)}}return this},_closeOpenPanels:function(){var e=this._panels,t=this._openPanels,i;for(i in t){if(t[i]){this._close(e[i])}}},_bindEvents:function(){this.$el.on("click",".key > header",{accordion:this},this._onKeyClick);return this},_getNormalizedStringPanelkey:function(e){if(typeof e==="string"){return e}var t,i=this._panels;for(t in i){if(i[t].index===e){return i[t].key}}},_getSingleOpenedPanelkey:function(){for(var e in this._openPanels){return e}},_onClose:function(){var e=$(this),t=e.closest(".accordion").data(SM.Accordion.__NAME),i=e.attr("id"),s=t._panels[i];s.$panel.removeClass("open");e.removeAttr("style");t.__trigger({type:"afterClose",index:s.index,id:s.key})},_onOpen:function(){var e=$(this),t=e.closest(".accordion").data(SM.Accordion.__NAME),i=e.attr("id"),s=t._panels[i];s.$panel.removeClass("opening");s.$panel.addClass("open");if(t.__settings.overflowAuto){e.css("overflow-y","auto")}t.__trigger({type:"afterOpen",index:s.index,id:s.key})},_onKeyClick:function(e){var t=e.data.accordion,i=$(this).find("a.keyOpener").attr("target").substring(1),s=t._getSingleOpenedPanelkey();e.preventDefault();if(t.isDisabled(i)){return}if(!t.__settings.multiOpen&&s&&t.isDisabled(s)){return}if(t._openPanels[i]){t.close(i)}else{t.open(i)}}});SM.Popout=SM.Widgets.register({__NAME:"popout",__defaults:{tipSideX:"left",tipSideY:"top",parentElement:document.body,offsetX:null,offsetY:null,at:"left top",showDelayTime:750,hideDelayTime:500,collision:"flip flip"},__init:function(e){this.$el.on("mouseenter.popout",{popout:this},this._onMouseenter).on("mouseleave.popout",{popout:this},this._onMouseleave).on("click.popout",this._onClick)},__destroy:function(){this.$el.off(".popout")},_isHovered:false,_isMsgSetup:false,_$msg:undefined,_offsetX:undefined,_offsetY:undefined,_tipSideX:undefined,_tipSideY:undefined,_positions:{left:{css:"tip-left",offset:"+32",flip:"right"},right:{css:"tip-right",offset:"-15",flip:"left"},bottom:{css:"tip-bottom",offset:"+34",flip:"top"},top:{css:"tip-top",offset:"-14",flip:"bottom"}},_beforeShow:function(){if(this.__settings.offsetX){this._offsetX=this.__settings.offsetX}else{this._offsetX=this._positions[this.__settings.tipSideX].offset}
if(this.__settings.offsetY){this._offsetY=this.__settings.offsetY}else{this._offsetY=this._positions[this.__settings.tipSideY].offset}this._$msg=this.$el.find(".popout");if(this._$msg.length===0){this.$el.append("<div class='popout'></div>");this._$msg=this.$el.find(".popout").html($("#"+this.$el.attr("data-help")).html())}this._$msg=this._$msg.clone();this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("mouseleave",{popout:this},this._onMessageMouseleave).on("position.horizontal.flip",{popout:this,offsetKey:"_offsetX",tipKey:"tipSideX"},this._onMessageFlip).on("position.vertical.flip",{popout:this,offsetKey:"_offsetY",tipKey:"tipSideY"},this._onMessageFlip).on("click",".close",{popout:this},this._onCloseClick).addClass(this._positions[this.__settings.tipSideX].css).addClass(this._positions[this.__settings.tipSideY].css).append('<span class="tip"></span>').append('<a class="close"><span aria-hidden="true"></span>Close</a>').appendTo(this.__settings.parentElement);this._isMsgSetup=true;return this},_show:function(){var e=this;setTimeout(function(){if(e._isHovered){e._$msg.addClass("open").position($.migrationFixPosition({my:e.__settings.tipSideX+" "+e.__settings.tipSideY,at:e.__settings.at,of:e.$el,offset:e._offsetX+" "+e._offsetY,collision:e.__settings.collision}));e.trigger("opened")}},e.get("showDelayTime"));return e},_hide:function(){var e=this;setTimeout(function(){if(!e._isHovered){if(e._$msg!==undefined){e._$msg.remove()}e._isMsgSetup=false}},e.get("hideDelayTime"));return e},_onMessageFlip:function(e){var t=e.data.popout,i=t.__settings[e.data.tipKey],s=t._positions[i],n=t._positions[s.flip];t[e.data.offsetKey]=n.offset;t._$msg.removeClass(s.css).addClass(n.css)},_onMouseenter:function(e){var t=e.data.popout;t._isHovered=true;if(!t._isMsgSetup){t._beforeShow()._show()}},_onMouseleave:function(e){var t=e.data.popout;t._isHovered=false;t._hide()},_onMessageMouseenter:function(e){var t=e.data.popout;t._isHovered=true},_onMessageMouseleave:function(e){var t=e.data.popout;t._isHovered=false;t._hide()},_onCloseClick:function(e){var t=e.data.popout;t._isHovered=false;t._$msg.remove();t._isMsgSetup=false;e.stopPropagation()},_onClick:function(e){e.preventDefault();e.stopPropagation()}});SM.SidiPopout=SM.Widgets.register({__NAME:"sidipopout",__defaults:{templateID:"sidi-popout-msg-template",tipSide:"left",parentElement:document.body,at:"left top",showDelayTime:250,hideDelayTime:150,collision:"flip flip"},__init:function(e){this.$el.on("mouseenter",{popout:this},this._onMouseenter).on("mouseleave",{popout:this},this._onMouseleave)},_isHovered:false,_isMsgSetup:false,_$msg:undefined,_tipSide:undefined,_beforeShow:function(){var e,t=this;this._$msg=this.$el.find(".popout");this._$msg=this._$msg.clone();e=SM.Template.render(this.__settings.templateID,this.__settings);this._$msg.append(e);if(t.__settings.tipSide==="bottom"){t._$msg.css("width",100)}this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("mouseleave",{popout:this},this._onMessageMouseleave).on(SM.Event.CLICK,"[data-dimension-id]",{popout:this},t._onClickCombineHide).addClass("sidi-tip-"+this.__settings.tipSide).appendTo(this.__settings.parentElement);this._isMsgSetup=true;return this},_show:function(){var e=this;if($("body").hasClass("noPopout")){return}setTimeout(function(){var t=e.$el.offset(),i=t.left,s=t.top;if(e._isHovered){if(e.__settings.tipSide==="left"||e.__settings.tipSide==="right"){if(e.__settings.tipSide==="left"){i+=e.$el.outerWidth()}else{i-=e._$msg.outerWidth()}s+=(e.$el.outerHeight()-e._$msg.outerHeight())/2}else{i+=(e.$el.outerWidth()-e._$msg.outerWidth())/2;if(e.__settings.tipSide==="bottom"){s-=e._$msg.outerHeight()+12}else{s+=e._$msg.outerHeight()}}e._$msg.addClass("open").css({left:Math.floor(i)+"px",top:Math.floor(s)+"px"});e.trigger("opened")}},e.get("showDelayTime"));return e},_hide:function(){var e=this;setTimeout(function(){if(!e._isHovered){e._$msg.remove();e._isMsgSetup=false}},e.get("hideDelayTime"));return e},_onMouseenter:function(e){var t=e.data.popout;t._isHovered=true;if(!t._isMsgSetup){t._beforeShow()._show()}},_onMouseleave:function(e){var t=e.data.popout;t._isHovered=false;t._hide()},_onMessageMouseenter:function(e){var t=e.data.popout;t._isHovered=true},_onMessageMouseleave:function(e){var t=e.data.popout;t._isHovered=false;t._hide()},_onClickCombineHide:function(e){var t=e.data.popout,i=$(e.currentTarget),s=i.attr("data-dimension-id"),n=t.__settings.question.getRollup().combinehideModel;if(s){n.unCombine(s)}else{n.unHideAll()}t._isHovered=false;t._hide()}});SM.TMBCPopout=SM.Widgets.register({__NAME:"tmbcpopout",__defaults:{templateID:"tmbc-popout-msg-template",tipSideX:"left",parentElement:document.body,at:"left top",showDelayTime:250,hideDelayTime:150,collision:"flip flip"},__init:function(e){this.$el.on("mouseenter",{popout:this},this._onMouseenter).on("mouseleave",{popout:this},this._onMouseleave)},_isHovered:false,_isMsgSetup:false,_$msg:undefined,_tipSideX:undefined,_beforeShow:function(){var e,t=this;this._$msg=this.$el.find(".popout");this._$msg=this._$msg.clone();e=SM.Template.render(this.__settings.templateID,this.__settings);this._$msg.append(e);this._$msg.on("mouseenter",{popout:this},this._onMessageMouseenter).on("mouseleave",{popout:this},this._onMessageMouseleave).addClass("sidi-tip-"+this.__settings.tipSideX).appendTo(this.__settings.parentElement);this._isMsgSetup=true;return this},_show:function(){var e=this;setTimeout(function(){var t=e.$el,i=t.offset(),s=i.left,n=i.top;if(e._isHovered){if(e.__settings.tipSideX==="left"){s+=t.outerWidth()+10}else{s-=e._$msg.outerWidth()}n+=(t.outerHeight()-e._$msg.outerHeight())/2;e._$msg.addClass("open").css({left:Math.floor(s)+"px",top:Math.floor(n)+"px"});e.trigger("opened")}},e.get("showDelayTime"));return e},_hide:function(){var e=this;setTimeout(function(){if(!e._isHovered){e._$msg.remove();e._isMsgSetup=false}},e.get("hideDelayTime"));return e},_onMouseenter:function(e){var t=e.data.popout;t._isHovered=true;if(!t._isMsgSetup){t._beforeShow()._show()}},_onMouseleave:function(e){var t=e.data.popout;t._isHovered=false;t._hide()},_onMessageMouseenter:function(e){var t=e.data.popout;t._isHovered=true},_onMessageMouseleave:function(e){var t=e.data.popout;t._isHovered=false;t._hide()}});SM.Form=SM.Widgets.register({__NAME:"form",__defaults:{formErrorsClass:"form-errors",formGroupErrorClass:"has-error",formControlErrorsClass:"form-control-errors",formControlErrorMessageClass:"form-control-error-message"},__init:function(e){var t=this;t.options=SM.Object.deepUpdate(t.__defaults,e);t.formView=t.options.formView;t.validations=t.formView.validations;t.errors=[]},attrs:function(){var e={},t;t=this.$el.serializeArray();_.each(t,function(t){e[t.name]=t.value});return e},validate:function(){var e=this,t=e.options.formErrorsClass,i=e.options.formGroupErrorClass,s=e.options.formControlErrorsClass,n=e.options.formControlErrorMessageClass;var r=function(t,i){var s=true,n,r;if(t["if"]){s=t["if"]()}else if(t["ifChecked"]){n=e.$el.find(t["ifChecked"]);if(n.length){s=n.prop("checked")}else{SM.log("Could not find "+t["ifChecked"])}}if(s){if(t.type==="presence"){r=e.$el.find(i).val();if(_.isEmpty(r)){e.errors.push([i,t.message])}}else if(t.type==="length"){r=e.$el.find(i).val();if(_.has(t,"exactly")&&r.length!==t.exactly){e.errors.push([i,t.message])}if(_.has(t,"min")&&r.length<t.min){e.errors.push([i,t.message])}if(_.has(t,"max")&&r.length>t.max){e.errors.push([i,t.message])}}}};e.errors=[];e.$el.find("."+t).hide();e.$el.find("."+i).removeClass(i);e.$el.find("."+s).remove();_.each(e.validations,function(e,t){if(!_.isArray(e)){r(e,t)}else{_.each(e,function(e){r(e,t)})}});var a,o,l,u;if(e.errors.length){e.$el.find("."+t).show();_.each(e.errors,function(t){a=t[0];o=t[1];l=e.$el.find(a);l.parents(".form-group").eq(0).addClass(i);u=l.next("."+s);if(!u.length){u=$("<div class='"+s+"'></div>");l.after(u)}u.append("<p class='"+n+"'>"+o+"</p>")})}},isValid:function(){this.validate();return _.isEmpty(this.errors)}});SM.Tabs=SM.Widgets.register({__NAME:"tabs",__defaults:{requireOpenTab:true},__setters:{selectedTab:function(e,t){e.open(t)}},__getters:{selectedTab:function(e){return e._selectedTab}},__init:function(){this._cacheData()._initTab()._bindEvents()},open:function(e){var t,i=this._selectedTab;if(typeof e!=="string"){e=this._getKeyFromIndex(e)}t=this._tabs[e];if(!t){return this}if(t.$tab.hasClass("disabled")||i===e){return this}this._opening=t;this._closeOpenTab();if(!this._selectedTab){this._open(t)}this._opening=undefined;return this},close:function(e){var t,i=this._selectedTab;if(e===undefined&&!this.__settings.requireOpenTab){this._closeOpenTab();return this}if(typeof e!=="string"){e=this._getKeyFromIndex(e)}t=this._tabs[e];if(t&&i===t.key&&!this.__settings.requireOpenTab){this._close(t)}return this},_selectedTab:undefined,_tabs:undefined,_close:function(e){var t=$.Event("beforeClose",{tab:e,opening:this._opening});this.__trigger(t);if(t.isDefaultPrevented()){return this}e.$panel.removeClass("open");e.$tab.removeClass("active");this._selectedTab=undefined;this.__trigger({type:"afterClose",tab:e});return this},_open:function(e){this.__trigger({type:"beforeOpen",tab:e});this._setOpenView(e);return this},_setOpenView:function(e){this._selectedTab=e.key;e.$tab.addClass("active");e.$panel.addClass("open")},_bindEvents:function(){this.$el.children("nav").find(".tab").on("click",{tabs:this},this._onTabClick);return this},_initTab:function(){var e=this.$el.children("nav").find(".tab.active"),t,i;if(e.length){t=e.attr("tab-target");i=this._tabs[t];this._setOpenView(i)}return this},_closeOpenTab:function(){var e=this._selectedTab,t;if(e===undefined){return this}t=this._tabs[e];this._close(t);return this},_cacheData:function(){var e,t,i=0,s,n,r;r=this.$el.children("nav").find(".tab");t=r.length;this._tabs={};for(;i<t;i++){s=r.eq(i);e=s.attr("tab-target");n=this.$el.find(".panel[tab="+e+"]");this._tabs[e]={index:i,$tab:s,key:e,$panel:n}}return this},_getKeyFromIndex:function(e){var t,i=this._tabs;for(t in i){if(i[t].index===e){return i[t].key}}},_onTabClick:function(e){var t=e.data.tabs,i=$(this),s;e.preventDefault();s=i.attr("tab-target");if(t.__settings.noClickTab===s){return}if(t._selectedTab===s){t.close(s)}else{t.open(s)}}});SM.SideTab=SM.Widgets.register({__NAME:"sideTab",__init:function(){var e=this,t;if(SM.Browser.isIE7){return}if(!this._supportsMediaQuery){this._bindWindowResize()}this.$el.appendTo(document.body);t=this._getBottomValue();this.$el.css("bottom",t);setTimeout(function(){var t=e._getRightValues();e.$el.css("right",t.normal);e.$el.hover(function(){e.$el.addClass("fast").css("right",t.hover)},function(){e.$el.css("right",t.normal)});if(!e._supportsMediaQuery){e._hasShown=true;e._$window.trigger("resize")}},1800)},_supportsMediaQuery:SM.Browser.support.mediaQuery(),_$window:$(window),MIN_SCREEN_WIDTH:1040,INITIAL_BOTTOM:30,SPACING:7,_bindWindowResize:function(){var e=this;this._hasShown=false;this._$window.on("resize",function(t){if(e._hasShown){if(e._$window.width()>e.MIN_SCREEN_WIDTH){e.$el.show()}else{e.$el.hide()}}})},_getRightValues:function(){var e=this.$el.outerWidth(),t=this.$el.outerHeight(),i,s;if(SM.Browser.isIE8){s=-1*(t-e)}else{s=-1*((e-t)/2)}i=Math.floor(s);s=i-5;return{hover:i,normal:i-5}},_getBottomValue:function(){var e=this.$el.prev(".sidetab"),t;if(e.length){t=this._getPreviousTopValue(e)+this.SPACING}else{t=this.INITIAL_BOTTOM}return t+this._getRotationAdjustment()},_getRotationAdjustment:function(){var e=this.$el.outerWidth(),t=this.$el.outerHeight();if(SM.Browser.isIE8){return t-e}else{return e-(e+t)/2}},_getPreviousTopValue:function(e){var t=e.outerWidth(),i=e.outerHeight(),s=parseInt(e.css("bottom"),10),n;if(SM.Browser.isIE8){n=t;return n+s}else{n=(t+i)/2;return n+s}}});SM.Timepicker=SM.Widgets.register({__NAME:"timepicker",__defaults:{minuteIncrement:15,militaryTime:false,time:null},__init:function(){var e={hours:-1,minutes:-1,ampm:"AM"};if(this.__settings.time){e=this._parseTime(this.__settings.time)}this._createMenus(e);this.bind("selectMenu.change",".hour-menu-btn",this._hoursPicked).bind("selectMenu.change",".minute-menu-btn",this._minutesPicked);if(!this.__settings.militaryTime){this.bind("selectMenu.change",".ampm-menu-btn",this._ampmPicked)}else{this.$el.find(".ampm-menu-btn").hide()}},__setters:{date:function(e,t){var i=e._parseTime(t);e._setMenus(i)},hours:function(e,t){var i,s;if(!e.__settings.militaryTime){s=e._convertHoursToAMPM(t);t=s.hours;i=s.ampm;e._ampm.set("value",i)}e._hours.set("value",t)},minutes:function(e,t){e._minutes.set("value",t)},ampm:function(e,t){e._ampm.set("value",t)},time:function(e,t){e.set("date",t)}},__getters:{isMilitaryTime:function(e){if(Globalize.usesMilitaryTime()){return true}return e.__settings.militaryTime},time:function(e){var t=parseInt(e._hours.get("value"),10),i=parseInt(e._minutes.get("value"),10),s;if(!e.__settings.militaryTime&&t>=0){s=e._ampm.get("value");if(t===12){if(s==="AM"){t=0}}else{if(s==="PM"){t+=12}}}return{hours:t,minutes:i}}},_createMenus:function(e){var t=Globalize.getSmartlingCulture();this._hours=this.$el.find(".hour-menu-btn").selectMenu({menuView:"HourSelectMenuView",selectWidth:"auto",selectedValue:e.hours,militaryTime:this.__settings.militaryTime}).data("selectMenu");this._minutes=this.$el.find(".minute-menu-btn").selectMenu({menuView:"MinuteSelectMenuView",selectWidth:"auto",selectedValue:e.minutes,increment:this.__settings.minuteIncrement}).data("selectMenu");if(!this.get("isMilitaryTime")){this._ampm=this.$el.find(".ampm-menu-btn").selectMenu({options:[{text:Globalize.cultures[t].calendar.AM[0],value:"AM"},{text:Globalize.cultures[t].calendar.PM[0],value:"PM"}],selectWidth:"auto",selectedValue:e.ampm}).data("selectMenu")}},_setMenus:function(e){this._hours.set("value",e.hours.toString());this._minutes.set("value",e.minutes.toString());if(!this.__settings.militaryTime){this._ampm.set("value",e.ampm)}},_convertHoursToAMPM:function(e){if(e===12){ampm="PM"}else if(e>12){e=e-12;ampm="PM"}else{ampm="AM";if(e===0){e=12}}return{hours:e,ampm:ampm}},_parseTime:function(e){var t=e.getHours(),i=e.getMinutes(),s,n=this.__settings.minuteIncrement,r,a;r=i%n;if(r>0){if(Math.floor(n/2)-r>0){i=i-r}else{i=i-r+n;if(i>=60){t++;i=0;if(t===24){t=0}}}}if(!this.__settings.militaryTime){a=this._convertHoursToAMPM(t);t=a.hours;s=a.ampm}return{hours:t,minutes:i,ampm:s}},_hoursPicked:function(e){var t=e.data.self;t.trigger("change")},_minutesPicked:function(e){var t=e.data.self;t.trigger("change")},_ampmPicked:function(e){var t=e.data.self;t.trigger("change")}});SM.Waterpark=SM.Widgets.register({__NAME:"waterpark",__init:function(){this.calculateAttributes()._bindEvents()._displayLocation(this.__settings.location)},__defaults:{location:{slide:0}},__setters:{location:function(e,t){e._setLocation(t)}},calculateAttributes:function(){var e=this.$el.find(".slide"),t=e.length,i,s;if(t%2!==0){t+=1}i=SM.Math.toPercentString(1/t,6),s=""+t*100+"%";this.$el.find(".mover").css("width",s);e.css("width",i);return this},_bindEvents:function(){this.$el.on("click","a.shifter",{waterpark:this},this._onShifterClick).on("click","a.custom-shifter",{waterpark:this},this._onCustomShiftClick).on("click","a.back-shifter",{waterpark:this},this._onBackClick);return this},_setLocation:function(e){var t=this.__settings.location,i=this,s;if(!e||e.slide===undefined){return this}if(t&&e.slide===t.slide&&e.lane===t.lane){return this}this._displayLocation(e);this.__settings.location.slide=e.slide;this.__settings.location.lane=e.lane;this.__trigger("shift");this._startAfterTimer(e.slide,e.lane);return this},_startAfterTimer:function(e,t){var i=this.__settings.location,s=this;setTimeout(function(){if(i.slide===e&&i.lane===t){s.trigger("afterShift")}},300)},_displayLocation:function(e){var t,i=""+e.slide*-100+"%";if(!SM.Browser.isIE7){this.$el.find(".mover").css("margin-left",i)}t=this.$el.find(".slide").removeClass("current").eq(e.slide).addClass("current");if(e.lane){t.find(".lane").removeClass("open").filter("."+e.lane).addClass("open")}},_onShifterClick:function(e){var t=$(this),i=e.data.waterpark,s=t.attr("lane-target"),n=parseInt(t.attr("slide-target"),10);i._setLocation({slide:n,lane:s});e.preventDefault()},_onCustomShiftClick:function(e){var t=e.data.waterpark;t.__trigger("customShift");e.preventDefault()},_onBackClick:function(e){var t=$(this);var i=e.data.waterpark;var s=i.get("location").slide-1;i._setLocation({slide:s});e.preventDefault()}});SM.DialogView=SM.Views.deepExtend({__NAME:"dialog",__templateID:"dialog-template",__defaults:{isModal:false,isFixed:true,width:350,position:{my:"center",at:"center",collision:"none"},easyClose:true,closeBtn:true},_hasShownOnce:false,__afterRender:function(){var e;this.$el.css("width",this.__settings.width);if(this.__settings.title){this.$el.attr("title",this.__settings.title)}e=this.$el.attr("title");if(e){this._addTitlebar(e);this.$el.removeAttr("title")}if(this.__settings.closeBtn){this._addCloseBtn()}if(this._hasShownOnce){this.$el.addClass("open");this.$el.removeClass("close")}else{this.$el.addClass("close");this.$el.removeClass("open")}if(this.__settings.isFixed){this.$el.closest("dialog-container").addClass("fixed-dialog")}},__onBeforeOpen:function(){var e=this;$(window).on(SM.Event.RESIZE+"."+this.__NAME+this.__uid,{self:this},this._onResize);this.subscribe(SM.Event.KEYDOWN,this._onOpenKeydown);this.$el.on("click",".dialog-close-btn",{self:this},this._onCloseClick)},__onAfterOpen:function(){},__onBeforeClose:function(){$(window).off(SM.Event.RESIZE+"."+this.__NAME+this.__uid,this._onResize);this.unsubscribe(SM.Event.KEYDOWN,this._onOpenKeydown);this.$el.off("click",this._onCloseClick)},__onAfterClose:function(){},__onWindowResize:function(e){this.position()},open:function(e){if(this._isOpen){return this}if(e){SM.Object.update(this.__settings,e)}this.trigger("beforeOpen");this.__onBeforeOpen();this._open();return this},update:function(e){if(e.title){this._updateTitlebar(e.title)}},close:function(){var e=$.Event("beforeClose",{dialog:this});if(!this._isOpen){return this}this.trigger(e);if(e.isDefaultPrevented()){return this}this.__onBeforeClose();this._close();return this},position:function(){var e;if(!this.__settings.position.of){this.__settings.position.of=window}e=$.migrationFixPosition({my:this.__settings.position.my,at:this.__settings.position.at,of:this.__settings.position.of,offset:this.__settings.position.offset,within:this.__settings.position.within,collision:this.__settings.position.collision});this.$el.position(e);this.trigger("position")},isOpen:function(){return this._isOpen},_$overlay:null,_isOpen:false,_open:function(){var e,t,i=this;e=SM.Template.renderHTML("dialog-container-template");t=SM.Template.renderHTML("dialog-overlay-template",{isModal:this.__settings.isModal});this._$dialogContainer=$(e);this._$dialogContainer.appendTo(document.body);this._$overlay=$(t);this._$overlay.appendTo(this._$dialogContainer);if(this.__settings.isModal&&this.__settings.isFixed){$("body").addClass("sm-fixed-dialog-modal")}if(this.__settings.easyClose){this._$overlay.on("click",{self:this},i._onOverlayClick)}this.$el.appendTo(this._$dialogContainer);this.position();setTimeout(function(){i._fadeIn()},0)},_close:function(){var e=this;this._$overlay.removeClass("open");this.$el.removeClass("open");this.$el.addClass("close");this._isOpen=false;this._hasShownOnce=false;if(this.__settings.isModal){$("body").removeClass("sm-fixed-dialog-modal")}setTimeout(function(){e._fadeOutComplete()},100)},_fadeIn:function(){this._$overlay.addClass("open");this.$el.addClass("open");this.$el.removeClass("close");this._isOpen=true;this._hasShownOnce=true;this.trigger("afterOpen");this.__onAfterOpen()},_fadeOutComplete:function(){this._$overlay.off("click");this._$overlay.remove();this._$overlay=null;this.$el.detach();this.trigger("afterClose");this._$dialogContainer.remove();this._$dialogContainer=null;this.__onAfterClose()},_addCloseBtn:function(){var e=SM.Template.renderHTML("dialog-close-btn-template");this.$el.prepend(e)},_updateTitlebar:function(e){this.$el.find(".dialog-title-bar").replaceWith(SM.Template.renderHTML("dialog-title-bar-template",{title:e}))},_addTitlebar:function(e){var t=SM.Template.renderHTML("dialog-title-bar-template",{title:e});this.$el.prepend(t)},_onCloseClick:function(e){e.data.self.close();e.preventDefault()},_onOverlayClick:function(e){e.data.self.close()},_onResize:function(e){var t=e.data.self;t.__onWindowResize(e)},_onOpenKeydown:function(e){var t=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){t.close();e.preventDefault()}},_contains:function(e){return SM.DOM.contains(this.el,e)}});SM.BaseNotificationView=SM.Views.register({__NAME:"BaseNotificationView",__templateID:"notification-template",__defaults:{duration:5e3,expires:true,tabMessage:null},close:function(){this.notifications.close(this)},isInQueue:function(){this.notifications.isInQueue(this)}});SM.SuccessNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"SuccessNotificationView",__templateID:"status-notification-template",__defaults:{icon:"2"}});SM.ErrorNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"ErrorNotificationView",__templateID:"status-notification-template",__defaults:{icon:"!"}});SM.InfoNotificationView=SM.Views.deepExtend(SM.BaseNotificationView,{__NAME:"InfoNotificationView",__templateID:"status-notification-template",__defaults:{icon:"i"}});SM.Notifications={_queuedList:[],CLOSE_ANIMATION_TIME:700,OPEN_ANIMATION_TIME:700,error:function(e){var t=SM.Views.create(SM.ErrorNotificationView,e);this.init();t.$el.addClass("sm-notification-error");this.queue(t);return t},success:function(e){var t=SM.Views.create(SM.SuccessNotificationView,e);this.init();t.$el.addClass("sm-notification-success");this.queue(t);return t},info:function(e){var t=SM.Views.create(SM.InfoNotificationView,e);this.init();t.$el.addClass("sm-notification-info");this.queue(t);return t},template:function(e){var t=SM.Views.create(SM.BaseNotificationView,e);this.init();this.queue(t);return t},queue:function(e){e.$el.data("smnotification",e);e.notifications=this;this._queuedList.push(e);if(this._isWindowFocused){this._processQueue()}else{this._startTitleMessager()}},init:function(){if(this._hasInit){return}this._originalTitle=document.title;this._titleChangeIntervalID=null;this._isWindowFocused=true;this.el=SM.Template.renderHTML("notifications-container-template");this.$el=$(this.el);$(document.body).append(this.el);$(window).on("focus.smnotification",{self:this},this._onWindowFocus).on("blur.smnotification",{self:this},this._onWindowBlur);this.$el.on("click","[notification-close-btn]",{self:this},this._onCloseClick);this._hasInit=true},close:function(e){var t,i=this._getQueueIndex(e),s=this;if(i!==-1){this._queuedList.splice(i,1);return}if(!e.$el){return}t=e.$el.parents(".sm-notification-wrapper");if(!t.length||t.hasClass("close")){return}t.css({height:t.height()});e.set("isOpen",false);setTimeout(function(){t.addClass("close");setTimeout(function(){t.remove()},s.CLOSE_ANIMATION_TIME)},0)},open:function(e){var t=this,i=SM.Template.renderHTML("notification-wrapper-template"),s=$(i);s.append(e.el);this.$el.prepend(s);s.css({marginTop:-1*s.outerHeight()-10});e.set("isOpen",true);setTimeout(function(){s.addClass("open");if(e.get("expires")){setTimeout(function(){t.close(e)},t.OPEN_ANIMATION_TIME+e.get("duration"))}},0)},isInQueue:function(e){return this._getQueueIndex(e)!==-1},_getQueueIndex:function(e){var t=-1;$.each(this._queuedList,function(i,s){if(e.__uid===s.__uid&&e.__NAME===s.__NAME){t=i;return false}});return t},_processQueue:function(){var e=this,t;while(this._queuedList.length>0){t=this._queuedList.shift();e.open(t)}},_startTitleMessager:function(){var e=this,t=this._indexOfNextTabMessage(0);if(this._titleChangeIntervalID===null&&t!==-1){this._titleChangeIntervalID=setInterval(function(){if(t!==-1){document.title=e._queuedList[t].get("tabMessage");t=e._indexOfNextTabMessage(t+1)}else{document.title=e._originalTitle;t=e._indexOfNextTabMessage(0)}},2500)}},_stopTitleMessager:function(){if(this._titleChangeIntervalID){document.title=this._originalTitle;clearInterval(this._titleChangeIntervalID);this._titleChangeIntervalID=null}},_indexOfNextTabMessage:function(e){var t=this._queuedList.length;for(;e<t;e++){if(this._queuedList[e].get("tabMessage")){return e}}return-1},_onWindowFocus:function(e){var t=e.data.self;t._isWindowFocused=true;t._stopTitleMessager();t._processQueue()},_onWindowBlur:function(e){var t=e.data.self;t._isWindowFocused=false},_onCloseClick:function(e){var t=e.data.self,i,s=$(this).parents(".sm-notification");e.preventDefault();if(s.length){i=s.data("smnotification");if(i){t.close(i)}}}};SM.Tooltips={init:function(e){this.enable(e)},enable:function(e){e=SM.Object.extend({selector:"[title]",delay:1500,fadeIn:false,fadeOut:false,fadeTime:250},e);if(!SM.Browser.isOldIE){$(document).on("mouseenter.smtooltips",e.selector,{self:this,delay:e.delay,fadeIn:e.fadeIn,fadeOut:e.fadeOut,fadeTime:e.fadeTime},this._onMouseenter)}},disable:function(e){var t=e?e:"[title]";if(!SM.Browser.isOldIE){$(document).off("mouseenter.smtooltips",t)}},_onMouseenter:function(e){var t=e.data.self,i=e.data.delay,s=e.data.fadeTime,n=e.data.fadeIn,r=e.data.fadeOut,a=$(e.currentTarget),o;if(!a.data("tooltip")){o=t._getAttrs(a);if(!o.text){return}a.data("tooltip",o);a.removeAttr("title");a.on("click.smtooltips mouseleave.smtooltips remove.smtooltips",{self:t,fadeOut:r,fadeTime:s},t._destroy);setTimeout(function(){var e=a.data("tooltip");if(e&&!e.isShown){t._showTipOn(a,n,s)}},i)}},_destroy:function(e){var t=e.data.self,i=$(this),s=e.data.fadeOut,n=e.data.fadeTime,r;r=i.data("tooltip");if(!r){return}if(r.$el){if(s){r.$el.fadeOut(n,function(){r.$el.remove()})}else{r.$el.remove()}}i.off("mouseleave.smtooltips");i.off("remove.smtooltips");i.off("click.smtooltips");i.attr("title",r.text);i.data("tooltip",null)},_showTipOn:function(e,t,i){var s=e.data("tooltip"),n=SM.Object.copy(this._sides[s.side].position),r=this._build(s);s.$el=r;s.isShown=true;if(t){r.hide().appendTo(document.body).fadeIn(i)}else{document.body.appendChild(r[0])}n.of=e;r.position($.migrationFixPosition(n))},_build:function(e){var t=document.createElement("div"),i="tool-tip ";i+=this._sides[e.side].className;if(e.classes){i+=" "+e.classes}t.className=i;t.innerHTML=e.text;return $(t)},_sides:{left:{className:"tool-tip-left",position:{my:"right center",at:"left center",offset:"-5 0",collision:"none"}},right:{className:"tool-tip-right",position:{my:"left center",at:"right center",offset:"5 0",collision:"none"}},top:{className:"tool-tip-top",position:{my:"center bottom",at:"center top",offset:"0 -5",collision:"none"}},bottom:{className:"tool-tip-bottom",position:{my:"center top",at:"center bottom",offset:"0 5",collision:"none"}}},_getAttrs:function(e){return{text:e.attr("title"),side:e.attr("sm-tooltip-side")||"top",classes:e.attr("sm-tooltip-classes")}}};SM.BaseMenuView=SM.Views.register({__NAME:"baseMenuView",__templateID:"base-menu-template"});SM.OptionMenuView=SM.Object.deepExtend({__init:function(){this.bind("focusin",".option",this._onFocusIn).bind("mouseenter",".option",this._onOptionMouseEnter).bind("mouseleave",this._onMouseLeave)},__setters:{currentIndex:function(e,t){e._$options.removeClass("current");if(t===-1){e._$currentOption=null}else{e._$currentOption=e._$options.eq(t).addClass("current")}e._currentIndex=t;e.focusOption(e._currentIndex)},selectedIndex:function(e,t){e._setSelectedIndex(t)}},__getters:{currentIndex:function(e,t){return e._currentIndex}},nextCurrent:function(){var e=this._currentIndex;if(e<this._optionCount-1){this.set("currentIndex",e+1);this.scrollToItem(this._currentIndex)}},prevCurrent:function(){var e=this._currentIndex;if(e>0){this.set("currentIndex",e-1);this.scrollToItem(this._currentIndex)}},selectCurrent:function(){if(this._$currentOption){this._$currentOption.click()}},_$selectedOption:undefined,_$currentOption:undefined,_$options:undefined,_currentIndex:-1,_selectedIndex:-1,_optionCount:0,_refreshOptionData:function(){this._$options=this.$el.find(".option").not(".disabled");this._optionCount=this._$options.length;return this},_setSelectedIndex:function(e){this._$options.removeClass("selected");if(e>=0&&e<this._optionCount){this._$selectedOption=this._$options.eq(e).addClass("selected")}else{this._$selectedOption=undefined}this._selectedIndex=e;return this},scrollToItem:function(e){var t=this.el,i=this._$options.eq(e).parent()[0];if(t.scrollHeight<=t.offsetHeight){return}if(i.offsetTop<t.scrollTop){t.scrollTop=i.offsetTop}else if(i.offsetTop+i.offsetHeight>t.scrollTop+t.clientHeight){t.scrollTop=i.offsetTop+i.offsetHeight-t.clientHeight}return this},focusOption:function(e){var t=this._$options.eq(e);t.focus()},_onOptionMouseEnter:function(e){var t=e.data.self,i=$(this);if(i.hasClass("disabled")){return}t.set("currentIndex",t._$options.index(i))},_onFocusIn:function(e){e.stopPropagation()},_onMouseLeave:function(e){var t=e.data.self;t.set("currentIndex",-1)}});SM.ActionMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"actionMenuView",__templateID:"action-menu-template",__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick)},__afterRender:function(){this._refreshOptionData();if(this.__settings.saveState){if(this.__settings.selectedAction){this._setSelectedAction(this.__settings.selectedAction,true)}else{this._setSelectedIndex(-1,true)}}},__setters:{selectedAction:function(e,t){e._setSelectedAction(t,false)},selectedIndex:function(e,t){e._setSelectedIndex(t,false)},actions:function(e,t){e.__settings.actions=t;e.render()}},hasAction:function(e){return this.$el.find('[data-action="'+e+'"]').length>0},_setSelectedAction:function(e,t){var i=-1,s=this.$el.find('[data-action="'+e+'"]');if(s.length){i=this._$options.index(s)}if(this.__settings.saveState){this._setSelectedIndex(i,t)}this.__settings.selectedAction=e;if(!t&&!(i>=0&&this.__settings.saveState)){this.trigger({type:"actionSelected",action:e,$action:s})}},_setSelectedIndex:function(e,t){var i;if(this.__settings.saveState){SM.OptionMenuView._setSelectedIndex.call(this,e)}if(e>=0&&e<this._optionCount){i=this._$options.eq(e);this.__settings.selectedAction=i.attr("data-action");if(!t){this.trigger({type:"actionSelected",action:i.attr("data-action"),$action:i})}}},_onOptionClick:function(e){var t=e.data.self,i=$(this),s,n=i.attr("href");if(n){s=n.split("#");if(s.length<2){if(i.hasClass("disabled")){e.preventDefault();e.stopPropagation()}else{t.trigger("optionClicked")}return}}e.preventDefault();e.stopPropagation();if(i.hasClass("disabled")){return}t.set("selectedAction",i.attr("data-action"));t.trigger("optionClicked")}});SM.SelectMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"SelectMenuView",__templateID:"select-menu-template",__create:function(){if(this.__settings.loadPage){this._loadedOptions=[]}if(this.__settings.loadSearchPage){this._loadedSearchOptions=[]}},__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click keydown",".option",this._onOptionClick);this.bind("focus",".option",this._onOptionFocus);this.bind("click keydown","[data-pageaction]",this._onPagingClick);this.bind("keydown",".search-bar",this._onSearchSubmit);this.bind("click keydown",".search-button",this._onSearchSubmit);this.bind("click keydown",".clear-search",this._onClearSearch)},__afterRender:function(){this._renderMenu()},__setters:{selectedValue:function(e,t){var i=e._getIndexByValue(t),s;if(i!==-1){e._setSelectedIndex(i);e.__settings.selectedValue=t;s=e._getText(t);e.trigger({type:"change",value:t,displayText:s})}},selectedIndex:function(e,t){var i,s;if(t>=0&&t<e._optionCount){e._setSelectedIndex(t);e.__settings.selectedValue=e._getValueByIndex(t);s=e._getText(e.__settings.selectedValue);e.trigger({type:"change",value:e.__settings.selectedValue,displayText:s})}},options:function(e,t){e.__settings.options=t;e.render()}},__getters:{selectedValue:function(e){return e.__settings.selectedValue;
},valueText:function(e){var t=e.__settings.selectedValue;return e._getText(t)}},VALUE_ATTR:"data-opt-value",inlineSearchOptionsWithSelect:function(e,t){var i=this._optionsText,s=i.length,n=e.length,r=t?this._selectedIndex:this._currentIndex,a;if(!(this.__settings.options||this._isLoaded)){return-1}if(n>1){a=r}else{if(r===-1){a=0}else{a=r+1}}for(a;a<s;a++){if(i[a].substr(0,n)===e){return a}}for(a=0;a<=r;a++){if(i[a].substr(0,n)===e){return a}}return-1},prepareMenuLoad:function(){var e=this.__settings.loadPage!==undefined;if(e){this._loadDynamicPageWithSearch(1,false)}this.scrollToItem(this._selectedIndex);this._focusMenu()},nextSelect:function(){var e=this._selectedIndex;if(e<this._optionCount-1){this.set("selectedIndex",e+1);this.scrollToItem(this._selectedIndex)}},prevSelect:function(){var e=this._selectedIndex;if(e>0){this.set("selectedIndex",e-1);this.scrollToItem(this._selectedIndex)}},_currentIndex:0,_optionsText:undefined,_firstNumOnPage:1,_firstNumOnSearchPage:1,_searchString:null,_showSearchResults:false,_prepopulatedSearchResults:null,_isLoaded:false,_loadedOptions:null,_totalLoadedOptions:0,_loadedSearchOptions:null,_totalLoadedSearchOptions:0,_renderMenu:function(){var e=this.__settings.options,t=this.__settings.numOptionsPerPage,i=e!==undefined,s=this.__settings.paginationEnabled,n=this.__settings.searchEnabled,r=this._showSearchResults,a=r?this._firstNumOnSearchPage:this._firstNumOnPage,o=this.get("selectedValue"),l,u,d,h,c,f,_,p,m,g,S,w="";if(!i){l=this._calculateCurrentPageNum(a);if(this._isDynamicPageLoadedWithSearch(l,r)){u=l-1;d=r?this._loadedSearchOptions[u]:this._loadedOptions[u];h=r?this._totalLoadedSearchOptions:this._totalLoadedOptions}}else{if(r){d=this._prepopulatedSearchResults}else{d=e}h=d.length}c=s&&h>t;if(s){f=r||n&&c}else{f=n}if(f){w+=SM.Template.render("select-search-template",{searchPlaceholderText:this.__settings.searchPlaceholderText,searchString:this._searchString})}if(d&&d.length>0){if(c){m=Math.min(a+t-1,h);if(i){d=d.slice(a-1,m)}w+=SM.Template.render("select-options-template",d);_=a===1;g=this._calculateLastPageFirstNum(h,t);p=a===g;w+=SM.Template.render("select-pagination-template",{firstNumOnPage:a,lastNumOnPage:m,totalOptions:h,isFirstPage:_,isLastPage:p})}else{w+=SM.Template.render("select-options-template",d)}this.trigger("onOptionsLoaded")}else if(!i&&!this._isLoaded){w+=$("#select-options-loading").html()}else if(r){w+=$("#select-search-none").html();this.trigger("onOptionsLoaded")}this.$el.html(w);S=this.$el.find(".selected").last();this._refreshOptionData();this._collectOptionsText();if(o){this._getOptionByValue(o).addClass("selected")}else if(S.length>0){this.set("selectedValue",S.attr("data-opt-value"))}this._focusMenu()},_focusMenu:function(){var e=this.$el.find('[name="searchTerm"]'),t=this.get("selectedValue"),i;if(e.length>0){e.focus()}else{i=this._getOptionByValue(t);if(t&&i.length>0){i.focus()}else{this.$el.find(".option").first().focus()}}},_refreshOptionData:function(){this._$options=this.$el.find(".option");this._optionCount=this._$options.length},_collectOptionsText:function(){this._optionsText=this._$options.map(function(){return $.trim($(this).text().toLowerCase())}).get()},_getText:function(e){return $.trim(this._getOptionByValue(e).text())},_getOptionByValue:function(e){return this.$el.find("["+this.VALUE_ATTR+'="'+e+'"]')},_getIndexByValue:function(e){var t=this._getOptionByValue(e);return this._$options.index(t)},_getValueByIndex:function(e){var t;if(e===-1){return}t=this._$options.eq(e);return t.attr(this.VALUE_ATTR)},_loadDynamicPageWithSearch:function(e,t,i){var s=this,n=e-1,r=this.__settings.numOptionsPerPage,a=r*n+1;if(this._isDynamicPageLoadedWithSearch(e,t)){return}if(t){this.__settings.loadSearchPage(a,r,i).done(function(e){s._isLoaded=true;s._totalLoadedSearchOptions=e.totalOptions;s._loadedSearchOptions[n]=e.options;s._renderMenu()})}else{this.__settings.loadPage(a,r).done(function(e){s._isLoaded=true;s._totalLoadedOptions=e.totalOptions;s._loadedOptions[n]=e.options;s._renderMenu()})}},_onMouseLeave:function(e){return},_onSearchSubmit:function(e){var t=e.data.self,i=$(this),s=t.__settings.loadSearchPage!==undefined,n=$.trim(t.$el.find('[name="searchTerm"]').val()),r;if(i.hasClass("search-button")){if(!SM.A11y.checkClick(e)){return}e.stopPropagation()}else if(i.hasClass("search-bar")){if(!SM.A11y.checkSubmit(e)){return}}if(n.length===0||n===t._searchString){return}else{t._firstNumOnSearchPage=1}t._showSearchResults=true;t._searchString=n;t.$el.find(".clear-search").removeClass("hide");if(s){t._loadedSearchOptions=[];t._totalLoadedSearchOptions=0;r=t._calculateCurrentPageNum(t._firstNumOnSearchPage);t._loadDynamicPageWithSearch(r,true,t._searchString)}else{t._prepopulatedSearchResults=t._searchOptions(t.__settings.options,t._searchString);if(t._prepopulatedSearchResults.length===0){t._firstNumOnSearchPage=0}}t._renderMenu()},_onClearSearch:function(e){var t=e.data.self,i=t.$el.find(".clear-search");if(!SM.A11y.checkClick(e)){return}e.preventDefault();e.stopPropagation();i.addClass("hide");t._prepopulatedSearchResults=null;t._loadedSearchOptions=[];t._totalLoadedSearchOptions=0;t._searchString=null;t._showSearchResults=false;t._firstNumOnSearchPage=1;t._renderMenu()},_onOptionClick:function(e){var t=e.data.self,i=$(this);if(!SM.A11y.checkClick(e)){return}e.preventDefault();e.stopPropagation();if(i.hasClass("disabled")){return}t.set("selectedIndex",t._$options.index(i))},_onPagingClick:function(e){var t=e.data.self,i=t.__settings.loadPage!==undefined,s=$(this),n=s.data("pageaction"),r=t.__settings.numOptionsPerPage,a,o=t._showSearchResults?t._firstNumOnSearchPage:t._firstNumOnPage,l;if(!SM.A11y.checkClick(e)){return}e.stopPropagation();if(t._showSearchResults){a=i?t._totalLoadedSearchOptions:t._prepopulatedSearchResults.length}else{a=i?t._totalLoadedOptions:t.__settings.options.length}switch(n){case"first":o=1;break;case"previous":o-=r;break;case"next":o+=r;break;case"last":o=t._calculateLastPageFirstNum(a,r);break;default:return}if(t._showSearchResults){t._firstNumOnSearchPage=o}else{t._firstNumOnPage=o}t._renderMenu();if(i){l=t._calculateCurrentPageNum(o);t._loadDynamicPageWithSearch(l,t._showSearchResults,t._searchString)}},_onOptionFocus:function(e){var t=$(this),i=e.data.self,s=t.closest("li").index();e.stopPropagation();if(!t.hasClass("current")){i.set("currentIndex",s)}},_calculateLastPageFirstNum:function(e,t){var i=Math.ceil(e/t);if(e===0){return 0}return(i-1)*t+1},_searchOptions:function(e,t){return $.map(e,function(e,i){var s=e.text.toLowerCase(),n=t.toLowerCase();if(s.indexOf(n)!==-1){return e}})},_isDynamicPageLoadedWithSearch:function(e,t){var i,s,n,r=e-1;if(t){i=this._loadedSearchOptions}else{i=this._loadedOptions}s=i.length;if(s>0&&s>=e){loadedPage=i[r];if(loadedPage!==undefined){this._isLoaded=true;return true}}this._isLoaded=false;return false},_calculateCurrentPageNum:function(e){var t=this.__settings.numOptionsPerPage;return Math.ceil(e/t)}});SM.CalendarMenuView=SM.Views.register({__NAME:"calendarMenuView",__templateID:"calendar-menu-template",__init:function(){this.bind("click",".nextBtn",this._onNextMonthClick).bind("click",".prevBtn",this._onPrevMonthClick).bind("click","td.day:not(.out-of-range)",this._onDayClick);if(this.__settings.selectMenus){this.bind("selectMenu.change",".yearSelect",this._onSelectYearChange).bind("selectMenu.change",".monthSelect",this._onSelectMonthChange)}},__beforeRender:function(){var e=this._buildDayHeaders(),t=this.__settings,i,s,n,r,a,o,l,u=Globalize.culture(),d,h;i=SM.Date.getSimpleDate(this._displayDate);s=SM.Date.getSimpleDate(t.minDate);n=SM.Date.getSimpleDate(t.maxDate);r=SM.Date.getSimpleDate(t.selectedDate);a=SM.Date.getSimpleDate(this._currentDate);o=i.year<=s.year&&i.month<=s.month;l=i.year>=n.year&&i.month>=n.month;d=u.calendars.standard.months.names[i.month],h=this._buildDays(i,s,n,r,a);return{weekdays:e,monthName:d,displayDate:i,minDate:s,maxDate:n,currentDate:a,selectedDate:r,isPrevBtnDisabled:o,isNextBtnDisabled:l,selectMenus:t.selectMenus,weeks:h,yearFirst:u.calendar.yearFirst}},__afterRender:function(e){var t,i;if(this.__settings.selectMenus){this.$el.find(".yearSelect").selectMenu({menuView:"YearSelectMenuView",selectWidth:"auto",selectedValue:e.displayDate.year,minYear:e.minDate.year,maxYear:e.maxDate.year});t=0;i=11;if(e.minDate.year&&e.displayDate.year===e.minDate.year){t=e.minDate.month}if(e.maxDate.year&&e.displayDate.year===e.maxDate.year){i=e.maxDate.month}this.$el.find(".monthSelect").selectMenu({menuView:"MonthSelectMenuView",selectWidth:"auto",selectedValue:e.displayDate.month,minMonth:t,maxMonth:i})}},resetDisplayDate:function(e){var t,i=this.__settings=e;this._currentDate=new Date;if(i.selectedDate){t=SM.Date.getSimpleDate(i.selectedDate)}else if(i.minDate&&this._currentDate<i.minDate){t=SM.Date.getSimpleDate(i.minDate)}else if(i.maxDate&&this._currentDate>i.maxDate){t=SM.Date.getSimpleDate(i.maxDate)}else{t=SM.Date.getSimpleDate(this._currentDate)}this._displayDate=new Date(t.year,t.month,1)},_setDisplayDate:function(e,t){var i=new Date(e,t,1);this._currentDate=new Date;this._displayDate=i},_buildDayHeaders:function(){var e=Globalize.culture(),t=e.calendars.standard,i=t.firstDay,s=t.days.names,n=t.days.namesShort,r,a=[],o=7;while(o){r=i<7?i:i-7;a.push({name:s[r],shortName:n[r]});o--;i++}return a},_buildDays:function(e,t,i,s,n){var r=0,a,o,l,u=s.month,d=s.year,h=s.day,c=n.month,f=n.year,_=n.day,p=t.month,m=t.year,g=t.day,S=i.day,w=i.month,v=i.year,M=[],y,b=e.month,D=e.year,C=Globalize.getWeekdayIndexOfFirstDay(b,D),E=SM.Date.getDaysInMonth(b,D),x=p===b&&m===D,V=w===b&&v===D,T=u===b&&d===D,A=c===b&&f===D,R=7*Math.ceil((E+C)/7);while(r<R){y=[];for(a=0;a<7;a++){l=r-C+1;if(r<C||l>E){o={isBlank:true,isFirstEnd:l===E+1}}else{o={number:l,isLast:l===E,isSelected:T&&h===l,isToday:A&&_===l,isOutOfRange:x&&r>=C&&l<g||V&&l>S&&l<=E}}y.push(o);++r}M.push(y)}return M},_onPrevMonthClick:function(e){var t=e.data.self,i=SM.Date.getSimpleDate(t._displayDate),s=$(this);e.preventDefault();e.stopPropagation();if(!s.hasClass("disabled")){t._setDisplayDate(i.year,i.month-1);t.render()}},_onNextMonthClick:function(e){var t=e.data.self,i=$(this),s=SM.Date.getSimpleDate(t._displayDate);e.preventDefault();e.stopPropagation();if(!i.hasClass("disabled")){t._setDisplayDate(s.year,s.month+1);t.render()}},_onSelectYearChange:function(e){var t=e.data.self,i,s,n=t.__settings,r=SM.Date.getSimpleDate(n.minDate),a=SM.Date.getSimpleDate(n.maxDate),o=SM.Date.getSimpleDate(t._displayDate);s=parseInt(e.value,10);i=o.month;if(r.year&&s===r.year&&r.month>o.month){i=r.month}if(a.year&&s===a.year&&a.month<o.month){i=a.month}t._setDisplayDate(s,i);t.render()},_onSelectMonthChange:function(e){var t=e.data.self,i=SM.Date.getSimpleDate(t._displayDate);t._setDisplayDate(i.year,parseInt(e.value,10));t.render()},_onDayClick:function(e){var t=e.data.self,i=$(e.currentTarget),s=parseInt(i.attr("data-day"),10),n=SM.Date.getSimpleDate(t._displayDate);t.trigger({type:"dateSelected",date:new Date(n.year,n.month,s)})}});SM.AutocompleteMenuView=SM.Views.deepExtend(SM.OptionMenuView,{__NAME:"AutocompleteMenuView",__templateID:"autocomplete-menu-template",__defaults:{results:[]},__init:function(){SM.OptionMenuView.__init.call(this);this.bind("click",".option",this._onOptionClick)},__afterRender:function(){this._refreshOptionData()},__setters:{results:function(e,t){e.__settings.results=t;e.render();e.set("currentIndex",-1)}},_onOptionClick:function(e){var t=e.data.self,i=$(this);e.preventDefault();e.stopPropagation();if(i.hasClass("disabled")){return}t.trigger({type:"selected",text:i.text(),value:i.attr("data-value")})}});SM.YearSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"years-select-menu-template",__NAME:"yearSelectMenuView",__defaults:{maxYear:null,minYear:null},__beforeRender:function(){var e=this.__settings.maxYear?this.__settings.maxYear:(new Date).getFullYear(),t=this.__settings.selectedValue,i=this.__settings.minYear,s=[],n=e;for(;n>=i;n--){s.push({text:n,value:n,selected:n===t})}this.__settings.options=s;return this.__settings}});SM.MonthSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"month-select-menu-template",__NAME:"monthSelectMenuView",__defaults:{maxMonth:11,minMonth:0},__beforeRender:function(){var e=this.__settings.maxMonth,t=this.__settings.selectedValue,i=[],s=Globalize.culture(),n=s.calendars.standard.months.namesAbbr,r=this.__settings.minMonth;for(;r<=e;r++){i.push({value:r,text:n[r],selected:r===t})}this.__settings.options=i;return this.__settings}});SM.HourSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"hour-select-menu-template",__NAME:"hourSelectMenuView",__defaults:{militaryTime:false},__beforeRender:function(){var e=0,t=this.__settings.selectedValue,i=[],s=Globalize.getSmartlingCulture(),n=s==="en"?"HH":Globalize.cultures[s].calendar.timeAbbr.h,r;i.push({value:"-1",text:n});if(this.__settings.militaryTime){r=23}else{r=11;e=1;i.push({value:12,text:"12",selected:0===t})}while(e<=r){i.push({value:e,text:e<10?"0"+e:e,selected:t===e});e++}this.__settings.options=i;return this.__settings}});SM.MinuteSelectMenuView=SM.Views.deepExtend(SM.SelectMenuView,{__templateID:"minute-select-menu-template",__NAME:"minuteSelectMenuView",__defaults:{increment:15},__beforeRender:function(){var e=60,t=this.__settings.increment,i=this.__settings.selectedValue,s=[],n=Globalize.getSmartlingCulture(),r=n==="en"?"MM":Globalize.cultures[n].calendar.timeAbbr.m,a=0;s.push({value:"-1",text:r});for(;a<e;a+=t){s.push({value:a,text:a<10?"0"+a:a,selected:i===a})}this.__settings.options=s;return this.__settings}});$.extend(SM.Object,{getOneKey:function(e){for(var t in e){return t}},getOnlyKey:function(e){var t=-1;for(var i in e){t++;if(t>0){throw"getOnlyKey() called on object with more than one key"}}return i},hasOnlyProperty:function(e,t){var i;for(i in e){if(e.hasOwnProperty(i)&&i!==t){return false}}return true}});SM.String.containsWordBoundary=function(e){return $.trim(e).length!==0};SM.String.truncateMiddle=function(e,t,i){if(e.length<=t){return e}i=i||"...";var s=i.length,n=t-s,r=Math.ceil(n/2),a=Math.floor(n/2);return e.substr(0,r)+i+e.substr(e.length-a)};SM.String.NON_BREAKING_HYPHEN=SM.Html.parse("&#8209;")[0].nodeValue;SM.String.NOT_AVAILABLE="Not Available";SM.String.localizeIfNotAvailable=function(e){return e===SM.String.NOT_AVAILABLE?Globalize.localize(SM.String.NOT_AVAILABLE):e};SM.String.textTitle=function(e){var t=$("<div></div>");t.html(e);return t.text()};SM.String.htmlStrip=function(e){return $("<p>"+_.escape(e)+"</p>").text()};SM.AjaxBase={init:function(){},Statuses:{SUCCESS:0,OK:200,NOT_FOUND:404,CONFLICT:409,SERVER_ERROR:500,BAD_GATEWAY:502},get:function(e,t,i){var s={dataType:"json",type:"GET",contentType:"application/json",processData:false,url:e,cache:false,headers:{}},n,r;if(i){$.extend(true,s,i)}if(t){n=new Uri(e);_.each(t,function(e,t){n.addQueryParam(t,e)});s.url=n.toString()}SM.log("Ajax GET:",JSON.stringify(s));r=$.ajax(s);r=this._normalizeRequest(r);return r},post:function(e,t,i){var s={dataType:"json",type:"POST",data:JSON.stringify(t),contentType:"application/json",processData:false,url:e,cache:false,headers:{}},n;if(i){$.extend(true,s,i)}SM.log("Ajax POST:",JSON.stringify(s));n=$.ajax(s);n=this._normalizeRequest(n);return n},destroy:function(e,t,i){var s={dataType:"json",type:"DELETE",data:JSON.stringify(t),contentType:"application/json",processData:false,url:e,cache:false,headers:{}},n;if(i){$.extend(true,s,i)}SM.log("Ajax DELETE:",JSON.stringify(s));n=$.ajax(s);n=this._normalizeRequest(n);return n},_normalizeRequest:function(e){var t=$.Deferred();$.when({dfd:t},e).done(this._done).fail(function(e,i,s){SM.Ajax._fail(t,e,i)});return t},_done:function(e,t){var i=t[0],s=t[1],n=t[2],r=e.dfd;if(i.status===SM.Ajax.Statuses.SUCCESS||i.status===SM.Ajax.Statuses.OK){if(i.data){r.resolve(i.data,s,n)}else{r.resolve(i,s,n)}}else{SM.log("Ajax done but not successful:",JSON.stringify(i));r.reject(i,s,n)}},_fail:function(e,t,i){var s;SM.log("Ajax fail, response text:",t.responseText);try{s=JSON.parse(t.responseText);if(s.status===SM.Ajax.Statuses.CONFLICT){SM.PubSub.publish("HTTP_CONFLICT");return}}catch(n){s={error_message:t.responseText}}e.reject(s,i,t)}};SM.Ajax=$.extend(true,{},SM.AjaxBase);SM.ApiBase={Paths:{},Urls:{},basePath:null,_addUrls:function(e,t){var i=this;_.each(t,function(t,s){i.Urls[s]=e+t})},init:function(e){var t=this;if(!t.basePath&&e){t.basePath=e.basePath;t._addUrls(t.basePath,t.Paths)}},extend:function(e,t){$.extend(true,this,t.API);if(t.Paths){e=e||"";this._addUrls(e,t.Paths)}},FORCE_FAIL:false,_prepare:function(e,t){var i=this.Urls[e];if(!i){throw"Unknown URL Key '"+e+"'"}if(t&&t.replacements){_.each(t.replacements,function(e,t){i=i.replace(e.key,e.value)})}if(this.FORCE_FAIL){i=i+"x"}return i},get:function(e,t,i){var s=this._prepare(e,i);return SM.Ajax.get(s,t,i)},post:function(e,t,i){var s=this._prepare(e,i);return SM.Ajax.post(s,t,i)},destroy:function(e,t,i){var s=this._prepare(e,i);return SM.Ajax.destroy(s,t,i)}};SM.API=$.extend(true,{},SM.ApiBase);SM.LogAPI={Paths:{LOG_INFO:"/ajax/log_info"},API:{hasLogAPI:true,logData:function(e,t,i){if($.type(t)==="string"){t={message:t}}t.level=e;t.url=window.location.href;return this.post("LOG_INFO",t,i)},logInfo:function(e,t){return this.logData("info",e,t)},logWarning:function(e,t){return this.logData("warning",e,t)},logError:function(e,t){return this.logData("error",e,t)},logDebug:function(e,t){return this.logData("debug",e,t)},logUiTrigger:null,logOptions:null,logInit:function(e){if(!e){throw"cannot init BI Logging"}if(!e.webapp){throw"no webapp set for BI Logging"}this.logOptions=e},addLogOptions:function(e){if(!this.logOptions){throw"can't add options - BI logging not init"}if(e){$.extend(true,this.logOptions,e)}},logSetUiTrigger:function(e){this.logUiTrigger=e},logBi:function(e,t){if(!this.logOptions){throw"BI Logging not initialized"}var i=$.extend(true,{ui_trigger:this.logUiTrigger},this.logOptions,e);this.logUiTrigger=null;return this.logInfo(i,t)}}};SM.Error={MAX_ERRLEN:400,init:function(){window.onerror=this._onWindowError},log:function(e,t){var i=e.stack;if(!e){return}if(!e.message){e.message="no message"}if(!e.name){e.name="UndefinedException"}if(SM.DEBUG){setTimeout(function(){if(t){SM.log(t)}if(i){SM.log(i)}throw e},0)}else{if(!t){t="No details."}if(!i){i="No trace."}SM.API.logError({name:e.name,message:e.message,details:t,trace:i})}},makeErrorMessage:function(e,t,i){var s="Unknown Error";if(e.data&&e.data.error_message){s=e.data.error_message}else if(e.exceptionMessage){s=e.exceptionMessage}else if(e.error){s="Error "+e.status+": "+e.error}else{s="Error "+i.status+": "+i.statusText}s=SM.String.truncate(s,this.MAX_ERRLEN,true);return s},_isThirdPartyScript:function(e){var t,i;e=this._parseUrl(e);if(!e||!e.host){return false}t=e.host.split(".");if(t.length!==3){return true}i=window.location.host.split(".");if(t[1]!==i[1]){return true}return false},_parseUrl:function(e){var t;if(!e){return null}t=document.createElement("a");t.href=e;return{raw:t.href,host:t.hostname,scheme:t.protocol,path:t.pathname,query:t.query,hash:t.hash}},_onWindowError:function(e,t,i){if(SM.DEBUG||SM.TEST){return false}else{try{if(SM.Error._isThirdPartyScript(t)){SM.API.logWarning({name:"ThirdPartyException",message:e,scriptUrl:t})}else{SM.API.logError({name:"UncaughtException",message:e})}}catch(s){}window.onerror=undefined;return true}}};SM.Bi={_makeBaseLog:function(e,t){var i={survey_id:SM.API.surveyID,user_id:SM.API.userID};return i},anViewRename:function(e){return SM.API.logBi({action_type:"analyze_view_rename",view_id:e.ID})},anViewDelete:function(e){return SM.API.logBi({action_type:"analyze_view_delete",view_id:e.ID,is_selected:e.isSelected})},anViewRevert:function(e){return SM.API.logBi({action_type:"analyze_view_revert",view_id:e.ID})},anViewSelect:function(e){return SM.API.logBi({action_type:"analyze_view_select",view_id:e.ID})},anViewCreate:function(e){return SM.API.logBi({action_type:"analyze_view_create",view_id:e.ID})},anViewSave:function(e){return SM.API.logBi({action_type:"analyze_view_save",view_id:e.ID})},_makeExportLog:function(e){var t=this._makeBaseLog();_.extend(t,{action_type:"analyze_export_create",export_format:e.format,export_type:e.export_type,include_openended:e.export_data.include_openended,one_question_per_page:e.export_data.forced_page_break,page_dimension:e.export_data.dimension,page_orientation:e.export_data.orientation});if(e.export_type==="full"){t.respondent_id=e.export_data.respondent_id;t.timezone_offset=e.export_data.timezone_offset}return t},exportCreate:function(e){var t=this._makeExportLog(e);return SM.API.logBi(t)},_makeRuleLog:function(e){var t=this._makeBaseLog();_.extend(t,{rule_id:e.ID,rule_type:e.ruleType,rule_family:e.ruleFamily,is_selected:e.selected,has_custom_heading:!!e.customHeader});return t},ruleApplied:function(e){var t=this._makeRuleLog(e);t.action_type="analyze_rule_changed";return SM.API.logBi(t)},ruleCopy:function(e){var t=this._makeRuleLog(e);t.action_type="analyze_rule_copy";return SM.API.logBi(t)},ruleToggle:function(e){var t=this._makeRuleLog(e);t.action_type="analyze_rule_toggle";t.is_selected=!t.is_selected;return SM.API.logBi(t)},ruleRename:function(e){var t=this._makeRuleLog(e);t.action_type="analyze_rule_rename";return SM.API.logBi(t)},ruleDelete:function(e){var t=this._makeRuleLog(e);t.action_type="analyze_rule_delete";return SM.API.logBi(t)},_makeSharedViewLog:function(e){var t=e.get("modes"),i=this._makeBaseLog();_.extend(i,{share_view_id:e.id,is_public:e.is_public,allow_team_export:e.allow_team_export,has_password:e.has_password,hide_open_ended:e.hide_open_ended,mode_summary:_.contains(t,"summary"),mode_browse:_.contains(t,"browse"),mode_trends:_.contains(t,"trends"),branding:e.branding,custom_branding:e.custom_branding,share_enabled:e.enabled,shared_view_id:e.sharable_view_id,default_view_id:e.default_view_id,share_id:e.id});return i},sharedViewSave:function(e){var t=this._makeSharedViewLog(e);t.action_type="analyze_shared_view_save";return SM.API.logBi(t)},sharedViewToggle:function(e){var t=this._makeSharedViewLog(e);t.action_type="analyze_shared_view_toggle";t.share_enabled=!t.share_enabled;return SM.API.logBi(t)},sharedViewRename:function(e){var t=this._makeSharedViewLog(e);t.action_type="analyze_shared_view_rename";return SM.API.logBi(t)},sharedViewVisit:function(e){var t=this._makeSharedViewLog(e);t.action_type="analyze_shared_view_visit";return SM.API.logBi(t)},sharedViewGetWeblink:function(e){var t=this._makeSharedViewLog(e);t.action_type="analyze_shared_view_get_weblink";return SM.API.logBi(t)},sharedViewDelete:function(e){var t=this._makeSharedViewLog(e);t.action_type="analyze_shared_view_delete";return SM.API.logBi(t)},customizeQuestion:function(e,t,i){var s=SM.Object.deepCopy(e);s.action_type="analyze_question_customize";s.question_id=i.ID;s.apply_to_all=t;s.customized_labels="labels"in s;delete s.labels;s.customized_colors="colors"in s;delete s.colors;return SM.API.logBi(s)},answersHide:function(e){var t={action_type:"analyze_answers_hide",question_id:e.ID};return SM.API.logBi(t)},answersUnhide:function(e){var t={action_type:"analyze_answers_unhide",question_id:e.ID};return SM.API.logBi(t)},answersUnhideAll:function(e){var t={action_type:"analyze_answers_unhide_all",question_id:e.ID};return SM.API.logBi(t)},answersEditCombine:function(e){var t={action_type:"analyze_answers_edit_combine",question_id:e.ID};return SM.API.logBi(t)},answersUncombine:function(e){var t={action_type:"analyze_answers_uncombine",question_id:e.ID};return SM.API.logBi(t)},answersCombine:function(e){var t={action_type:"analyze_answers_combine",question_id:e.ID};return SM.API.logBi(t)},_makeRespondentLog:function(e){var t=this._makeBaseLog();_.extend(t,{respondent_id:e.ID,collection_mode:e.details.collection_mode,collector_id:e.details.collector_id,ip_address:e.details.ip_address,status:e.details.status});return t},respondentDelete:function(e){var t=this._makeRespondentLog(e);t.action_type="analyze_respondent_delete";return SM.API.logBi(t)},respondentBrowse:function(){var e={action_type:"analyze_respondent_browse"};return SM.API.logBi(e)},respondentEdit:function(e){var t=this._makeRespondentLog(e);t.action_type="analyze_respondent_edit";return SM.API.logBi(t)},trendsQuestionZoomSelected:function(e,t){var i=this._makeBaseLog();_.extend(i,{action_type:"analyze_trends_question_zoom_change",question_id:e.ID,zoom:t});return SM.API.logBi(i)},trendsSurveyZoomSelected:function(e){var t=this._makeBaseLog();_.extend(t,{action_type:"analyze_trends_survey_zoom_change",zoom:e});return SM.API.logBi(t)},trendsQuestionTrendBySelected:function(e,t){var i=this._makeBaseLog();_.extend(i,{action_type:"analyze_trends_question_trendby_change",question_id:e.ID,trend_by:t});return SM.API.logBi(i)},trendsSurveyTrendBySelected:function(e){var t=this._makeBaseLog();_.extend(t,{action_type:"analyze_trends_survey_trendby_change",trend_by:e});return SM.API.logBi(t)},trendsQuestionChartTypeSelected:function(e,t){var i=this._makeBaseLog();_.extend(i,{action_type:"analyze_trends_question_chart_change",chart_type:t,question_id:e.ID});return SM.API.logBi(i)},trendsSurveyChartTypeSelected:function(e){var t=this._makeBaseLog();_.extend(t,{action_type:"analyze_trends_survey_chart_change",chart_type:e});return SM.API.logBi(t)},trendsQuestionDisplayOptionsSelected:function(e,t){var i=this._makeBaseLog();_.extend(i,{action_type:"analyze_trends_question_display_options_change",question_id:e.ID,display_option:t});return SM.API.logBi(i)},_logBenchmarkingData:function(e){e.log_category="benchmarking";e.has_paid_benchmark=SM.App.survey.dataSegmentList.hasPaidBenchmarks();e.has_restricted=SM.App.survey.owner.benchmarkingRestrictedEnabled;return SM.API.logBi(e)},benchmarkingProfilerDialogOpened:function(e,t){var i=this._makeBaseLog();_.extend(i,{action_type:"profiler_dialog_opened",action_source:t});SM.API.logSetUiTrigger(e);return this._logBenchmarkingData(i)},benchmarkingProfilerDialogClosed:function(e,t,i){var s=this._makeBaseLog(),n=SM.App.survey.dataSegmentList.getSelectedSegment();_.extend(s,{action_type:"profiler_dialog_closed",action_source:t,canceled:i});if(!i){s.segment_name=n.getCanonicalName()}SM.API.logSetUiTrigger(e);return this._logBenchmarkingData(s)},_getQuestionData:function(e){var t=SM.App.survey,i={},s;if(e){s=t.getQuestion(e);if(s){i.logicalId=s.logicalID;i.logicalName=s.logicalName;i.logicalLangId=s.logicalLangId;return i}}},benchmarkingShowHide:function(e,t,i){var s=SM.App.survey.dataSegmentList.getSelectedSegment(),n=this._makeBaseLog(),r=this._getQuestionData(e);_.extend(n,{action_type:"benchmarks_show_hide",show_hide:t,action_source:"question",all:i,segment_name:s.getCanonicalName()});if(r){n.question_id=e;n.logical_question_id=r.logicalId;n.question_name=r.logicalName;n.lang_question_id=r.logicalLangId}SM.API.logSetUiTrigger("benchmarking_show_hide_button");return this._logBenchmarkingData(n)},benchmarkingDownloadCSV:function(e,t,i){var s=this._makeBaseLog(),n=this._getQuestionData(e);_.extend(s,{action_type:"benchmarks_download_csv",segment_id:t,action_source:i});if(n){s.question_id=e;s.logical_question_id=n.logicalId;s.question_name=n.logicalName;s.lang_question_id=n.logicalLangId}SM.API.logSetUiTrigger("benchmarking_download_csv_menu_action");return this._logBenchmarkingData(s)},benchmarkingAbout:function(e,t,i,s){var n=this._makeBaseLog(),r=this._getQuestionData(e);_.extend(n,{action_type:"benchmarks_about",action_source:t,destUrl:i,isNPS:s});if(r){n.question_id=e;n.logical_question_id=r.logicalId;n.question_name=r.logicalName;n.lang_question_id=r.logicalLangId}SM.API.logSetUiTrigger("benchmarking_about_menu_action");return this._logBenchmarkingData(n)},benchmarkingBuyMore:function(e,t,i,s,n,r){var a=this._makeBaseLog(),o=this._getQuestionData(e);_.extend(a,{action_type:"benchmarks_buy",action_source:i,destUrl:s,has_restricted:n,isNPS:r});if(o){a.question_id=e;a.logical_question_id=o.logicalId;a.question_name=o.logicalName;a.lang_question_id=o.logicalLangId}SM.API.logSetUiTrigger(t);return this._logBenchmarkingData(a)},logUserProfileState:function(e,t,i,s,n,r,a,o){var l=this._makeBaseLog();_.extend(l,{log_category:"benchmarking",action_type:"user_scenario_state",has_valid_entity:e,has_collector_profile:t,has_opt_out:i,has_restricted:s,has_paid_benchmark:n,benchmarks_shown:r,question_set:a,gei_fe_shown:o,webapp:SM.API.logOptions.webapp,survey_id:SM.API.logOptions.survey_id});return SM.API.logInfo(l)},logUpsellTooltipOpened:function(e){var t=this._makeBaseLog(),i=this._getQuestionData(e);_.extend(t,{action_type:"upsell_tooltip_opened",action_source:"question"});if(i){t.question_id=e;t.logical_question_id=i.logicalId;t.question_name=i.logicalName;t.lang_question_id=i.logicalLangId}SM.API.logSetUiTrigger("icon");return this._logBenchmarkingData(t)},logProfilerMarketingDialog:function(e,t){var i=this._makeBaseLog();_.extend(i,{action_type:"interstitial_modal_opened",action_source:"accordion",upsell_segment:t});SM.API.logSetUiTrigger(e);return this._logBenchmarkingData(i)},logSegmentSwitch:function(e,t,i){var s=SM.App.survey.isTMBCTemplate(),n=this._makeBaseLog();_.extend(n,{action_type:"benchmarks_segment_switch"});n.action_source=i||"accordion";if(e===""){e=s?"standout_gei_benchmark":"survey_monkey_global_benchmark"}if(t===""){t=s?"standout_gei_benchmark":"survey_monkey_global_benchmark"}n.segment_name=t;n.origin_segment_name=e;return this._logBenchmarkingData(n)},logSegmentRemoved:function(e){var t=this._makeBaseLog();_.extend(t,{action_type:"benchmarks_segment_removed",action_source:"accordion"});t.segment_name=e;return this._logBenchmarkingData(t)}};SM.Ajax=$.extend(true,{},SM.AjaxBase,{init:function(e){SM.AjaxBase.init.call(this);this.appVersion=e},__prepare:function(e){e=e||{headers:{}};if(!e.headers){e.headers={}}e.headers["SM-Analyze-Version"]=this.appVersion;return e},get:function(e,t,i){i=this.__prepare(i);return SM.AjaxBase.get.call(this,e,t,i)},post:function(e,t,i){i=this.__prepare(i);return SM.AjaxBase.post.call(this,e,t,i)},destroy:function(e,t,i){i=this.__prepare(i);return SM.AjaxBase.destroy.call(this,e,t,i)}});SM.AnalyzeAPI={Paths:{FETCH_RESPONSES:"/ajax/respondents/responses",DELETE_RESPONDENT:"/ajax/respondents/delete",FETCH_ROLLUPS:"/ajax/questions/rollups",FETCH_TREND_ROLLUPS:"/ajax/questions/trend_rollups",DELETE_VIEW:"/ajax/view/delete",DUPLICATE_VIEW:"/ajax/view/duplicate",EDIT_VIEW:"/ajax/view/edit",SWITCH_VIEW:"/ajax/view/switch",EXPORT_DELETE:"/ajax/export/delete",EXPORT_CREATE:"/ajax/export/create",EXPORT_LIST:"/ajax/export/list",TA_GET_ROLLUP_QUESTION:"/ajax/ta/rollup/by_question",TA_GET_ROLLUP_SEARCH:"/ajax/ta/rollup/by_search",TA_GET_ROLLUP_PHRASE:"/ajax/ta/rollup/by_phrase",TA_TEXT_TAG_ALL:"/ajax/ta/response_texts/tag_all",TA_TEXT_TAG_EXCEPT:"/ajax/ta/response_texts/tag_except",TA_EDIT_TAG:"/ajax/ta/question_tags/update",TA_DELETE_TAG:"/ajax/ta/question_tags/delete",TA_CREATE_TAG:"/ajax/ta/question_tags/create",BM_GET_BENCHMARK_ROLLUPS:"/ajax/bm/get_benchmark_rollups",MERVEYS_COMPLETE_SURVEY_MERGE:"/ajax/merveys/merge_complete",MERVEYS_SAVE_DISPLAY_OPTIONS:"/ajax/merveys/set_display_options"},API:{fetchRespondentsAnalyze:function(e,t){return this.post("FETCH_RESPONSES",e,t)},createExportAnalyze:function(e,t){return this.post("EXPORT_CREATE",e,t)},getExportListAnalyze:function(e,t){return this.post("EXPORT_LIST",e,t)},taGetRollupQuestionAnalyze:function(e,t){return this.post("TA_GET_ROLLUP_QUESTION",e,t)}}};SM.SharingAPI={Paths:{FETCH_SHARED_RESPONSES:"/ajax/shared-view/{shared_view_key}/respondents/responses",SHARED_VIEWS_EXPORT_CREATE:"/ajax/shared-view/{shared_view_key}/export/create",SHARED_VIEWS_EXPORT_GET:"/ajax/shared-view/{shared_view_key}/export/get",TA_GET_ROLLUP_SHARED_QUESTION:"/ajax/shared-view/{shared_view_key}/ta/rollup/by_question",SHARED_VIEWS_LIST:"/ajax/shared_views{shared_view_path}"},API:{postShared:function(e,t,i){var s=SM.Object.extend({replacements:[{key:"{shared_view_key}",
value:SM.App.sharedView.get("key")}]},i);return this.post(e,t,s)},fetchRespondentsShared:function(e,t){return this.postShared("FETCH_SHARED_RESPONSES",e,t)},createExportShared:function(e,t){return this.postShared("SHARED_VIEWS_EXPORT_CREATE",e,t)},getExportListShared:function(e,t){return this.postShared("SHARED_VIEWS_EXPORT_GET",e,t)},taGetRollupQuestionShared:function(e,t){return this.postShared("TA_GET_ROLLUP_SHARED_QUESTION",e,t)},fetchSharedViewList:function(e,t){t=t||{};if(!t.replacements){t.replacements=[{key:"{shared_view_path}",value:""}]}return this.get("SHARED_VIEWS_LIST",e,t)}}};SM.API=$.extend(true,{},SM.ApiBase,{init:function(e){SM.ApiBase.init.call(this);this.surveyID=e;this.userID=0;this.extend("/analyze",SM.LogAPI);this.logInit({webapp:"analyze",survey_id:e});this.extend("/analyze",SM.AnalyzeAPI);this.extend("/results",SM.SharingAPI)},post:function(e,t,i){var s=SM.Object.extend({survey_id:this.surveyID},t);return SM.ApiBase.post.call(this,e,s,i)},fetchRespondents:function(e,t){if(SM.App.isSharingApp()){return this.fetchRespondentsShared(e,t)}else{return this.fetchRespondentsAnalyze(e,t)}},deleteRespondent:function(e,t){return this.post("DELETE_RESPONDENT",e,t)},fetchRollups:function(e,t){return this.post("FETCH_ROLLUPS",e,t)},fetchTrends:function(e,t){return this.post("FETCH_TREND_ROLLUPS",e,t)},editView:function(e,t){return this.post("EDIT_VIEW",e,t)},deleteView:function(e,t){return this.post("DELETE_VIEW",e,t)},duplicateView:function(e,t){return this.post("DUPLICATE_VIEW",e,t)},switchView:function(e,t){return this.post("SWITCH_VIEW",e,t)},createExport:function(e,t){SM.Bi.exportCreate(e.exportjob);if(SM.App.isSharingApp()){return this.createExportShared(e,t)}else{return this.createExportAnalyze(e,t)}},getExportList:function(e,t){if(SM.App.isSharingApp()){return this.getExportListShared(e,t)}else{return this.getExportListAnalyze(e,t)}},deleteExport:function(e,t){return this.post("EXPORT_DELETE",e,t)},setUser:function(e){this.userID=e},taGetRollupQuestion:function(e,t){if(SM.App.isSharingApp()){return this.taGetRollupQuestionShared(e,t)}else{return this.taGetRollupQuestionAnalyze(e,t)}},taGetRollupSearch:function(e,t){return this.post("TA_GET_ROLLUP_SEARCH",e,t)},taGetRollupPhrase:function(e,t){return this.post("TA_GET_ROLLUP_PHRASE",e,t)},taTagAllText:function(e,t){return this.post("TA_TEXT_TAG_ALL",e,t)},taTagExceptText:function(e,t){return this.post("TA_TEXT_TAG_EXCEPT",e,t)},taDeleteTag:function(e,t){return this.post("TA_DELETE_TAG",e,t)},taCreateTag:function(e,t){return this.post("TA_CREATE_TAG",e,t)},taEditTag:function(e,t){return this.post("TA_EDIT_TAG",e,t)},bmFetchBenchmarkRollups:function(e,t){return this.post("BM_GET_BENCHMARK_ROLLUPS",e,t)},merveysCompleteMerge:function(e,t){return this.post("MERVEYS_COMPLETE_SURVEY_MERGE",e,t)},saveMerveysDisplayOptions:function(e,t){return this.post("MERVEYS_SAVE_DISPLAY_OPTIONS",e,t)}});SM.FunctionTimer={time:function(e,t){var i=(new Date).getTime();e();var s=(new Date).getTime();if(t){SM.log("Took "+(s-i)+"ms to call "+t)}else{SM.log("Took "+(s-i)+"ms")}}};SM.TrendLib={getDefaultScales:function(e,t,i){var s=e/this.HOUR,n=t?this.zoomMapping:this.zoomMapping_inactive,r={},a,o,l;for(l in n){if(s<=n[l]){r.zoom=l;r.zoomMax=l;r.trend=i;r.label=this.getLabelUnit(r.zoom,r.trend);break}}return r},getLabelUnit:function(e,t){if(e==="max"&&_.contains(["quarter","month","week","day"],t)){return"year"}else if(e==="year"&&t==="week"||e==="three_years"&&_.contains(["week","day"],t)){return"month"}else{return t}},checkLabel:function(e){return _.contains(this.timeUnits,e)},smallerTimeUnit:{week:"day",month:"week",quarter:"month",year:"quarter",three_years:"year",max:"quarter"},HOUR:1e3*3600,timeUnits:["day","week","month","quarter","year","three_years","max"],timeIdx:{day:0,week:1,month:2,quarter:3,year:4,three_years:5,max:6},Trend2ZoomOptions:{day:{list:["week","month"],selected:"week"},week:{list:["month","quarter","year"],selected:"month"},month:{list:["quarter","year","three_years"],selected:"quarter"},quarter:{list:["year","three_years","max"],selected:"year"},year:{list:["three_years","max"],selected:"three_years"}},Trend2ZoomOptions_inactive:{day:{list:["week","month"],selected:"week"},week:{list:["month","quarter","year"],selected:"month"},month:{list:["quarter","year","three_years"],selected:"quarter"},quarter:{list:["year","three_years","max"],selected:"year"},year:{list:["three_years","max"],selected:"year"}},trendMapping:{day:24,"7days":24*7,week:24*7,"30days":24*30,month:24*30,quarter:24*30*3,year:24*30*12,three_years:24*30*12*3,max:24*366*15},zoomMapping:{week:24*7,month:24*30,quarter:24*30*3,year:24*30*12,three_years:24*30*12*3,max:24*366*15},zoomMapping_inactive:{month:24*30,quarter:24*30*3,year:24*30*12,three_years:24*30*12*3,max:24*366*15},getBucket:function(e,t){var i={startsAt:SM.TrendLib._getStartOfBucket(e,t).valueOf(),endsAt:SM.TrendLib._getEndOfBucket(e,t).valueOf(),unit:t};return i},_getStartOfBucket:function(e,t){var i,s=this.localize(e),n;switch(t){case"hour":return moment(e).startOf("hour");case"day":return moment(e).startOf("day");case"week":return moment(e).startOf("week");case"month":return moment(e).startOf("month");case"quarter":i=Math.floor(s.month()/3)*3;n=s.month(i);return n.startOf("month");case"year":return moment(e).startOf("year");default:return null}},_getEndOfBucket:function(e,t){var i,s=this.localize(e),n;switch(t){case"hour":return moment(e).endOf("hour");case"day":return moment(e).endOf("day");case"week":return moment(e).endOf("week");case"month":return moment(e).endOf("month");case"quarter":i=Math.floor(s.month()/3)*3+2;n=s.month(i);return n.endOf("month");case"year":return moment(e).endOf("year");default:return null}},getBucketDiff:function(e,t){var i=e/this.HOUR,s=Math.ceil(i/this.trendMapping[t]);return s},getPreviousBucket:function(e,t){var i=this.localize(e.startsAt),s=e.unit;if(t===undefined){t=1}switch(s){case"hour":i.subtract("hour",1*t);return this.getBucket(i,s);case"day":i.subtract("day",1*t);return this.getBucket(i,s);case"week":i.subtract("week",1*t);return this.getBucket(i,s);case"month":i.subtract("month",1*t);return this.getBucket(i,s);case"quarter":i.subtract("month",3*t);return this.getBucket(i,s);case"year":i.subtract("year",1*t);return this.getBucket(i,s);default:return null}},getNextBucket:function(e,t){var i=this.localize(e.startsAt),s=e.unit;if(t===undefined){t=1}switch(s){case"hour":i.add("hour",1*t);return this.getBucket(i,s);case"day":i.add("day",1*t);return this.getBucket(i,s);case"week":i.add("week",1*t);return this.getBucket(i,s);case"month":i.add("month",1*t);return this.getBucket(i,s);case"quarter":i.add("month",3*t);return this.getBucket(i,s);case"year":i.add("year",1*t);return this.getBucket(i,s);default:return null}},getLabelName:function(e,t){var i=Globalize.culture(),s=i.calendars.standard,n=s.months.namesAbbr,r=this.localize(e),a,o,l,u,d;a=r.year();o=r.month();l=r.date();u=r.hour();d=new Date(a,o,l);switch(t){case"year":return a+"";case"quarter":case"month":return n[o]+" "+a;case"week":case"day":return Globalize.format(d,"d");case"hour":return Globalize.normalizeHour(u)+" "+Globalize.format(d,"d");default:return"<invalid-label>"}},toDate:function(e){var t,i,s,n;t=e.year();i=e.month();s=e.date();n=new Date(t,i,s);return Globalize.format(n,"d")},isActive:function(e){return moment().diff(e,"days")<15},localize:function(e){var t=moment.lang();moment.lang(t,{week:{dow:1,doy:4}});return moment(e).zone(moment().zone())},BucketingException:function(e){var t=e.bucketIndex,i=e.trendDatum,s=e.respondentBucket,n="trendBucket#"+t+": start@"+i.start.valueOf()+" ("+i.start.toString()+")"+"; data bucket start@"+s.start+" ("+SM.TrendLib.localize(s.start).toString()+")"+" end@"+s.end+" ("+SM.TrendLib.localize(s.end).toString()+")";return{name:"TrendBucketingException",message:n,toString:function(){return this.name+": "+this.message}}}};SM.ComparedByNps={structure:function(e){var t;e.answers.realRows=e.answers.rows;e.answers.rows=_.map(e.answers.cols,function(e){t=SM.Object.deepCopy(e);t.type="row";return t});delete e.answers.cols;e.type={family:"single_choice",subtype:"net_promoter_score"};return e},rollup:function(e){if(e.type==="matrix"){e.type="simple"}_.each(e.summary.options,function(t){e.summary.options=t.options;if(t.stats){e.summary.stats=t.stats}});return e},choiceSetRevert:function(e,t){var i,s;e.cols=e.rows;i=t.structure.answers.realRows?t.structure.answers.realRows:t.structure.answers.rows;s=_.pluck(i,"id");e.rows={};e.rows[s[0]]=true;return e},choiceSetConvert:function(e){var t=SM.Object.deepCopy(e);t.rows=SM.Object.deepCopy(t.cols);delete t.cols;return t},aggregate:function(e,t){var i=this,s,n,r,a,o,l={};_.each(e,function(e,r){s=t.answers[r];n=i._getDistributedPosition(s.position);a=i.distributed[n].id;if(_.isUndefined(l[a])){l[a]=[]}l[a].push(e)});r={};_.each(l,function(e,t){o=SM.CompositeSummaryBuilder.combineSummaries(e);r[t]=o});return r},answered_subtotals:function(e,t){var i=this,s,n,r,a,o,l={};_.each(e,function(e,r){s=t.answers[r];n=i._getDistributedPosition(s.position);a=i.distributed[n].id;if(_.isUndefined(l[a])){l[a]=0}l[a]+=e});return l},calcScore:function(e,t){var i=this,s,n,r,a=0,o=0,l=0;_.each(e,function(e,r){s=_.findWhere(t,{position:parseInt(r)+1});n=s.position;n=i._getDistributedPosition(n);if(n===0){o+=e.count}else if(n===1){l+=e.count}else{a+=e.count}});if(o+a+l===0){r=0}else{r=Math.round(100*(a-o)/(o+a+l))}return r},mergeCrossedRows:function(e,t){var i=this,s,n,r,a=[];_.each(e,function(e){s=t.answers[e];n=i._getDistributedPosition(s.position);r=i.distributed[n].id;a.push(r)});a=_.uniq(a);return a},distributed:[{text:"Detractors (0-6)",visible:true,position:0,type:"row",id:"Detractors",question_id:null,mediaHTML:"Detractor",is_openended:false},{text:"Passives (7-8)",visible:true,position:1,type:"row",id:"Passives",question_id:null,mediaHTML:"Passive",is_openended:false},{text:"Promoters (9-10)",visible:true,position:2,type:"row",id:"Promoters",question_id:null,mediaHTML:"Promoter",is_openended:false}],detailed:[[1,2,3,4,5,6,7],[8,9],[10,11]],_getDistributedPosition:function(e){if(e<8){return 0}else if(e<10){return 1}else{return 2}},map2DistributedByQuestion:function(e,t){var i=this,s,n=Globalize.localize("Question").substr(0,1),r,a=[];s=n+t.position+": ";_.each(e,function(e){r=_.findWhere(i.distributed,{id:e});r=SM.Object.copy(r);r.text=s+Globalize.localize(r.text);r.mediaHTML=null;r.question_id=t.ID;a.push(r)});return a},map2DistributedBySurvey:function(e,t){var i=this,s,n,r,a=[],o=[];_.each(e,function(e,r){s=t.getAnswer(r);n=i._getDistributedPosition(s.position);o.push(n)});o=_.uniq(o);_.each(o,function(e){r=SM.Object.copy(i.distributed[e]);a.push(r)});return a},getDetailedRows:function(e,t){var i=this,s=i.detailed[e],n,r,a;n=t.family===SM.QuestionModel.QTYPE.single_choice?"row":"column";r=_.map(s,function(e){a=_.findWhere(t.answers,{position:e,type:n});return a});return r},getDistributedOptions:function(e,t){var i=this,s,n,r,a,o=[],l=[];_.each(e,function(e,r){s=t.answers[r];n=i._getDistributedPosition(s.position);l.push(n)});l=_.uniq(l);r="Q"+t.position+": ";_.each(l,function(e){a=SM.Object.copy(i.distributed[e]);a.text=r+a.text;a.question_id=t.ID;o.push(a)});return o},isDistributed:function(e,t){var i=this,s,n,r=0,a=true,o=[0,0,0],l=[7,2,2];_.each(e,function(e,r){s=t.answers[r];n=i._getDistributedPosition(s.position);o[n]++});_.each(o,function(e,t){if(e===0){r++}else if(e!==l[t]){a=false}});if(r===3){return false}else{return a}}};SM.BasicStatsUtils={cols:[{text:"Minimum",visible:true,position:1,type:"column",id:"min",question_id:null},{text:"Maximum",visible:true,position:2,type:"column",id:"max",question_id:null},{text:"Median",visible:true,position:3,type:"column",id:"median",question_id:null},{text:"Mean",visible:true,position:4,type:"column",id:"mean",question_id:null},{text:"Standard Deviation",visible:true,position:5,type:"column",id:"std",question_id:null}],getStructure:function(e){var t=[];_.each(this.cols,function(i){var s=SM.Object.deepCopy(i);s.type=e||s.type;s.text=Globalize.localize(i.text);t.push(s)});return t},hasBasicStats:function(e){var t;if(e.summary.stats){return true}t=_.values(e.summary.options);if(_.size(t)>0){if(t[0].stats){return true}else{t=_.values(t[0].options);if(_.size(t)>0&&t[0].stats){return true}}}return false}};SM.SidiUtils={labelBySidi:function(e,t){var i=this,s;if(t.hasRandomAssignment()){return}s=e.crossed_cols||e.crossed_rows;if(_.size(s)===0){s=e.crossed_rows}_.each(s,function(e,i){var s=t.getAnswer(e);s.sidiLabel=String.fromCharCode(65+i%26);if(Math.floor(i/26)>0){s.sidiLabel+=Math.floor(i/26)+""}})},buildPhrase:function(e,t){var i=_.size(e),s,n,r,a,o;s=_.sortBy(e,function(e){return t.getAnswer(e).sidiLabel});switch(i){case 0:a=null;break;case 1:a=t.getAnswer(s[0]).sidiLabel;break;default:o=[s[i-1]];n=s.slice(0,-1);r=_.map(n,function(e){return t.getAnswer(e).sidiLabel});a=r.join(", ")+" and "+t.getAnswer(o[0]).sidiLabel;break}return a},join:function(e,t){var i=_.size(e),s,n,r;s=_.sortBy(e,function(e){return t.getAnswer(e).sidiLabel});switch(i){case 0:r=null;break;case 1:r=t.getAnswer(s[0]).sidiLabel;break;default:n=_.map(s,function(e){return t.getAnswer(e).sidiLabel});r=n.join("");break}return r}};SM.BaseAnView={currentSaveRequest:undefined,currentRevertRequest:undefined,isDefault:false,isCurrent:false,clone:function(e){var t=this.dump(),i;t.is_default=false;t.is_current=false;t.name=e||t.name+" - "+Globalize.localize("COPY");i=SM.Models.create("AnView",{ID:"new_"+SM.Date.timestamp(),anView:t});i.anviews=this.anviews;return i},save:function(){var e=SM.API.editView({view_data:this.dump(),view_id:this.ID});this.set("lastEditRequest",e);return e}};SM.Models.register("AnViewList",{viewMap:null,viewList:null,currentView:null,defaultView:null,nextSelectedViewID:null,selectedViewID:null,__create:function(e){var t=this;t.survey=e.survey;t.viewMap={};t.viewList=[]},createViewModels:function(e){var t=e.viewMap[e.currentViewID],i=e.viewMap[e.defaultViewID];delete e.viewMap[e.currentViewID];delete e.viewMap[e.defaultViewID];this.selectedViewID=e.selectedViewID;this._initStandardViews(e);this.defaultView=this._initDefaultView(i);this.currentView=this._initCurrentView(t);this.currentView.loadView(t);this.currentView.loadMetadata(t.metadata);this.currentView.on("isDirty.set",{self:this},this._onCurrentViewDirtySet)},__setters:{selectedViewID:function(e,t){var i=e.getView(t),s=e.getView(e.selectedViewID);if(t===e.selectedViewID){return}if(e.currentView.get("isDirty")){e.set("nextSelectedViewID",t,{notify:true})}else{e.selectedViewID=t;e.updateSelectedView();i.set("selected",true,{notify:true});s.set("selected",false,{notify:true})}}},addView:function(e,t){this.viewMap[e.ID]=e;this.viewList.push(e);this._trigger({type:"viewAdded",anViewModel:e,isSelected:t});this._trigger("sizeChanged")},removeView:function(e){var t=this;$.each(this.viewList,function(i,s){if(e.ID===s.ID){t.viewList.splice(i,1);return false}});delete this.viewMap[e.ID];this._trigger("sizeChanged")},deleteView:function(e){var t=this.currentView,i=this.defaultView.ID,s=e.ID===this.get("selectedViewID");if(s){this.set("selectedViewID",this.defaultView.ID)}else if(this.get("nextViewID")===e.ID){this.set("nextViewID",null)}this.removeView(e);return SM.API.deleteView({view_id:e.ID})},copyView:function(e){var t=e.clone(),i=SM.API.duplicateView({source_view_id:e.ID,name:t.get("name")});this.addView(t,false);$.when({self:this,tempID:t.ID},i).done(this._onViewCopySuccess)},_onViewCopySuccess:function(e,t){var i=e.self,s=t[0],n=i.getView(e.tempID);n.ID=s.new_view.view_id;i.viewMap[n.ID]=n;delete i.viewMap[e.tempID];n._trigger("copySuccess")},saveCurrentViewAs:function(e){var t=this.get("selectedViewID"),i=this.get("nextSelectedViewID"),s=this.currentView,n=s.clone(e),r={self:this,tempID:n.ID,switchToNewView:i===null,requestData:{source_view_id:s.ID,name:e}};s.set("isDirty",false,{notify:true});this.addView(n,r.switchToNewView);this.currentView._trigger("savedToNewView");$.when(r,this.currentView.get("lastEditRequest")).always(this._makeSaveAsRequest);if(i){this.set("selectedViewID",i)}},_onViewSaveAsSuccess:function(e,t){var i=e.self,s=t[0],n=i.getView(e.tempID);n.ID=s.new_view.view_id;i.viewMap[n.ID]=n;delete i.viewMap[e.tempID];n._trigger("createSuccess");if(e.switchToNewView){i.set("selectedViewID",n.ID)}},getView:function(e){if(this.currentView.ID===e){return this.currentView}return this.viewMap[e]},getSelectedView:function(){return this.getView(this.get("selectedViewID"))},_initCurrentView:function(e){var t=SM.Models.create("CurrentAnView",{ID:e.view_id});t.anviews=this;t.on("committed",{self:this},this._onCurrentViewCommitted);return t},_initDefaultView:function(e){var t=this,i=e.view_id,s=SM.Models.create("DefaultAnView",{ID:i,anView:e,survey:t.survey});s.anviews=this;s.loadDisplayData();this.viewMap[i]=s;this.viewList.push(s);return s},_makeSaveAsRequest:function(e,t){var i=SM.API.duplicateView(e.requestData);$.when(e,i).done(e.self._onViewSaveAsSuccess)},_initStandardViews:function(e){var t=this,i=e.viewMap,s;$.each(i,function(e,i){s=SM.Models.create("AnView",{ID:e,anView:i});t.viewMap[e]=s;t.viewList.push(s);s.anviews=t})},updateSelectedView:function(){var e={pageIndex:this.survey.state.get("page"),self:this,timestamp:SM.Date.timestamp()},t=this.getView(this.get("selectedViewID")),i=this.currentView.get("lastSwitchRequest");this.currentView.set("lastSwitchStamp",e.timestamp);this._trigger({type:"selectedViewChanged",viewID:this.get("selectedViewID")});$.when(e,i).always(function(){e.self._makeSwitchViewRequest(e)})},_makeSwitchViewRequest:function(e){var t=e.self,i=t.currentView,s,n=t.survey.state.get("mode");if(i.get("lastSwitchStamp")===e.timestamp){s=SM.API.switchView({selected_view_id:t.get("selectedViewID"),utc_offset:SM.Date.utcOffset(),mode:n});i.set("lastSwitchRequest",s,{notify:true});$.when(e,s).done(t._onViewSwitched).fail(function(i){t._onViewSwitchedFailed(e,i)})}},_onViewSwitched:function(e,t){var i=e.self,s=t[0],n=i.currentView,r=s.current_view.selected_view_id,a=i.getView(r),o=a.isDefault?a.metadata:s.current_view.metadata;if(n.get("lastSwitchStamp")===e.timestamp){$.extend(true,[],s.current_view.metadata);a.metadata=$.extend(true,[],o);n.loadView(s.current_view);n.loadMetadata(o);i._trigger({type:"selectedViewLoaded",anViewModel:a,pageIndex:e.pageIndex,timestamp:e.timestamp,respondentData:s.respondent_data,benchmarkData:s.benchmark_data});a.set("isLoaded",true,{notify:true})}},_onViewSwitchedFailed:function(e,t){var i=t&&t.request_id,s=this.get("selectedViewID"),n=this.getView(s);this.currentView.set("failedLoadRequestID",i,{notify:true})},_onCurrentViewCommitted:function(e){var t=e.data.self,i=t.get("nextSelectedViewID");if(i){t.set("selectedViewID",i)}},_onCurrentViewDirtySet:function(e){var t=e.data.self;if(e.value===true&&t.nextSelectedViewID!==null){t.set("nextSelectedViewID",null,{notify:true})}}});SM.Models.extend("AnView",SM.BaseAnView,{__create:function(e){var t=e.anView;this.ID=e.ID;this.show=t.show;if(this.show.selected===null){this.show.selected=false}this.metadata=t.metadata;this.name=t.name;this.viewType=t.type;this.isDirty=false;this.loadFailed=false},dump:function(){return{view_id:this.ID,survey_id:this.anviews.survey.ID,is_current:false,is_default:false,selected_view_id:null,name:this.name,page:null,show:this.show,type:this.viewType}}});SM.Models.extend("DefaultAnView",SM.BaseAnView,{__setters:{page:function(e,t){if(e.page!==t){e.page=t;if(!SM.App.isSharingApp()){e.save()}}}},isDefault:true,_displayData:{},METADATA_COMPARE_PREFIX:"compare:",__create:function(e){var t=this,i=e.anView;t.survey=e.survey;t.ID=e.ID;t.name=Globalize.localize(i.name);t.viewType=i.type;t.metadata=i.metadata;t.page=i.page;t.show={pages:null,questions:null,selected:false};t.filter=null;t.compare=null},loadDisplayData:function(){var e=this,t;_.each(e.metadata,function(i){t=i.question_id;if(_.isEmpty(e._displayData[t])){e._displayData[t]={}}e._displayData[t][i.key]=i.value;if(i.option_id==="None"){i.option_id=null}})},appliedSidi:function(){var e=this,t;t=_.some(e._displayData,function(e){return e.show_sig_diffs===SM.QuestionDisplayModel.DISPLAY_VALUES.show});return t},appliedSidiAll:function(){var e=this,t=e._displayData["0"];if(_.isEmpty(t)){return false}return t.show_sig_diffs===SM.QuestionDisplayModel.DISPLAY_VALUES.show},updateSidiAll:function(e){var t=this,i;i={show_sig_diffs:e?SM.QuestionDisplayModel.DISPLAY_VALUES.show:SM.QuestionDisplayModel.DISPLAY_VALUES.hide};t.updateSharedDisplayData({updates:i,deletedKeys:["show_sig_diffs"],untypedKeys:SM.QuestionDisplayModel.UNTYPED_DISPLAY_OPTIONS,isCompared:true})},getDisplayData:function(e,t){t=t||{};var i=this,s=i._displayData[e],n=i._displayData["0"],r=!!t.forTrends;if(_.isEmpty(s)){s={}}if(!r&&!!n){s=SM.Object.extend(n,s)}s=SM.Object.deepCopy(s);return s},_typifyUpdates:function(e,t,i){var s=this,n=s.getDisplayData(e),r={},a,o=i.isCompared,l=i.untypedKeys,u=s.METADATA_COMPARE_PREFIX;_.each(t,function(e,t){a=u+t;if(o){if(!l[t]){r[a]=e}else{if(n[a]!==undefined){r[a]=e}r[t]=e}}else{r[t]=e}});return r},updateDisplayData:function(e,t,i){var s=this,n,r=s._displayData[e],a;i=i||{};if(_.isEmpty(r)){r=s._displayData[e]={}}t=s._typifyUpdates(e,t,i);_.each(t,function(t,i){if(_.isEmpty(r[i])){a=s.buildDisplayMetadatum(e,i,t);s.metadata.push(a)}else{s.updateDisplayMetadatum(e,i,t)}r[i]=t});if(i.save!==false){n=s.save();n.done(i.done).fail(i.fail)}},deleteDisplayData:function(e,t,i){var s=this,n,r=i.isCompared,a=i.untypedKeys,o,l,u,d;i=i||{};if(!_.isArray(e)){e=[e]}_.each(e,function(e){l=s._displayData[e];if(!_.isEmpty(l)){_.each(t,function(t){o=s.METADATA_COMPARE_PREFIX+t;t=r&&!a[t]?o:t;delete l[t];u=_.filter(s.metadata,function(i){return i.question_id===e&&i.view_id===s.ID&&i.key===t});if(u){_.each(u,function(e){d=_.indexOf(s.metadata,e);s.metadata.splice(d,1)})}})}});if(i.save!==false){n=s.save();n.done(i.done).fail(i.fail)}},updateSharedDisplayData:function(e){var t=this,i,s=e.updates,n=e.deletedKeys,r=e.untypedKeys,a=e.isCompared,o;var l=[],u=[];_.each(t.survey.questionRollups.questions,function(e){if(e.question.subtype==="net_promoter_score"){u.push(e.questionID)}else{l.push(e.questionID)}});t.updateDisplayData("0",s,{save:false,isCompared:a,untypedKeys:r});t.deleteDisplayData(l,n,{save:false,isCompared:a,untypedKeys:r});if(u.length>0){o=["show_chart","show_table"];t.deleteDisplayData(u,o,{save:false,isCompared:a,untypedKeys:r})}if(e.noSave!==false){i=t.save();i.done(e.done).fail(e.fail)}},findMetadatumByQuestionIDAndKey:function(e,t){var i=this,s;s=_.filter(i.metadata,function(i){return i.question_id===e&&i.key===t});return _.last(s)},updateDisplayMetadatum:function(e,t,i){var s=this,n=s.findMetadatumByQuestionIDAndKey(e,t);if(n){n.value=i}},buildDisplayMetadatum:function(e,t,i){var s=this;return{view_id:s.ID,metadata_id:null,question_id:e,option_id:null,key:t,value:i}},isBenchmarkingShownForAnyQuestion:function(){var e=this,t;t=_.filter(e.metadata,function(e){return e.key==="show_benchmark"&&e.value==="show"});return t.length>0},setBenchmarkSegments:function(e,t){var i={updates:{benchmark_segments:e},deletedKeys:["benchmark_segment"]};$.extend(i,t);this.updateSharedDisplayData(i)},getBenchmarkSegments:function(){var e=this.getDisplayData();return e.benchmark_segments},setDriverState:function(e,t){var i={updates:{driver_state:e},deletedKeys:["show_tmbc_benchmark","tmbc_chart_type"]};$.extend(i,t);this.updateSharedDisplayData(i)},getDriverState:function(){var e=this.getDisplayData();return e.driver_state||{}},enableAllBenchmarks:function(e){var t=this,i=e?"show":"hide",s={show_benchmark:i},n=this.anviews.survey.getAllBenchmarkableQuestionIds();_.each(n,function(e,i){t.updateDisplayData(e,s,{save:false})});if(this.anviews.survey.isTMBCTemplate()){this.survey.tmbc.setTMBCShowHide(SM.TMBCModel.TMBC_TYPE_ALL,e,{save:false})}var r=_.filter(t.metadata,function(e){return e.key==="show_benchmark"&&e.value!==i});if(r.length>0){_.each(r,function(e){e.value=i});SM.API.logWarning({name:"Duplicate Metadata",message:"Survey "+this.survey.ID+" has "+r.length+" duplicate show_benchmark flags"})}r=_.filter(t.metadata,function(e){return e.key!=="show_tmbc_benchmark"&&e.key!=="tmbc_chart_type"});t.metadata=r;return t.save()},enableDisableInlineProfiler:function(e,t,i){var s={updates:{show_inline_profiler:e?"show":"hide"}};if(t){s.done=t}if(i){s.fail=i}this.updateSharedDisplayData(s)},dump:function(){return{view_id:this.ID,survey_id:this.anviews.survey.ID,page:this.page,is_current:false,is_default:true,selected_view_id:null,name:this.name,filter:null,compare:null,type:this.viewType,show:{pages:null,questions:null,selected:false},metadata:this.metadata}},copy:function(){SM.Error.log({name:"DefaultViewCopyException",message:"Cannot copy the default view"})}});SM.Models.extend("CurrentAnView",SM.BaseAnView,{lastSaveTimeStamp:-1,lastSaveRequest:null,__setters:{isDirty:function(e,t,i){e.isDirty=t;e.anviews.getSelectedView().set("isDirty",t,i)},failedLoadRequestID:function(e,t){var i=t!==null;e.anviews.getSelectedView().set("loadFailed",i,{notify:i});e.failedLoadRequestID=t}},__create:function(e){this.ID=e.ID;this.isDirty=false;this.lastSwitchStamp=-1;this.lastSwitchRequest=null;this.rules=null;this.metadataLoaded=false;this.isCurrent=true;this.isSaving=false},loadView:function(e){this.show=e.show;this.viewType=e.type;this.anviews.survey.updateShownLists(this.show,{notify:false});this.metadataLoaded=false},loadMetadata:function(e){var t=this,i=[];this._clearRuleModels();this.metadata=e;_.each(e,function(e,s){if(t._metadataIsRule(e)){i.push(e)}});i.sort(function(e,t){return e.metadata_id-t.metadata_id});this._createRuleModels(i);this.isDirty=false;this.metadataLoaded=true;this.set("failedLoadRequestID",null);this.set("isDirty",this._getDirtyState())},hasShowRule:function(){return this.showRule!==null},hasCompareRule:function(){return this.compareRule!==null},hasFilterRule:function(){var e=this;return _.size(e.getFilterRulesSelected())>0},getFilterRulesSelected:function(){var e=this,t=SM.BaseAnRule.FAMILY_TYPES,i=[];_.each(this.ruleList,function(e){if(e.get("selected")&&e.get("ruleFamily")===t.FILTER){i.push(e)}});return i},getCompareRuleSelected:function(){var e=this,t;_.each(this.ruleList,function(e){if(e.get("selected")&&e.isCompare){t=e}});return t},hasRAFilterSelected:function(){var e=this,t,i={};t=e.getFilterRulesSelected();i=_.find(t,function(e){return e.isRA});return!!i},hasRACompareSelected:function(){var e=this,t,i={};t=e.getCompareRuleSelected();return t?t.isRA:false},deleteRule:function(e){var t=this.ruleList,i=this.rules[e],s=this.anviews.defaultView.ID===this.anviews.get("selectedViewID");this._unbindRuleEvents(this.rules[e]);delete this.rules[e];$.each(t,function(i,s){if(e===s.ID){t.splice(i,1);return false}})},revert:function(){var e=this.anviews.getSelectedView();this.loadView(e.dump());this.set("isDirty",false,{notify:true});this.anviews.updateSelectedView()},commitChanges:function(){var e,t=this.anviews.getSelectedView(),i=this.dump().metadata,s;t.metadata=i;$.each(i,function(e,i){i.metadata_id=null;i.view_id=t.ID});t.show=this.show;s=t.dump();s.metadata=i;this.set("isDirty",false,{notify:true});this._trigger("committed");return SM.API.editView({view_data:s,view_id:t.ID})},addRule:function(e){this._bindRuleEvents(e);this.ruleList.push(e);this.rules[e.ID]=e;if(e.isShow){this._onShowRuleChanged(e);this.save()}else{if(e.isCompare&&e.get("selected")){if(this.compareRule){this.compareRule.set("selected",false,{notify:true})}this.compareRule=e}this.set("isSaving",true,{notify:true})}this._trigger({type:"ruleAdded",ruleModel:e})},dump:function(){var e,t=this.anviews.get("selectedViewID").toString();if(this.metadataLoaded){e=[];_.each(this.ruleList,function(t){if(!t.get("isCorrupt")){e.push(t.dump())}})}return{view_id:this.ID,survey_id:this.anviews.survey.ID,is_current:true,is_default:false,page:null,selected_view_id:t,name:"Current View",show:this.show,type:this.viewType,metadata:e}},hasActiveShowRule:function(){return this.show.selected},save:function(){var e=this,t={self:this,timestamp:SM.Date.timestamp()};this.set("isSaving",true,{notify:true});this.set("isDirty",this._getDirtyState(),{notify:true});this.set("lastSaveTimeStamp",t.timestamp);$.when(t,this.get("lastSaveRequest")).always(function(){e._makeSaveRequest(t)})},invalidateNewRules:function(){$.each(this.ruleList,function(e,t){if(!t.isPersisted()){t.set("isCorrupt",true,{notify:true})}})},_metadataIsRule:function(e){return e.key.indexOf(SM.BaseAnRule.BASE_RULE_METADATA_KEY)>=0},_getDirtyState:function(){var e=this,t=false,i=this.dump().metadata,s=i.length,n=false,r=this.anviews.getSelectedView(),a=$.extend(true,[],r.metadata);if(r.isDefault){return this.ruleList.length>0}if(a.length!==s){return true}$.each(i,function(i,s){if(e._metadataIsRule(s)){t=true;$.each(a,function(i,r){n=e._checkMetadataEquality(s,r);if(n){t=false;a.splice(i,1);return false}});if(t){return false}}});if(!t){t=!SM.Object.equals(this.show,r.show)}return t},_checkMetadataEquality:function(e,t){var i=true;try{if(e.value.selected!==t.value.selected){i=false}else{_.each(e.value,function(e,s){if(s!=="answers"){if(!SM.Object.equals(t.value[s],e)){i=false;return}}});if(e.value.answers&&t.value.answers){if(!SM.Object.equals(e.value.answers[0],t.value.answers[0])){i=false}}}}catch(s){SM.Error.log(s,"error comparing metadata");i=false}return i},_makeSaveRequest:function(e){var t=this,i=SM.API.editView({view_data:this.dump(),view_id:this.ID});this.set("lastSaveRequest",i);$.when(i,e).done(this._onSaveSuccess).always(function(){t._onSavedAlways(e)})},_onShowRuleChanged:function(e){this.show=e.get("show");this.anviews.survey.updateShownLists(this.show,{notify:true});this._trigger({type:"showRuleChanged",ruleModel:e})},_createRuleModels:function(e){var t=this,i,s,n;$.each(e,function(e,r){i=r.value;n={ID:r.metadata_id,attrs:i,isCorrupt:r.is_corrupt};s=SM.BaseAnRule.FactoryCreate(n,t.anviews.survey);s.loadSurvey(t.anviews.survey);if(s.isShow){t.showRule=s}if(s.isCompare&&s.get("selected")){t.compareRule=s}t.ruleList.push(s);t.rules[s.ID]=s;t._bindRuleEvents(s)})},_clearRuleModels:function(){var e=this;if(this.ruleList){$.each(this.ruleList,function(t,i){e._unbindRuleEvents(i)})}this.showRule=null;this.compareRule=null;this.ruleList=[];this.rules={}},_bindRuleEvents:function(e){e.on("customHeading.changed",{self:this},this._onRuleRenamed);e.on("ruleEdited",{self:this},this._onRuleEdited);e.on("ruleDeleted",{self:this},this._onRuleDeleted)},_unbindRuleEvents:function(e){e.off("customHeading.changed",this._onRuleRenamed);e.off("ruleEdited",this._onRuleEdited);e.off("ruleDeleted",this._onRuleDeleted)},_onRuleEdited:function(e){var t=e.ruleModel,i,s=e.data.self,n=t.get("selected");if(t.isShow){s._onShowRuleChanged(t);s.save()}else{if(t.isCompare){i=s.compareRule;if(i&&t!==i&&t.get("selected")){i.set("selected",false,{notify:true})}s.compareRule=n?t:null}s.set("isSaving",true,{notify:true})}s._trigger({type:"ruleEdited",ruleModel:t})},_onRuleRenamed:function(e){var t=e.data.self;t.save()},_onRuleDeleted:function(e){var t=e.data.self,i=e.ruleModel;t.deleteRule(i.ID);if(i.isShow){t.showRule=null;t._onShowRuleChanged(i);t.save()}else{if(!i.get("selected")){t.save()}else{if(i.isCompare){t.compareRule=null}t.set("isSaving",true,{notify:true})}}t._trigger({type:"ruleDeleted",ruleModel:i})},_onSaveSuccess:function(e,t){var i=e[0],s=i.created_metadata_ids,n=t.self;if(n.get("lastSaveTimeStamp")===t.timestamp){n.metadata=i.view_edited.metadata;if(!s){return}$.each(s,function(e,t){var i=n.rules[t];if(i){n.rules[e]=i;delete n.rules[t];i.ID=e}})}},_onSavedAlways:function(e){if(this.get("lastSaveTimeStamp")===e.timestamp){this.set("isSaving",false,{notify:true})}}});SM.Models.register("SharedView",{BASE_URL:"/results/ajax/shared_views",TYPES:{WEB_LINK:"weblink"},MODES:{SUMMARY:"summary",TRENDS:"trends",BROWSE:"browse"},BRANDING:{DEFAULT:"default",CUSTOM:"custom",NONE:"none"},__create:function(e){_.extend(this,{DEFAULT_NAME:Globalize.localize("Shared Data"),
survey:e.survey,list:e.list,index:e.index,id:e.attrs.id});this.load(e.attrs)},isNew:function(){return!this.id},attributes:function(){var e=this,t={id:e.id,survey_id:e.get("survey_id"),default_view_id:e.get("default_view_id"),sharable_view_id:e.get("sharable_view_id"),key:e.get("key"),type:e.TYPES.WEB_LINK,domain:e.get("domain"),modes:e.get("modes"),enabled:e.get("enabled"),password:e.get("password"),name:e.get("name"),title:e.get("title"),description:e.get("description"),branding:e.get("branding"),hide_open_ended:e.get("hide_open_ended"),is_public:e.get("is_public"),team_only_share:e.get("team_only_share"),allow_team_export:e.get("allow_team_export")};if(!e.get("has_password")){t.password=null}if(!t.team_only_share){t.allow_team_export=false}return t},load:function(e){var t=this;t._setDefaults();_.each(e,function(e,i){t.set(i,e,{notify:false})});if(t.shareGroup()!==this.GROUP_SETTINGS.passwordShare){t.set("password",null)}},_setDefaults:function(){if(_.isEmpty(this.get("modes"))){this.set("modes",["summary"])}if(_.isEmpty(this.get("name"))){this.set("name",this._getDefaultName())}if(_.isEmpty(this.get("title"))){this.set("title",this.survey.get("title"))}if(_.isEmpty(this.get("domain"))){var e,t;if(this.groupDomainLinkEnabled()){t=this.survey.owner.getEnterpriseGroupDefaultDomain();e=t.split(".")[0]}else{e=this.getCultureSubdomain();t=new Uri(document.location.href).host();if(t.indexOf(e)!==0){var i=t.split(".");i[0]=e;t=i.join(".")}}this.set("domain",t)}if(_.isEmpty(this.get("type"))){this.set("type",this.TYPES.WEB_LINK)}if(_.isNull(this.get("enabled"))||_.isUndefined(this.get("enabled"))){this.set("enabled",true)}if(_.isNull(this.get("branding"))||_.isUndefined(this.get("branding"))){this.set("branding",this.BRANDING.DEFAULT)}if(_.isNull(this.get("hide_open_ended"))||_.isUndefined(this.get("hide_open_ended"))){this.set("hide_open_ended",true)}if(_.isNull(this.get("is_public"))||_.isUndefined(this.get("is_public"))){this.set("is_public",false)}if(_.isUndefined(this.get("allow_team_export"))){this.set("allow_team_export",false)}if(_.isNull(this.get("team_only_share"))||_.isUndefined(this.get("team_only_share"))){this.set("team_only_share",false)}},_getDefaultName:function(){var e=this.isNew()?this.survey.sharedViews.list.length:this.index;return this.DEFAULT_NAME+" "+Globalize.format(e+1,"n0")},loadView:function(e){this.sourceView=e},SHARED_VIEW_KEY:"SHARED_VIEWS_LIST",SHARED_VIEW_PATH_KEY:"{shared_view_path}",_getSharedViewOptions:function(e){var t={replacements:[]};e=e||"";if(this.isNew()){t.replacements.push({key:this.SHARED_VIEW_PATH_KEY,value:""})}else{t.replacements.push({key:this.SHARED_VIEW_PATH_KEY,value:"/"+this.key+e})}return t},save:function(){var e=this,t,i;e._setDefaults();t=e.attributes();SM.log(t);i=SM.API.post(this.SHARED_VIEW_KEY,t,e._getSharedViewOptions());$.when(i,{self:this}).done(function(t,i){var s=t[0]["shared_view"];e.load(s);e.survey.sharedViews.add(e);e._trigger("saved",{notify:true})}).fail(function(){SM.log("failed!")});return i},destroy:function(){var e=this,t;t=SM.API.destroy(this.SHARED_VIEW_KEY,{survey_id:e.get("survey_id")},e._getSharedViewOptions());$.when(t,{self:this}).done(function(){e.survey.sharedViews.remove(e)}).fail(function(){SM.log("destroy failed")});return t},isSocialShareable:function(){return(this.isPublic()||this.isWebLink())&&!this.isEnterpriseTeam()},GROUP_SETTINGS:{publicShare:"share-group-public",enterpriseShare:"share-group-enterprise",passwordShare:"share-group-password",linkShare:"share-group-link"},shareGroup:function(){var e=this,t=null;if(e.isEnterpriseTeam()){t=this.GROUP_SETTINGS.enterpriseShare}else if(e.isPassword()){t=this.GROUP_SETTINGS.passwordShare}else if(e.isPublic()){t=this.GROUP_SETTINGS.publicShare}else{t=this.GROUP_SETTINGS.linkShare}return t},shareGroupLabel:function(){var e=this,t,i="";if(e.isEnterpriseTeam()){t=Globalize.localize("Enterprise Group")}else if(e.isPassword()){t=Globalize.localize("Password Restricted")}else if(e.isPublic()){t=Globalize.localize("Public")}else{t=Globalize.localize("Anyone with the Link")}return t},allowTeamExport:function(){return this.get("allow_team_export")},getCultureSubdomain:function(){var e=Globalize.findClosestCulture(this.survey.language.code);if(e){switch(e.language){case"en":return"www";case"ja":return"jp";default:return e.language}}else{return new Uri(document.location.href).getSubDomains()[0]}},sharedPageURL:function(){var e=new Uri;e.setProtocol("https");e.setHost(this.get("domain"));e.setPath(this.sharedPagePath());return e.toString()},sharedPagePath:function(){return"/results/"+this.key+"/"},toggleMode:function(e,t){var i=this,s=i.get("modes"),n=_.contains(s,e),r;if(t&&!n){s.push(e)}if(!t&&n){r=_.indexOf(s,e);s.splice(r,1)}i.set("modes",s)},hideOpenEnded:function(){return this.get("hide_open_ended")},hasCustomTitle:function(){var e=this.get("title");return!_.isEmpty(e)&&e!==this.survey.get("title")},hasDescription:function(){return!_.isEmpty(this.get("description"))},hasCustomName:function(){var e=this.get("name");return!_.isEmpty(e)&&e!==this._getDefaultName()},hasPassword:function(){return this.get("has_password")},canHavePassword:function(){return!this.survey.owner.isBasic()},canHaveTrends:function(){return this.survey.owner.hasTrends()},isEnterpriseAccount:function(){return this.survey.owner.isEnterprisePlatinum()},isTrendsTabEnabled:function(){return _.contains(this.get("modes"),this.MODES.TRENDS)&&this.survey.owner.hasTrends()},isBrowseTabEnabled:function(){return _.contains(this.get("modes"),this.MODES.BROWSE)},isEnabled:function(){return this.get("enabled")},isPublic:function(){return this.get("is_public")},isEnterpriseTeam:function(){return this.get("team_only_share")},isWebLink:function(){return this.get("type")===this.TYPES.WEB_LINK},isPassword:function(){return this.canHavePassword()&&this.hasPassword()},toggleEnabled:function(){this.set("enabled",!this.get("enabled"),{notify:true});this.save()},incrementNumViews:function(){SM.API.post(this.SHARED_VIEW_KEY,{survey_id:this.survey.ID},this._getSharedViewOptions("/increment"))},groupDomainLinkEnabled:function(){if(this.isEnterpriseAccount()){return this.survey.owner.enterprisePreferences.custom_domain_enabled}return false},hasEnterpriseDomainOptions:function(){var e=this.survey.owner;return e.isEnterprisePlatinum()&&e.getEnterpriseGroupDomains().length>1},getSelectedDomain:function(){return this.survey.owner.getEnterpriseGroupDefaultDomain()},canCustomizeBranding:function(){return!(this.survey.owner.isBasic()||this.survey.owner.isSelect()||this.survey.owner.isZoomPro())},canCustomizeDomain:function(){if(this.survey.owner.isPlatinum())return true;return this.survey.owner.isEnterprisePlatinum()&&this.hasEnterpriseDomainOptions()},hasHiddenBranding:function(){return this.get("branding")===this.BRANDING.NONE},setBranding:function(e,t){if(e==="none"){e=t?this.BRANDING.NONE:this.BRANDING.DEFAULT}this.set("branding",e)}});SM.Models.register("Survey",{TEMPLATE_TYPES:{SHRM:"shrm",CSAT:"csat",EVENT:"event",NPS:"nps",TMBC:"tmbc"},TEMPLATE_NAMES_BY_TYPE:{shrm:"shrm_employee_engagement_survey_template",csat:"customer_satisfaction_template_revised",event:"general_event_feedback_template",nps:"net_promoter_score_template",tmbc:"standout_globalengagement_index_template"},TEMPLATE_TYPES_BY_ID:{surveymonkey:{607:"SHRM",293:"CSAT",568:"EVENT",257:"NPS",1042:"TMBC"},research:{607:"SHRM",293:"CSAT",568:"EVENT",257:"NPS",1042:"TMBC"},monkeytest1:{90:"SHRM",113:"CSAT",68:"EVENT",61:"NPS",112:"TMBC"},monkeyscience:{90:"SHRM",113:"CSAT",68:"EVENT",61:"NPS",112:"TMBC"},monkeytest3:{94:"SHRM",123:"CSAT",68:"EVENT",61:"NPS",121:"TMBC"},monkeytest5:{94:"SHRM",123:"CSAT",68:"EVENT",61:"NPS",121:"TMBC"}},TMBC_QUESTION_COUNT:8,DRIVER_TYPES:{TMBC:"tmbc",STD:"std"},__create:function(e){var t=e.survey_data,i;this.ID=t.id;this.language=t.language;this.dateCreated=new Date(t.date_created);this.encryptedID=t.mangled_id;this.templateID=t.template_id;this.previewLink=t.preview_link;this.resourcePath=t.resource_path;this.themeSettings=t.theme_settings;this.designSettings=t.design_settings;this.hasLogic=t.has_logic;this.hasRandomization=t.has_randomization;this.hasPanelPage=t.has_panel_page;this.includeOpenEnded=e.includeOpenEnded;this.isExport=e.isExport||false;this.exportFormat=e.exportFormat||null;this.exportData=e.exportData||{};this.title=t.title;this.nickname=t.nickname;this.surveyAlertsOn=t.survey_alerts_on;this.pageIDs=t.page_ids;this.pageCount=this.pageIDs.length;this.fullQuestionCount=t.question_count;this.respondentCounts={};this.loadCollectors(t.collectors);this.hasEmailCollector=t.has_email_collector;this.hasOpenCollectors=t.has_open_collector;this.hasCollectors=t.has_collector;this.hasUnconfiguredCollector=t.has_unconfigured_collector;this.hasAllClosedCollectors=t.has_all_closed_collectors;if(t.source_surveys){this.createSourceSurveys(t.source_surveys);this.isMergedSurvey=true;this.source_surveys_question_id=t.source_surveys_question_id}i=this._createPageModels({pageIDs:this.pageIDs,survey_data:t,npsEnabled:e.npsEnabled,mode:e.mode});this.pages=i.pages;this.pageList=i.pageList;this.questions=i.questions;this.questionList=i.questionList;this.hasQuestions=i.questionList.length>0;this.searchTerms=i.searchTerms;this.answers=i.answers;this.questionCount=this.questionList.length;this.quotas=t.quotas;this.nltkOptionEnabled=t.nltk_option_enabled;this.currentUserBenchmarksEnabled=t.current_user_benchmarks_enabled},__setters:{respondentCounts:function(e,t){if(!t||t.failed){e.respondentCounts={failed:true}}else{SM.Object.update(e.respondentCounts,t);e.respondentCounts.failed=false}}},ID:"",encryptedID:"",title:"",nickname:"",pageIDs:[],pages:{},pageList:[],pageCount:0,fullQuestionCount:0,questions:{},questionList:[],questionCount:0,questionRollups:null,answers:{},searchTerms:null,respondentsList:null,respondentCounts:{},collectors:{},collectorList:[],hasEmailCollector:false,hasOpenCollectors:false,owner:null,anviews:null,SEARCH_NGRAM_SIZE:2,shownPageList:[],shownQuestionList:[],updateShownLists:function(e,t){var i=this.pageList,s=i.length,n=0,r,a,o,l,u,d,h=t.notify&&true;this.shownPageList=[];this.shownQuestionList=[];for(;n<s;n++){a=i[n];a.shownQuestionList=[];if(a.isShown(e)){this.shownPageList.push(a);l=a.questionList;d=l.length;for(r=0;r<d;r++){u=l[r];if(u.isShown(e)){a.shownQuestionList.push(u);this.shownQuestionList.push(u)}}}}o=this._validatePage();this.state.set("page",o);if(h){this._trigger("shownListsChanged")}},_validatePage:function(){var e,t,i=this.state.get("page"),s=this.state.get("allPagesSelected");if(!s){e=this.pageList[i];if(!e.isShown()){e=this.getFirstShownPage();return e.position-1}}return i},getPage:function(e){return this.pages[e]},getQuestion:function(e){if(e==="merveySources"||e===this.getSourceSurveysQuestionId()){return this.getSourceSurveys()}return this.questions[e]},getSourceSurveysQuestionId:function(){return this.source_surveys_question_id},getSourceSurvey:function(e){var t=this;return t.sourceSurveysModel.getAnswer(e)},createSourceSurveys:function(e){var t=this,i;i={answers:{},id:"merveySources",type:{family:"single_choice",subtype:"vertical"},headings:[{heading:""}],is_merged_survey:true};i.answers.rows=e;t.sourceSurveysModel=SM.Models.create("Question",{structure:i});t.sourceSurveysModel.loadAnswers(i);return t.sourceSurveysModel},getSourceSurveys:function(){return this.sourceSurveysModel},getAnswer:function(e){return this.answers[e]},getRespondentByID:function(e){return this.respondentsList.map[e]},getRespondentByOffset:function(e){return this.respondentsList.getOffset(e)},getCollector:function(e){return this.collectors[e]},getRollup:function(e){if(this.questionRollups){return this.questionRollups.questions[e]||null}},getRandomAssignmentRollup:function(e,t){var i;if(this.questionRollups){i=this.questionRollups.questions[e];if(i.nestedQuestionDict[t]){return i.nestedQuestionDict[t]}else{return this.getRollup(e)}}},getBenchmarkRollup:function(e){if(this.benchmarkRollups){return this.benchmarkRollups.getRollup(e)}},getLastShownPage:function(){var e=this.shownPageList.length;if(!e){return null}return this.shownPageList[e-1]},getNextShownPage:function(e){var t=this.pageList,i=e+1,s,n=t.length;for(;i<n;i++){s=t[i];if(s.isShown()){return s}}return null},getPrevShownPage:function(e){var t=this.pageList,i=e-1,s;for(;i>=0;i--){s=t[i];if(s.isShown()){return s}}return null},getFirstShownPage:function(){var e=this.shownPageList.length;if(!e){return null}return this.shownPageList[0]},getShownQuestionIDs:function(e){var t;if(e!=="all"){t=this.survey.pageList[e].shownQuestionList}else{t=this.shownQuestionList}return $.map(t,function(e){return e.ID})},getQuestionTrend:function(e){if(this.trendsModel&&this.trendsModel.questionTrends){return this.trendsModel.questionTrends.questionMap[e]}},getResponsesTrend:function(){if(this.trendsModel&&this.trendsModel.responseTrends){return this.trendsModel.responseTrends}},getSelectedView:function(){return this.anviews.getView(this.anviews.get("selectedViewID"))},loadViews:function(e){this.anviews=SM.Models.create("AnViewList",{survey:this});this.anviews.createViewModels(e)},loadOwner:function(e){this.owner=SM.Models.create("User",{ID:e["id"],user:e["features"],groupPreferences:e["group_preferences"]});this.owner.survey=this},loadCurrentUser:function(e){this.currentUserID=e.id;this.currentUserEmail=e.email},loadRespondents:function(e){var t=e.status===0?e.data.respondent_offset:null;this.respondentsList=SM.Models.create("RespondentList",{selectedOffset:t});this.respondentsList.loadSurvey(this);if(e.status===0&&this.respondentCounts.total_context){this.respondentsList.loadRespondents(e.data.respondents)}else if(e.status!==0){this.respondentsList.set("failedLoad",true);this.respondentsList.set("failedLoadRequestID",e.request_id)}},loadQuestionRollups:function(e){this.questionRollups=SM.Models.create("QuestionRollupList");this.questionRollups.loadSurvey(this);if(e.status===0){this.questionRollups.loadRollups(e.data.question_rollups)}else{this.questionRollups.set("failedLoad",true);this.questionRollups.set("failedLoadRequestID",e.request_id)}},loadSurveyTrends:function(e){this.trendsModel=SM.Models.create("SurveyTrends");this.trendsModel.loadSurvey(this);if(e.status===0){if(e.data.survey_respondent_trends){this.trendsModel.loadResponsesTrends(e.data)}if(e.data.question_responses_trends){this.trendsModel.loadQuestionTrends(e.data.question_responses_trends,e.data.trend_range)}}else{this.trendsModel.set("failedLoad",true);this.trendsModel.set("failedLoadRequestID",e.request_id)}},loadAnalyzeState:function(e){this.state=SM.Models.create("AnalyzeState",e);this.state.survey=this},loadExportJobs:function(e){this.exportJobs=SM.Models.create("ExportJobList",{config:this.config});this.exportJobs.survey=this;this.exportJobs.poller=SM.Models.create("ExportJobPoller",{config:this.config.export_poller});this.exportJobs.poller.loadJobs(this.exportJobs)},loadSharedViews:function(){this.sharedViews=SM.Models.create("SharedViewList",{survey:this});this.sharedViews.fetch()},loadConfig:function(e){this.config=e;this.config.export_formats_enabled_server_side=SM.Object.deepCopy(this.config.export_formats_enabled)},loadBenchmarkRollups:function(e){this.benchmarkRollups=SM.Models.create("QuestionBenchmarkRollups",{survey:this});if(e.status===0){this.benchmarkRollups.loadRollups(e.data)}else{this.benchmarkRollups.set("failedLoad",true);this.benchmarkRollups.set("failedLoadRequestID",e.request_id)}},loadDriverRollups:function(e){if(!this.driverRollups){this.driverRollups=SM.Models.create("DriverBenchmarkRollups",{survey:this})}if(e.status===0){this.driverRollups.loadRollups(e.data)}else{this.driverRollups.set("failedLoad",true);this.driverRollups.set("failedLoadRequestID",e.request_id)}},loadBenchmarkQuestions:function(e){this.dataSegmentList=SM.Models.create("DataSegmentList",{survey:this,defaultView:this.anviews.defaultView,benchmarkQuestions:e})},isExportFormatTypeEnabled:function(e,t){var i=this.config.export_formats_enabled[t];return!!(i[e]&&this.config.exports_enabled)},isExportEnabled:function(){return this.config["exports_enabled"]},isSharingEnabled:function(){return this.config["sharing_enabled"]},searchQuestions:function(e){var t={},i=[],s=this.searchTerms,n=e.toLowerCase().split(/[\s,-,?,!,(,)]+/),r=n.length,a=this.SEARCH_NGRAM_SIZE,o=0,l,u,d,h,c,f,_,p,m,g;for(;o<r;o++){u=n[o];d=u.substring(0,a);h=o+1===r&&d===u;if(d in s){f=s[d];_=f.length;for(l=0;l<_;l++){c=f[l];if(h||c.word.substring(0,u.length)===u){g=c.id;if(g in t){t[g]++}else{t[g]=1;i.push(g)}}}}}return i.sort(function(e,i){return t[i]-t[e]})},hasRespondents:function(){return this.respondentCounts.total>0},hasFilteredRespondents:function(){return this.respondentCounts.total_context>0},decrementRespondentCounts:function(){var e=this,t={};$.each(this.respondentCounts,function(i,s){if(s!==null&&s!==undefined&&i!=="failed"){t[i]=e.respondentCounts[i]-1}});this.set("respondentCounts",t,{notify:true})},getRespondentUrl:function(e){return"/analyze/browse/"+this.encryptedID+"?respondent_id="+e},_createPageModels:function(e){var t,i,s,n=e.survey_data,r=e.pageIDs,a=n.pages,o=n.questions,l={},u=[],d={},h=[],c={},f={},_=r.length,p,m;for(t=0;t<_;t++){i=r[t];m=a[i];p=SM.Models.create("Page",{ID:i,structure:m});p.survey=this;p.loadQuestions({questionMap:o,questionIDs:m.question_ids,npsEnabled:e.npsEnabled,mode:e.mode});if(t===_-1){p.isPanelPage=this.hasPanelPage}l[i]=p;u.push(p);SM.Object.update(d,p.questions);SM.Object.update(c,p.answers);for(s in p.searchTerms){if(f[s]){f[s]=f[s].concat(p.searchTerms[s])}else{f[s]=p.searchTerms[s]}}h=h.concat(p.questionList)}return{pages:l,pageList:u,questions:d,questionList:h,answers:c,searchTerms:f}},isFiltered:function(){return this.respondentCounts.matching!==null&&this.respondentCounts.matching!==undefined},loadCollectors:function(e){var t={},i=[],s={weblink:"Web Link",email:"Email",audience:"Targeted Audience",popup:"Website Survey",facebook:"Facebook Link"},n=30,r,a,o,l,u;this.collectorList=$.map(e,function(e){var i={id:e.collector_id,title:SM.String.truncateMiddle(SM.Html.strip(e.title),n),dateCreated:new Date(e.date_created),isOpen:e.is_open,isClosed:e.is_closed,isClearing:e.is_clearing_responses,isUnconfigured:e.is_new,isArchived:e.is_archived,type:e.collector_type,formattedType:Globalize.localize(s[e.collector_type]),isFacebook:e.is_facebook,isLink:e.is_weblink,isAudience:e.is_audience,isEmail:e.is_email,isPopup:e.is_popup,link:e.link,entity_id:e.entity_id,formattedResponseCount:Globalize.format(e.response_count,"n0")};r=SM.TrendLib.localize(e.date_created);a=r.year();o=r.month();l=r.date();u=new Date(a,o,l);i.formattedDate=Globalize.format(u,"d");t[i.id]=i;return i});this.collectors=t},hasTextAnalysis:function(){return this.owner.hasTextAnalysis()},getCountOfBenchmarkableQuestions:function(){var e=0;_.each(this.pages,function(t,i){e=e+t.getCountOfBenchmarkableQuestions()});return e},getAllBenchmarkableQuestionIds:function(){var e=[];_.each(this.pages,function(t,i){e=e.concat(t.getAllBenchmarkableQuestionIds())});return e},getAllBenchmarkableQuestionLogicalIds:function(){var e=[];_.each(this.pages,function(t,i){e=e.concat(t.getAllBenchmarkableQuestionLogicalIds())});return e},getIndexOfFirstPageWithQuestions:function(){var e;e=_.find(this.pageList,function(e){return e.questionList.length>0});return e?e.index:0},hasSHRMQuestion:function(){var e=_.find(this.pages,function(e,t){if(e.hasSHRMQuestion()){return true}});return!_.isUndefined(e)},hasCSATQuestion:function(){var e=_.find(this.pages,function(e,t){if(e.hasCSATQuestion()){return true}});return!_.isUndefined(e)},hasEventQuestion:function(){var e=_.find(this.pages,function(e,t){if(e.hasEventQuestion()){return true}});return!_.isUndefined(e)},hasNPSQuestion:function(){var e=_.find(this.pages,function(e,t){if(e.hasNPSQuestion()){return true}});return!_.isUndefined(e)},getDomainName:function(){var e=new Uri(document.location.href),t=e.getRootDomain();if(t==="localmonkey"){t="monkeytest3"}return t},getTemplateTypeFromTemplateId:function(e){var t=this.getDomainName();if(t in this.TEMPLATE_TYPES_BY_ID){if(e in this.TEMPLATE_TYPES_BY_ID[t]){return this.TEMPLATE_TYPES_BY_ID[t][e]}}},getTemplateTypeFromQuestions:function(){if(this.hasSHRMQuestion()){return this.TEMPLATE_TYPES.SHRM}if(this.hasCSATQuestion()){return this.TEMPLATE_TYPES.CSAT}if(this.hasEventQuestion()){return this.TEMPLATE_TYPES.EVENT}if(this.hasNPSQuestion()){return this.TEMPLATE_TYPES.NPS}},validateTMBCTemplate:function(){var e;e=_.filter(this.questions,function(e,t){if(e.is_tmbc&&!e.structure.is_edited){return true}});e=_.uniq(e);if(e.length!==this.TMBC_QUESTION_COUNT){return false}return true},getTemplateType:function(){var e=this.getTemplateTypeFromTemplateId(this.templateID);if(!!e&&this.TEMPLATE_TYPES[e]===this.TEMPLATE_TYPES.TMBC){return this.TEMPLATE_TYPES[e]}if(!e){e=this.getTemplateTypeFromQuestions()}return e},getTemplateName:function(){var e=this.getTemplateType()||"";e=e.toLowerCase();if(e in this.TEMPLATE_NAMES_BY_TYPE){return this.TEMPLATE_NAMES_BY_TYPE[e]}},isSHRMTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.SHRM.toUpperCase()},isNPSTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.NPS.toUpperCase()},isCSATTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.CSAT.toUpperCase()},isEVENTTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.EVENT.toUpperCase()},isTMBCTemplate:function(){return this.getTemplateType()===this.TEMPLATE_TYPES.TMBC},isGenericTemplate:function(){return!this.getTemplateType()},getDriverType:function(){if(this.isTMBCTemplate()){return this.DRIVER_TYPES.TMBC}return this.DRIVER_TYPES.STD},hasProfiledCollector:function(){var e=_.filter(this.collectorList,function(e){if(e.entity_id!=="verified.0"){return e}});return e.length>0},hasValidEntity:function(){return!!this.profiler&&this.profiler.hasValidEntity()||this.hasProfiledCollector()},isProfilerDriverEnabled:function(){var e=this.hasValidEntity(),t=this.hasProfiledCollector(),i=this.dataSegmentList.hasPaidBenchmarks(),s=this.dataSegmentList.hasRestrictedFeatures(),n=this.owner.hasBenchmarkingOptOut(),r=this.anviews.defaultView.isBenchmarkingShownForAnyQuestion(),a=this.getTemplateName(),o;if(!this.profiler){return false}if(!this.isCurrentUserAlsoOwner()){return false}if(this.getCountOfBenchmarkableQuestions()>0){if(this.isTMBCTemplate()){o=this.validateTMBCTemplate()&&this.hasValidEntity()}if(this.owner.benchmarkingHasOptOut||!this.hasValidEntity()){r=false}SM.Bi.logUserProfileState(e,t,n,s,i,r,a,o)}return!e&&!s},shouldShowProfiler:function(){if(this.owner.hasBenchmarkingRestricted()||!this.isCurrentUserAlsoOwner()&&(this.currentUserBenchmarksEnabled||!this.owner.hasBenchmarkingOptOut())){return false}return!this.owner.benchmarkingOptOutWasSet||!this.hasValidEntity()&&!this.owner.benchmarkingHasOptOut},isProfilerDialogEnabled:function(){if(!this.profiler){return false}if(!this.isCurrentUserAlsoOwner()){return false}if(this.owner.hasBenchmarkingRestricted()){return false}return this.shouldShowProfiler()||this.owner.hasBenchmarkingOptOut()},canShowBenchmarking:function(){if(!this.isCurrentUserAlsoOwner()){if(!this.profiler){return false}if(this.owner.canShowBenchmarking()||this.owner.hasBenchmarkingRestricted()){return true}if(this.currentUserBenchmarksEnabled){return true}if(this.profiler.shouldShowProfiler()||this.owner.hasBenchmarkingOptOut()){return false}}return this.owner.canShowBenchmarking()},isOwner:function(e){return e===this.owner.ID},isCurrentUserAlsoOwner:function(){return this.isOwner(this.currentUserID)},triggerProfileSaved:function(){this._trigger({type:"profiler:profile_saved"})}});SM.Models.register("User",{UNLIMITED:"unlimited",BASIC:"BASIC",SELECT_YEARLY:"SELECT_YEARLY",SELECT_MONTHLY:"SELECT_MONTHLY",GOLD:"GOLD",PLATINUM:"PLATINUM",ENTERPRISE_PLATINUM:"ENTERPRISE_PLATINUM",ZOOM_PRO:"ZOOM_PRO",__create:function(e){this.ID=e.ID;this.packageType=e.user.package_type;this.responseLimit=e.user.analyze_response_limit;this.responseDeleteLimit=e.user.response_delete_limit;this.ruleLimit=e.user.analyze_rule_limit;this.textAnalysIsEnabled=e.user.analyze_ta_enabled;this.hasDismissedTaUpgrade=false;this.trendsEnabled=e.user.analyze_trends_enabled;this.sharingEnabled=e.user.sharing_enabled;this.hipaaEnabled=e.user.hipaa_enabled;this.exportEnabled=e.user.analyze_export_enabled;this.logoEnabled=e.user.create_logo_enabled;this.logicEnabled=e.user.create_skip_logic_enabled;this.email=e.user.email||"";this.benchmarkingEnabled=e.user.benchmarking_enabled;this.benchmarkingRestrictedEnabled=e.user.benchmarking_restricted_enabled;this.benchmarkingHasOptOut=e.user.benchmarking_has_opt_out;this.benchmarkingOptOutWasSet=e.user.benchmarking_opt_out_was_set;this.whiteLabel=e.user.white_label;this.disabledExports={spss:!e.user.analyze_export_spss_enabled,ppt:!this.canExportPPT()};this.enterprisePreferences=e.groupPreferences},isOverResponseLimit:function(e){return this.responseLimit!==this.UNLIMITED&&this.responseLimit<e},hasRuleLimit:function(){return this.ruleLimit!==this.UNLIMITED},isOverRuleLimit:function(){var e=this.survey.anviews.currentView.ruleList;if(!this.hasRuleLimit()){return false}if(!e){return this.ruleLimit===0}return e.length>=this.ruleLimit},isBasic:function(){return this.packageType===this.BASIC},isSelect:function(){return this.packageType===this.SELECT_YEARLY||this.packageType===this.SELECT_MONTHLY},isZoomPro:function(){return this.packageType===this.ZOOM_PRO},isGold:function(){return this.packageType===this.GOLD},isPlatinum:function(){return this.packageType===this.PLATINUM},isEnterprisePlatinum:function(){return this.packageType===this.ENTERPRISE_PLATINUM},hasTextAnalysis:function(){return this.textAnalysIsEnabled},hasExports:function(){return this.exportEnabled},canExport:function(e){if(this.exportEnabled){if(this.disabledExports[e]){return false}return true}return false},canExportPPT:function(){return this.isSelect()||this.isGold()||this.isPlatinum()||this.isEnterprisePlatinum()},hasTrends:function(){return this.trendsEnabled},hasSharing:function(){return this.sharingEnabled},hasBenchmarking:function(){return this.benchmarkingEnabled&&!SM.App.isSharingApp()&&!this.survey.isExport},hasBenchmarkingRestricted:function(){return this.benchmarkingRestrictedEnabled&&this.hasBenchmarking()},hasBenchmarkingOptOut:function(){return this.benchmarkingOptOutWasSet&&this.benchmarkingHasOptOut},canShowBenchmarking:function(){if(this.hasBenchmarkingRestricted()){return true}return this.hasBenchmarking()&&!this.hasBenchmarkingOptOut()},canHideExportBranding:function(){return this.isGold()||this.isPlatinum()||this.isEnterprisePlatinum()},canSigDiffs:function(){return this.isGold()||this.isPlatinum()||this.isEnterprisePlatinum()},getEnterpriseGroupDefaultDomain:function(){return this.enterprisePreferences.selected_domain||null},getEnterpriseGroupDomains:function(){return $.map(this.enterprisePreferences.custom_domains,function(e,t){return{domain:e}})},isMonthly:function(){return this.packageType===this.SELECT_MONTHLY},isInGroup:function(){return this.enterprisePreferences&&this.enterprisePreferences["group_id"]},canHaveMultiSeat:function(){return!(this.isMonthly()||this.isBasic())&&!this.isInGroup()}});SM.Models.register("Page",{__create:function(e){var t=e.structure,i;this.ID=e.ID;this.heading=SM.Html.strip(t.heading);this.shortHeading=SM.String.truncate(this.heading,17);this.position=t.position;this.hasHeading=this.heading.length>0;this.index=t.position-1;this.subheading=t.subheading;this.editLink=t.edit_link},ID:"",heading:"",position:null,index:null,subheading:"",questions:{},questionList:[],questionCount:null,answers:{},searchTerms:{},survey:null,shownQuestionList:[],loadedQuestionMap:{},isPanelPage:false,loadQuestions:function(e){var t=0,i=e.questionMap,s=e.questionIDs,n,r,a,o,l=[],u={},d={},h={},c=s.length;for(;t<c;t++){a=s[t];n=i[a];if(n.type.family==="presentation"&&!n.has_random_assignment){continue}r=SM.Models.create("Question",{ID:n.id,structure:n,npsEnabled:e.npsEnabled,mode:e.mode});r.page=this;u[n.id]=r;l.push(r);r.loadAnswers(n);r.loadIntoSearch();for(o in r.searchTerms){if(h[o]){h[o]=h[o].concat(r.searchTerms[o])}else{h[o]=r.searchTerms[o]}}SM.Object.update(d,r.answers)}this.questions=u;this.questionList=l;this.questionCount=this.questionList.length;this.answers=d;this.searchTerms=h},isShown:function(e){e=e||this.survey.anviews.currentView.show;var t=e.pages;return!e.selected||t&&t[this.ID]},getCountOfBenchmarkableQuestions:function(){var e=0;_.each(this.questions,function(t,i){if(t.isBenchmarkable()){e=e+1}});return e},getAllBenchmarkableQuestionIds:function(){var e=[];_.each(this.questions,function(t,i){if(t.isBenchmarkable()){e.push(t.ID)}});return e},getAllBenchmarkableQuestionLogicalIds:function(){var e=[];_.each(this.questions,function(t,i){if(t.isBenchmarkable()){e.push(t.logicalID)}});return e},hasSHRMQuestion:function(){var e=_.find(this.questions,function(e,t){if(e.is_shrm){return true}});return!_.isUndefined(e)},hasCSATQuestion:function(){var e=_.find(this.questions,function(e,t){if(e.is_csat){return true}});return!_.isUndefined(e)},hasEventQuestion:function(){var e=_.find(this.questions,function(e,t){if(e.is_event){return true}});return!_.isUndefined(e)},hasNPSQuestion:function(){var e=_.find(this.questions,function(e,t){if(e.isNPS()){return true}});return!_.isUndefined(e)},validateTMBCQuestions:function(){var e=_.find(this.questions,function(e,t){if(!e.is_tmbc||e.structure.is_edited){return true}});return _.isUndefined(e)}});SM.Models.register("Question",{QTYPE:{open_ended:"open_ended",datetime:"datetime",demographic:"demographic",numerical:"numerical",nps:"net_promoter_score",single_choice:"single_choice",multiple_choice:"multiple_choice",horiz:"horiz",matrix:"matrix",menu:"menu",menu_matrix:"menu_matrix",single:"single",simple:"simple",rating_scale:"rating",ranking:"ranking",essay:"essay",other_option:"other_option",presentation:"presentation",multi:"multi",descriptive_text:"descriptive_text",image:"image"},compareMap:{single_choice:"matrix",multiple_choice:"matrix",matrix:"menu_matrix",open_ended:"matrix",demographic:"matrix",datetime:"matrix"},ID:null,title:"",number:null,family:null,subtype:null,searchTerms:{},options:null,rowList:[],colList:[],colChoices:{},page:null,commentField:null,randomAssignmentMap:null,__create:function(e){var t=e.structure;if(t.type.subtype===this.QTYPE.rating_scale&&t.type.family===this.QTYPE.matrix){this.name=t.type.name}this.is_shrm=t.type.is_shrm;this.is_nps=t.type.is_nps;this.is_event=t.type.is_event;this.is_csat=t.type.is_csat;this.is_tmbc=t.type.is_tmbc;if(e.npsEnabled&&e.mode==="summary"&&this.is_nps){t=SM.ComparedByNps.structure(t)}this.npsEnabled=e.npsEnabled;this.is_merged_survey=t.is_merged_survey;this.ID=t.id;this.logicalID=t.logical_id;this.logicalName=t.logical_name;this.logicalLangId=t.logical_lang_id;this.structure=t;this.headings=t.headings;this.position=t.position;this.family=t.type.family;this.subtype=t.type.subtype;this.heading=SM.Html.strip(this.headings[0].heading);this.randomAssignmentList=[];for(var i=0;i<this.headings.length;i++){var s=this.headings[i],n=s.heading;if(n==""){n=s.description}s.heading=SM.Html.strip(n);if(s.random_assignment){var r={heading:s.heading,percent:s.random_assignment.percent,variable_id:s.random_assignment.variable_id,variable_name:s.random_assignment.variable_name};if(s.image){var a;if(s.image.s3_key){a="s3"}else if(s.image.url.indexOf("http://")==0||s.image.url.indexOf("https://")==0){a="url"}else{a="upload"}r.image={source:s.image.s3_key==""?s.image.url:s.image.s3_key,type:a,url:s.image.url}}this.randomAssignmentList.push(r)}}this.sanitizeRAList(this.randomAssignmentList);var o=typeof SM.AnalyzeApp!=="undefined"&&"defaultRAHeader"in SM.AnalyzeApp?SM.AnalyzeApp.defaultRAHeader:SM.raHeader||"A/B Test";if(this.isPresentation()){this.heading=t.nickname||o}else if(this.headings.length>1){this.heading=o}this.searchTerms={};this._models={};
},loadIntoSearch:function(){this._addToSearchTerms("Q"+this.position);this._addToSearchTerms(this.heading)},hasRollupLoaded:function(){var e=this.getRollup();return e&&e.type!=="null_rollup"},hasTrendLoaded:function(){var e=this.getTrend();return e.get("isLoaded")},hasRandomAssignment:function(){return!!this.randomAssignmentList&&this.randomAssignmentList.length>0},isAfterLastLoadedRollup:function(){return this.page.survey.questionRollups.isAfterLastLoadedQuestion(this)},isAfterLastLoadedTrend:function(){return this.page.survey.trendsModel.questionTrends.isAfterLastLoadedQuestion(this)},setCompareStructure:function(e){this.compareStructure=e},isComparable:function(){return!!this.compareMap[this.family]&&!(this.subtype===this.QTYPE.menu&&this.family===this.QTYPE.matrix)},hasComparableOptions:function(){return this.family===this.QTYPE.matrix&&this.subtype!==this.QTYPE.menu||this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice},isBenchmarkable:function(){var e=this,t=e.structure;if(!t.is_benchmarkable){return false}if(e.isNPS()&&_.size(t.answers.rows)!==11){return false}return true},hasChartView:function(){return this.family===this.QTYPE.matrix||this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice||this.subtype===this.QTYPE.numerical},getCompareType:function(){return this.compareMap[this.family]},getContextStructure:function(){if(this.isCompared()){return this.compareStructure}return this.structure},getContextAnswerStructure:function(){if(this.compositeAnswerStructure){return this.compositeAnswerStructure}else{return this.getContextStructure().answers}},isCompared:function(){return this.compareStructure!==undefined},isShown:function(e){e=e||this.page.survey.anviews.currentView.show;var t=e.questions;return!e.selected||t&&t[this.ID]},getRollup:function(){var e=!!(this.randomAssignmentList&&this.randomAssignmentOption);if(e){return this.getRandomAssignmentRollup()}else{return this.page.survey.getRollup(this.ID)}},getRandomAssignmentRollup:function(){return this.page.survey.getRandomAssignmentRollup(this.ID,this.randomAssignmentOption)},getRandomAssignmentOption:function(e){this.randomAssignmentMap=this.randomAssignmentMap||this._createRandomAssignmentMap();return this.randomAssignmentMap[e]},_createRandomAssignmentMap:function(){var e={},t=this.randomAssignmentList,i,s;_.each(t,function(t){i=t.variable_id;e[i]=t});return e},getTrend:function(){return this.page.survey.getQuestionTrend(this.ID)},getResponse:function(e){var t=this.page.survey.respondentsList.map[e];return t.getResponse(this.ID)},getCrossedQuestion:function(){var e=this.page.survey,t=e.anviews.currentView;if(this.isCompared()&&t.compareRule){return e.getQuestion(t.compareRule.get("questionID"))}},loadAnswers:function(e){var t=this;this.answers={};if(e.answers.rows){if(!e.is_merged_survey){this._parseRowAnswers(e.answers.rows)}else{_.each(e.answers.rows,function(e){t.answers[e.id]=e})}this.rowList=e.answers.rows}else{e.answers.rows=[]}if(e.answers.cols){this._parseColAnswers(e.answers.cols);this.colList=e.answers.cols;if(this.subtype==="ranking"){this._initRankingWeights()}}if(e.answers.other){this._parseOtherAnswers(e.answers.other);this.commentFieldList=e.answers.other;this.commentField=this.commentFieldList[0]}},getAnswer:function(e){return this.answers[e]},buildCompositeAnswerStructure:function(e){var t=this,i=t.getContextStructure(),s=i.answers,n=t.getCombineHideDim(),r,a,o,l,u,d,h,c,f,p,m;if(!e){t.compositeAnswerStructure=null;t.hiddenComposites=[];t.combinedComposites=[];return}r={rows:"row",cols:"column"};a=SM.Object.deepCopy(s);l=[];_.each(e.combines,function(e){_.each(a[n],function(t){h=SM.Object.deepCopy(t);h.combineId=e.id;if(_.contains(e.combine,t.id)){l.push(h)}})});t.combinedComposites=l;_.each(e.combines,function(e,t){_.each(e.combine,function(e){a[n]=_.reject(a[n],function(t){return t.id===e})})});u=_.pluck(e.hides,"id");d=[];if(_.size(u)!==0){_.each(a[n],function(e){if(_.contains(u,e.id)){d.push(SM.Object.deepCopy(e))}})}t.hiddenComposites=d;_.each(e.hides,function(e){a[n]=_.reject(a[n],function(t){return t.id===e.id})});_.each(e.combines,function(e){f={text:e.title,visible:true,position:999,type:r[n],isCombined:true,id:e.id,question_id:t.ID,is_openended:false};if(t.isRating()){p=_.min(e.combine,function(e){return e});o=_.findWhere(s[n],{id:p});f.weight=o.weight}a[n].push(f)});a[n]=_.sortBy(a[n],function(e){return e.id});if(t.isRanking()){c=[];m=_.size(a[n]);_.each(a[n],function(e,t){h=SM.Object.deepCopy(e);h.weight=m-t;c.push(h)});a[n]=c}t.compositeAnswerStructure=a},buildCompositeMapping:function(e){var t=this,i=t.getContextStructure(),s=i.answers,n=t.getCombineHideDim(),r=t.compositeAnswerStructure,a={},o,l,u,d;_.each(r[n],function(t){d=_.findWhere(e.combines,{id:t.id});if(d){l=d.combine;_.each(l,function(e){o=_.findWhere(s[n],{id:e});a[o.id]=t})}else{o=_.findWhere(s[n],{id:t.id});a[o.id]=t}});_.each(e.hides,function(e){o=_.findWhere(s[n],{id:e.id});a[o.id]=null});return a},getCombineHideDim:function(){var e=this;if(e.isCompared()){if(e.isMenuMatrix()){return null}else{return"rows"}}else{if(e.isSimple()){return"rows"}else if(e.isMatrix()){return"cols"}}return null},canCombineHide:function(){var e=this;if(e.isCompared()&&e.isMenuMatrix()){return false}if(e.isOpenEnded()){return false}if(e.hasRandomAssignment()){return false}if(e.isNPS()){return false}return this.isSimple()||this.isMatrix()},otherIsAnAnswerChoice:function(){var e=this,t=e.getContextStructure(),i=t.answers;return i.other!==undefined&&i.other[0].options.is_answer_choice},isOther:function(e){var t=this,i=t.getContextStructure(),s=i.answers;return s.other!==undefined&&s.other[0].id===e},summaryType:function(){var e=this,t=e.getRollup(),i=t.summary;return e.isCompared()?i.summary.type:i.type},depthType:function(){var e=this;if(e.isMatrix()){if(e.isMenuMatrix()){return e.QTYPE.menu_matrix}else{return e.QTYPE.matrix}}else{return e.QTYPE.single}},isNPS:function(){var e=this;if(!e.npsEnabled){return false}return this.is_nps},isSimple:function(){if(this.isCompared()){return false}return this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.single_choice},isSingleChoice:function(){return this.family===this.QTYPE.single_choice},isMultipleChoice:function(){return this.family===this.QTYPE.multiple_choice||this.family===this.QTYPE.matrix&&this.subtype===this.QTYPE.multi},isNumerical:function(){return this.subtype===this.QTYPE.numerical},isMatrix:function(){if(this.isCompared()){return this.compareStructure.type.family===this.QTYPE.matrix}return this.family===this.QTYPE.matrix},isMenuMatrix:function(){if(this.isCompared()){return this.compareStructure.type.family===this.QTYPE.matrix&&this.compareStructure.type.subtype===this.QTYPE.menu}return this.family===this.QTYPE.matrix&&this.subtype===this.QTYPE.menu},isMultiResponse:function(){return this.family==="multiple_choice"||this.family==="open_ended"&&(this.subtype==="multi"||this.isNumerical())||this.family==="demographic"||this.family==="datetime"||this.family==="matrix"&&this.subtype==="multi"},isOpenEnded:function(){return this.family==="open_ended"||this.family==="demographic"||this.family==="datetime"},isPresentation:function(){return this.family===this.QTYPE.presentation},isEssay:function(){return this.family==="open_ended"&&(this.subtype==="essay"||this.subtype==="single")},isRating:function(){return this.subtype==="rating"},isRanking:function(){return this.subtype==="ranking"},isDateTime:function(){return this.family===this.QTYPE.datetime},isDemographic:function(){return this.family===this.QTYPE.demographic},isSimpleRating:function(){return this.subtype==="rating"&&!this.isCompared()&&_.size(this.structure.answers.rows)===1},canSidi:function(){var e=this;if(e.isOpenEnded()){return false}if(e.hasRandomAssignment()){return false}if(e.isNPS()){return false}return this.isCompared()&&(this.isSimple()||this.isMatrix())},hasCommentsPerRow:function(){return!!(this.structure.answers.other&&this.structure.answers.other[0].options.apply_all_rows)},getOpenEndedType:function(){var e=this.family,t=this.subtype;if(e==="open_ended"){return t}if(e==="demographic"||e==="datetime"){return e}},labelByWeights:function(e){var t=this,i,s=0,n=SM.Object.deepCopy(e),r=n.other,a,o;if(t.compositeAnswerStructure||t.isNPS()||t.isRanking()||!t.getRollup().display.getDisplayData().show_basic_stats){return n}if(t.isSimple()){i="rows"}else if(t.isNumerical()){return n}else if(t.isCompared()){if(t.isMenuMatrix()){i="cols"}else{i="rows"}}else if(t.isMenuMatrix()){i="columnChoices"}else if(t.isMatrix()){i="cols"}if(i==="rows"){_.each(n.rows,function(e,t){e.text+=" ("+(t+1)+")";if(e.mediaHTML){e.mediaHTML+=" ("+(t+1)+")"}s=t+1})}else if(i==="cols"){_.each(n.cols,function(e,t){if(!e.options.is_na){e.text+=" ("+(t+1)+")";if(e.mediaHTML){e.mediaHTML+=" ("+(t+1)+")"}s=t+1}})}else{_.each(n.cols,function(e){_.each(e.items,function(e,t){e.text+=" ("+(t+1)+")";if(e.mediaHTML){e.mediaHTML+=" ("+(t+1)+")"}s=t+1})})}o=r!==undefined&&r[0].options.is_answer_choice;if(o){a=n.other[0];a.text+=" ("+(s+1)+")"}return n},_initRankingWeights:function(){var e=this.colList,t=this.colList.length;$.each(e,function(e,i){if(i.options.is_na){t--}});$.each(e,function(e,i){if(i.options.is_na){i.options.weight=0}else{i.options.weight=t-e}})},_parseAnswers:function(e,t){var i=e.length,s=0,n,r=this.answers,a;for(;s<i;s++){n=e[s];this.sanitizeAnswer(n);r[n.id]=n;this._addToSearchTerms(n.text);n.is_openended=t}},_parseOtherAnswers:function(e){this._parseAnswers(e,true)},_parseRowAnswers:function(e){this._parseAnswers(e,this.isOpenEnded())},_parseColAnswers:function(e){var t=e.length,i,s,n=this.answers,r,a,o,l,u;for(i=0;i<t;i++){r=e[i];this.sanitizeAnswer(r);if(r.options.is_na){this.naCol=r}n[r.id]=r;this._addToSearchTerms(r.text);a=r.items?r.items:[];o=a.length;for(s=0;s<o;s++){l=a[s];this.sanitizeAnswer(l);n[l.id]=l;this._addToSearchTerms(l.text)}}if(this.naCol&&this.naCol.position===0){e.shift();e.push(this.naCol);this.naCol.position=t}},_addToSearchTerms:function(e){var t=e.toLowerCase().split(/[\s,-,?,!,(,),\/]+/),i=t.length,s=this.page.survey.SEARCH_NGRAM_SIZE,n=this.searchTerms,r=0,a,o;for(;r<i;r++){a=t[r];o=a.substring(0,s);if(!a.length){continue}else if(o in n){n[o].push({word:a,id:this.ID})}else{n[o]=[{word:a,id:this.ID}]}}},mungeCompareMenuMatrix:function(e,t,i){var s,n,r,a=e.crossed_cols||e.crossed_rows,o,l,u,d=this.structure,h=this.rowList,c=h.length,f=this.colList,p=f.length,m=0,g=0;u=SM.Object.deepCopy(d);u.type={family:"matrix",subtype:"menu"};if(!i){for(m=0;m<p;m++){u.answers.cols[m].items=[];for(g=0;g<a.length;g++){s=t.is_merged_survey?"Survey: ":"Q"+t.position+": ";if(e.crossed_cols){o=e.crossed_rows[0];r=t.answers[o];n=e.crossed_cols[g];l=t.answers[n];l=SM.Object.copy(l);s=s+[r.text,l.text].join(": ");u.answers.cols[m].items[g]=l}else{o=e.crossed_rows[g];r=t.answers[o];r=SM.Object.copy(r);s=s+r.text;u.answers.cols[m].items[g]=r}u.answers.cols[m].items[g].text=s}}for(m=0;m<c;m++){u.answers.rows[m].items=[];for(g=0;g<a.length;g++){s=t.is_merged_survey?"Survey: ":"Q"+t.position+": ";if(e.crossed_cols){o=e.crossed_rows[0];r=t.answers[o];n=e.crossed_cols[g];l=t.answers[n];l=SM.Object.copy(l);s=s+[r.text,l.text].join(": ");u.answers.rows[m].items.push(l)}else{o=e.crossed_rows[g];r=t.answers[o];r=SM.Object.copy(r);s=s+r.text;u.answers.rows[m].items.push(r)}u.answers.rows[m].items[g].text=s}if(!u.answers.crossedOptions){u.answers.crossedOptions=u.answers.rows[m].items}}}else{var S=SM.ComparedByNps.map2DistributedByQuestion(e.crossed_rows,t);_.each(u.answers.cols,function(e,t){u.answers.cols[t].items=_.map(S,_.clone)});_.each(u.answers.rows,function(e,t){u.answers.rows[t].items=_.map(S,_.clone)});if(!u.answers.crossedOptions){u.answers.crossedOptions=S}}return u},mungeCompareMenuMatrixRA:function(e,t){var i,s,n,r=e.crossed_cols||e.crossed_rows,a,o,l,u=this.structure,d=this.rowList,h=d.length,c=this.colList,f=c.length,_=0,p=0;if(r.length===0){r=e.crossed_rows}l=SM.Object.deepCopy(u);l.type={family:"matrix",subtype:"menu"};for(_=0;_<f;_++){l.answers.cols[_].items=[];for(p=0;p<r.length;p++){i="Q"+t.position+": ";if(e.crossed_cols&&e.crossed_cols.length>0){a=e.crossed_rows[0];n=t.answers[a];s=e.crossed_cols[p];o=t.answers[s];o=SM.Object.copy(o);i=i+[n.text,o.text].join(": ");l.answers.cols[_].items[p]=o}else{a=e.crossed_rows[p];for(var m=0;m<t.randomAssignmentList.length;m++){if(a===t.randomAssignmentList[m].variable_id){n=t.randomAssignmentList[m];break}}n=SM.Object.copy(n);n.id=n.variable_id.toString();if(n.heading){i+=n.heading}else{i+=n.variable_name}n.position=p+1;n.question_id=parseInt(t.ID);n.visible=true;n.type="col";l.answers.cols[_].items[p]=n}l.answers.cols[_].items[p].text=i}}for(_=0;_<h;_++){l.answers.rows[_].items=[];for(p=0;p<r.length;p++){i=t.is_merged_survey?"Survey: ":"Q"+t.position+": ";if(e.crossed_cols&&e.crossed_cols.length>0){a=e.crossed_rows[0];n=t.answers[a];s=e.crossed_cols[p];o=t.answers[s];o=SM.Object.copy(o);i=i+[n.text,o.text].join(": ");l.answers.rows[_].items.push(o)}else{a=e.crossed_rows[p];for(var m=0;m<t.randomAssignmentList.length;m++){if(a===t.randomAssignmentList[m].variable_id){n=t.randomAssignmentList[m];break}}n=SM.Object.copy(n);n.id=n.variable_id.toString();if(n.heading){i+=n.heading}else{i+=n.variable_name}n.position=p+1;n.question_id=parseInt(t.ID);n.visible=true;n.type="row";l.answers.rows[_].items.push(n)}l.answers.rows[_].items[p].text=i}if(!l.answers.crossedOptions){l.answers.crossedOptions=l.answers.rows[_].items}}return l},mungeCompareMatrix:function(e,t,i){var s=this.structure,n,r=e.crossed_cols||e.crossed_rows,a,o,l,u,d,h;n=SM.Object.deepCopy(s);n.type={family:"matrix",subtype:"single"};if(!i){n.answers.cols=[];for(h=0;h<r.length;h++){d=t.is_merged_survey?"Survey: ":"Q"+t.position+": ";if(e.crossed_cols){o=e.crossed_rows[0];a=t.answers[o];l=e.crossed_cols[h];u=t.answers[l];u=SM.Object.copy(u);d=d+[a.text,u.text].join(": ");n.answers.cols[h]=u}else{o=e.crossed_rows[h];a=t.answers[o];a=SM.Object.copy(a);d=d+a.text;n.answers.cols[h]=a}n.answers.cols[h].text=d}}else{n.answers.cols=SM.ComparedByNps.map2DistributedByQuestion(e.crossed_rows,t)}n.answers.crossedOptions=n.answers.cols;if(this.isEssay()){n.answers.rows=[{id:"0",question_id:this.ID,text:this.heading,type:"row",is_openended:true}]}return n},mungeCompareMatrixRA:function(e,t){var i=this.structure,s,n=e.crossed_cols||e.crossed_rows,r,a,o,l,u,d,h;if(n.length===0){n=e.crossed_rows}s=SM.Object.deepCopy(i);s.type={family:"matrix",subtype:"single"};s.answers.cols=[];for(d=0;d<n.length;d++){u=t.is_merged_survey?"Survey: ":"Q"+t.position+": ";if(e.crossed_cols&&e.crossed_cols.length>0){a=e.crossed_rows[0];r=t.answers[a];o=e.crossed_cols[d];l=t.answers[o];l=SM.Object.copy(l);u=u+[r.text,l.text].join(": ");s.answers.cols[d]=l}else{a=e.crossed_rows[d];for(var h=0;h<t.randomAssignmentList.length;h++){if(a===t.randomAssignmentList[h].variable_id){r=t.randomAssignmentList[h];break}}r=SM.Object.copy(r);r.id=r.variable_id.toString();if(r.heading){u+=r.heading}else{u+=r.variable_name}s.answers.cols[d]=r}s.answers.cols[d].text=u}s.answers.crossedOptions=s.answers.cols;if(this.isEssay()){s.answers.rows=[{id:"0",question_id:this.ID,text:this.heading,type:"row",is_openended:true}]}return s},getSidiOptions:function(e,t,i){var s=this,n=s.getRollup(),r=s.getCrossedQuestion(),a,o,l,u;if(n.combinehideModel.isCombined(e)){u={isCombined:true,answerID:e,hasSidi:false};return u}o=n.combinehideModel.getHides();if(_.size(o)>0){u={hasHidden:true,answerID:e,hasSidi:false};return u}l=n.getSidiData(e,t,i);if(!l||!l.enough_responses){return null}if(!l.has_significant_diffs){u={noSidi:true,hasSidi:false};return u}u={p:l.p,confidence_level:l.confidence_level,hasSidi:true};u.higherGroups=SM.SidiUtils.buildPhrase(l.higher_diffs,r);u.hasHigherGroups=u.higherGroups!==null;u.lowerGroups=SM.SidiUtils.buildPhrase(l.lower_diffs,r);u.hasLowerGroups=u.lowerGroups!==null;a=l.higher_diffs.concat(l.lower_diffs);u.groups=SM.SidiUtils.join(a,r);u.answerID=e;return u},sanitizeRAList:function(e){var t=this,i;if(!!e&&e.length){if(this.isPresentation()){_.each(e,function(e,s){if(e.variable_name.length===0){if(t.subtype===t.QTYPE.image){i=Globalize.localize("Image Random Assignment - Image")+" "+(s+1)}else{i=Globalize.localize("Text Random Assignment - Text")+" "+(s+1)}e.variable_name=i}},t)}return e}return[]},sanitizeAnswer:function(e){var t,i,s,n,r="("+Globalize.localize("no label")+")",a;s=SM.Html.findFirstTag(e.text,"img");if(!s){n=SM.Html.strip(e.text,false);s=SM.Html.findFirstTag(n,"img")}if(s){s=SM.Html.removeExternalAttributes(s);a=SM.Html.parse(s)[0]}if(a){t=a.getAttribute("data-src");t=SM.String.trim(t);t=SM.Html.strip(t);if(SM.String.isHttpUrl(t)){i=t}}if(i){e.text=SM.String.afterLast(i,"/");e.mediaHTML=SM.Template.render("img",{classes:"img-option",src:i,alt:e.text,title:e.text})}else{if(!e.text){e.text=r}else{e.text=SM.Html.strip(e.text)}}}});SM.BaseAnRule={CHOICE_SET_SCHEMA:{rows:{}},BASE_RULE_METADATA_KEY:"rule_",MAX_CHOICE_HEADING_LENGTH:2,TEMP_ID_PREFIX:"new_",FAMILY_TYPES:{SHOW:"show",FILTER:"filter",COMPARE:"compare"},ruleTypeToModelMap:{filter:{respondent_data:"FilterRespondentDataAnRule",collector:"FilterCollectorAnRule",completeness:"FilterCompletenessAnRule",time_period:"FilterTimePeriodAnRule",random_assignment:"FilterRandomAssignmentRule"},compare:{random_assignment:"CompareRandomAssignmentRule"},show:{show:"ShowAnRule"}},qnaRuleModelMap:{single_choice:"QnaSimpleAnRule",multiple_choice:"QnaSimpleAnRule",matrix:"QnaMatrixAnRule",menu_matrix:"QnaMenuMatrixAnRule",open_ended:"QnaOpenEndedAnRule",demographic:"QnaOpenEndedAnRule",datetime:"QnaDatetimeAnRule",numerical:"QnaNumericalAnRule",rating_comment_per_row:"QnaRatingCommentPerRowAnRule",source_surveys:"SourceSurveysRule"},lastValidation:{isValid:true,invalids:[]},__create:function(e){if(!e.ID){this.isNew=true;this.ID=this.TEMP_ID_PREFIX+this.__uid}else{this.isNew=false;this.ID=e.ID}this.is_nps=e.is_nps;this.loadRuleMetadataValue(e.attrs);this.isCorrupt=e.isCorrupt===true;this.ruleFamily=this.isCompare?"compare":"filter";this.editMode=false;this.isDirty=false;this.isShow=false;this.isQNA=false;this.isRA=false;if(this.metadata_id){delete this.metadata_id}},loadRuleMetadataValue:function(e){this.customHeading=e.custom_heading;this.isCompare=e.is_compare_rule||false;this.selected=e.selected},FactoryCreate:function(e,t){var i=e.attrs.rule_type,s,n,r,a,o;if(i==="show"){o="show"}else if(i==="random_assignment"&&e.attrs.is_compare_rule){o="compare"}else{o="filter"}if(i==="qna"){s=t.getQuestion(e.attrs.question_id);n=s.family;if(s.isNPS()){n="single_choice"}if(s.family==="matrix"&&s.subtype==="menu"){n="menu_matrix"}else if(s.subtype==="numerical"){n="numerical"}if(s.commentField&&s.commentField.options.apply_all_rows){n="rating_comment_per_row"}if(e.attrs.question_id===t.getSourceSurveysQuestionId()){n="source_surveys"}a=this.qnaRuleModelMap[n];e.is_nps=s.isNPS();r=SM.Models.create(a,e);if(e.attrs.is_compare_rule){r.ruleFamily="compare";r.isCompare=true}}else if(i==="random_assignment"){a=this.ruleTypeToModelMap[o][i];r=SM.Models.create(a,e);if(e.attrs.is_compare_rule){r.ruleFamily="compare";r.isCompare=true}}else{a=this.ruleTypeToModelMap[o][i];r=SM.Models.create(a,e)}return r},loadSurvey:function(e){this.survey=e},__setters:{editMode:function(e,t){if(t===true){e._ruleBackup=e.dumpRuleValue()}else if(e._ruleBackup){e.loadRuleMetadataValue(e._ruleBackup);delete e._ruleBackup}e.editMode=t}},__getters:{heading:function(e){return e.customHeading||e.getHeading()},selected:function(e){return e.selected&&!e.isCorrupt}},applyRule:function(){if(this.isNew){this.survey.anviews.currentView.addRule(this);this.isNew=false}else{this._trigger({type:"ruleEdited",ruleModel:this})}},copyRule:function(){var e=this.copy();this.survey.anviews.currentView.addRule(e);this.survey.anviews.currentView.save()},toggleRule:function(){var e=!this.get("selected");this.set("selected",e);this._trigger({type:"ruleEdited",ruleModel:this})},deleteRule:function(){this._trigger({type:"ruleDeleted",ruleModel:this})},copy:function(){var e=SM.Models.create(this.__NAME,{ID:null,is_nps:this.is_nps,attrs:this.dumpRuleValue()}),t=e.customHeading||this.get("heading");t=t+" - "+Globalize.localize("COPY");e.set("customHeading",t);e.loadSurvey(this.survey);e.set("selected",false);e.set("isNew",false);return e},isPersisted:function(){return this.ID.substr(0,4)!==this.TEMP_ID_PREFIX},dump:function(){var e=this.BASE_RULE_METADATA_KEY,t=this.ID,i,s=null;e=[e,this.ruleFamily,"_",this.get("ruleType")].join("");i=this.dumpRuleValue();if(!this.isPersisted()){t=null;s=this.ID}return{key:e,temp_id:s,is_corrupt:this.isCorrupt,metadata_id:t,option_id:null,question_id:null,value:i,view_id:this.survey.anviews.currentView.ID}},sanitize:function(){},dumpRuleValue:function(){var e=this,t={};t.rule_type=this.ruleType;t.selected=this.selected;t.custom_heading=this.customHeading;return SM.Object.deepCopy(t)},commit:function(){this.sanitize();this.lastValidation=this.validate();if(this.lastValidation.isValid){delete this._ruleBackup;this.editMode=false}return this.lastValidation.isValid},_getNpsChoiceSetHeading:function(e){var t,i,s="",n,r=0,a=this.MAX_CHOICE_HEADING_LENGTH,o=this.survey,l;e=SM.ComparedByNps.map2DistributedBySurvey(e,o);_.each(e,function(e){i=Globalize.localize(e.text);if(r<a){s+=i+", "}n=r+1;r++});s=s.substring(0,s.length-2);l=s.length;if(n>a){s+=" +"+(n-a)}return{heading:s,numChoices:r,indexOfLastChoice:l}},_getChoiceSetHeading:function(e,t){var i,s="",n,r=0,a,o=this.MAX_CHOICE_HEADING_LENGTH,l=this.survey,u;a=_.keys(e);a=_.sortBy(a,function(e){return e});_.each(a,function(e){i=t(e);if(r<o){s+=i+", "}n=r+1;r++});s=s.substring(0,s.length-2);u=s.length;if(n>o){s+=" +"+(n-o)}return{heading:s,numChoices:r,indexOfLastChoice:u}}};SM.Models.extend("FilterRespondentDataAnRule",SM.BaseAnRule,{__create:function(e){this.ruleType="respondent_data";SM.BaseAnRule.__create.call(this,e)},loadRuleMetadataValue:function(e){var t=this;SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.timeTotal=e.time_total;if(!this.get("timeTotal")){this.set("timeTotal",{op:">",unit:"s",value:""})}if(e.txt_rows){$.each(this.respondentAttributes,function(i,s){if(e.txt_rows[s.key]){t.set(s.id,e.txt_rows[s.key])}})}},__validators:{email:function(e,t){var i=/\S+@\S+\.\S+/,s={message:Globalize.localize(e._errorMessages.email),isValid:true};if(t&&t.length>0){s.isValid=i.test(t)}return s},ip:function(e,t){var i=$.trim(t||""),s={message:Globalize.localize(e._errorMessages.ip),isValid:true},n=null,r=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;if(i.length>0){n=i.match(r);if(n){$.each(n,function(e,t){t=parseInt(t,10);if(t>255||t<0){s.isValid=false}})}else{s.isValid=false}}return s},timeTotal:function(e,t){var i=t.value||"",s=true,n;i=$.trim(i);if(i.length>0){n=parseInt(i,10);if(isNaN(n)||!isFinite(i)||n===0){s=false}}return{isValid:s}}},_errorMessages:{ip:"Please enter a valid IP address",email:"Please enter a valid email"},respondentAttributes:[{id:"ip",key:"ip",textLabel:"IP Address"},{id:"email",key:"email",textLabel:"Email Address"},{id:"firstName",key:"first_name",textLabel:"First Name"},{id:"lastName",key:"last_name",textLabel:"Last Name"},{id:"custom",key:"custom",textLabel:"Custom Data",popout_id:"custom-data-popout"}],dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this),t=this,i=t.get("timeTotal"),s={},n,r;$.each(this.respondentAttributes,function(e,i){n=i.id;if(t.get(n)){r=$.trim(t.get(n)||"");if(r){s[i.key]=r}}});e.txt_rows=s;if(i.value){e.time_total=i}return SM.Object.deepCopy(e)},getHeading:function(){var e=this.get("timeTotal"),t=this,i="",s=2,n=0,r=Globalize.culture();if(e&&$.trim(e.value)){i+=Globalize.localize("Response time");i+=" "+e.op+" "+e.value;i+=r.calendar.timeAbbr[e.unit]+", ";n++}$.each(this.respondentAttributes,function(e,r){if(t.get(r.id)){if(n<s){i+=Globalize.localize(r.textLabel);i+=" = "+t.get(r.id)+", "}n++}});i=i.substring(0,i.length-2);if(n>s){i+=" + "+(n-s)}return i},attributeIsVisible:function(e){if(e==="first_name"||e==="last_name"||e==="email"){return this.survey.hasEmailCollector}return true}});SM.Models.extend("FilterCollectorAnRule",SM.BaseAnRule,{__create:function(e){SM.BaseAnRule.__create.call(this,e);this.ruleType="collector"},loadRuleMetadataValue:function(e){SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.rows=_.isEmpty(e.rows)?{}:e.rows},dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this);e.rows=this.get("rows");return SM.Object.deepCopy(e)},getHeading:function(){var e=this.survey,t;t=this._getChoiceSetHeading(this.get("rows"),function(t){var i=e.getCollector(t);return i.title});return t.heading}});SM.Models.extend("FilterCompletenessAnRule",SM.BaseAnRule,{__create:function(e){SM.BaseAnRule.__create.call(this,e);this.ruleType="completeness"},loadRuleMetadataValue:function(e){SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.rows=_.isEmpty(e.rows)?{}:e.rows},dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this);e.rows=this.get("rows");return SM.Object.deepCopy(e)},getHeading:function(){var e=this.get("rows"),t=Globalize.localize("complete responses"),i=Globalize.localize("partial responses"),s=Globalize.localize("disqualified responses"),n=Globalize.localize("responses over quota"),r=[];if(e.completely){r.push(t)}if(e.partially){r.push(i)}if(e.disqualified){r.push(s)}if(e.overquota){r.push(n)}r=r.join(", ");r=r[0].toUpperCase()+r.substr(1);return r}});SM.Models.extend("FilterTimePeriodAnRule",SM.BaseAnRule,{__create:function(e){var t;SM.BaseAnRule.__create.call(this,e);this.ruleType="time_period"},loadRuleMetadataValue:function(e){SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.startDate=e.start_date;this.endDate=e.end_date;this.timeType=e.time_type},__validators:{endDate:function(e,t){if(!t){return{isValid:false}}return{isValid:true}},startDate:function(e,t){if(!t){return{isValid:false}}return{isValid:true}}},getHeading:function(){return Globalize.format(new Date(this.get("startDate")),"d")+" - "+Globalize.format(new Date(this.get("endDate")),"d")},dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this);e.start_date=this.get("startDate");e.end_date=this.get("endDate");e.time_type=this.get("timeType")||"custom";return SM.Object.deepCopy(e)}});SM.Models.extend("BaseQnaAnRule",SM.BaseAnRule,{__create:function(e){SM.BaseAnRule.__create.call(this,e);this.ruleType="qna";this.isQNA=true},loadRuleMetadataValue:function(e){SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.questionID=e.question_id},getQuestion:function(){return this.survey.getQuestion(this.get("questionID"))},getHeading:function(){var e=this.getQuestion(),t=Globalize.localize("Question").substr(0,1),i=t+e.position+": ";return i+this._getQnaHeading()},dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this);if(this.is_nps_distributed){e.is_nps_distributed=true}if(this.choiceSet){e.answers=[this.choiceSet.dump()]}e.is_compare_rule=this.isCompare;e.question_id=this.questionID;return SM.Object.deepCopy(e)},_addCommentFieldHeading:function(e,t){var i=e.heading,s=this.getQuestion().commentField,n,r=this.MAX_CHOICE_HEADING_LENGTH;if(t.get("commentFieldSelected")){e.numChoices++;if(e.numChoices<=r){n=t.get("searchTerm");if(e.numChoices>1){i+=", "}i+=s.text;if(n){i+=[' = "',n,'"'].join("")}e.indexOfLastChoice=i.length}else{i=i.substring(0,e.indexOfLastChoice)+" +"+(e.numChoices-r)}e.heading=i}return e}});SM.Models.extend("QnaSimpleAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{}},loadRuleMetadataValue:function(e){var t=this,i;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,e);this.is_nps_distributed=e.is_nps_distributed||false;if(_.isEmpty(e.answers)){i=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{if(t.is_nps){i=SM.ComparedByNps.choiceSetConvert(e.answers[0])}else{i=e.answers[0]}}this.choiceSet=SM.Models.create("SimpleQnaRuleChoiceSet",i);this.choiceSet.loadRule(this)},__validators:{choiceSet:function(e,t){return t.validate()}},sanitize:function(){var e=this.choiceSet.get("searchTerm");if(e){this.choiceSet.set("searchTerm",_.string.trim(e))}},_getQnaHeading:function(){var e=this,t=this.survey,i;if(e.is_nps){e.is_nps_distributed=SM.ComparedByNps.isDistributed(e.choiceSet.rows,e.getQuestion())}else{e.is_nps_distributed=false}i=e.is_nps_distributed?e._getNpsChoiceSetHeading(e.choiceSet.rows):this._getChoiceSetHeading(this.choiceSet.rows,function(e){return t.getAnswer(e).text});i=this._addCommentFieldHeading(i,this.get("choiceSet"));return i.heading}});SM.Models.extend("SourceSurveysRule",SM.QnaSimpleAnRuleModel,{loadRuleMetadataValue:function(e){var t=this,i;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,e);this.is_nps_distributed=false;if(_.isEmpty(e.answers)){i=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{i=e.answers[0]}this.choiceSet=SM.Models.create("SimpleQnaRuleChoiceSet",i);this.choiceSet.loadRule(this);this.rows=_.isEmpty(e.rows)?{}:e.rows},getHeading:function(){var e=this,t=this.survey,i;i=_.map(this.choiceSet.rows,function(e,i){return t.getSourceSurvey(i).text});return i.join()}});SM.Models.extend("QnaOpenEndedAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{search_type:"all",rows:{},search_term:""}},loadRuleMetadataValue:function(e){var t;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,e);if(_.isEmpty(e.answers)){t=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{t=e.answers[0]}this.choiceSet=SM.Models.create("QnaOpenEndedRuleChoiceSet",t);this.choiceSet.loadRule(this)},__validators:{choiceSet:function(e,t){return t.validate()}},loadSurvey:function(e){var t;SM.BaseQnaAnRuleModel.loadSurvey.call(this,e);t=this.getQuestion();if(t.isEssay()){this.choiceSet.set("selectedRowID","0")}},_getQnaHeading:function(){var e=this.getQuestion(),t=this.choiceSet,i,s;if(e.isEssay()){s=e.heading}else{s=e.getAnswer(t.get("selectedRowID")).text}i=s.substr(-1);if(i===":"||i==="="){s=s.substring(0,s.length-1)}s+=' = "'+t.get("searchTerm")+'"';return s}});SM.Models.extend("QnaDatetimeAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{search_term:undefined,rows:{},op:"="}},__validators:{choiceSet:function(e,t){return t.validate()}},_choiceSetModel:"QnaDateTimeRuleChoiceSet",loadRuleMetadataValue:function(e){var t;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,e);if(_.isEmpty(e.answers)){t=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{t=e.answers[0]}this.choiceSet=SM.Models.create(this._choiceSetModel,t);this.choiceSet.loadRule(this)},_getQnaHeading:function(){var e=this.getQuestion(),t=this.choiceSet.get("op"),i=e.getAnswer(this.choiceSet.get("selectedRowID")).text,s=e.structure.validation,n=s&&s.type,r=this.choiceSet.selectedDate,a=new Date(r.year(),r.month(),r.date(),r.hours(),r.minutes());if(e.subtype==="date_only"){if(n==="date_intl"){i+=" "+t+" "+Globalize.format(a,"d/M/yyyy")}else{i+=" "+t+" "+Globalize.format(a,"d")}}else if(e.subtype==="time_only"){i+=" "+t+" "+Globalize.format(a,"t")}else{if(n==="date_intl"){i+=" "+t+" "+Globalize.format(a,"d/M/yyyy h:mm tt")}else{i+=" "+t+" "+Globalize.format(a,"M/d/yyyy h:mm tt")}}return i}});SM.Models.extend("QnaNumericalAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{comment:{op:"=",rows:{},search_term:""}},loadRuleMetadataValue:function(e){var t;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,e);if(_.isEmpty(e.answers)){t=SM.Object.deepCopy(this.CHOICE_SET_SCHEMA)}else{t=e.answers[0]}this.choiceSet=SM.Models.create("QnaNumericalRuleChoiceSet",t);this.choiceSet.loadRule(this)},__validators:{choiceSet:function(e,t){return t.validate()}},_getQnaHeading:function(){var e=this.getQuestion(),t=this.choiceSet,i=e.getAnswer(t.get("selectedRowID")).text,s;s=i.substr(-1);if(s===":"||s==="="){i=i.substring(0,i.length-1)}i+=" "+this.choiceSet.get("op")+' "'+t.get("searchTerm")+'"';return i},sanitize:function(){var e=Globalize.parseFloat(this.choiceSet.searchTerm,10);this.choiceSet.searchTerm=e.toString()}});SM.Models.register("BaseQnaRuleChoiceSet",{__create:function(e){var t=e.comment;if(t){
this.set("commentFieldSelected",true);this.searchType=t.search_type;this.searchTerm=t.search_term}this.rows=e.rows},loadRule:function(e){this.ruleModel=e},__validators:{searchTerm:function(e,t){var i={isValid:true};if(!e.get("commentFieldSelected")){return i}if(_.isEmpty(t)){return i}if(!SM.String.containsWordBoundary(t)){i.isValid=false}return i}},dump:function(){var e=this.ruleModel.getQuestion(),t=SM.Object.deepCopy({rows:this.rows}),i=e.commentField;if(this.get("commentFieldSelected")&&i){t.comment={search_term:this.get("searchTerm")||null,rows:{}};t.comment.rows[i.id]=true;if(t.comment.search_term){t.comment.search_type=this.get("searchType")||"all"}}return t}});SM.Models.extend("SimpleQnaRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{dump:function(){var e=this.ruleModel.getQuestion(),t=SM.BaseQnaRuleChoiceSetModel.dump.call(this),i=t.comment;if(this.ruleModel.is_nps){t=SM.ComparedByNps.choiceSetRevert(t,e)}if(this.get("commentFieldSelected")&&i&&!i["search_term"]){t.comment["search_term"]=""}return t}});SM.Models.extend("MatrixQnaRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(e){SM.BaseQnaRuleChoiceSetModel.__create.call(this,e);this.cols=e.cols;if(e.colChoices){this.colChoices=e.colChoices}},dump:function(){var e=SM.BaseQnaRuleChoiceSetModel.dump.call(this);e.cols=SM.Object.deepCopy(this.cols);if(this.colChoices){e.col_choices=SM.Object.deepCopy(this.colChoices)}return e}});SM.Models.extend("QnaDateTimeRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(e){var t=SM.Object.getOneKey(e.comment.rows)||"-1",i;this.op=e.comment.op;this.selectedRowID=t;if(t==="-1"){i=moment(new Date);i.startOf("day")}else{i=moment.utc(e.comment.search_term)}this.set("selectedDate",i);this.set("selectedTime",{hours:i.hours(),minutes:i.minutes()})},__validators:{selectedDate:function(e,t){var i=e.ruleModel.getQuestion();if(i.subtype==="date_only"||i.subtype==="both"){return{isValid:t?true:false}}return{isValid:true}},selectedTime:function(e,t){var i=e.ruleModel.getQuestion();if(i.subtype==="time_only"||i.subtype==="both"){if(!t||t.minutes===-1||t.hours===-1){return{isValid:false}}}return{isValid:true}},selectedRowID:function(e,t){var i={isValid:true};if(t==="-1"){i.isValid=false}return i}},dump:function(){var e={rows:{},search_term:this.dumpDateTime(),op:this.get("op")};e.rows[this.get("selectedRowID")]=true;return{comment:e}},dumpDateTime:function(){var e=this.get("selectedDate")||moment(),t=this.get("selectedTime")||{hours:0,minutes:0};e.hours(t.hours);e.minutes(t.minutes);return moment(e).utc().format("YYYY-MM-DD[T]HH:mm:ss")}});SM.Models.extend("QnaOpenEndedRuleChoiceSet",SM.BaseQnaRuleChoiceSetModel,{__create:function(e){this.searchTerm=e.comment.search_term;this.searchType=e.comment.search_type;this.selectedRowID=SM.Object.getOneKey(e.comment.rows)||"-1"},__validators:{searchTerm:function(e,t){var i={isValid:true};if(!SM.String.containsWordBoundary(t)){i.isValid=false}return i},selectedRowID:function(e,t){var i={isValid:true};if(t==="-1"){i.isValid=false}return i}},dump:function(){var e=this.ruleModel.getQuestion(),t={search_term:this.get("searchTerm"),search_type:this.get("searchType")};if(e.isMultiResponse()){t.rows={};t.rows[this.selectedRowID]=true}return{comment:t}}});SM.Models.extend("QnaNumericalRuleChoiceSet",SM.QnaOpenEndedRuleChoiceSetModel,{__create:function(e){SM.BaseQnaRuleChoiceSetModel.__create.call(this,e);this.op=e.comment.op;this.selectedRowID=SM.Object.getOneKey(e.comment.rows)||"-1"},__validators:{searchTerm:function(e,t){var i={isValid:true},s=parseFloat(t,10);if(isNaN(s)||s<0){i.isValid=false}return i},selectedRowID:function(e,t){var i={isValid:true};if(t==="-1"){i.isValid=false}return i}},dump:function(){var e=SM.QnaOpenEndedRuleChoiceSetModel.dump.call(this);delete e.comment.search_type;e.comment.op=this.get("op");return e}});SM.Models.extend("QnaMatrixAnRule",SM.BaseQnaAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{},cols:{}},__validators:{choiceSetList:function(e,t){var i=[];if(t.length===0&&!e.commentChoiceSet){return false}_.each(t,function(e){var t=e.validate();i.push(t)});return i},commentChoiceSet:function(e,t){if(t.get("commentFieldSelected")){return t.validate()}return false}},__create:function(e){SM.BaseQnaAnRuleModel.__create.call(this,e)},loadRuleMetadataValue:function(e){var t=this,i=e.answers,s=e.comment;SM.BaseQnaAnRuleModel.loadRuleMetadataValue.call(this,e);this.choiceSetList=[];if(_.isEmpty(i)){this.addChoiceSet()}else{_.each(i,function(e){t.loadChoiceSet({rows:e.rows,cols:e.cols,colChoices:e.col_choices})})}this.commentChoiceSet=SM.Models.create("MatrixQnaRuleChoiceSet",{comment:s});this.commentChoiceSet.loadRule(this)},commit:function(){this.sanitize();this.lastValidation=this.validate();if(this.lastValidation.invalids.commentChoiceSet){this.lastValidation.isValid=this.lastValidation.invalids.commentChoiceSet.isValid}else{this.lastValidation.isValid=this.lastValidation.invalids.choiceSetList}if(this.lastValidation.isValid){this.lastValidation.invalids=[];delete this._ruleBackup;this.editMode=false}return this.lastValidation.isValid},addChoiceSet:function(){var e=this.loadChoiceSet(SM.Object.deepCopy(this.CHOICE_SET_SCHEMA));e.loadRule(this);return e},loadChoiceSet:function(e){var t;if(!e.cols){return}t=SM.Models.create("MatrixQnaRuleChoiceSet",e);this.choiceSetList.push(t);t.loadRule(this);return t},isInvalidSet:function(e){return SM.Object.getOnlyKey(e.get("rows"))===undefined||SM.Object.getOneKey(e.get("cols"))===undefined||e.get("colChoices")&&SM.Object.getOneKey(e.get("colChoices"))===undefined},sanitize:function(){var e=this.choiceSetList,t=this.commentChoiceSet,i=t.get("searchTerm"),s,n=this,r=0;for(;r<e.length;r++){s=e[r];if(n.isInvalidSet(s)){e.splice(r,1);r--}}if(i){t.set("searchTerm",_.string.trim(i))}},_dumpAnswers:function(){var e=[],t=this;_.each(this.choiceSetList,function(i){if(!t.isInvalidSet(i)){e.push(i.dump())}});return e},dumpRuleValue:function(){var e=this.getQuestion(),t=SM.BaseQnaAnRuleModel.dumpRuleValue.call(this),i=e.commentField,s=this.get("commentChoiceSet"),n,r,a,o;t.question_id=this.questionID;t.answers=this._dumpAnswers();r=this.get("commentFieldSelected")||s&&s.get("commentFieldSelected");if(i&&r){t.comment=this.commentChoiceSet.dump().comment;n=i.id;a=$.trim(t.comment.search_term||null);o={rows:{}};o.rows[n]={search_type:t.comment.search_type||null,search_term:a};t.answers.push(o)}return SM.Object.deepCopy(t)},_getQnaHeading:function(){var e=this.getQuestion(),t=this.choiceSetList,i=this.survey,s=function(e){return i.getAnswer(e).text},n,r,a,o;if(t.length>0){r=SM.Object.getOnlyKey(t[0].get("rows"));if(r){n=e.getAnswer(r).text+": ";o=this._getChoiceSetHeading(t[0].get("cols"),s);n=n+this._addCommentFieldHeading(o,t[0]).heading;if(t.length>1){r=SM.Object.getOnlyKey(t[1].get("rows"));n+="; "+e.getAnswer(r).text+": ";if(t[1].cols){o=this._getChoiceSetHeading(t[1].get("cols"),s);n=n+this._addCommentFieldHeading(o,t[1]).heading}if(t.length>2){n+="..."}}}}if(this.commentChoiceSet.get("commentFieldSelected")){if(t.length<this.MAX_CHOICE_HEADING_LENGTH){a=this.commentChoiceSet.get("searchTerm");if(n){n+="; "}else{n=""}n+=this.getQuestion().commentField.text;if(a){n+=[' = "',a,'"'].join("")}}else{n+="..."}}return n}});SM.Models.extend("QnaRatingCommentPerRowAnRule",SM.QnaMatrixAnRuleModel,{dumpRuleValue:function(){var e=SM.QnaMatrixAnRuleModel.dumpRuleValue.call(this);e.answers=this._dumpAnswers();return SM.Object.deepCopy(e)}});SM.Models.extend("QnaMenuMatrixAnRule",SM.QnaMatrixAnRuleModel,{CHOICE_SET_SCHEMA:{rows:{},cols:{},colChoices:{}},_getQnaHeading:function(){var e=this.getQuestion(),t=this.choiceSetList,i="",s=this.survey,n;if(t.length>0){i+=this._getRowColHeading(e,t[0].rows,t[0].cols);i+=this._getChoiceSetHeading(t[0].colChoices,function(e){return s.getAnswer(e).text}).heading;if(t.length>1){i+="; "+this._getRowColHeading(e,t[1].rows,t[1].cols);i+=this._getChoiceSetHeading(t[1].colChoices,function(e){return s.getAnswer(e).text}).heading;if(t.length>2){i+="..."}}}if(this.commentChoiceSet.get("commentFieldSelected")){if(t.length<this.MAX_CHOICE_HEADING_LENGTH){n=this.commentChoiceSet.get("searchTerm");i+="; "+this.getQuestion().commentField.text;if(n){i+=[' = "',n,'"'].join("")}}else{i+="..."}}return i},_getRowColHeading:function(e,t,i){var s="",n=SM.Object.getOnlyKey(t);s+=e.getAnswer(n).text+", ";n=SM.Object.getOnlyKey(i);s+=e.getAnswer(n).text+": ";return s}});SM.Models.extend("ShowAnRule",SM.BaseAnRule,{__create:function(e){SM.BaseAnRule.__create.call(this,e);this.ruleFamily="show";this.isShow=true;this.ruleType="show"},__getters:{show:function(e){var t=e.get("showSet").dump();t.selected=e.get("selected");return t}},loadSurvey:function(e){this.survey=e;this.showSet=SM.Models.create("ShowSet");this.showSet.loadView(this.survey.anviews.currentView);this.set("selected",this.get("selected")||false)},getHeading:function(){var e=this,t=e.showSet,i="",s=Globalize.localize("Page"),n=Globalize.localize("Question").substr(0,1),r=2,a=0;$.each(this.survey.pageList,function(e,o){if(t.hasPage(o)){if(a<r){i+=s+" "+o.position;if(t.pageQuestionsCheckedCount!==o.questionList.length){i+=": ";$.each(o.questionList,function(e,s){if(t.hasQuestion(s)){i+=n+s.position+", "}});i=i.replace(/,\s$/,"; ")}else{i+=", "}}a++}});i=i.substring(0,i.length-1);if(a>r){i+=" +"+(a-r)}return i},deleteRule:function(){this.showSet.clear();this.set("selected",false);this._trigger({type:"ruleDeleted",ruleModel:this})}});SM.Models.register("ShowSet",{show:null,survey:null,pageQuestionCounts:null,totalQuestionCount:0,totalPageCount:0,loadView:function(e){var t,i,s,n;this.survey=e.anviews.survey;n=e.show;this.clear();if(n.pages){for(t in n.pages){this.show.pages[t]=true;this.totalPageCount++}}if(n.questions){for(i in n.questions){s=this.survey.getQuestion(i);if(!s){continue}this.show.questions[i]=true;this.pageQuestionCounts[s.page.ID]++;this.totalQuestionCount++}}},__create:function(e){this.show={pages:{},questions:{}}},allSelected:function(){if(this.totalQuestionCount===this.survey.questionCount){return true}else{return false}},togglePage:function(e){if(this.show.pages[e.ID]){if(this.pageQuestionCounts[e.ID]===e.questionList.length){this.removePage(e);return false}this.addPage(e);return true}else{this.addPage(e);return true}},toggleQuestion:function(e){if(this.show.questions[e.ID]){this.removeQuestion(e);return false}else{this.addQuestion(e);return true}},toggleAll:function(){if(this.allSelected()){this.clear();return false}else{this.addAll();return true}},addAll:function(){var e=this.survey.pageList,t=0,i,s,n;this.totalQuestionCount=this.survey.questionCount;this.totalPageCount=this.survey.pageList.length;for(;t<e.length;t++){n=e[t];if(n.questionList.length>0){this.show.pages[n.ID]=true;for(i=0;i<n.questionList.length;i++){s=n.questionList[i];this.show.questions[s.ID]=true;this.pageQuestionCounts[n.ID]++}}}},clear:function(){var e={},t=0,i=this.survey.pageList,s=i.length;for(;t<s;t++){e[i[t].ID]=0}this.pageQuestionCounts=e;this.show.pages={};this.show.questions={};this.totalQuestionCount=0;this.totalPageCount=0},addQuestion:function(e){if(!this.show.questions[e.ID]){this.show.questions[e.ID]=true;if(!this.show.pages[e.page.ID]){this.show.pages[e.page.ID]=true}this.pageQuestionCounts[e.page.ID]++;this.totalQuestionCount++}},addPage:function(e){var t=0,i=e.questionList.length;if(!this.show.pages[e.ID]){this.show.pages[e.ID]=true;this.totalPageCount++}this.pageQuestionCounts[e.ID]=i;for(;t<i;t++){if(!this.show.questions[e.questionList[t].ID]){this.show.questions[e.questionList[t].ID]=true;this.totalQuestionCount++}}},removePage:function(e){var t=0,i;if(this.show.pages[e.ID]){for(;t<e.questionList.length;t++){i=e.questionList[t];if(this.show.questions[i.ID]){delete this.show.questions[i.ID];this.totalQuestionCount--}}delete this.show.pages[e.ID];this.pageQuestionCounts[e.ID]=0;this.totalPageCount--}},removeQuestion:function(e){var t=0,i=e.page;if(this.show.questions[e.ID]){this.totalQuestionCount--;this.pageQuestionCounts[e.page.ID]--;delete this.show.questions[e.ID]}if(this.pageQuestionCounts[e.page.ID]===0){delete this.show.pages[e.page.ID]}},hasPage:function(e,t){var i=t||this;return i.show.pages[e.ID]},hasQuestion:function(e,t){var i=t||this;return i.show.questions[e.ID]},questionCheckedCount:function(e){return this.totalQuestionCount},pageQuestionsCheckedCount:function(e){return this.pageQuestionCounts[e.ID]||0},dump:function(){var e=this.show;if(this.isEmpty()){e.questions=null;e.pages=null}return SM.Object.deepCopy(this.show)},isEmpty:function(){return $.isEmptyObject(this.show.questions)||$.isEmptyObject(this.show.pages)},_toNumberList:function(e,t,i){var s=0,n=this.survey.pageList,r="";if(t===e.length||t===0){return Globalize.localize("All")}for(;s<e.length;s++){if(i(e[s],this)){r+=[e[s].position,", "].join("")}}return r.substring(0,r.length-2)},getPageString:function(){return this._toNumberList(this.survey.pageList,this.totalPageCount,this.hasPage)},getQuestionString:function(){return this._toNumberList(this.survey.questionList,this.totalQuestionCount,this.hasQuestion)}});SM.Models.extend("FilterRandomAssignmentRule",SM.BaseAnRule,{__create:function(e){SM.BaseAnRule.__create.call(this,e);this.ruleType="random_assignment";this.isRA=true},dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this);e.rows=this.get("rows");e.question_id=this.get("questionID");e.family=this.getFamily();e.subtype=this.getSubtype();return SM.Object.deepCopy(e)},loadRuleMetadataValue:function(e){SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.rows=_.isEmpty(e.rows)?{}:e.rows;this.questionID=e.question_id},getFamily:function(){return this.getQuestion().family},_mapTypeToText:function(e,t){var i={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test",ranking:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return i[e][t]},getHeading:function(){var e=this,t=this.getQuestion(),i=this.get("rows"),s=[],n,r,a;_.each(i,function(e,i){_.each(t.randomAssignmentList,function(e){if(e.variable_id.toString()===i){s.push(e.variable_name||e.heading)}})});n="Q"+t.position+": "+Globalize.localize("("+this._mapTypeToText(t.family,t.subtype)+")")+" "+s.join(", ");return n},getQuestion:function(){return this.survey.getQuestion(this.get("questionID"))},getRandomAssignmentList:function(){return this.getQuestion().randomAssignmentList},getSubtype:function(){return this.getQuestion().subtype}});SM.Models.extend("CompareRandomAssignmentRule",SM.BaseAnRule,{__create:function(e){e.attrs.is_compare_rule=true;SM.BaseAnRule.__create.call(this,e);this.ruleType="random_assignment";this.isRA=true},dumpRuleValue:function(){var e=SM.BaseAnRule.dumpRuleValue.call(this);e.rows=this.get("rows");e.cols=this.get("cols");e.question_id=this.get("questionID");e.family=this.getFamily();e.subtype=this.getSubtype();e.is_compare_rule=true;return SM.Object.deepCopy(e)},loadRuleMetadataValue:function(e){SM.BaseAnRule.loadRuleMetadataValue.call(this,e);this.rows=_.isEmpty(e.rows)?{}:e.rows;this.questionID=e.question_id},_mapTypeToText:function(e,t){var i={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test",ranking:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return i[e][t]},getHeading:function(){var e=this,t=Globalize.localize("Question").substr(0,1),i=this.getQuestion(),s=this.get("rows"),n=[],r,a,o;_.each(s,function(e,t){_.each(i.randomAssignmentList,function(e){if(e.variable_id.toString()===t){n.push(e.variable_name||e.heading)}})});r=t+i.position+": "+Globalize.localize("("+this._mapTypeToText(i.family,i.subtype)+")")+" "+n.join(", ");return r},getFamily:function(){return this.getQuestion().family},getQuestion:function(){return this.survey.getQuestion(this.get("questionID"))},getRandomAssignmentList:function(){return this.getQuestion().randomAssignmentList},getSubtype:function(){return this.getQuestion().subtype}});SM.Models.register("AnalyzeState",{SUMMARY_MODE:"summary",BROWSE_MODE:"browse",TREND_MODE:"trends",__create:function(e){this.page=e.pageIndex;this.mode=e.mode;this.viewID=e.viewID;this.nextViewID=null},__setters:{page:function(e,t){e.page=t;e.survey.anviews.defaultView.set("page",t)},mode:function(e,t){e.mode=t}},__getters:{page:function(e){return e.survey.anviews.defaultView.get("page")},mode:function(e){return e.mode},allPagesSelected:function(e){return e.get("page")==="all"||e.survey&&e.survey.pageList.length<=1}},isBrowseMode:function(){return this.mode===this.BROWSE_MODE},isSummaryMode:function(){return this.mode===this.SUMMARY_MODE},isTrendMode:function(){return this.mode===this.TREND_MODE},survey:null});(function(e,t){var i,s="ui-button ui-widget ui-state-default ui-corner-all",n="ui-button-icons-only ui-button-icon-only ui-button-text-icons ui-button-text-icon-primary ui-button-text-icon-secondary ui-button-text-only",r=function(){var t=e(this);setTimeout(function(){t.find(":ui-button").button("refresh")},1)},a=function(t){var i=t.name,s=t.form,n=e([]);if(i){i=i.replace(/'/g,"\\'");if(s){n=e(s).find("[name='"+i+"']")}else{n=e("[name='"+i+"']",t.ownerDocument).filter(function(){return!this.form})}}return n};e.widget("ui.button",{version:"1.10.4",defaultElement:"<button>",options:{disabled:null,text:true,label:null,icons:{primary:null,secondary:null}},_create:function(){this.element.closest("form").unbind("reset"+this.eventNamespace).bind("reset"+this.eventNamespace,r);if(typeof this.options.disabled!=="boolean"){this.options.disabled=!!this.element.prop("disabled")}else{this.element.prop("disabled",this.options.disabled)}this._determineButtonType();this.hasTitle=!!this.buttonElement.attr("title");var t=this,n=this.options,o=this.type==="checkbox"||this.type==="radio",l=!o?"ui-state-active":"";if(n.label===null){n.label=this.type==="input"?this.buttonElement.val():this.buttonElement.html()}this._hoverable(this.buttonElement);this.buttonElement.addClass(s).attr("role","button").bind("mouseenter"+this.eventNamespace,function(){if(n.disabled){return}if(this===i){e(this).addClass("ui-state-active")}}).bind("mouseleave"+this.eventNamespace,function(){if(n.disabled){return}e(this).removeClass(l)}).bind("click"+this.eventNamespace,function(e){if(n.disabled){e.preventDefault();e.stopImmediatePropagation()}});this._on({focus:function(){this.buttonElement.addClass("ui-state-focus")},blur:function(){this.buttonElement.removeClass("ui-state-focus")}});if(o){this.element.bind("change"+this.eventNamespace,function(){t.refresh()})}if(this.type==="checkbox"){this.buttonElement.bind("click"+this.eventNamespace,function(){if(n.disabled){return false}})}else if(this.type==="radio"){this.buttonElement.bind("click"+this.eventNamespace,function(){if(n.disabled){return false}e(this).addClass("ui-state-active");t.buttonElement.attr("aria-pressed","true");var i=t.element[0];a(i).not(i).map(function(){return e(this).button("widget")[0]}).removeClass("ui-state-active").attr("aria-pressed","false")})}else{this.buttonElement.bind("mousedown"+this.eventNamespace,function(){if(n.disabled){return false}e(this).addClass("ui-state-active");i=this;t.document.one("mouseup",function(){i=null})}).bind("mouseup"+this.eventNamespace,function(){if(n.disabled){return false}e(this).removeClass("ui-state-active")}).bind("keydown"+this.eventNamespace,function(t){if(n.disabled){return false}if(t.keyCode===e.ui.keyCode.SPACE||t.keyCode===e.ui.keyCode.ENTER){e(this).addClass("ui-state-active")}}).bind("keyup"+this.eventNamespace+" blur"+this.eventNamespace,function(){e(this).removeClass("ui-state-active")});if(this.buttonElement.is("a")){this.buttonElement.keyup(function(t){if(t.keyCode===e.ui.keyCode.SPACE){e(this).click()}})}}this._setOption("disabled",n.disabled);this._resetButton()},_determineButtonType:function(){var e,t,i;if(this.element.is("[type=checkbox]")){this.type="checkbox"}else if(this.element.is("[type=radio]")){this.type="radio"}else if(this.element.is("input")){this.type="input"}else{this.type="button"}if(this.type==="checkbox"||this.type==="radio"){e=this.element.parents().last();t="label[for='"+this.element.attr("id")+"']";this.buttonElement=e.find(t);if(!this.buttonElement.length){e=e.length?e.siblings():this.element.siblings();this.buttonElement=e.filter(t);if(!this.buttonElement.length){this.buttonElement=e.find(t)}}this.element.addClass("ui-helper-hidden-accessible");i=this.element.is(":checked");if(i){this.buttonElement.addClass("ui-state-active")}this.buttonElement.prop("aria-pressed",i)}else{this.buttonElement=this.element}},widget:function(){return this.buttonElement},_destroy:function(){this.element.removeClass("ui-helper-hidden-accessible");this.buttonElement.removeClass(s+" ui-state-active "+n).removeAttr("role").removeAttr("aria-pressed").html(this.buttonElement.find(".ui-button-text").html());if(!this.hasTitle){this.buttonElement.removeAttr("title")}},_setOption:function(e,t){this._super(e,t);if(e==="disabled"){this.element.prop("disabled",!!t);if(t){this.buttonElement.removeClass("ui-state-focus")}return}this._resetButton()},refresh:function(){var t=this.element.is("input, button")?this.element.is(":disabled"):this.element.hasClass("ui-button-disabled");if(t!==this.options.disabled){this._setOption("disabled",t)}if(this.type==="radio"){a(this.element[0]).each(function(){if(e(this).is(":checked")){e(this).button("widget").addClass("ui-state-active").attr("aria-pressed","true")}else{e(this).button("widget").removeClass("ui-state-active").attr("aria-pressed","false")}})}else if(this.type==="checkbox"){if(this.element.is(":checked")){this.buttonElement.addClass("ui-state-active").attr("aria-pressed","true")}else{this.buttonElement.removeClass("ui-state-active").attr("aria-pressed","false")}}},_resetButton:function(){if(this.type==="input"){if(this.options.label){this.element.val(this.options.label)}return}var t=this.buttonElement.removeClass(n),i=e("<span></span>",this.document[0]).addClass("ui-button-text").html(this.options.label).appendTo(t.empty()).text(),s=this.options.icons,r=s.primary&&s.secondary,a=[];if(s.primary||s.secondary){if(this.options.text){a.push("ui-button-text-icon"+(r?"s":s.primary?"-primary":"-secondary"))}if(s.primary){t.prepend("<span class='ui-button-icon-primary ui-icon "+s.primary+"'></span>")}if(s.secondary){t.append("<span class='ui-button-icon-secondary ui-icon "+s.secondary+"'></span>")}if(!this.options.text){a.push(r?"ui-button-icons-only":"ui-button-icon-only");if(!this.hasTitle){t.attr("title",e.trim(i))}}}else{a.push("ui-button-text-only")}t.addClass(a.join(" "))}});e.widget("ui.buttonset",{version:"1.10.4",options:{items:"button, input[type=button], input[type=submit], input[type=reset], input[type=checkbox], input[type=radio], a, :data(ui-button)"},_create:function(){this.element.addClass("ui-buttonset")},_init:function(){this.refresh()},_setOption:function(e,t){if(e==="disabled"){this.buttons.button("option",e,t)}this._super(e,t)},refresh:function(){var t=this.element.css("direction")==="rtl";this.buttons=this.element.find(this.options.items).filter(":ui-button").button("refresh").end().not(":ui-button").button().end().map(function(){return e(this).button("widget")[0]}).removeClass("ui-corner-all ui-corner-left ui-corner-right").filter(":first").addClass(t?"ui-corner-right":"ui-corner-left").end().filter(":last").addClass(t?"ui-corner-left":"ui-corner-right").end().end()},_destroy:function(){this.element.removeClass("ui-buttonset");this.buttons.map(function(){return e(this).button("widget")[0]}).removeClass("ui-corner-left ui-corner-right").end().button("destroy")}})})(jQuery);(function(e){function t(e){return function(){var t=this.element.val();e.apply(this,arguments);this._refresh();if(t!==this.element.val()){this._trigger("change")}}}e.widget("ui.spinner",{version:"1.10.4",defaultElement:"<input>",widgetEventPrefix:"spin",options:{culture:null,icons:{down:"ui-icon-triangle-1-s",up:"ui-icon-triangle-1-n"},incremental:true,max:null,min:null,numberFormat:null,page:10,step:1,change:null,spin:null,start:null,stop:null},_create:function(){this._setOption("max",this.options.max);this._setOption("min",this.options.min);this._setOption("step",this.options.step);if(this.value()!==""){this._value(this.element.val(),true)}this._draw();this._on(this._events);this._refresh();this._on(this.window,{beforeunload:function(){this.element.removeAttr("autocomplete")}})},_getCreateOptions:function(){var t={},i=this.element;e.each(["min","max","step"],function(e,s){var n=i.attr(s);if(n!==undefined&&n.length){t[s]=n}});return t},_events:{keydown:function(e){if(this._start(e)&&this._keydown(e)){e.preventDefault()}},keyup:"_stop",focus:function(){this.previous=this.element.val()},blur:function(e){if(this.cancelBlur){delete this.cancelBlur;return}this._stop();this._refresh();if(this.previous!==this.element.val()){this._trigger("change",e)}},mousewheel:function(e,t){if(!t){return}if(!this.spinning&&!this._start(e)){return false}this._spin((t>0?1:-1)*this.options.step,e);clearTimeout(this.mousewheelTimer);this.mousewheelTimer=this._delay(function(){if(this.spinning){this._stop(e)}},100);e.preventDefault()},"mousedown .ui-spinner-button":function(t){var i;i=this.element[0]===this.document[0].activeElement?this.previous:this.element.val();function s(){var e=this.element[0]===this.document[0].activeElement;if(!e){this.element.focus();this.previous=i;this._delay(function(){this.previous=i})}}t.preventDefault();s.call(this);this.cancelBlur=true;this._delay(function(){delete this.cancelBlur;s.call(this)});if(this._start(t)===false){return}this._repeat(null,e(t.currentTarget).hasClass("ui-spinner-up")?1:-1,t)},"mouseup .ui-spinner-button":"_stop","mouseenter .ui-spinner-button":function(t){if(!e(t.currentTarget).hasClass("ui-state-active")){return}if(this._start(t)===false){return false}this._repeat(null,e(t.currentTarget).hasClass("ui-spinner-up")?1:-1,t)},"mouseleave .ui-spinner-button":"_stop"},_draw:function(){var e=this.uiSpinner=this.element.addClass("ui-spinner-input").attr("autocomplete","off").wrap(this._uiSpinnerHtml()).parent().append(this._buttonHtml());this.element.attr("role","spinbutton");this.buttons=e.find(".ui-spinner-button").attr("tabIndex",-1).button().removeClass("ui-corner-all");if(this.buttons.height()>Math.ceil(e.height()*.5)&&e.height()>0){e.height(e.height())}if(this.options.disabled){this.disable()}},_keydown:function(t){var i=this.options,s=e.ui.keyCode;switch(t.keyCode){case s.UP:this._repeat(null,1,t);return true;case s.DOWN:this._repeat(null,-1,t);return true;case s.PAGE_UP:this._repeat(null,i.page,t);return true;case s.PAGE_DOWN:this._repeat(null,-i.page,t);return true}return false},_uiSpinnerHtml:function(){return"<span class='ui-spinner ui-widget ui-widget-content ui-corner-all'></span>"},_buttonHtml:function(){return""+"<a class='ui-spinner-button ui-spinner-up ui-corner-tr'>"+"<span class='ui-icon "+this.options.icons.up+"'>&#9650;</span>"+"</a>"+"<a class='ui-spinner-button ui-spinner-down ui-corner-br'>"+"<span class='ui-icon "+this.options.icons.down+"'>&#9660;</span>"+"</a>"},_start:function(e){if(!this.spinning&&this._trigger("start",e)===false){return false}if(!this.counter){this.counter=1}this.spinning=true;return true},_repeat:function(e,t,i){e=e||500;clearTimeout(this.timer);this.timer=this._delay(function(){this._repeat(40,t,i)},e);this._spin(t*this.options.step,i)},_spin:function(e,t){var i=this.value()||0;if(!this.counter){this.counter=1}i=this._adjustValue(i+e*this._increment(this.counter));if(!this.spinning||this._trigger("spin",t,{value:i})!==false){this._value(i);this.counter++}},_increment:function(t){var i=this.options.incremental;if(i){return e.isFunction(i)?i(t):Math.floor(t*t*t/5e4-t*t/500+17*t/200+1)}return 1},_precision:function(){var e=this._precisionOf(this.options.step);if(this.options.min!==null){e=Math.max(e,this._precisionOf(this.options.min))}return e},_precisionOf:function(e){var t=e.toString(),i=t.indexOf(".");return i===-1?0:t.length-i-1},_adjustValue:function(e){var t,i,s=this.options;t=s.min!==null?s.min:0;i=e-t;i=Math.round(i/s.step)*s.step;e=t+i;e=parseFloat(e.toFixed(this._precision()));if(s.max!==null&&e>s.max){return s.max}if(s.min!==null&&e<s.min){return s.min}return e},_stop:function(e){if(!this.spinning){return}clearTimeout(this.timer);clearTimeout(this.mousewheelTimer);this.counter=0;this.spinning=false;this._trigger("stop",e)},_setOption:function(e,t){if(e==="culture"||e==="numberFormat"){var i=this._parse(this.element.val());this.options[e]=t;this.element.val(this._format(i));return}if(e==="max"||e==="min"||e==="step"){if(typeof t==="string"){t=this._parse(t)}}if(e==="icons"){this.buttons.first().find(".ui-icon").removeClass(this.options.icons.up).addClass(t.up);this.buttons.last().find(".ui-icon").removeClass(this.options.icons.down).addClass(t.down)}this._super(e,t);if(e==="disabled"){if(t){this.element.prop("disabled",true);this.buttons.button("disable")}else{this.element.prop("disabled",false);this.buttons.button("enable")}}},_setOptions:t(function(e){this._super(e);this._value(this.element.val())}),_parse:function(e){if(typeof e==="string"&&e!==""){e=window.Globalize&&this.options.numberFormat?Globalize.parseFloat(e,10,this.options.culture):+e}return e===""||isNaN(e)?null:e},_format:function(e){if(e===""){return""}return window.Globalize&&this.options.numberFormat?Globalize.format(e,this.options.numberFormat,this.options.culture):e},_refresh:function(){this.element.attr({"aria-valuemin":this.options.min,"aria-valuemax":this.options.max,"aria-valuenow":this._parse(this.element.val())})},_value:function(e,t){var i;if(e!==""){i=this._parse(e);if(i!==null){if(!t){i=this._adjustValue(i)}e=this._format(i)}}this.element.val(e);this._refresh()},_destroy:function(){this.element.removeClass("ui-spinner-input").prop("disabled",false).removeAttr("autocomplete").removeAttr("role").removeAttr("aria-valuemin").removeAttr("aria-valuemax").removeAttr("aria-valuenow");this.uiSpinner.replaceWith(this.element)},stepUp:t(function(e){this._stepUp(e)}),_stepUp:function(e){if(this._start()){this._spin((e||1)*this.options.step);this._stop()}},stepDown:t(function(e){this._stepDown(e)}),_stepDown:function(e){if(this._start()){this._spin((e||1)*-this.options.step);this._stop()}},pageUp:t(function(e){this._stepUp((e||1)*this.options.page)}),pageDown:t(function(e){this._stepDown((e||1)*this.options.page)}),value:function(e){if(!arguments.length){return this._parse(this.element.val())}t(this._value).call(this,e)},widget:function(){return this.uiSpinner}})})(jQuery);SM.SharedViewsRouter=function(e){var t=this;t.initialize=function(e){t.survey=e.survey};t.newSharedView=function(e){e=e||{};var s,n=this.survey.anviews.defaultView.ID,r=_.has(e,"view")?e.view.ID:this.survey.anviews.currentView.ID;s=SM.Models.create("SharedView",{survey:t.survey,attrs:{survey_id:this.survey.ID,default_view_id:n,sharable_view_id:r}});i(s)};t.edit=function(e,t){i(e,t)};t.show=function(e){window.open(e.sharedPageURL())};t.destroy=function(e){e.destroy()};function i(e,t){var i,s;i=SM.Views.create(SM.DialogView,{isModal:true,width:710,easyClose:true,closeBtn:true,templateID:"shared-view-dialog-template"});s=SM.Views.create(SM.SharedViewFormView,{dialogView:i,sharedView:e});if(e.survey.owner.canHaveMultiSeat()){i.$el.find("[shared-view-form-container]").before(SM.Template.renderHTML("shared-group-upgrade-template"));
}i.$el.find("[shared-view-form-container]").append(s.$el);i.open();s.setViewLink(!!t)}t.initialize(e)};SM.Models.register("ExportJobPoller",{EXPONENTIAL_COEFFICIENT:1.5,KILL_SWITCH_CAP:30,interval:6e3,iterations:0,isActive:false,__create:function(e){var t=e.config;this.START_INTERVAL=t.start_interval||6e3;this.INTERVAL_CAP=t.interval_cap||6e4;this.ITERATION_CAP=t.iteration_cap||15},loadJobs:function(e){this.exportJobs=e},start:function(){var e=this,t=0;this.iterations=0;this.interval=this.START_INTERVAL;if(this.get("isActive")||!this.hasJobsPending()){return}this.set("isActive",true,{notify:true});this._poll()},_poll:function(){var e=this;if(this.iterations>this.ITERATION_CAP){if(this.iterations<this.KILL_SWITCH_CAP){this.interval=this.INTERVAL_CAP*5}else{this.stop();return}}else{if(this.interval>this.INTERVAL_CAP){this.interval=this.INTERVAL_CAP}}this.intervalID=setTimeout(function(){e._onePoll()},this.interval)},_onePoll:function(){if(!this.get("isActive")||!this.hasJobsPending()){this.stop();return}this.interval*=this.EXPONENTIAL_COEFFICIENT;this.iterations++;this.updateStatuses();this._poll()},hasJobsPending:function(){var e=this.exportJobs.list,t=e.length,i=0,s;for(;i<t;i++){s=e[i];if(s.pending()){return true}}return false},stop:function(){this.set("isActive",false,{notify:true});clearTimeout(this.intervalID);delete this.intervalID},updateStatuses:function(){var e=null;if(SM.App.isSharingApp()){var t=[];$.each(this.exportJobs.list,function(e,i){t.push(i.ID)});e={exportjob_ids:t}}var i=SM.API.getExportList(e);$.when(i,{self:this}).done(this._onFetchedStatuses)},_onFetchedStatuses:function(e,t){var i=e[0],s=0,n=t.self,r,a=SM.Models.create("ExportJobList");a.loadJobs(i["exportjob_list"]);$.each(n.exportJobs.list,function(e,t){r=a.map[t.ID];if(r){if(r.status!==t.status){t.downloadLink=r.downloadLink;t.set("status",r.status,{notify:true})}}});if(!n.hasJobsPending()){n.stop()}}});SM.Models.register("ExportJobList",{EXPORT:"export",isLoaded:false,__create:function(e){this.list=null;this.map=null;this._cancelledJobs={};this.isUnavailable=false;this.isUserInBillingRetry=false;this.isDriveAuthorized=false;this.config=e},isAvailable:function(){return!this.isUnavailable},isNotAllowedToExport:function(){return this.isUserInBillingRetry},requiresDriveAuth:function(){return!this.isDriveAuthorized},onAuthEstablished:function(e){if(e!=null){e.finalizeExportData();this.addJob(e)}this.isDriveAuthorized=true},createJob:function(e){var t=SM.Models.create("ExportJob",{data:e});t.exportJobs=this;return t},addJob:function(e){var t=e.sourceView,i,s;e.createJobInfo(t);if(t.isCurrent){e.jobInfo.view_name=this.survey.anviews.getSelectedView().name;if(t.get("isDirty")){i=Globalize.localize("edited");e.jobInfo.view_name+="("+i+")"}}e.loadDate("createDate",(new Date).getTime());e.on("status.changed",{self:this,job:e},this._onJobStatusChanged);this.map[e.ID]=e;this.list.unshift(e);s=SM.API.createExport({view_id:t.ID,exportjob:e.dump()});$.when(s,{exportID:e.ID,self:this}).done(this._onExportCreated).fail(function(t){e.set("failedRequestID",t.request_id);if(t.status===601){e.set("status",e.STATUS.TOO_LARGE_ERROR,{notify:true})}else{e.set("status",e.STATUS.SERVER_ERROR,{notify:true})}});this._trigger({type:"jobAdded",job:e})},_onExportCreated:function(e,t){var i=t.self,s=e[0].export_job.exportjob_id,n=i.map[t.exportID],r=i._cancelledJobs[t.exportID];if(n){delete i.map[n.ID];n.set("ID",s);i.map[s]=n;i.poller.start()}else if(r){delete i._cancelledJobs[t.exportID];r.set("ID",s);r.deleteJob()}},loadJobs:function(e){var t=this;if(!this.get("isLoaded")){this.list=[];this.map={}}$.each(e,function(e,i){var s=SM.Models.create("ExportJob",{data:i});t.map[s.ID]=s;t.list.push(s);s.exportJobs=t;s.on("status.changed",{self:t,job:s},t._onJobStatusChanged)});this.set("isLoaded",true,{notify:true})},hasFullExportPending:function(){var e=false,t=this.list||[];$.each(t,function(t,i){if(i.type==="full"&&i.pending()){e=true;return false}});return e},getPendingFullExports:function(){var e=null,t=this.list||[];return $.map(t,function(e){if(e.type==="full"&&e.pending()){return e}})},deleteJob:function(e){var t=this;e.deleteJob();delete t.map[e.ID];e.off("status.changed",t._onJobStatusChanged);t._spliceJob(e.ID);this._trigger({type:"jobDeleted",job:e})},cancelJob:function(e){var t=this;e.set("isCancelled",true,{notify:true});t._cancelledJobs[e.ID]=e;delete t.map[e.ID];e.off("status.changed",t._onJobStatusChanged);t._spliceJob(e.ID);this._trigger({type:"jobCancelled",job:e})},_onJobStatusChanged:function(e){var t=e.data.self;t._trigger({type:"jobStatusChanged",job:e.data.job})},fetchJobs:function(){var e=this;if(this.survey.owner.isBasic()||SM.App.isSharingApp()){this.loadJobs([])}else if(!this.get("isLoaded")){$.when(SM.API.getExportList(),{self:this}).done(this._onFetchedJobs).fail(function(t,i,s){e._onJobFetchFailed(t)})}},_spliceJob:function(e){var t=this;$.each(t.list,function(i,s){if(e===s.ID){t.list.splice(i,1);return false}})},_onFetchedJobs:function(e,t){var i=t.self,s=e[0];i.set("unavailableErrorID","");i.set("isUnavailable",false,{notify:true});i.set("isUserInBillingRetry",s["is_user_in_billing_retry"]);i.set("isDriveAuthorized",s["is_drive_authorized"]);i.loadJobs(s["exportjob_list"]);i.poller.start()},_onJobFetchFailed:function(e){if(e.status===503){this.set("unavailableErrorID",e.request_id);this.set("isUnavailable",true,{notify:true})}}});SM.Models.register("ExportJob",{STATUS:{SUCCESS:"succeeded",ENQUEUED:"enqueued",STARTED:"started",SERVER_ERROR:"server_error",FILTER_ERROR:"filter_error",CROSSTAB_ERROR:"crosstab_error",TOO_LARGE_ERROR:"too_large_error"},FORMAT:{CSV:"csv",EXCEL:"excel",EXCEL_PLUS:"excel_plus",GIF:"gif",HTML:"html",JPG:"jpg",PDF:"pdf",PNG:"png",PPT:"ppt",SPSS:"spss"},TYPE:{SUMMARY_EXPORT:"summary",ALL_EXPORT:"full",CHART_EXPORT:"chart"},NOTIFICATION_MESSAGES:{succeeded:"Your export is complete",server_error:"There was a problem exporting your data",filter_error:"There was a problem exporting your data",crosstab_error:"There was a problem exporting your data",too_large_error:"Your export file is too large to process"},sourceView:null,exportExtensionMap:{csv:".zip",excel:".zip",excel_plus:".zip",gif:".zip",html:".zip",jpg:".zip",pdf:".pdf",png:".png",gss:"",ppt:".pptx",spss:".zip"},__create:function(e){this.load(e.data)},__setters:{includeOpenended:function(e,t){e.exportData.include_openended=t},includeChart:function(e,t){e.exportData.include_chart=t},pdfOrientation:function(e,t){e.exportData.orientation=t},pdfPaperSize:function(e,t){e.exportData.dimension=t},format:function(e,t){if(t===undefined){return}e.format=t;e.name=e.generateFileName();e.initExport()},questionDisplay:function(e,t){e.exportData.question_display=t},columnSetting:function(e,t){e.exportData.column_setting=t},cellType:function(e,t){e.exportData.cell_type=t},useNonBrandedTemplate:function(e,t){e.exportData.non_branded_template=t},forcedPageBreak:function(e,t){e.exportData.forced_page_break=t}},__getters:{includeOpenended:function(e){return e.exportData.include_openended},includeChart:function(e){return e.exportData.include_chart},pdfOrientation:function(e){return e.exportData.orientation},pdfPaperSize:function(e){return e.exportData.dimension},isSingleQuestionMode:function(e){return e.exportData&&e.exportData.question_id!==undefined},isSingleResponseMode:function(e){return e.exportData&&e.exportData.respondent_id!=="all"},forcedPageBreak:function(e){return e.exportData.forced_page_break}},initExport:function(){var e=this._initByTypeFormat[this.type],t;this.exportData={};if(e){t=e[this.format];if(t){t(this)}}this.exportData["timezone_offset"]=SM.Date.stdTimezoneOffset()*6e4},_initByTypeFormat:{summary:{pdf:function(e){var t=false;e.createPDFSettings(t);if(e.questionID){e.exportData.question_id=e.questionID;e.exportData.questionNumber=e.questionNumber}},excel:function(e){e.exportData={question_display:"multiple_sheets",include_openended:false,include_chart:true};if(e.questionID){e.exportData.question_id=e.questionID;e.exportData.questionNumber=e.questionNumber}},csv:function(e){e.exportData={include_openended:false};if(e.questionID){e.exportData.question_id=e.questionID;e.exportData.questionNumber=e.questionNumber}},ppt:function(e){e.exportData={non_branded_template:false,include_openended:false,include_charts:true,include_tables:true,zoomFactor:"1",question_ids:[],survey_title:SM.String.textTitle(e.exportJobs.survey.title),todays_date:Globalize.format(new Date,"D"),survey_summary:{summary_translations:{complete_responses:Globalize.localize("Complete Responses"),date_created:Globalize.localize("Date Created"),total_responses:Globalize.localize("Total Responses")},total_responses:0,complete_responses:0,date_created:Globalize.format(e.exportJobs.survey.dateCreated,"D")},css_selectors:".sm-chart,.sm-data-table-container"};if(e.questionID){e.exportData.question_id=e.questionID;e.exportData.questionNumber=e.questionNumber}}},chart:{png:function(e){e.exportData={question_id:e.questionID,questionNumber:e.questionNumber,css_selectors:[".sm-export-question-view"]}}},full:{excel:function(e){e.exportData={column_setting:"condensed",cell_type:"actual_choice_text"}},pdf:function(e){var t=true;e.createPDFSettings(t);e.exportData.respondent_id=e.respondentID}}},createPDFSettings:function(e){var t=this,i=t.exportJobs.survey.owner.isSelect(),s={headerHeight:"0.8cm",footerHeight:"0.8cm",marginTop:"0.1cm",marginLeft:"1cm",marginRight:"1cm",marginBottom:"0.1cm",header:SM.Template.render("phantom-pdf-header-template"),footer:SM.Template.render("phantom-pdf-footer-template"),phantomjs_pdf_enabled:true},n={marginTop:"15mm",marginBottom:"15mm",headerSpacing:"3",footerSpacing:"2",phantomjs_pdf_enabled:false},r;t.exportData={orientation:"portrait",include_openended:e,dimension:"letter",zoomFactor:".95",forced_page_break:true};if(t.exportJobs.survey.config.phantomjs_pdf_enabled){_.extend(t.exportData,s)}else{_.extend(t.exportData,n);r=i?"pdf-branded-header-template":"pdf-header-template";t.exportData.header=SM.Template.render(r);t.exportData.footer=SM.Template.render("pdf-footer-template")}},load:function(e){this.ID=e.exportjob_id||"exp-"+this.__uid;this.email=e.email||"";this.jobInfo=e.job_info||{};this.filterData=e.filter_data||null;this.compareData=e.crosstab||null;this.format=e.format;this.type=e.export_type;this.loadDate("createDate",e.create_date);this.loadDate("startDate",e.start_date);this.loadDate("endDate",e.end_date);this.exportPreferences=this.export_pref;this.downloadLink=e.download_link;this.status=e.job_status||"enqueued";this.size=e.size;this.exportData=e.export_data;if(e.export_data){this.questionID=e.export_data.question_id;this.respondentID=e.export_data.respondent_id}this.questionNumber=e.questionNumber;this.respondentNumber=e.respondentNumber;this.name=e.custom_filename||this.generateFileName()},dump:function(){var e=this.exportData.question_display;if(this.type==="summary"&&this.format==="excel"&&e!=="multiple_sheets"){this.set("includeChart",false)}return{custom_filename:this.name,format:this.format,email:this.email,export_data:this.exportData,export_type:this.type,job_info:this.jobInfo,type:this.type}},generateFileName:function(e){var t=new Date,i=this.type,s=this.format,n=this.exportExtensionMap[s],r,a,o,l,u,d,h,c;if(e){return e+n}if(i==="chart"){o=Globalize.localize("Chart");l=Globalize.localize("Question")[0];e=o+"_"+l+this.questionNumber}else if(i==="summary"&&this.questionNumber!==undefined){u=Globalize.localize("Data");l=Globalize.localize("Question")[0];e=u+"_"+l+this.questionNumber}else if(i==="full"&&s==="pdf"){if(this.exportData.respondent_id!=="all"){h=Globalize.localize("Response");c=this.respondentNumber}else{h=Globalize.localize("Responses");c=Globalize.localize("All")}e=h+"_"+c}else{u=Globalize.localize("Data");d=Globalize.localize("All");e=u+"_"+d}r=[e+"_",t.getFullYear().toString().substring(2,4),this.doubleDigify(t.getMonth()+1),this.doubleDigify(t.getDate())].join("")+n;return r},loadDate:function(e,t){if(t){this[e]=new Date(t)}else{this[e]=null}if(e==="createDate"&&t){this.expirationDate=new Date(t);this.expirationDate.setDate(this.expirationDate.getDate()+14)}},doubleDigify:function(e){e=e.toString();if(e.length<2){e="0"+e}return e},failed:function(){return this.status===this.STATUS.CROSSTAB_ERROR||this.status===this.STATUS.FILTER_ERROR||this.status===this.STATUS.TOO_LARGE_ERROR||this.status===this.STATUS.SERVER_ERROR},createJobInfo:function(e){var t=SM.Models.create("ShowSet");t.loadView(e);this.jobInfo={view_name:e.name,pages:t.getPageString(),questions:t.getQuestionString()}},getReadableStatus:function(){if(this.failed()){return"failed"}if(this.done()){return"finished"}if(this.pending()){return"processing"}},done:function(){return this.status===this.STATUS.SUCCESS},pending:function(){return this.status===this.STATUS.ENQUEUED||this.status===this.STATUS.STARTED},deleteJob:function(){SM.API.deleteExport({export_id:this.ID});this._trigger("deleted")},toDateString:function(e){if(!e){return"N/A"}return Globalize.format(e,"d")},isNew:function(){return SM.String.beginsWith(this.ID,"exp-")},isDrive:function(){return this.format==="gss"},finalizeExportData:function(){if(this.format===this.FORMAT.PPT){this.finalizePptExportData()}},finalizePptExportData:function(){var e=this.exportData,t=this.exportData.survey_summary,i=this.exportJobs.survey,s=i.respondentCounts.total,n=i.respondentCounts.total_context,r,a,o;if(e.question_id){r=[i.getQuestion(e.question_id)]}else if(this.sourceView.isCurrent){r=i.shownQuestionList}else{r=i.questionList}_.each(r,function(t){if(this.canExportQuestionInPPT(t)){e.question_ids.push(t.ID)}},this)},canExportQuestionInPPT:function(e){var t=e.isOpenEnded()&&!e.isNumerical();return!(t||e.hasRandomAssignment())}});SM.Models.register("SharedViewList",{__defaults:{isLoaded:false},__create:function(e){this.survey=e.survey;this.list=[];_.bindAll(this,"_onViewsFetched","_onViewsFetchFailed")},add:function(e){var t=this,i;i=_.indexOf(_.pluck(t.list,"key"),e.get("key"));if(i===-1){t.list.push(e);t._trigger({type:"add",sharedView:e})}},remove:function(e){var t=this,i;i=_.indexOf(t.list,e);t.list.splice(i,1);t._trigger({type:"remove",sharedView:e})},load:function(e){var t=this,i,s;_.each(e,function(e,n){s={survey:t.survey,list:t,attrs:e,index:n};i=SM.Models.create("SharedView",s);t.list.push(i)});t.set("isLoaded",true,{notify:true})},fetch:function(){var e={survey_id:this.survey.ID};$.when(SM.API.fetchSharedViewList(e),{self:this}).done(this._onViewsFetched).fail(this._onViewsFetchFailed)},_onViewsFetched:function(e,t){var i=e[0],s=i.shared_views;this.load(s)},_onViewsFetchFailed:function(e,t,i){}});SM.Models.register("Quota",{__create:function(e){var t=this;t.totalContext=e.quota_data.current_response_count;t.total=e.quota_data.max_response_count;t.label=e.quota_data.display_label;t.filter_group_id=e.quota_data.filter_group_id;t.quota_id=e.quota_data.quota_id;t.quota_equation_id=e.quota_data.quota_equation_id;t.status=e.quota_data.status;if(t.totalContext>t.total){t.totalContext=t.total}t.percent=t.totalContext/t.total}});SM.Models.register("QuotaList",{__create:function(e){var t=this;t.quota_list_data=e.quota_data.model;t.quota_list=[];t.total=0;t.totalContext=0;$.each(t.quota_list_data.equations,function(e,i){t.quota_list.push(SM.Models.create("Quota",{quota_data:i}));t.totalContext+=t.quota_list[e].totalContext;t.total+=t.quota_list[e].total});if(t.totalContext>t.total){t.totalContext=t.total}t.numQuotas=t.quota_list.length;t.percent=t.totalContext/t.total}});SM.Models.register("DataSegment",{__create:function(e){this.segmentList=e.segmentList;this.segmentData=e.segmentData;if(!this.segmentData.isFake){this.segmentData.isFake=false}},getData:function(){return this.segmentData},isDefault:function(){return this.segmentData.isDefault},isFake:function(){return this.segmentData.isFake},name:function(){return this.segmentData.name},getCanonicalName:function(){var e=this.segmentList.survey.isTMBCTemplate(),t=this.isLegacy(),i=this.isDefault(),s=t?this.segmentId:i?"":this.segmentData.id;if(s===""){s=e?"standout_gei_benchmark":"survey_monkey_global_benchmark"}return s},setName:function(e){this.segmentData.name=e},id:function(){return this.segmentData.id},isLegacy:function(){return!this.id()&&!this.isDefault()},isDerived:function(){return!!this.segmentData._derivedFrom},derivedFrom:function(){return this.segmentData._derivedFrom},segmentId:function(){return this.segmentData.segmentId},keys:function(){return this.segmentData.keys},dateStart:function(){return this.segmentData.date_start},dateEnd:function(){return this.segmentData.date_end},percentileStart:function(){return this.segmentData.percentile_start||0},percentileEnd:function(){return this.segmentData.percentile_end||100},isSelected:function(){return this.segmentData.isSelected},logName:function(){var e=this.id()||this.segmentId(),t=this.name()+"["+e+"]";return t+(this.isDefault()?"(default)":"")},setSelected:function(e){this.segmentData.isSelected=e;SM.log((e?"Selecting ":"Deselecting ")+this.logName())},downloadCSV:function(){var e=document.createElement("form");e.setAttribute("method","post");e.setAttribute("action","/analyze/ajax/bm/download_benchmark_data");var t=document.createElement("input");t.setAttribute("type","hidden");t.setAttribute("name","qids");t.setAttribute("value",JSON.stringify(this.segmentList.survey.getAllBenchmarkableQuestionLogicalIds()));e.appendChild(t);var i=document.createElement("input");i.setAttribute("type","hidden");i.setAttribute("name","filter_keys");i.setAttribute("value",JSON.stringify(this.keys()));e.appendChild(i);var s=document.createElement("input");s.setAttribute("type","hidden");s.setAttribute("name","date_start");s.setAttribute("value",this.dateStart());e.appendChild(s);var n=document.createElement("input");n.setAttribute("type","hidden");n.setAttribute("name","date_end");n.setAttribute("value",this.dateEnd());e.appendChild(n);var r=document.createElement("input");r.setAttribute("type","hidden");r.setAttribute("name","percentile_start");r.setAttribute("value",this.percentileStart());e.appendChild(r);var a=document.createElement("input");a.setAttribute("type","hidden");a.setAttribute("name","percentile_end");a.setAttribute("value",this.percentileEnd());e.appendChild(a);document.body.appendChild(e);e.submit()}});SM.Models.register("DataSegmentList",{DEFAULT_NAME:"SurveyMonkey Global Benchmark",DATA_SEGMENT_SAVED:"benchmarking:data-segment-saved",DATA_SEGMENT_ERROR:"benchmarking:data-segment-error",DATA_SEGMENT_LOADED:"benchmarking:data-segment-loaded",DATA_SEGMENT_DELETED:"benchmarking:segmentDeleted",DATA_SEGMENT_NEW_LOADED:"benchmarking:newSegmentLoaded",DATA_SEGMENT_ADDED:"benchmarking:segmentAdded",DATA_SEGMENT_SELECTION_CHANGED:"benchmarking:selectionChanged",DATA_SEGMENT_SHOWN_CHANGED:"benchmarking:benchmarkShownChanged",PROTOTYPE_SEGMENT_DESCRIPTOR:{name:"No Name",isFake:false,isDefault:false,isSelected:false,keys:[],percentile_start:0,percentile_end:100,date_start:0,date_end:0},__create:function(e){var t=this,i=e.survey.isTMBCTemplate(),s,n;this.survey=e.survey;this.defaultView=e.defaultView;this.benchmarkQuestions=e.benchmarkQuestions;this.segmentData=e.segmentData.error?undefined:e.segmentData.data;this.questionMap=this._buildQuestionMap(this.benchmarkQuestions);this.segmentList=[];this.segmentMap={};n=this.defaultView.getBenchmarkSegments();if(!n||n.length===0){s=this._makeSegmentDescriptor(this.DEFAULT_NAME,false);s.isDefault=true;s.isSelected=true;n=[s]}if(this.survey.isCurrentUserAlsoOwner()&&!this.survey.owner.hasBenchmarkingRestricted()){n=n.slice(0,1);s=this._makeSegmentDescriptor(Globalize.localize("Professional Services"),true);n.push(s);s=this._makeSegmentDescriptor(Globalize.localize("Consumer Products"),true);n.push(s)}if(i){n[0].isSelected=true}_.each(n,function(e){var r;if(i&&!(e.isDefault||e.isFake)){return}if(t.segmentData){if(e.isDefault&&!!e.id){delete e.id}if(e.id){if(e._derivedFrom===n[0].segmentId){r=n[0]}else if(e.isFake){r=e}else{r=_.find(t.segmentData,function(t){if(t.name===e.id||t.name===e._derivedFrom){return t}});if(r&&r.logical_bank_question_ids.length===0){r=null;if(e.isSelected){e.isSelected=false;t.segmentList[0].setSelected(true)}}}}else{if(e.keys.length===1){r=_.find(t.segmentData,function(t){if(t.name===e.keys[0]){return t}});if(r){r=null;if(e.isSelected){e.isSelected=false;t.segmentList[0].setSelected(true)}}else{r=e}}else{r=e}}}else{r=e}if(r){e.date_start=t._make_start_date();e.date_end=t._make_end_date();if(e._derivedFrom){e.name="Top 25%: "+(r.label||r.name)}s=t.addSegment(e);if(!s){SM.log("Could not create segment for "+e.id)}}});if(i){t.segmentList[0].setName(SM.TMBCModel.TMBC_DEFAULT_NAME)}else{_.each(this.segmentData,function(e,i){var s;if(e.logical_bank_question_ids.length>0){s={name:e.label,isDefault:false,isSelected:false,percentile_start:0,percentile_end:100,date_start:t._make_start_date(),date_end:t._make_end_date()};s.id=i;s.keys=[i];t.addSegment(s)}})}var r=_.find(this.segmentList,function(e,t){if(e.segmentData.isSelected){return true}});if(!r){this.segmentList[0].segmentData.isSelected=true}},_makeSegmentDescriptor:function(e,t){var i=$.extend(true,{},this.PROTOTYPE_SEGMENT_DESCRIPTOR);i.name=e;i.segmentId=this._makeSegmentId(e);if(t){i.id=i.segmentId}i.isFake=t;i.date_start=this._make_start_date();i.date_end=this._make_end_date();i.percentile_start=0;i.percentile_end=100;return i},addDerivedSegment:function(e,t){var i=function(e){n._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ADDED,segment:a.segment});SM.Bi.logSegmentSwitch(l,u);n._fetchAllBenchmarkRollups(a)},s=function(t,i,s){var r="Save New Segment failed",o="Save segment ["+e.name+"] failed.";SM.API.logError({name:r,message:o});n._removeSegment(a.segment.segmentId());a.previouslySelectedSegment.segmentData.isSelected=true;o="We were unable to save your new data segment. Please try again later.";n._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:r,message:o})};var n=this,r=$.extend({},e.segmentData),a={self:this},o,l=e.getCanonicalName(),u;if(t==="top25"){r.name="Top 25%: "+e.name();r.isDefault=false;r.isSelected=false;r.percentile_start=75;r.id=e.segmentId()+"_top_25";r.segmentId=r.id;r._derivedFrom=e.segmentId();o=this.addSegment(r);if(o){u=o.getCanonicalName();a.segment=o;a.previouslySelectedSegment=this.getSelectedSegment();a.previouslySelectedSegment.segmentData.isSelected=false;a.segment.segmentData.isSelected=true;SM.API.logSetUiTrigger("segment_tile_add");this.save({done:i,fail:s})}else{SM.log("Could not create segment for "+r.id)}}else{SM.log("addDerivedSegment: derivation type "+t+" not yet supported")}},loadSegmentData:function(e){var t=this},_get_quarter_start:function(){var e=moment().month(),t;e=Math.floor(e/3)*3;t=moment().month(e);t.date(1);return t},_make_start_date:function(){var e=this._get_quarter_start();e.subtract(1,"y");return e.unix()},_make_end_date:function(){var e=this._get_quarter_start();e.subtract(1,"d");return e.unix()},hasBenchmarking:function(){return this.survey.owner.hasBenchmarking()},hasRestrictedFeatures:function(){return this.survey.owner.hasBenchmarkingRestricted()},getCountOfBenchmarkableQuestions:function(){return this.survey.getCountOfBenchmarkableQuestions()},hasPaidBenchmarks:function(){var e=_.filter(this.segmentList,function(e){if(!e.isLegacy()&&!e.isDerived()&&!e.isDefault()&&!e.isFake()){return e}});return e.length>0},_buildQuestionMap:function(e){var t={},i;_.each(e,function(e){t[e.name]=e});return t},getQuestionOptions:function(){var e=this,t=this.benchmarkQuestions,i=[{label:Globalize.localize("Choose"),value:"",selected:true},{label:Globalize.localize("All Organizations"),value:"all",selected:false}];_.each(t,function(e){i.push({label:e.attributes.label,value:e.name,selected:false})});return i},getOptionOptions:function(e){var t=this,i=this.questionMap[e],s=[{label:Globalize.localize("Choose"),value:"",selected:true}];_.each(i.answers.rows,function(e){s.push({label:e.text,value:e.name,selected:false})});return s},getKeyInfo:function(e,t){var i=_.find(e.answers.rows,function(e){return e.name===t});return i},getSegmentInfoForKey:function(e){var t=this,i={};_.each(this.questionMap,function(s,n){var r=t.getKeyInfo(s,e);if(r){i.type=n;i.typeName=s.attributes.label;i.key=e;i.keyName=r.text}});return i},_makeSegmentName:function(e){var t=this,i="";if(e.isDefault){return e.name}if(e.keys.length>0){_.each(e.keys,function(e,s){var n=t.getSegmentInfoForKey(e);if(s>0){i=i+", "}i=i+n.typeName+": "+n.keyName})}else{i=Globalize.localize("All Organizations")}if(e.percentile_start===75){i=Globalize.localize("Top 25%, ")+i}else if(e.percentile_start===90){i=Globalize.localize("Top 10%, ")+i}return i},_makeSegmentId:function(e){if(e){return e.replace(/ /g,"_")}},buildSegmentDescriptor:function(e,t,i){var s={keys:[],percentile_end:100};if(e!=="all"){if(t===""){s.keys.push(e)}else{s.keys.push(t)}}s.percentile_start=i;s.name=this._makeSegmentName(s);s.segmentId=this._makeSegmentId(s.name);s.date_start=this._make_start_date();s.date_end=this._make_end_date();return s},save:function(e){var t=[];e=e||{};_.each(this.segmentList,function(e){if(!e.isFake()){t.push(e.getData())}});this.defaultView.setBenchmarkSegments(t,e)},_onFetchBenchmarkRollupsDone:function(e,t){var i=e.self,s=t[0],n,r;SM.log("bmFetchBenchmarkRollups succeeded.");SM.log("triggering newSegmentLoaded");i.survey.driverRollups.loadRollups(s);i.set("isLoading",false,{notify:true});i._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_LOADED,segment:e.segment,benchmarkData:s});i._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_NEW_LOADED,segment:e.segment,benchmarkData:s});n=$(".analyze-secondary-column.accordion");r=n.accordion().data("accordion");if(r){r.open("DataSegmentBuilderViewContainer")}},_onFetchBenchmarkRollupsFail:function(e,t){var i="Fetch Benchmark data failed",s="bmFetchBenchmarkRollups failed with "+t;this.set("isLoading",false,{notify:true});SM.API.logError({name:i,message:s});s="We were unable to retrieve the benchmark data at this time. Please try again later.";this._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:i,message:s})},_fetchAllBenchmarkRollups:function(e){var t=this,i={view_data:this.defaultView.dump(),question_ids:[]};t.set("isLoading",true,{notify:true});t.lastFetchRequest=SM.API.bmFetchBenchmarkRollups(i);$.when(e,t.lastFetchRequest).done(t._onFetchBenchmarkRollupsDone).fail(function(i,s,n){t._onFetchBenchmarkRollupsFail(e,i)})},createNewSegment:function(e,t,i){var s=function(e){r._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ADDED,segment:a.segment});SM.Bi.logSegmentSwitch(u,d);r._fetchAllBenchmarkRollups(a)},n=function(s,n,o){var l="Save New Segment failed",u="Save segment ["+e+", "+t+", "+i+"] failed.";SM.API.logError({name:l,message:u});r._removeSegment(a.segment.segmentId());u="We were unable to save your new data segment. Please try again later.";r._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:l,message:u})};var r=this,a={self:this},o=this.buildSegmentDescriptor(e,t,i),l=this.getSelectedSegment().id(),u=l.getCanonicalName(),d;if(this._validateId(o.segmentId)){this.deselectAll();o.isDefault=false;o.isSelected=true;a.segment=this.addSegment(o);if(a.segment){d=a.segment.getCanonicalName();SM.API.logSetUiTrigger("segment_tile_add");this.save({done:s,fail:n})}return true}SM.log("Attempted to create duplicate segment");return false},_onEnableBenchmarksDone:function(e){SM.log("EnableBenchmarks succeeded");this._fetchAllBenchmarkRollups({self:this})},_onEnableBenchmarksFail:function(e,t,i){var s="Show/Hide Benchmark(s) failed",n="We were unable to show or hide your benchmark(s) at this time. Please try again later.";SM.API.logError({name:s,message:s});this._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:s,message:n})},enableAllBenchmarks:function(e){function t(e){s._onEnableBenchmarksDone(e)}function i(e,t,i){s._onEnableBenchmarksFail(e,t,i)}var s=this,n=this.defaultView.enableAllBenchmarks(e);n.done(t).fail(i)},deselectAll:function(){_.each(this.segmentList,function(e){e.setSelected(false)})},toggleSelection:function(e){if(!e.isDefault()||this.count()>1){SM.API.logSetUiTrigger("segment_tile");this.selectSegment(e)}},getSelectedSegment:function(){var e;_.each(this.segmentList,function(t){if(t.isSelected()){e=t}});return e},_onSwitchSegmentDone:function(e,t){var i=e.self,s=e.segment,n,r=t[0];SM.log("SwitchSegment succeeded");SM.log("triggering segmentSelectionChanged");i._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_SELECTION_CHANGED});i.set("isLoading",false,{notify:true});SM.log("triggering newSegmentLoaded");i._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_NEW_LOADED,segment:n,benchmarkData:r});SM.Bi.logSegmentSwitch(e.segmentFrom,e.segmentTo,e.source)},_onSwitchSegmentFail:function(e,t){var i="Switch Segment Failed",s="Switch segment failed with "+t;this.set("isLoading",false,{notify:true});SM.API.logError({name:i,message:s});s="We were unable to switch segments. Please try again later.";this._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:i,message:s})},switchSegment:function(e,t,i,s){var n=this,r={view_data:this.defaultView.dump(),question_ids:[]},a={self:this,segmentFrom:t,segmentTo:i,source:s};a.segment=e;n.set("isLoading",true,{notify:true});n.lastFetchRequest=SM.API.bmFetchBenchmarkRollups(r);$.when(a,n.lastFetchRequest).done(n._onSwitchSegmentDone).fail(function(e,t,i){n._onSwitchSegmentFail(a,e)})},selectSegment:function(e,t,i){var s=this,n=s.getSelectedSegment(),r;var a=function(n){s.switchSegment(e.getData(),t,r,i)};var o=function(e,t,i){s._onSwitchSegmentFail({self:this},"Select Segment failed")};if(!t){if(!n){t=""}else{t=n.getCanonicalName()}}if(!e.isSelected()){this.deselectAll();e.setSelected(true)}else if(e.isDefault()){return}else{e.setSelected(false);e=this.getDefault();e.setSelected(true)}r=e.getCanonicalName();this.save({done:a,fail:o})},_validateId:function(e){var t=false;if(!e){return false}_.each(this.segmentList,function(i){if(e===i.segmentId()){t=true}});return!t},count:function(){return this.segmentList.length},countSelected:function(){var e=0;_.each(this.segmentList,function(t){if(t.isSelected()){e+=1}});return e},getDefault:function(){var e=_.find(this.segmentList,function(e){if(e.isDefault()){return e}});if(!e){SM.log("Error: no default segment!")}return e},_findFirstOldSegmentIndex:function(){var e=-1;$.each(this.segmentList,function(t,i){if(!i.isDefault()&&!i.id()){e=t;return false}});return e},_findDerivedFromIndex:function(e){var t=-1;if(this.segmentList[0]&&e===this.segmentList[0].segmentId()){return 0}$.each(this.segmentList,function(i,s){if(s.id()===e){t=i;return false}});return t},findDerived:function(e){var t=_.find(this.segmentList,function(t){if(e.isDefault()){if(e.segmentId()===t.derivedFrom()){return t}}else if(e.id()===t.derivedFrom()){return t}});return t},_createSegment:function(e){var t,i=-1;t=SM.Models.create("DataSegment",{segmentList:this,segmentData:e});this.segmentMap[e.segmentId]=t;SM.log("Creating segment "+t.logName());if(e.id){if(t.isDerived()){i=this._findDerivedFromIndex(t.derivedFrom());if(i<0){SM.API.logWarning({message:"Segment "+t.logName()+"was derived from cannot be found"});i=this._findFirstOldSegmentIndex()}if(i<0){this.segmentList.push(t)}else{this.segmentList.splice(i+1,0,t)}}else{i=this._findFirstOldSegmentIndex();if(i<0){this.segmentList.push(t)}else{this.segmentList.splice(i,0,t)}}}else{this.segmentList.push(t)}SM.log("added "+t.logName());return t},_removeSegments:function(e){var t=this;_.each(e,function(e){var i=e.segmentId(),s=t.getSegmentIndex(i);SM.log("removing "+e.logName());t.segmentList.splice(s,1);delete t.segmentMap[i]})},_removeSegment:function(e){var t=this,i=this.segmentMap[e],s=this.getSegmentIndex(e),n=i.id(),r=[i];if(s){if(!i.isDerived()&&!i.isLegacy()){_.each(t.segmentList,function(e){if(n===e.derivedFrom()){r.push(e)}})}this._removeSegments(r);return true}SM.log("Couldn't find segment with id "+e);return;
},addSegment:function(e){var t=e.segmentId,i,s,n;if(e.isDefault){e.name="SurveyMonkey Global Benchmark";t="SurveyMonkey_Global_Benchmark"}if(!t||t===""){if(e.id){t=e.id}else{t=this._makeSegmentId(e.name)}}if(this._validateId(t)){e.segmentId=t;i=this._createSegment(e);return i}},getSegmentIndex:function(e){var t=-1;_.find(this.segmentList,function(i,s){if(i.segmentId()===e){t=s;return true}});if(t===-1){SM.log("Could not find segment with id "+e)}return t},findSegmentById:function(e){var t=_.find(this.segmentList,function(t,i){if(t.id()===e||t.segmentId()===e){return true}});return t},deleteSegment:function(e){var t=this,i=e.segmentId(),s=e.getCanonicalName(),n=this._removeSegment(i),r=this.getDefault();var a=function(e){t._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_DELETED,segmentId:i});SM.Bi.logSegmentRemoved(s)};var o=function(s,n,r){var a=e.getData(),o="Failed to Delete Segment",l="Failed to delete segment with id "+i;SM.API.logError({name:o,message:l});t._createSegment(a);l="We were unable to delete that data segment. Please try again later.";t._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:o,message:l})};if(n){if(this.countSelected()===0){SM.API.logSetUiTrigger("segment_tile_remove");this.selectSegment(r,s)}else{this.save({done:a,fail:o})}}}});SM.AnalyzeLoaderView=SM.Views.register({__NAME:"analyzeLoaderView",__templateID:"analyze-content-loader-template",__defaults:{defaultTop:200,isFixed:false},__getters:{isFixed:function(e){if(SM.Browser.isIE7){return false}return e.__settings.isFixed}},show:function(){if(this.get("isFixed")){this.$el.css({position:"fixed",top:"50%",marginTop:-(this.$el.outerHeight()/2)})}else{this.$el.css({position:"absolute",top:this.get("defaultTop"),marginTop:0})}this.$el.removeClass("exit").removeClass("hide");this._isShown=true},hide:function(){var e=this;if(e._isShown){e._isShown=false;setTimeout(function(){if(!e._isShown){e.$el.addClass("exit");e.$el.css("top","-=200");setTimeout(function(){if(!e._isShown){e.$el.addClass("hide")}},400)}},400)}}});SM.ResponseLimitUpgradeView=SM.Views.register({__NAME:"responseLimitUpgradeView",__model:"survey",__templateID:"upgrade-response-limit-template",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountChange)},__beforeRender:function(e){var t=this.survey.respondentCounts,i=this.survey.owner;if(this.survey.hasFilteredRespondents()){return{responseCount:Globalize.format(t.total,"n0"),responseLimit:Globalize.format(i.responseLimit,"n0"),packageType:i.packageType,classes:this.__settings.classes,linkSource:this.__settings.linkSource}}return{classes:this.__settings.classes,linkSource:this.__settings.linkSource}},_onCountChange:function(e){var t=e.data.self;t.render()}});SM.NoResponsesView=SM.Views.register({__NAME:"noResponsesView",__templateID:"no-responses-template",__model:"survey",__beforeRender:function(){var e={surveyIDEncryption:this.survey.encryptedID,classes:this.__settings.classes,shouldShowBuyResponsesButton:Globalize.culture().name==="en",surveyID:this.survey.ID,onSharedPage:SM.App.isSharingApp()};return e}});SM.AnalyzeContentView=SM.Views.register({__NAME:"analyzeContentView",__model:"survey",__templateID:"analyze-pages-content-container",__init:function(){var e=this.survey.state;if(e.isSummaryMode()){this.bindModel(this.survey.questionRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);if(this.survey.owner.hasBenchmarking()){this.bindModel(this.survey.benchmarkRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(this.survey.dataSegmentList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}}else if(e.isBrowseMode()){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onRespondentCountChanged);this.bindModel(this.survey.respondentsList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}else if(e.isTrendMode()){this.bindModel(this.survey.trendsModel,"isLoading.changed",{self:this},this._onIsLoadingChanged)}},__beforeRender:function(){var e=this.survey.getCountOfBenchmarkableQuestions()>0,t=this.survey.hasFilteredRespondents(),i=this.survey.hasRespondents(),s=this.survey.shownQuestionList.length>0,n=this.survey.questionCount>0,r=this.survey.state;if(r.isSummaryMode()&&!SM.App.isSharingApp()&&!t&&e){t=true;i=true}return{hasQuestions:n,hasShownQuestions:s,hasRespondents:i,hasFilteredResponses:t}},__afterRender:function(e){var t,i=this._getModelState();if(i.failed){t=SM.Template.renderHTML("content-load-error-template",{classes:"mod-no-header",requestID:i.requestID})}else if(!e.hasQuestions){t=SM.Template.renderHTML("no-questions-template",{surveyIDEncryption:this.survey.encryptedID,classes:"mod-no-header"})}else if(!e.hasRespondents){t=SM.Views.create(SM.NoResponsesView,{model:this.survey,classes:"mod-no-header"}).el}else if(!e.hasFilteredResponses){t=SM.Template.renderHTML("filtered-no-responses-template",{classes:"mod-no-header"})}else if(this.survey.state.isSummaryMode()){t=SM.Views.create(SM.SummaryPageListView,{model:this.survey}).el}else if(this.survey.state.isBrowseMode()){t=SM.Views.create(SM.RespondentListView,{model:this.survey}).el}else if(this.survey.state.isTrendMode()){t=SM.Views.create(SM.TrendContainerView,{model:this.survey.trendsModel}).el}this.el.appendChild(t)},_getModelState:function(){var e=this.survey,t=e.state;if(t.isSummaryMode()){return{requestID:e.questionRollups.get("failedLoadRequestID"),failed:e.questionRollups.get("failedLoad")}}else if(t.isBrowseMode()){return{requestID:e.respondentsList.get("failedLoadRequestID"),failed:e.respondentsList.get("failedLoad")}}else if(t.isTrendMode()){return{requestID:e.trendsModel.get("failedLoadRequestID"),failed:e.trendsModel.get("failedLoad")}}},_onIsLoadingChanged:function(e){var t=e.data.self,i=e.value;if(!i){t.render();t.$el.removeClass("disabled")}else{t.$el.addClass("disabled")}},_onRespondentCountChanged:function(e){var t=e.data.self;if(!t.survey.hasRespondents()){t.render()}}});SM.AnalyzeContentWrapperView=SM.Views.register({__NAME:"analyzeContentWrapperView",__model:"survey",__templateID:"analyze-pages-content-wrapper-container",__init:function(){var e=this.survey.state;if(e.isSummaryMode()){this.bindModel(this.survey.questionRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(this.survey.questionRollups,"isUpdating.changed",{self:this},this._onIsUpdatingChanged);if(this.survey.owner.hasBenchmarking()){this.bindModel(this.survey.benchmarkRollups,"isLoading.changed",{self:this},this._onIsLoadingChanged);this.bindModel(this.survey.dataSegmentList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}}else if(e.isBrowseMode()){this.bindModel(this.survey.respondentsList,"isLoading.changed",{self:this},this._onIsLoadingChanged)}else if(e.isTrendMode()){this.bindModel(this.survey.trendsModel,"isLoading.changed",{self:this},this._onIsLoadingChanged)}this._isLoading=false;this._isUpdating=false},__destroy:function(){$(window).off("scroll."+this.__uid+"."+this.__NAME);this._loaderView=null},__afterRender:function(){var e,t;this._loaderView=SM.Views.create(SM.AnalyzeLoaderView);e=SM.Views.create(SM.AnalyzeContentView,{model:this.survey});this.el.appendChild(this._loaderView.el);this.el.appendChild(e.el)},_showSpinner:function(){this.$el.css({height:this.$el.height(),width:this.$el.width()});this.$el.find("[analyze-mode-spinner-backdrop]").removeClass("hide").addClass("disabled");this._loaderView.show();$(window).on("scroll."+this.__uid+"."+this.__NAME,{self:this},this._onScroll);$(window).scroll()},_hideSpinner:function(e){this.$el.find("[analyze-mode-spinner-backdrop]").addClass("hide").removeClass("disabled");this.$el.css({height:"auto",width:"auto"});$(window).off("scroll."+this.__uid+"."+this.__NAME,this._onScroll);this._loaderView.hide()},_onIsLoadingChanged:function(e){var t=e.data.self,i=e.value;if(i){t._isLoading=true;setTimeout(function(){if(!t._isLoading){return}t._showSpinner()},400)}else{t._isLoading=false;setTimeout(function(){t._hideSpinner()},0)}},_onIsUpdatingChanged:function(e){var t=e.data.self,i=e.value;if(i){t._isUpdating=true;t._showSpinner()}else{t._isUpdating=false;setTimeout(function(){t._hideSpinner()},0)}},_onScroll:function(e){var t=e.data.self,i=t.$el.offset(),s=$(window).scrollTop();if(s<i.top){t._loaderView.$el.css("top",100)}else{t._loaderView.$el.css("top",100+s-i.top)}}});SM.AnRuleListItemView=SM.Views.register({__model:"ruleModel",__templateID:"rule-list-item-view",__NAME:"AnRuleListItemView",__defaults:{rule_id:undefined,isToggleable:true,isDisabled:false,renameMode:false},__init:function(){var e=this;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onRuleClick);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.DeleteView.deleteClicked":this._deleteClick,"FunctionListItem.DeleteView.cancelClicked":this.showMenu,"FunctionListItem.RenameView.Canceled":this.showMenu,"FunctionListItem.RenameView.Renamed":function(t){e.ruleModel.set("customHeading",t.newName,{notify:true});SM.Bi.ruleRename(e.ruleModel);e.__settings.isToggleable=true;e.__settings.renameMode=false;e.render()}},{self:this});this.bindModel(this.ruleModel,"ruleEdited",{self:this},this._onRuleChanged);this.bindModel(this.ruleModel,"isCorrupt.changed",{self:this},this._onRuleChanged);if(this.ruleModel.isCompare){this.bindModel(this.ruleModel,"selected.changed",{self:this},this._onCompareSelectedChanged)}},__beforeRender:function(){var e=this,t;if(this.ruleModel.get("isCorrupt")){this.__settings.deleteMode=true}try{t={name:this.ruleModel.get("heading"),isDisabled:this.__settings.isDisabled,isActive:this.ruleModel.get("selected"),renameMode:this.__settings.renameMode,deleteMode:this.__settings.deleteMode,toggleAnimate:this.__settings.toggleAnimate,isToggleable:this.__settings.isToggleable,isCorrupt:this.ruleModel.get("isCorrupt"),ruleFamily:Globalize.localize(this.ruleModel.ruleFamily)+": ",rule_id:this.ruleModel.ID}}catch(i){e.ruleModel.set("isCorrupt",true);e.__settings.deleteMode=true;t={name:"Corrupted",isDisabled:true,isActive:false,renameMode:false,isCorrupt:true,toggleAnimate:false,isToggleable:false,deleteMode:this.__settings.deleteMode,rule_id:this.ruleModel.ID};e._handleRenderingError(i)}return t},__afterRender:function(e){var t,i=!this.__settings.renameMode&&!this.__settings.deleteMode,s=this.$el.children(".list-item");if(i){this.$el.find("a.btn-menu-down").actionMenu({templateID:"rule-menu-template",isActive:e.isActive,isDisabled:this.__settings.isDisabled,includeMenuCopy:!this.ruleModel.isShow,disableMenuCopy:this.ruleModel.survey.owner.hasRuleLimit()})}else{if(this.__settings.renameMode){t=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:e.name});t.open()}else if(this.__settings.deleteMode){t=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true,hasCancel:!this.ruleModel.get("isCorrupt")})}s.prepend(t.el)}if(this.__settings.toggleAnimate){this.$el.toggleClass("active",e.isActive)}},_handleRenderingError:function(e){var t=this;SM.Error.log(e,"RuleRenderingException: Rule#"+t.ruleModel.ID+", Survey#"+SM.App.survey.ID)},showMenu:function(e){var t=e.data.self;t.__settings.renameMode=false;t.__settings.deleteMode=false;t.__settings.isToggleable=true;t.__settings.toggleAnimate=false;t.render()},_onRuleChanged:function(e){e.data.self.render()},_disable:function(e){var t=e.data.self;t.__settings.isToggleable=false;t.__settings.isDisabled=true;t.__settings.toggleAnimate=false;t.render()},_enable:function(e){var t=e.data.self;t.__settings.isToggleable=true;t.__settings.isDisabled=false;t.__settings.toggleAnimate=false;t.render()},_deleteClick:function(e){var t=e.data.self;SM.Bi.ruleDelete(e.data.self.ruleModel);e.data.self.ruleModel.deleteRule();t.$el.remove()},_onCompareSelectedChanged:function(e){var t=e.data.self;t.__settings.toggleAnimate=true;t.render()},_onMenuAction:function(e){var t=e.data.self;t[e.action]()},_menuCopyClick:function(){SM.Bi.uiTrigger="copyRuleItemMenu";SM.Bi.ruleCopy(this.ruleModel);this.ruleModel.copyRule()},_menuEditClick:function(){SM.Bi.uiTrigger="editRuleItemMenu";this.trigger("editClicked")},_menuDeleteClick:function(){SM.Bi.uiTrigger="deleteRuleItemMenu";this.__settings.isToggleable=false;this.__settings.deleteMode=true;this.__settings.toggleAnimate=false;this.render()},_menuRenameClick:function(){SM.Bi.uiTrigger="renameRuleItemMenu";this.__settings.renameMode=true;this.__settings.isToggleable=false;this.__settings.toggleAnimate=false;this.render()},_menuToggleRule:function(){SM.Bi.uiTrigger="applyRuleItemMenu";this._toggleRule()},_onRuleClick:function(e){var t=e.data.self;e.preventDefault();if(t.ruleModel.get("isCorrupt")){return}if(!t.__settings.isDisabled&&t.__settings.isToggleable){SM.Bi.uiTrigger="ruleItem";t._toggleRule()}},_toggleRule:function(){SM.Bi.ruleToggle(this.ruleModel);this.__settings.toggleAnimate=true;this.ruleModel.toggleRule()}});SM.AnRuleView=SM.Views.register({__model:"ruleModel",__templateID:"an-rule-template",__NAME:"AnRuleView",__init:function(){var e=this,t=function(){e.$el.remove()};this.$el.on({"RuleView.destroy":function(){e.ruleModel.set("editMode",false);t()},"RuleView.applied":function(){if(!e.ruleModel.isNew){setTimeout(t,e.COLLAPSE_DELAY)}else{t()}},"RuleButtons.cancelClicked":function(){e.ruleModel.set("editMode",false);if(!e.ruleModel.isNew){setTimeout(t,e.COLLAPSE_DELAY)}else{t()}}})},COLLAPSE_DELAY:300,modelEditViewMap:{FilterRespondentDataAnRule:"RespDataRuleEditView",FilterCollectorAnRule:"CollectorRuleEditView",FilterCompletenessAnRule:"CompletenessRuleEditView",FilterTimePeriodAnRule:"TimePeriodRuleEditView",FilterRandomAssignmentRule:"RARuleEditView",CompareRandomAssignmentRule:"RARuleEditView",QnaMatrixAnRule:"QNAMatrixRuleEditView",QnaRatingCommentPerRowAnRule:"QNAMatrixRuleEditView",QnaMenuMatrixAnRule:"QNAMenuMatrixRuleEditView",SourceSurveysRule:"SourceSurveysRuleEditView",QnaSimpleAnRule:"QNASimpleRuleEditView",QnaOpenEndedAnRule:"QNA_OEndedRuleEditView",QnaDatetimeAnRule:"QNA_DatetimeRuleEditView",QnaNumericalAnRule:"QNA_NumericalRuleView",ShowAnRule:"ShowRuleEditView"},__afterRender:function(){var e=this.modelEditViewMap[this.ruleModel.__NAME];var t=SM.Views.create(SM[e],{model:this.ruleModel});this.el.appendChild(t.el)}});SM.BaseRuleEditView={__model:"ruleModel",__templateID:"rule-edit-view",__init:function(){this.$el.on("submit",{self:this},this._onFormSubmit).on("RuleButtons.applyClicked",{self:this},this._applyClk);this.bindModel(this.ruleModel,"isDirty.set",{self:this},this._onRuleDirtySet);if(this.ruleModel.isNew){this.buttons.applyDisable()}this.$el.find(".plate").on("click",{self:this},this._onEditSidi)},__setters:{applyEnabled:function(e,t){if(t){e.buttons.applyEnable()}else{e.buttons.applyDisable()}}},_buildChoiceGroup:function(e){var t=this;return $.map(e,function(e){return SM.Views.create(SM.SimpleRuleChoiceView,{model:t.ruleModel,text:e.text,showCollectorType:e.showCollectorType,type:e.type,id:e.id}).el})},__afterRender:function(){var e;if(SM.App.isMerveysApp()){e=SM.App.survey.getSourceSurveysQuestionId()}this.buttons=SM.Views.create(SM.RuleButtonsView,{model:this.ruleModel});this._renderChoices();this._afterRenderChoices();if(this.ruleModel.isCompare&&this.ruleModel.get("questionID")!==e){this._renderSidiRuleEdit();this.$el.find(".q").popout()}this.$el.append(this.buttons.el)},_renderSidiRuleEdit:function(e){var t=this,i,s,n,r=t.ruleModel.getQuestion(),a=r.page.survey,o=a.respondentCounts.total>=30,l=!a.owner.canSigDiffs();if(!t.ruleModel.isCompare||!a.state.isSummaryMode()||r.hasRandomAssignment()){return}if(l){i=SM.Template.renderHTML("sidi-rule-edit-view-upgrade",{hide:this.__NAME==="QNAMatrixRuleView"})}else{n=Globalize.culture().name==="en";if(o){s=a.anviews.defaultView.appliedSidi()}i=SM.Template.renderHTML("sidi-rule-edit-view",{hide:this.__NAME==="QNAMatrixRuleView"&&t.ruleModel.get("editMode")!==true,surveyID:a.ID,checked:s,canBuy:n,enoughResponses:o})}$(this.el).append(i)},_onEditSidi:function(e){var t=e.data.self,i,s,n;i=t.$el.find(".sidi-switch");s=i.find(".plate");if(!s.hasClass("disabled")){i.toggleClass("off");t.ruleModel.set("isDirty",true,{notify:true})}},_onShowUpgradeDialog:function(e){this._showUpgradeDialog("sig-diff-upgrade-dialog-template")},_showUpgradeDialog:function(e){var t=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:e});t.open()},_onUpgradeBtnClicked:function(e){e.stopImmediatePropagation()},_afterRenderChoices:function(){},_renderChoices:function(){},_onRuleDirtySet:function(e){var t=e.data.self,i=SM.Object.getOneKey(t.ruleModel.get("rows"))!==undefined;t.set("applyEnabled",i)},_onFormSubmit:function(e){e.data.self._applyClk(e)},_applyClk:function(e){var t=e.data.self,i=t.ruleModel,s=t.ruleModel.commit(),n,r;SM.Bi.ruleApplied(t.ruleModel);e.preventDefault();if(!s){t.render();return}n=t.$el.find(".sidi-switch");if(n.length){r=!n.hasClass("off");t.ruleModel.getQuestion().page.survey.anviews.defaultView.updateSidiAll(r)}if(!i.get("selected")||i.get("isDirty")){i.set("selected",true);i.applyRule();t.dirty=false}t.$el.trigger("RuleView.applied",t)}};SM.RuleButtonsView=SM.Views.register({__NAME:"RuleButtonsView",__templateID:"rule-buttons-template",__model:"ruleModel",__init:function(){this.$el.on(SM.Event.CLICK,".btn.cancel",{self:this},this._cancelClk);if(!this._hasUpgradeButton()){this.$el.on(SM.Event.CLICK,".btn.apply-button",{self:this},this._applyClk)}else{this.$el.on(SM.Event.CLICK,".btn.apply-button",{self:this},function(e){e.preventDefault();var t=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"rules-upgrade-dialog-template"});t.open()})}},__defaults:{applyDisabled:false},__beforeRender:function(){return{applyDisabled:this.__settings.applyDisabled}},applyDisable:function(){if(this._hasUpgradeButton()){return}this.__settings.applyDisabled=true;this.render()},applyEnable:function(){if(this._hasUpgradeButton()){return}this.__settings.applyDisabled=false;this.render()},_hasUpgradeButton:function(){var e=this.ruleModel.survey.owner;return e.isOverRuleLimit()&&this.ruleModel.isNew},_cancelClk:function(e){e.preventDefault();e.data.self.$el.trigger("RuleButtons.cancelClicked")},_applyClk:function(e){var t=e.data.self;e.preventDefault();if(!t.__settings.applyDisabled){t.$el.trigger("RuleButtons.applyClicked")}}});SM.QNARuleEditView=SM.Object.extend(SM.BaseRuleEditView,{__templateID:"qna-rule-edit-view",_afterRenderChoices:function(){var e=this.ruleModel.getQuestion(),t;if(!this.ruleModel.isCompare){if(e.commentField){t=SM.Views.create(SM.QNA_CommentFieldChoiceView,{model:this.ruleModel.choiceSet});this.$el.append(t.el)}}},_onRuleDirtySet:function(e){var t=e.data.self,i=SM.Object.getOneKey(t.ruleModel.choiceSet.get("rows"))!==undefined;t.set("applyEnabled",i)},_buildChoiceGroup:function(e){var t=this;return _.map(e,function(e){return SM.Views.create(SM.QNA_SimpleRuleChoiceView,{model:t.ruleModel.choiceSet,text:e.text,id:e.id}).el})},__beforeRender:function(){var e=this.ruleModel.getQuestion();return{position:e.position,heading:e.heading}}});SM.QNASimpleRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNASimpleRuleView",_renderChoices:function(){var e=this.ruleModel,t=e.getQuestion(),i;if(t.isNPS()){i=this._buildChoiceGroupNps(t.rowList)}else{i=this._buildChoiceGroup(t.rowList)}this.$el.find("[rule-choices]").append(i)},_buildChoiceGroupNps:function(e){var t=this,i=SM.ComparedByNps.distributed;return _.map(i,function(e){return SM.Views.create(SM.QNA_NpsRuleChoiceView,{model:t.ruleModel.choiceSet,text:e.text,id:e.id,position:e.position}).el})},_onRuleDirtySet:function(e){var t=e.data.self,i=SM.Object.getOneKey(t.ruleModel.choiceSet.get("rows"))!==undefined;i=i||t.ruleModel.choiceSet.get("commentFieldSelected");t.set("applyEnabled",i)}});SM.SourceSurveysRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"SourceSurveysRuleView",__beforeRender:function(){return{heading:Globalize.localize("survey"),is_source_surveys_rule:true}},_renderChoices:function(){var e;e=$.map(this.ruleModel.survey.getSourceSurveys().answers,function(e){return{text:e.text,id:e.id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(e))}});SM.QNAMatrixRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNAMatrixRuleView",__init:function(){SM.QNARuleEditView.__init.call(this);this.$el.on(SM.Event.CLICK,"[add-new-row-btn]",{self:this},this._onAddNewMatrixSelection)},_renderChoices:function(){var e=this.ruleModel.choiceSetList,t=this,i,s=e.length===0;if(s){this.ruleModel.addChoiceSet()}_.each(e,function(e){if(e.cols){t._appendMatrixSelectionView(e)}});i=SM.Template.renderHTML("add-matrix-selection-template");if(this.ruleModel.isNew||this.ruleModel.isCompare||s){$(i).hide()}t.$el.append(i)},_afterRenderChoices:function(){var e=this.ruleModel.getQuestion(),t;if(!this.ruleModel.isCompare){if(e.commentField&&!e.commentField.options.apply_all_rows){t=SM.Views.create(SM.QNA_CommentFieldChoiceView,{model:this.ruleModel.commentChoiceSet});this.$el.append(t.el)}}},_appendMatrixSelectionView:function(e){var t=this.$el.find("[rule-choices]").get(0),i=SM.Views.create(SM.QNA_MatrixRuleChoiceSetView,{model:e});t.appendChild(i.el)},_hasAllSectionsComplete:function(e){var t=true,i=this.ruleModel.choiceSetList;_.each(i,function(i){if(SM.Object.getOneKey(i[e])===undefined){t=false;return false}});return t},_hasOneSectionComplete:function(e){var t=false,i=this.ruleModel.choiceSetList;_.each(i,function(i){if(e!=="comment"){if(SM.Object.getOneKey(i[e])!==undefined){t=true}}else{t=i.commentFieldSelected}if(t){return false}});return t},_onRuleDirtySet:function(e){var t=e.data.self,i=t.ruleModel.getQuestion(),s=t._hasAllSectionsComplete("rows"),n=t._hasOneSectionComplete("cols"),r,a=t.$el.find("[add-new-row-btn]"),o;if(i.commentField&&i.commentField.options.apply_all_rows){r=t._hasOneSectionComplete("comment")}else{r=t.ruleModel.commentChoiceSet.get("commentFieldSelected")}if(s&&!t.ruleModel.isCompare){a.show()}else{a.hide()}o=t.$el.find(".sidi-rule-edit");if(t.ruleModel.isCompare&&o.length){if(s){o.removeClass("hide")}else{o.addClass("hide")}}if(n||r){t.buttons.applyEnable()}else{t.buttons.applyDisable()}},_onAddNewMatrixSelection:function(e){var t=e.data.self,i=t.ruleModel.addChoiceSet();e.preventDefault();t.$el.find("[add-new-row-btn]").hide();t._appendMatrixSelectionView(i)}});SM.QNAMenuMatrixRuleEditView=SM.Views.extend(SM.QNAMatrixRuleEditView,{__NAME:"QNAMenuMatrixRuleView",_appendMatrixSelectionView:function(e){var t=this.$el.find("[rule-choices]").get(0),i=SM.Views.create(SM.QNA_MenuMatrixRuleChoiceSetView,{model:e});t.appendChild(i.el)},_onRuleDirtySet:function(e){var t=e.data.self,i=t._hasAllSectionsComplete("rows"),s=t._hasAllSectionsComplete("cols"),n=t.ruleModel.commentChoiceSet.get("commentFieldSelected"),r=t._hasOneSectionComplete("colChoices"),a=t.$el.find("[add-new-row-btn]");if(i&&s&&!t.ruleModel.isCompare){a.show()}else{a.hide()}if(r||n){t.buttons.applyEnable()}else{t.buttons.applyDisable()}}});SM.QNA_OEndedRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNA_OEndedRuleView",_onRuleDirtySet:function(e){var t=e.data.self;t._validateApplyBtn()},_validateApplyBtn:function(){var e=this.ruleModel.lastValidation.invalids,t=!e.searchTerm&&!e.selectedRowID;this.set("applyEnabled",t)},_renderChoices:function(){var e=SM.QNA_SingleOpenEndedRuleChoiceView;if(this.ruleModel.getQuestion().isMultiResponse()){e=SM.QNA_MultiOpenEndedRuleChoiceView}this.openEndedChoice=SM.Views.create(e,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.openEndedChoice.el);this._validateApplyBtn()}});SM.QNA_DatetimeRuleEditView=SM.Views.extend(SM.QNARuleEditView,{__NAME:"QNA_DatetimeRuleEditView",_renderChoices:function(){this.dateChoice=SM.Views.create(SM.QNA_DateTimeRuleChoiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.dateChoice.el)},_onRuleDirtySet:function(e){var t=e.data.self,i=t.ruleModel.lastValidation.invalids;if(i.selectedRowID||i.selectedTime||i.selectedDate){t.buttons.applyDisable()}else{t.buttons.applyEnable()}}});SM.QNA_NumericalRuleView=SM.Views.extend(SM.QNA_OEndedRuleEditView,{__NAME:"QNA_NumericalRuleView",_renderChoices:function(){this.numericalChoice=SM.Views.create(SM.QNA_NumericalRuleChoiceView,{model:this.ruleModel.choiceSet});this.$el.find("[rule-choices]").get(0).appendChild(this.numericalChoice.el)}});SM.RespDataRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"RespDataRuleView",__create:function(){this.survey=this.ruleModel.survey},__beforeRender:function(){return{heading:Globalize.localize("respondent metadata")}},_renderChoices:function(){var e=this.$el.find("[rule-choices]"),t;this.timeChoice=SM.Views.create(SM.TimeTotalRuleChoiceView,{model:this.ruleModel});e.append(this.timeChoice.el);t=this._renderTxtAttrs();e.append(t)},_renderTxtAttrs:function(){var e=this.ruleModel;return $.map(e.respondentAttributes,function(t){return SM.Views.create(SM.TextRuleChoiceView,{textLabel:Globalize.localize(t.textLabel),model:e,id:t.id,popout_id:t.popout_id}).el})},_onRuleDirtySet:function(e){var t=e.data.self,i=t.ruleModel,s=false,n=i.get("timeTotal"),r;if(n.value!==""){s=true}if(!s){$.each(i.respondentAttributes,function(e,t){r=i.get(t.id);if(r!==""&&r!==undefined){s=true;return false}})}if(s){t.buttons.applyEnable()}else{t.buttons.applyDisable()}}});SM.ShowRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"ShowRuleView",__templateID:"show-rule-edit-view",__defaults:{selectAllChecked:false,applyEnabled:false},__init:function(){var e=this;this.$el.on("submit",{self:this},this._onFormSubmit);this.$el.on("RuleButtons.applyClicked",{self:this},this._applyClk);this.expandStates={};this.bindModel(this.ruleModel,"isDirty.set",{self:this},function(t){e.render()});this.$el.on(SM.Event.CLICK,".rule-select-all",{self:this},this._onSelectAllClicked).on("pageExpandToggled",function(t,i){e.expandStates[i.ID]=i.val}).on("RuleButtons.cancelClicked",function(t){e.ruleModel.showSet=SM.Models.create("ShowSet");e.ruleModel.showSet.loadView(e.ruleModel.survey.anviews.currentView)})},__beforeRender:function(e){return{hasSelectAll:true,applyEnabled:this.__settings.applyEnabled,selectAllChecked:this.ruleModel.showSet.allSelected(),showRuleModel:this.ruleModel}},_renderChoices:function(){var e=this,t=this.ruleModel.survey.pageList,i=this.ruleModel.showSet,s=this.$el.find("[rule-choices]"),n=this.expandStates||{},r;r=$.map(t,function(i,s){return SM.Views.create(SM.ShowPageRuleChoiceView,{model:e.ruleModel,pageID:i.ID,isFirstChoice:s===0,isLastChoice:s===t.length-1,expanded:n[i.ID]||false}).el});s.append(r);if(i.isEmpty()){this.buttons.applyDisable()}else{this.$el.find(".rule-select-all").prop("indeterminate",i.questionCheckedCount()<this.ruleModel.survey.questionCount);this.buttons.applyEnable()}},_onSelectAllClicked:function(e){var t=e.data.self,i=t.ruleModel.showSet.toggleAll();t.__settings.selectAllChecked=i;t.__settings.applyEnabled=i;t.ruleModel.set("isDirty",true,{notify:true})}});SM.TimePeriodRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"TimePeriodRuleView",__init:function(){SM.BaseRuleEditView.__init.call(this);this.bindModel(this.ruleModel,"isDirty.set",{self:this},this._onRuleDirtySet)},__beforeRender:function(){return{heading:Globalize.localize("time period")}},_renderChoices:function(){var e=SM.Views.create(SM.TimeRangeRuleChoiceView,{model:this.ruleModel});this.$el.find("[rule-choices]").append(e.el)},_onRuleDirtySet:function(e){var t=e.data.self;if(t.ruleModel.get("startDate")&&t.ruleModel.get("endDate")){t.buttons.applyEnable()}else{t.buttons.applyDisable()}}});SM.CompletenessRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"CompletenessRuleView",__beforeRender:function(){return{heading:Globalize.localize("completeness")}},_options:[{text:"Complete responses",id:"completely"},{text:"Partial responses",id:"partially"},{text:"Disqualified responses",id:"disqualified"},{text:"Responses over quota",id:"overquota"}],_renderChoices:function(){var e=$.map(this._options,function(e){return{text:Globalize.localize(e.text),id:e.id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(e))}});SM.CollectorRuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"CollectorRuleView",__beforeRender:function(){return{heading:Globalize.localize("collector")}},_renderChoices:function(){var e;e=$.map(this.ruleModel.survey.collectorList,function(e){var t=Globalize.culture().name!=="en"&&!!e.type;return{showCollectorType:t,text:e.title,type:e.formattedType,id:e.id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(e))}});SM.RARuleEditView=SM.Views.extend(SM.BaseRuleEditView,{__NAME:"RARuleEditView",_renderChoices:function(){var e;e=$.map(this.ruleModel.getRandomAssignmentList(),function(e){return{text:e.variable_name||e.heading,id:e.variable_id}});this.$el.find("[rule-choices]").append(this._buildChoiceGroup(e))},__beforeRender:function(){var e=this.ruleModel.getQuestion();return{position:e.position,heading:e.heading}}});SM.SimpleRuleChoiceView=SM.Views.register({__NAME:"SimpleRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-simple",__init:function(){this.$el.on(SM.Event.CLICK,"[rule-choice-checkbox]",{self:this},this._checkboxChanged)},__beforeRender:function(){var e=this.__settings.id;return{text:this.__settings.text,isVisible:this.__settings.visible,id:e,showCollectorType:this.__settings.showCollectorType,type:this.__settings.type,choiceViewID:this.__NAME+"_"+this.__uid,isChecked:this.ruleModel.rows[e]}},_toggleRow:function(e,t){if(e[t]){delete e[t]}else{e[t]=true}this.render();this.$el.find("input:first").focus()},_checkboxChanged:function(e){var t=e.data.self,i=t.__settings.id,s=t.ruleModel.get("rows");t._toggleRow(s,i);t.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_SimpleRuleChoiceView=SM.Views.extend(SM.SimpleRuleChoiceView,{__NAME:"QNA_SimpleRuleChoiceView",__model:"choiceSet",__beforeRender:function(){var e=this.__settings.id;return{text:this.__settings.text,isVisible:this.__settings.visible,id:e,isIndented:this.__settings.isIndented,choiceViewID:this.__NAME+"_"+this.__uid,isChecked:this.choiceSet.rows[e]}},_checkboxChanged:function(e){var t=e.data.self,i=t.__settings.id,s=t.choiceSet.get("rows");t._toggleRow(s,i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_NpsSimpleRuleChoiceView=SM.Views.extend(SM.QNA_SimpleRuleChoiceView,{__NAME:"QNA_NpsSimpleRuleChoiceView",__model:"choiceSet",__init:function(){var e=this;e.$el.on(SM.Event.CHANGE,"input[rule-choice-checkbox]",function(t){var i=$(this).prop("checked");e._toggleRow(e.choiceSet.rows,e.__settings.id);e.choiceSet.ruleModel.set("isDirty",true,{notify:true})})},_toggleRow:function(e,t){var i=this,s=i.choiceSet.ruleModel.getQuestion();if(e[t]){delete e[t]}else{e[t]=true}i.choiceSet.ruleModel.is_nps_distributed=SM.ComparedByNps.isDistributed(e,s);this.render();this.$el.find("input:first").focus()}});SM.QNA_NpsRuleChoiceView=SM.Views.register({__NAME:"QNA_NpsRuleChoiceView",__model:"choiceSet",__templateID:"rule-choice-nps",__defaults:{expanded:false},__init:function(){var e=this;this.bindModel(this.choiceSet.ruleModel,"isDirty.set",{self:this},function(t){e.render()});this.$el.on(SM.Event.CLICK,".choice-expander",function(t){e.__settings.expanded=!e.__settings.expanded;e.render()}).on(SM.Event.CLICK,"input[rule-choice-checkbox][page-checkbox]",function(t){var i=$(this).prop("checked");e._toggleRows(i);e.choiceSet.ruleModel.set("isDirty",true,{notify:true})})},_toggleRows:function(e){var t=this,i=t.choiceSet.get("rows"),s=t._getDetailedRows(),n=_.pluck(s,"id"),r=t._hasSomeRowsChecked(n,i);_.each(n,function(t){if(e||r){i[t]=true}else{if(i[t]){delete i[t]}}});t.choiceSet.ruleModel.is_nps_distributed=SM.ComparedByNps.isDistributed(i,t.choiceSet.ruleModel.getQuestion());t.render()},_hasSomeRowsChecked:function(e,t){var i=0;_.each(e,function(e){if(!_.isUndefined(t[e])){i++}});return i<e.length},_hasAllRowsChecked:function(e,t){var i=0;_.each(e,function(e){if(!_.isUndefined(t[e])){i++}
});return i==e.length},_isCheckedDistributionOption:function(e){var t=this,i=t.__settings.position,s=SM.ComparedByNps.getDistributedOptions(e,t.choiceSet.ruleModel.getQuestion()),n=_.pluck(s,"position");return _.contains(n,i)},_getDetailedRows:function(){var e=this,t=e.__settings.position;return SM.ComparedByNps.getDetailedRows(t,e.choiceSet.ruleModel.getQuestion())},__beforeRender:function(){var e=this,t=this.__settings.id,i=this.__settings.position,s=e.choiceSet.get("rows"),n;n=e._isCheckedDistributionOption(s);return{text:Globalize.localize(this.__settings.text),id:this.__settings.id,expanded:this.__settings.expanded,isChecked:n,choiceViewID:this.__NAME+"_"+this.__uid}},__afterRender:function(){var e=this,t=e._getDetailedRows(),i=t.length,s=0,n=this.$el.find(".question-choices"),r;_.each(t,function(t){if(e.choiceSet.rows[t.id]){s++}});if(this.__settings.expanded){r=$.map(t,function(t,i){return SM.Views.create(SM.QNA_NpsSimpleRuleChoiceView,{id:t.id,text:t.text,isIndented:true,model:e.choiceSet}).el});n.append(r)}else{n.html("")}if(s>0&&s<i){this.$el.find("input[rule-choice-checkbox][page-checkbox]").prop("indeterminate",true)}}});SM.QNA_SingleOpenEndedRuleChoiceView=SM.Views.register({__NAME:"QNA_SingleOpenEndedRuleChoiceView",__templateID:"rule-choice-qna-text",__model:"choiceSet",__create:function(e){this.question=this.choiceSet.ruleModel.getQuestion()},__init:function(e){this.$el.on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered);this.$el.on(SM.Event.CHANGE,".search-type",{self:this},this._onSearchTypeChanged)},__beforeRender:function(){var e,t,i,s;t=this.choiceSet.get("searchType");i=this.choiceSet.ruleModel.lastValidation;s=i.invalids.choiceSet?i.invalids.choiceSet.invalids:undefined;if(!s){s=i.invalids.commentChoiceSet?i.invalids.commentChoiceSet.invalids:undefined}e={searchType:{},searchTerm:this.choiceSet.get("searchTerm"),rowSelected:true,invalidInput:s};e.searchType[t]="selected";return e},_onTextEntered:function(e){var t=e.data.self,i=$(e.currentTarget).val();t.choiceSet.set("searchTerm",i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true})},_onSearchTypeChanged:function(e){var t=$(this).val(),i=e.data.self;i.choiceSet.set("searchType",t);i.choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_MultiOpenEndedRuleChoiceView=SM.Views.extend(SM.QNA_SingleOpenEndedRuleChoiceView,{__NAME:"QNA_MultiOpenEndedRuleChoiceView",_operationToTemplateMap:{">":"opGreaterThan","<":"opLessThan","=":"opEquals"},__init:function(){SM.QNA_SingleOpenEndedRuleChoiceView.__init.call(this);this.$el.on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged)},__beforeRender:function(){var e=this.choiceSet.get("selectedRowID"),t=this.choiceSet.ruleModel.lastValidation,i=t.invalids.choiceSet?t.invalids.choiceSet.invalids:undefined,s={searchType:{},isMulti:true,rowSelected:this.choiceSet.get("selectedRowID")!=="-1",rows:$.extend(true,[],this.question.structure.answers.rows),invalidInput:i,searchTerm:this.choiceSet.get("searchTerm")},n=this.choiceSet.get("searchType")||"all";s.searchType[n]="selected";if(e!=="-1"){$.each(s.rows,function(t,i){if(e===i.id){i.selected=true;return false}})}return s},_onAnswerRowChanged:function(e){var t=e.data.self,i=$(this).val();t.choiceSet.set("selectedRowID",i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true});t.render()}});SM.QNA_DateTimeRuleChoiceView=SM.Views.extend(SM.QNA_MultiOpenEndedRuleChoiceView,{__NAME:"QNA_DateTimeRuleChoiceView",__templateID:"datetime-qna-choice",_formats:{date_intl:"d/M/yyyy",date_us:"M/d/yyyy"},_onAnswerRowChanged:function(e){var t=e.data.self,i=$(this).val();t.choiceSet.set("selectedRowID",i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true});t.render()},__init:function(){this.$el.on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged);this.$el.on("datepicker.dateSelected",".datepicker",{self:this},this._onDateSelected).on("timepicker.change",".timepicker",{self:this},this._onTimeSelected).on("change","[op-select]",{self:this},this._onOperatorChanged)},__beforeRender:function(){var e=this.question,t=SM.QNA_MultiOpenEndedRuleChoiceView.__beforeRender.call(this),i=this._operationToTemplateMap[this.choiceSet.get("op")];t.hasDatePicker=e.subtype==="date_only"||e.subtype==="both";t.hasTimePicker=e.subtype==="time_only"||e.subtype==="both";t.isMilitaryTime=Globalize.usesMilitaryTime();t[i]=true;return t},__afterRender:function(e){var t=this.choiceSet.get("selectedTime"),i=this.question.structure.validation,s=this.choiceSet.get("selectedDate"),n=new Date(s.year(),s.month(),s.date(),s.hour(),s.minute()),r;if(!t||(t.hours===-1||t.minutes===-1)){t=undefined}else{t=new Date(0,0,0,t.hours,t.minutes)}if(i&&i.type){r=this._formats[i.type]||"d"}else{r="d"}if(this.question.subtype==="date_only"||this.question.subtype==="both"){this.$el.find(".datepicker").datepicker({selectedDate:n,selectMenus:true,dateFormat:r,minDate:new Date(1900,0,1),maxDate:new Date(2050,11,31)})}if(this.question.subtype==="time_only"||this.question.subtype==="both"){this.$el.find(".timepicker").timepicker({time:t,minuteIncrement:1,militaryTime:Globalize.usesMilitaryTime()})}},_onOperatorChanged:function(e){e.data.self.choiceSet.set("op",$(this).val())},_onTimeSelected:function(e){var t=e.data.self,i=t.$el.find(".timepicker").data("timepicker").get("time");t.choiceSet.set("selectedTime",i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true})},_onDateSelected:function(e){var t=e.data.self,i=t.choiceSet.get("selectedRowID"),s=t.$el.find(".datepicker").data("datepicker").get("selectedDate");t.choiceSet.set("selectedDate",moment.utc(s));t.choiceSet.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_NumericalRuleChoiceView=SM.Views.extend(SM.QNA_MultiOpenEndedRuleChoiceView,{__NAME:"QNA_NumericalRuleChoiceView",__templateID:"qna-rule-numeric-choice",__init:function(){this.$el.on(SM.Event.PASTE,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.CHANGE,"[row-select]",{self:this},this._onAnswerRowChanged).on(SM.Event.CHANGE,"[op-select]",{self:this},this._onOperatorChanged)},__beforeRender:function(){var e=SM.QNA_MultiOpenEndedRuleChoiceView.__beforeRender.call(this),t=this._operationToTemplateMap[this.choiceSet.get("op")];e[t]=true;return e},_onOperatorChanged:function(e){var t=e.data.self,i=$(this).val();t.choiceSet.set("op",i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true});t.render()}});SM.QNA_CommentFieldChoiceView=SM.Views.register({__NAME:"QNA_CommentFieldChoiceView",__model:"choiceSet",__templateID:"rule-qna-choice-wrapper",__init:function(){this.$el.on(SM.Event.CHANGE,"input[type='checkbox']",{self:this},this._checkboxChanged)},_checkboxChanged:function(e){var t=e.data.self,i=t.choiceSet.get("commentFieldSelected");i=!i;t.choiceSet.set("commentFieldSelected",i);t.choiceSet.ruleModel.set("isDirty",true,{notify:true});t.render();if(i){t.$el.find("input[match-input]").focus()}},__afterRender:function(){var e=this.choiceSet.get("commentFieldSelected"),t,i=this.choiceSet.ruleModel.getQuestion();if(e&&!this.choiceSet.ruleModel.isCompare){t=SM.Views.create(SM.QNA_ExpandedCommentFieldChoiceView,{model:this.choiceSet}).el}else{t=SM.Template.renderHTML("rule-choice-simple",{isChecked:this.choiceSet.get("commentFieldSelected"),text:i.commentField.text,choiceViewID:this.__NAME+"_"+this.__uid})}this.$el.append(t)}});SM.QNA_ExpandedCommentFieldChoiceView=SM.Views.extend(SM.QNA_SingleOpenEndedRuleChoiceView,{__NAME:"QNA_ExpandedCommentFieldChoiceView",__beforeRender:function(e){var t=SM.QNA_SingleOpenEndedRuleChoiceView.__beforeRender.call(this,e),i=this.choiceSet.ruleModel.getQuestion();t.isCommentField=true;t.commentFieldHeading=i.commentField.text;return t}});SM.QNA_MatrixSimpleRuleChoiceView=SM.Views.extend(SM.SimpleRuleChoiceView,{__NAME:"QNA_MatrixSimpleRuleChoiceView",__model:"choiceSetModel",__beforeRender:function(){var e=this.__settings.id,t=this.__settings.choiceSetName;return{text:this.__settings.text,isVisible:this.__settings.visible,id:e,isChecked:this.choiceSetModel.get(t)[e],choiceViewID:this.__NAME+"_"+this.__uid}},_checkboxChanged:function(e){var t=e.data.self,i=t.__settings.choiceSetName,s=t.__settings.id,n=t.choiceSetModel[i];if(n[s]){delete n[s]}else{n[s]=true}t.render();t.$el.find("input").focus();t.choiceSetModel.ruleModel.set("isDirty",true,{notify:true})}});SM.QNA_MatrixSelectRuleChoiceView=SM.Views.register({__model:"choiceSetModel",__NAME:"matrixSelectRuleChoiceView",__templateID:"rule-choice-matrix-select",__defaults:{prompt:"Choose a row..."},__create:function(){this.__settings.prompt=Globalize.localize(this.__settings.prompt)},__beforeRender:function(){var e=this.choiceSetModel.ruleModel.getQuestion(),t=this.__settings.choiceSetName,i=$.extend(true,[],e.structure.answers[t]),s=SM.Object.getOnlyKey(this.choiceSetModel[t]);if(s){_.each(i,function(e){if(e.id===s){e.selected="selected";return false}})}return{choiceSetName:t,answerList:i,placeholderPrompt:this.__settings.prompt,isDisabled:this.__settings.isDisabled}}});SM.QNA_MatrixRuleChoiceSetView=SM.Views.register({__NAME:"QNA_MatrixRuleChoiceSetView",__model:"choiceSetModel",__templateID:"rule-qna-choice-wrapper",__init:function(){this.$el.on(SM.Event.CHANGE,"[answer-set='rows']",{self:this},this._onRowChanged)},__afterRender:function(){var e=this.choiceSetModel.rows,t=SM.Object.getOnlyKey(e)!==undefined,i=this.choiceSetModel.ruleModel.getQuestion(),s=i.structure.answers["cols"];this._addSelectList("rows",false);if(t){this._buildChoiceList(s,"cols")}},_onRowChanged:function(e){var t=e.data.self,i=$(this).val(),s=t.choiceSetModel;s.rows={};s.cols={};if(i!=="-1"){s.rows[i]=true}t.render();t.$el.find("input[type='checkbox']:first").focus();s.ruleModel.set("isDirty",true,{notify:true})},_addSelectList:function(e,t){var i=SM.Views.create(SM.QNA_MatrixSelectRuleChoiceView,{model:this.choiceSetModel,choiceSetName:e,isDisabled:t});this.$el.append(i.el)},_buildChoiceList:function(e,t){var i=this,s=this.choiceSetModel.ruleModel.getQuestion(),n,r;n=_.map(e,function(e){return SM.Views.create(SM.QNA_MatrixSimpleRuleChoiceView,{model:i.choiceSetModel,text:e.text,id:e.id,choiceSetName:t}).el});this.$el.append(n)}});SM.QNA_MenuMatrixRuleChoiceSetView=SM.Views.extend(SM.QNA_MatrixRuleChoiceSetView,{__NAME:"QNA_MenuMatrixRuleChoiceView",__templateID:"rule-qna-choice-wrapper",__init:function(){SM.QNA_MatrixRuleChoiceSetView.__init.call(this);this.$el.on(SM.Event.CHANGE,"[answer-set='cols']",{self:this},this._onColChanged)},__afterRender:function(){var e=this.__settings.sectionIndex,t=this.choiceSetModel,i=t.rows,s=t.cols,n=SM.Object.getOnlyKey(i)!==undefined,r=SM.Object.getOnlyKey(s)!==undefined,a=t.ruleModel.getQuestion(),o,l,u;if(_.isEmpty(s)){o=a.structure.answers["cols"][0].items}else{_.each(s,function(e,t){l=t});u=_.find(a.structure.answers["cols"],function(e){return e.id===l});o=u.items}this._addSelectList("rows");this._addSelectList("cols",!n);if(n&&r){this._buildChoiceList(o,"colChoices")}},_onColChanged:function(e){var t=e.data.self,i=t.choiceSetModel,s=$(this).val();i.cols={};i.colChoices={};if(s!=="-1"){i.cols[s]=true}t.render();t.$el.find("input[type='checkbox']:first").focus();i.ruleModel.set("isDirty",true,{notify:true})},_onRowChanged:function(e){var t=e.data.self,i=$(this).val(),s=t.choiceSetModel;s.rows={};s.cols={};s.colChoices={};if(i!=="-1"){s.rows[i]=true}t.render();t.$el.find("select[answer-set='cols']").focus();s.ruleModel.set("isDirty",true,{notify:true})}});SM.TimeTotalRuleChoiceView=SM.Views.register({__NAME:"TimeTotalRuleChoiceView",__templateID:"rule-choice-time-total",__model:"ruleModel",__init:function(){this.$el.on(SM.Event.CHANGE,".time-unit",{self:this,setter:"unit"},this._onTotalTimeAttributeChanged);this.$el.on(SM.Event.KEYUP,".time-value",{self:this,setter:"value"},this._onTotalTimeAttributeChanged);this.$el.on(SM.Event.CHANGE,".op-select",{self:this,setter:"op"},this._onTotalTimeAttributeChanged)},__beforeRender:function(){var e=this.ruleModel.get("timeTotal"),t=this.ruleModel.lastValidation,i=!t.invalids.timeTotal,s={selected:{},timetext:e.value,isValid:i};s.selected[e.unit]=true;if(e.op===">"){s.selected.greaterthan=true}else if(e.op==="<"){s.selected.lessthan=true}return s},_onTotalTimeAttributeChanged:function(e){var t=e.data.self,i=t.ruleModel.get("timeTotal");i[e.data.setter]=$(this).val();t.ruleModel.set("isDirty",true,{notify:true})}});SM.TextRuleChoiceView=SM.Views.register({__NAME:"TextRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-text",__init:function(){this.$el.on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.BLUR,"input[type='text']",{self:this},this._onTextEntered).on(SM.Event.PASTE,"input[type='text']",{self:this},this._onTextEntered)},__beforeRender:function(){var e=this.__settings,t=this.__settings.id,i=this.ruleModel.lastValidation;this.popout_id=this.__settings.popout_id;e.isVisible=this.ruleModel.attributeIsVisible(t);e.textEntered=this.ruleModel.get(t);e.isValid=true;if(i.invalids[t]){e.validationErrorMsg=i.invalids[t].message;e.isValid=false}return e},_onTextEntered:function(e){var t=e.data.self,i=$(e.currentTarget).val(),s=t.__settings.id;t.ruleModel.set(s,i);t.ruleModel.set("isDirty",true,{notify:true})},__afterRender:function(){this.$textBox=this.$el.find(".fv-textbox");this.$textLabel=this.$el.find(".fv-textlabel");this.$errorMsg=this.$el.find(".fv-error");if(!!this.popout_id){this.$el.append(SM.Views.create(SM.RuleBuilderPopouts,{templateID:this.popout_id}).el)}}});SM.ShowPageRuleChoiceView=SM.Views.register({__NAME:"ShowRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-show",__defaults:{expanded:false,isFirstChoice:false,isLastChoice:false},__init:function(){var e=this,t=this.ruleModel.survey.getPage(this.__settings.pageID);this.$el.on(SM.Event.CLICK,".choice-expander",function(i){e.__settings.expanded=!e.__settings.expanded;e.$el.trigger("pageExpandToggled",{ID:t.ID,val:e.__settings.expanded});e.render()}).on(SM.Event.CHANGE,"input[rule-choice-checkbox][page-checkbox]",function(i){e.ruleModel.showSet.togglePage(t);e.ruleModel.set("isDirty",true,{notify:true})})},__beforeRender:function(){var e=this.ruleModel.survey.getPage(this.__settings.pageID),t=""+e.position,i=this.ruleModel.showSet;if(e.heading.length>0){t+=": "+e.heading}return{text:t,id:e.ID,isExpandable:true,isFirstChoice:this.__settings.isFirstChoice,isLastChoice:this.__settings.isLastChoice,hasQuestions:e.questionList.length>0,expanded:this.__settings.expanded,isChecked:i.hasPage(e),choiceViewID:this.__NAME+"_"+this.__uid}},__afterRender:function(){var e=this.ruleModel.survey.getPage(this.__settings.pageID),t=this,i=e.questionList,s=this.ruleModel.showSet.pageQuestionsCheckedCount(e),n=this.$el.find(".question-choices"),r;if(this.__settings.expanded){r=$.map(i,function(e,s){return SM.Views.create(SM.ShowQuestionRuleChoiceView,{questionID:e.ID,model:t.ruleModel,isFirstChoice:s===0,isLastChoice:s===i.length-1}).el});n.append(r)}else{n.html("")}if(s>0){if(s<i.length){this.$el.find("input[rule-choice-checkbox][page-checkbox]").prop("indeterminate",true)}}}});SM.ShowQuestionRuleChoiceView=SM.Views.register({__NAME:"ShowQuestionRuleChoiceView",__model:"ruleModel",__templateID:"rule-choice-simple",__defaults:{isFirstChoice:false,isLastChoice:false},__init:function(){var e=this,t=this.ruleModel.survey.getQuestion(this.__settings.questionID);this.$el.on(SM.Event.CHANGE,"input[rule-choice-checkbox]",function(i){e.ruleModel.showSet.toggleQuestion(t);e.ruleModel.set("isDirty",true,{notify:true})})},__beforeRender:function(){var e=this.ruleModel.survey.getQuestion(this.__settings.questionID),t=Globalize.localize("Question")[0]+e.position;if(e.heading&&e.heading.length>0){t+=": "+e.heading}return{text:t,id:e.ID,isIndented:true,isLastChoice:this.__settings.isLastChoice,isFirstChioce:this.__settings.isFirstChoice,isHighlighted:this.__settings.isHighlighted,isVisible:true,isChecked:this.ruleModel.showSet.hasQuestion(e),choiceViewID:this.__NAME+"_"+this.__uid}}});SM.TimeRangeRuleChoiceView=SM.Views.register({__NAME:"TimeRangeRuleChoiceView",__templateID:"rule-choice-date",__model:"ruleModel",__init:function(){this.$el.on("datepicker.afterClose",{self:this},this._onDateChanged)},__afterRender:function(){var e=this.ruleModel.get("startDate"),t=this.ruleModel.get("endDate");this.$el.dateRangePicker({startMinDate:new Date(1999,0,1),endMaxDate:new Date(2020,11,31),selectMenus:true});this.daterange=this.$el.data("dateRangePicker");if(e){this.daterange.set("startSelectedDate",new Date(e));this.daterange.set("endSelectedDate",new Date(t))}},_onDateChanged:function(e){var t=e.data.self,i=t.$el.data("dateRangePicker"),s=i.get("startSelectedDate"),n=i.get("endSelectedDate");if(s!==null){t.ruleModel.set("startDate",s.getTime())}if(n!==null){t.ruleModel.set("endDate",n.getTime())}t.ruleModel.set("isDirty",true,{notify:true})}});SM.QNARulePickerView=SM.Views.register({__model:"survey",__NAME:"QNARulePickerView",__templateID:"QNARulePickerView",_compareBuilderType:"CompareBuilderView",_filterBuilderType:"FilterBuilderView",__init:function(){var e=this;this.$el.on("autocomplete.selected","[qna-search-text]",{self:this},this._searchResultSelected).on("change","select",{self:this},this._onSelectChange).on("click",".btn-filter-cancel",{self:this},this._onCancelClick);this._autocomplete=this.$el.find("[qna-search-text]").autocomplete({search:function(e){var t=this.get("survey"),i=t.searchQuestions(e),s,n,r=this.get("isCompare");i=$.map(i,function(e,i){s=t.questions[e];n=r&&!s.hasComparableOptions()||s.isPresentation()||r&&s.isNPS();return{value:s.ID,text:"Q"+s.position+": "+s.heading,isDisabled:n}});this.set("results",i)},isCompare:this.__settings.builder_type===this._compareBuilderType,minLength:this.survey.SEARCH_NGRAM_SIZE,survey:this.survey,classes:["searchresults-menu","long"]})},__destroy:function(){if(this._autocomplete){if(this._autocomplete.menu){this._autocomplete.menu.$el.remove();this._autocomplete.menu=undefined}this._autocomplete=undefined}},__beforeRender:function(){var e=this.survey.questionList,t=0,i,s,n,r=this.__settings.builder_type===this._compareBuilderType,a={questions:[],isCompare:r};i=e.length;for(;t<i;t++){n=e[t];s={text:n.position+": "+n.heading,id:n.ID};a.questions.push(s);if(r&&!n.hasComparableOptions()||n.isPresentation()||r&&n.isNPS()){a.questions[t].isDisabled=true}}return a},reset:function(){this.$el.find("[qna-search-text]").val("");this.$el.find("select").val("-1")},_onCancelClick:function(e){var t=e.data.self;e.preventDefault();t.reset();t.$el.trigger("QNARulePickerView.cancelClicked")},_onSelectChange:function(e){var t=e.data.self;if(parseInt(this.value,10)>0){t.$el.trigger("QNARulePickerView.questionSelected",{questionID:this.value});t.reset()}},_searchResultSelected:function(e){var t=e.data.self;t.$el.trigger("QNARulePickerView.questionSelected",{questionID:e.value});t.reset()}});SM.RandomAssignmentRulePickerView=SM.Views.register({__model:"survey",__NAME:"RandomAssignmentRulePickerView",__templateID:"RandomAssignmentRulePickerView",_compareBuilderType:"CompareBuilderView",_filterBuilderType:"FilterBuilderView",__init:function(){var e=this;this.$el.on("change","select",{self:this},this._onSelectChange).on("click",".btn-filter-cancel",{self:this},this._onCancelClick)},__destroy:function(){},_mapTypeToText:function(e,t){var i={datetime:{date_only:"Question Test",time_only:"Question Test",both:"Question Test"},demographic:{us:"Question Test",international:"Question Test"},single_choice:{vertical:"Question Test"},multiple_choice:{vertical:"Question Test"},open_ended:{essay:"Question Test",single:"Question Test",multi:"Question Test",numerical:"Question Test"},matrix:{rating:"Question Test",single:"Question Test",multi:"Question Test",ranking:"Question Test"},presentation:{image:"Image Test",descriptive_text:"Text Test"}};return i[e][t]},__parseParams:function(e){var t=parseInt(e.split("_")[1]);return t},__makeParams:function(e){return"qid_"+e},__beforeRender:function(){var e=this,t=e.survey.questionList,i=e.__settings.builder_type===e._compareBuilderType,s={randomAssignments:[],hasRandomAssignment:false,isCompare:i};_.each(t,function(t){if(t.randomAssignmentList.length>0){s.hasRandomAssignment=true;if(t.family=="datetime"||t.family=="open_ended"||t.family=="demographic"){isDisabled=true}else{isDisabled=false}s.randomAssignments.push({text:Globalize.localize("Question").substr(0,1)+t.position+": "+Globalize.localize("("+e._mapTypeToText(t.family,t.subtype)+")")+" "+t.heading,questionID:t.ID,params:e.__makeParams(t.ID),isDisabled:isDisabled})}});return s},reset:function(){this.$el.find("select").val("-1")},_onCancelClick:function(e){var t=e.data.self;e.preventDefault();t.reset();t.$el.trigger("RandomAssignmentRulePickerView.cancelClicked")},_onSelectChange:function(e){var t=e.data.self,i=t.__parseParams(this.value);if(i>0){t.$el.trigger("RandomAssignmentRulePickerView.variationSelected",{questionID:i});t.reset()}}});SM.BaseCompareAndFilterBuilderView={__model:"survey",isCompareBuilder:false,BI_BUTTON_NAME:"",ruleTypes:{COLLECTOR:"collector",COMPLETENESS:"completeness",QNA:"qna",RANDOM_ASSIGNMENT:"random_assignment",RESPONDENT_DATA:"respondent_data",TIME_PERIOD:"time_period"},__init:function(){var e=this;this.bindModel(this.survey.anviews,"selectedViewChanged",{self:this},this.close);this.bindModel(this.survey.anviews.currentView,"ruleAdded",{self:this},this.close);this.bindModel(this.survey.anviews.currentView,"ruleEdited",{self:this},this.close);this.$el.on("waterpark.shift",{self:this},this._createRuleModel).on("waterpark.afterShift",{self:this},this._onAfterShift).on(SM.Event.CLICK,".back-shifter",{self:this},this._onBackShifterClick).on("RuleButtons.cancelClicked",{self:this},this.close).on("RuleView.applied",{self:this},this.close).on("QNARulePickerView.cancelClicked",{self:this},this.close).on("QNARulePickerView.questionSelected",{self:this,ruleType:this.ruleTypes.QNA},this._createQNAOrRARuleModel).on("RandomAssignmentRulePickerView.variationSelected",{self:this,ruleType:this.ruleTypes.RANDOM_ASSIGNMENT},this._createQNAOrRARuleModel);this.wpark=this.$el.waterpark().data("waterpark")},__beforeRender:function(){return{id:this.__NAME,is_merged_survey:SM.App.isMerveysApp()}},__afterRender:function(){this.questionPicker=SM.Views.create(SM.QNARulePickerView,{model:this.survey,builder_type:this.__NAME});this.$el.find("section.lane.qna.select").append(this.questionPicker.el);this.raPicker=SM.Views.create(SM.RandomAssignmentRulePickerView,{model:this.survey,builder_type:this.__NAME});this.$el.find("section.lane.random_assignment.select").append(this.raPicker.el)},_isMultiSlideSelect:function(e){if(e===this.ruleTypes.QNA||e===this.ruleTypes.RANDOM_ASSIGNMENT){return true}return false},_createQNAOrRARuleModel:function(e,t){var i=e.data.self,s=e.data.ruleType,n=i.isCompareBuilder,r=i._createAndAddRule(s,n,t.questionID);SM.Bi.uiTrigger=i.BI_BUTTON_NAME;i.wpark.set("location",{slide:2,lane:s})},_createRuleModel:function(e){var t=e.data.self,i=t.wpark.get("location"),s=i.lane;if(i.slide===1&&!t._isMultiSlideSelect(s)){t._createAndAddRule(s,t.isCompareBuilder,null)}},_createAndAddRule:function(e,t,i){var s;if(e==="qna-source-surveys"){e="qna";i=this.survey.getSourceSurveysQuestionId()}s=SM.BaseAnRule.FactoryCreate({ID:null,attrs:{is_compare_rule:t,question_id:i,rule_type:e,selected:true}},this.survey);s.loadSurvey(this.survey);this._appendRule(s);return s},_appendRule:function(e){var t,i,s,n=this.survey.getSourceSurveysQuestionId();t=e.get("ruleType");if(t==="qna"&&e.get("questionID")===n){t="qna-source-surveys"}i="section."+t;s=SM.Views.create(SM.AnRuleView,{model:e,editMode:true});if(e.isQNA&&t!=="qna-source-surveys"||e.isRA){i+=":last"}this.$el.find(i).append(s.el)},_onBackShifterClick:function(e){var t=e.data.self;t.$el.find(".an-rule").trigger("RuleView.destroy")},_onAfterShift:function(e){var t=e.data.self,i=e.waterpark,s=i.get("location");t.$el.find(".slide").eq(s.slide).find("."+s.lane).eq(0).find("input, select, button, textarea").eq(0).focus()},onTabClose:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");this.wpark.set("location",{slide:0})},close:function(e){var t=e.data.self,i=t.wpark.get("location");if(i.slide!==0){t._close()}},_close:function(){this.wpark.set("location",{slide:0})}};SM.FilterBuilderView=SM.Views.extend(SM.BaseCompareAndFilterBuilderView,{__NAME:"FilterBuilderView",__templateID:"filterBuildersTemplate",BI_BUTTON_NAME:"NewFilterRuleButton"});SM.CompareBuilderView=SM.Views.extend(SM.BaseCompareAndFilterBuilderView,{__NAME:"CompareBuilderView",__templateID:"compareBuildersTemplate",BI_BUTTON_NAME:"NewCompareRuleButton",isCompareBuilder:true});SM.ShowBuilderView=SM.Views.register({__NAME:"ShowBuilderView",__templateID:"ShowBuilderTemplate",__model:"survey",BI_BUTTON_NAME:"NewShowRuleButton",onTabClose:function(){this.$el.find(".an-rule").trigger("RuleView.destroy")},open:function(){var e=this,t=SM.Models.create("ShowAnRule",{ID:null,attrs:{selected:false}}),i;SM.Bi.uiTrigger=e.BI_BUTTON_NAME;t.loadSurvey(this.survey);i=SM.Views.create(SM.AnRuleView,{model:t,editMode:true});this.el.appendChild(i.el);this.$el.find("input").first().focus()}});SM.RuleBuilderPopouts=SM.Views.register({__NAME:"RuleBuilderPopouts",__templateID:"rule-popout",__afterRender:function(){this.$el.popout()}});SM.RuleListContainerView=SM.Views.register({__model:"currentView",__NAME:"RulesContainerView",__templateID:"RulesContainerTemplate",__afterRender:function(){this.$ruleListSlide=this.$el.find("[rules_slide]");this.$editSlide=this.$el.find("[edit_slide]");this.ruleListView=SM.Views.create(SM.RuleListView,{model:this.currentView});this.$ruleListSlide.append(this.ruleListView.$el);this.resetSlider();return this},__init:function(){var e=this;this.bindModel(this.currentView.anviews,"selectedViewLoaded",{self:this},this._onRulesChanged);this.slider=this.$el.waterpark().data("waterpark");this.$el.on("RuleButtons.cancelClicked","[edit_slide]",function(){e.resetSlider()}).on("RuleView.applied","[edit_slide]",function(){e.resetSlider()}).on("AnRuleListItemView.editClicked","[rules_slide]",{self:this},this._onRuleEditClicked).on("waterpark.afterShift",{self:this},this._onAfterShift)},__destroy:function(){delete this.slider},hide:function(){this.$el.hide();return this},_onRulesChanged:function(e){var t=e.data.self;t.render()},FADE_SPEED:250,resetSlider:function(){if(this.slider){this.slider.calculateAttributes();this.slider.set("location",{slide:0})}this.$el.show()},_onRuleEditClicked:function(e){var t=e.AnRuleListItemView,i=t.ruleModel,s=e.data.self;i.set("editMode",true);s.$editSlide.append(SM.Views.create(SM.AnRuleView,{AnRuleListItemView:t,model:i}).$el);s.slider.set("location",{slide:1})},_onAfterShift:function(e){var t=e.data.self,i=e.waterpark,s=i.get("location");t.$el.find(".slide").eq(s.slide).find("input, select, button, textarea").eq(0).focus()}});SM.RuleListView=SM.Views.register({__model:"currentView",__templateID:"RuleListTemplate",__NAME:"RuleListView",__init:function(){var e=this;this.bindModel(this.currentView,"ruleDeleted",{self:this},this._onRuleDeleted);this.bindModel(this.currentView,"ruleAdded",{self:this},this._onRuleAdded);this.bindModel(this.currentView,"failedLoadRequestID.set",{self:this},this._onCurrentViewFailedToLoad)},__beforeRender:function(){var e=this.currentView.anviews.survey.owner;return{hasNoRules:this.currentView.ruleList.length===0,hasUpgradeTrigger:e.isOverRuleLimit()}},__afterRender:function(){var e=this.currentView.anviews.survey.owner,t=e.hasRuleLimit(),i=this.currentView.ruleList,s=i.length,n=this,r=this.currentView.anviews.survey.owner,a=this.$el.find("ul"),o=this.$el.find("[rule-list-messages]"),l,u=this.currentView.get("failedLoadRequestID"),d;if(u!==null){o.html(SM.Template.render("view-switch-failed",{requestID:u,classes:"mod-no-header"}));return}if(r.isOverRuleLimit()){o.html(SM.Template.render("rule-limit-upgrade-message-template"))}_.each(i,function(i,r){if(!t||r>=s-e.ruleLimit){l=false}else{l=true}d=SM.Views.create(SM.AnRuleListItemView,{isDisabled:l,model:i});a.prepend(d.$el);n.$el.find(".q").popout()})},_onCurrentViewFailedToLoad:function(e){e.data.self.render()},_onRuleAdded:function(e){e.data.self.render()},_onRuleDeleted:function(e){var t=e.data.self;if(t.currentView.ruleList.length===0){t.render()}}});SM.RuleBuilderContainerView=SM.Views.register({__templateID:"RuleBuilderContainerTemplate",__defaults:{},__model:"survey",__NAME:"RuleBuilderContainerView",_lastPanel:null,_lastTab:null,__beforeRender:function(){return{showTabTitle:this._getShowTabTitle(),compareTabTitle:this._getCompareTabTitle(),shouldDisableShowTab:this._shouldDisableShowTab(),shouldDisableCompareTab:this._shouldDisableCompareTab()}},_getShowTabTitle:function(){if(this._shouldDisableShowTab()){return Globalize.localize("You can apply only one SHOW rule")}else{return Globalize.localize("Show only certain questions")}},_getCompareTabTitle:function(){if(this._shouldDisableCompareTab()){if(this.survey.state.isBrowseMode()){return Globalize.localize("Compare is not allowed for Individual Responses")}else if(this.survey.state.isTrendMode()){return Globalize.localize("Compare is not allowed in Data Trends")}else{return Globalize.localize("Compare is not allowed")}}else{return Globalize.localize("Crosstabulate your data")}},_shouldDisableShowTab:function(){return this.survey.anviews.currentView.hasShowRule()},_shouldDisableCompareTab:function(){return this.survey.state.isTrendMode()},__afterRender:function(){this._cacheElements();this._initWidgets()},_initWidgets:function(){this.$el.find(".q").popout()},__init:function(){var e=this.survey.anviews.currentView;this.bindModel(this.survey.anviews,"selectedViewChanged",{self:this},this._disable);this.bindModel(this.survey.anviews,"selectedViewLoaded",{self:this},this._enable);this.bindModel(e,"failedLoadRequestID.set",{self:this},this._onCurrentViewFailedToLoad);this.bindModel(e,"savedToNewView",{self:this},this._disable);this.bindModel(e,"ruleAdded",{self:this},this._onRuleAdded);this.bindModel(e,"ruleDeleted",{self:this},this._onRuleDelete);this.$el.on(SM.Event.CLICK,"a.tab",{self:this},this._onTabClick);this.$el.on(SM.Event.CLICK,"#rule_limit_upgrade_message .learn-more",function(e){e.preventDefault();var t=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"rules-upgrade-dialog-template"});t.open()});this.$el.on({"RuleView.ruleClosed":this._closeTabs,"RuleView.applied":this._closeTabs,"RuleButtons.cancelClicked":this._closeTabs,"QNARulePickerView.cancelClicked":this._closeTabs},{self:this});this.$el.on(SM.Event.CLICK,".waterpark .cancel.btn",{self:this},this._closeTabs)},__destroy:function(){delete this.tabs},_cacheElements:function(){var e=this.$el.find(".panels").get(0);this.showBuilder=SM.Views.create(SM.ShowBuilderView,{model:this.survey});this.compareBuilder=SM.Views.create(SM.CompareBuilderView,{model:this.survey});this.filterBuilder=SM.Views.create(SM.FilterBuilderView,{model:this.survey});e.appendChild(this.filterBuilder.el);e.appendChild(this.compareBuilder.el);e.appendChild(this.showBuilder.el);this.showTab=this.$el.find("#ShowBuilderTab");this.currRules=SM.Views.create(SM.RuleListContainerView,{model:this.survey.anviews.currentView});this.el.appendChild(this.currRules.el);return this},_onTabClick:function(e){var t=e.data.self,i=t._lastPanel,s=$(this),n=s.attr("target");e.preventDefault();if(s.hasClass("disabled")){return}if(!!i){t.closeTabs()}if(i!==n){t._lastPanel=n;t._lastTab=s.attr("id");t._beforeTabOpen();$(n).addClass("open");s.data("title",s.attr("title"));s.addClass("active").removeAttr("title")}},_beforeTabOpen:function(){this.$el.find(".an-rule").trigger("RuleView.destroy");this.currRules.hide();if(this._lastPanel==="#ShowBuilderView"){this.showBuilder.open()}},_closeTabs:function(e){var t=e.data.self,i,s=t._lastPanel;if(s){$(s).removeClass("open");i=$("#"+t._lastTab);i.removeClass("active");
if(!i.attr("title")){i.attr("title",i.data("title"))}t._lastTab=null;t._lastPanel=null;t._afterTabClose(s)}},closeTabs:function(){this._closeTabs({data:{self:this}})},_afterTabClose:function(e){if(e==="#ShowBuilderView"){this.showBuilder.onTabClose()}else if(e==="#FilterBuilderView"){this.filterBuilder.onTabClose()}else if(e==="#CompareBuilderView"){this.compareBuilder.onTabClose()}this.currRules.resetSlider()},_disable:function(e){var t=e.data.self;t.closeTabs();t.$el.find(".rules-loading-icon").fadeIn(100);t.$el.find(".rules-ui-blocker").fadeIn(100);t.$el.find(".tab").addClass("disabled")},_enable:function(e){var t=e.data.self;t.$el.find(".rules-loading-icon").hide();t.$el.find(".rules-ui-blocker").hide();t.$el.find(".tab").removeClass("disabled");t._renderShowTab();t._renderCompareTab();t._initWidgets()},_onCurrentViewFailedToLoad:function(e){var t=e.data.self;t.$el.find(".rules-loading-icon").hide();t.$el.find(".rules-ui-blocker").hide()},_renderShowTab:function(){var e=$("#ShowBuilderTab");if(this._shouldDisableShowTab()){e.addClass("disabled")}else{e.removeClass("disabled")}},_renderCompareTab:function(){var e=$("#CompareBuilderTab");if(this._shouldDisableCompareTab()){e.addClass("disabled")}else{e.removeClass("disabled")}},_onRuleAdded:function(e){var t=e.data.self,i=SM.Views.create(SM.AnRuleListItemView,{model:e.ruleModel});if(e.ruleModel.isShow){$("#ShowBuilderTab").addClass("disabled").attr("title",Globalize.localize("You can apply only one SHOW rule"))}},_onRuleDelete:function(e){var t=e.data.self;if(e.ruleModel.isShow){$("#ShowBuilderTab").removeClass("disabled").attr("title",Globalize.localize("Create a show rule"))}}});SM.AnalyzeSecondaryView=SM.Views.register({__NAME:"AnalyzeSecondaryView",__model:"survey",__templateID:"analyze-secondary-column",__init:function(){var e=this;this.$el.accordion({multiOpen:true,overflowAuto:false});this.$el.on({"accordion.beforeOpen":function(t){if(t.id==="ExportListContainer"){e.exportsHeadingView.set("isOpen",true);e.exportsHeadingView.render()}if(t.id==="SharedViewsListContainer"){e.sharedViewsHeadingView.set("isOpen",true);e.sharedViewsHeadingView.render()}},"accordion.afterClose":function(t){if(t.id==="ExportListContainer"){e.exportsHeadingView.set("isOpen",false);e.exportsHeadingView.render()}if(t.id==="SharedViewsListContainer"){e.sharedViewsHeadingView.set("isOpen",false);e.sharedViewsHeadingView.render()}}})},__beforeRender:function(){return{exportsEnabled:this._shouldShowExportsKey(),sharingEnabled:this._shouldShowSharedViewsKey(),showBenchmarkingKey:this._shouldShowBenchmarkingKey(),benchmarkingEnabled:this._shouldOpenBenchmarkingKey()}},__afterRender:function(){this._renderRulesKey();if(this._shouldShowBenchmarkingKey()){this._renderBenchmarkingKey()}this._renderSavedViewsKey();if(this._shouldShowExportsKey()){this._renderExportsKey()}if(this._shouldShowSharedViewsKey()){this._renderSharedViewsKey()}this.$el.find(".q").popout()},_renderRulesKey:function(){var e;e=SM.Views.create(SM.RuleBuilderContainerView,{model:this.survey});this.$el.find("#RuleBuilderViewContainer").append(e.$el)},_renderBenchmarkingKey:function(){this.dataSegmentContainerView=SM.Views.create(SM.DataSegmentContainerView,{model:this.survey});this.$el.find("#DataSegmentBuilderViewContainer").append(this.dataSegmentContainerView.$el)},_renderSavedViewsKey:function(){var e,t;t=SM.Views.create(SM.AnViewListView,{model:this.survey.anviews,isOpen:true});e=SM.Views.create(SM.SavedViewsHeadingView,{model:this.survey.anviews});this.$el.find("[saved-views-key] .keyOpener").append(e.$el);this.$el.find("#view-list-area").append(t.$el)},_renderExportsKey:function(){var e;e=SM.Views.create(SM.ExportJobListView,{model:this.survey.exportJobs});this.exportsHeadingView=SM.Views.create(SM.ExportHeadingView,{model:this.survey.exportJobs,isLoading:this.survey.exportJobs.poller.get("isActive"),hideCount:!this.survey.exportJobs.get("isLoaded")});this.$el.find("[exports-key] .keyOpener").append(this.exportsHeadingView.$el);this.$el.find("#export-job-list-area").append(e.$el)},_renderSharedViewsKey:function(){var e;e=SM.Views.create(SM.SharedViewListView,{survey:this.survey,sharedViews:this.survey.sharedViews});this.sharedViewsHeadingView=SM.Views.create(SM.SharedViewsKeyHeadingView,{sharedViews:this.survey.sharedViews});this.$el.find("[shared-views-key] .keyOpener").append(this.sharedViewsHeadingView.$el);this.$el.find("[shared-view-list]").append(e.$el)},_shouldShowExportsKey:function(){return this.survey.isExportEnabled()},_shouldShowSharedViewsKey:function(){return SM.App.isSharingEnabled()},_shouldShowBenchmarkingKey:function(){if(0==this.survey.getCountOfBenchmarkableQuestions()){return false}if(!this.survey.isCurrentUserAlsoOwner()){return this.survey.canShowBenchmarking()}return this.survey.owner.hasBenchmarking()&&this.survey.state.isSummaryMode()},_shouldOpenBenchmarkingKey:function(){if(!this.survey.profiler){return false}return true}});SM.ExportNullStateView=SM.Views.register({__NAME:"ExportNullStateView",__model:"survey",__templateID:"export-null-state-template",__afterRender:function(){var e=this.$el.find("p[export-menu]"),t=SM.Views.create(SM.ExportAllBtnView,{model:this.survey,buttonName:"ExportEmptyAccordionButton"});e.append(t.el)}});SM.AnalyzeCTAView=SM.Views.register({__NAME:"AnalyzeCTAView",__model:"survey",__templateID:"analyze-cta",__beforeRender:function(){return{encryptedSurveyID:this.survey.encryptedID}},__afterRender:function(){this.$el.find("[export-btn]").append(SM.Views.create(SM.ExportAllBtnView,{model:this.survey,noBorder:true}).el)}});SM.PageArrowBtnsView=SM.Views.register({__NAME:"pageArrowBtnsView",__model:"survey",__templateID:"page-arrow-btns-template",__init:function(){this.survey.state.on("page.changed",{self:this},this._onPageChange);this.$el.on(SM.Event.CLICK,"[sm-prev-btn]",{self:this},this._onPrevPageClick).on(SM.Event.CLICK,"[sm-next-btn]",{self:this},this._onNextPageClick)},__destroy:function(){this.survey.state.off("page.changed",this._onPageChange)},__beforeRender:function(){var e=this.survey.state.get("page"),t=this.survey.getLastShownPage(),i=this.survey.getFirstShownPage(),s=e<=i.position-1,n=e>=t.position-1,r=this.survey.state.get("allPagesSelected");return{prevBtnDisabled:r||s,nextBtnDisabled:r||n}},_onPageChange:function(e){var t=e.data.self;t.render()},_onNextPageClick:function(e){var t=e.data.self,i=t.survey.state.get("page"),s=t.survey.state.get("allPagesSelected"),n;e.preventDefault();if(s){return}n=t.survey.getNextShownPage(i);if(!n){return}t.survey.state.set("page",n.position-1,{notify:true})},_onPrevPageClick:function(e){var t=e.data.self,i=t.survey.state.get("page"),s=t.survey.state.get("allPagesSelected"),n;e.preventDefault();if(s){return}n=t.survey.getPrevShownPage(i);if(!n){return}t.survey.state.set("page",n.position-1,{notify:true})}});SM.PageMenuBtnView=SM.Views.register({__NAME:"pageMenuBtnView",__model:"survey",__templateID:"page-menu-btn-template",__init:function(e){this.survey.state.on("page.changed",{self:this},this._onPageChange);this.$el.actionMenu({menuView:"PageMenuView",model:this.survey,selectedAction:this.survey.state.get("page").toString(),saveState:true}).on("actionMenu.actionSelected",{self:this},this._onPageSelected).on("actionMenu.beforeOpen",{self:this},this._onBeforeMenuOpen)},__destroy:function(){this.survey.state.off("page.changed",this._onPageChange)},__beforeRender:function(){var e,t=this.survey.state.get("page"),i=this.survey.anviews.currentView.hasActiveShowRule(),s=this.survey.state.get("allPagesSelected");if(t!=="all"){e=t+1}return{hasShowRule:i,allPagesSelected:s,pageNumber:e}},_onPageSelected:function(e){var t=e.data.self,i=e.action;if(i!=="all"){i=parseInt(i,10)}t.survey.state.set("page",i,{notify:true})},_onBeforeMenuOpen:function(e){e.actionMenu.get("menuView").render()},_onPageChange:function(e){var t=e.data.self,i=t.$el.data("actionMenu");i.set("selectedAction",t.survey.state.get("page"));t.render()}});SM.PageMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"pageMenuView",__model:"survey",__templateID:"page-menu-template",__beforeRender:function(){var e=this.survey.pageCount,t=this.survey.anviews.currentView.hasActiveShowRule(),i=[],s,n,r=0;for(;r<e;r++){n=this.survey.pageList[r];s={};s.title=n.heading;s.number=n.position;s.index=n.position-1;s.isShown=n.isShown();i.push(s)}return{pages:i,hasShowRule:t}}});SM.PageNavView=SM.Views.register({__NAME:"pageNavView",__model:"survey",__templateID:"page-nav-container-template",__init:function(){this.survey.on("shownListsChanged",{self:this},this._onShownListChange)},__destroy:function(){this.survey.off("shownListsChanged",this._onShownListChange)},__beforeRender:function(){return{pageCount:this.survey.pageCount}},__afterRender:function(e){var t,i;if(e.pageCount>1){i=SM.Views.create(SM.PageMenuBtnView,{model:this.survey});t=SM.Views.create(SM.PageArrowBtnsView,{model:this.survey});this.el.appendChild(t.el);this.el.appendChild(i.el)}},_onShownListChange:function(e){var t=e.data.self;t.render()}});SM.ContentNavView=SM.Views.register({__NAME:"contentNavView",__model:"survey",__templateID:"content-nav-view-template",__init:function(){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountUpdate);this.bindModel(this.survey.anviews,"selectedViewLoaded",{self:this},this._onSelectedViewLoaded);this.bindModel(this.survey,"shownListsChanged",{self:this},this._onShownListChange)},__beforeRender:function(){var e=this.survey.pageCount,t=this.survey.state.isBrowseMode(),i=this.survey.respondentCounts.total_context>1,s=this.survey.respondentCounts.total_context===1,n=t&&i,r=this.survey.shownQuestionList.length>0,a=this.survey.shownPageList.length>0,o=(i||s)&&e>1&&r&&a;return{hasPageNav:o,hasRespondentNav:n,isHidden:!o&&!n}},__afterRender:function(e){var t,i;if(!e.isHidden){if(e.hasPageNav){t=SM.Views.create(SM.PageNavView,{model:this.survey});this.el.appendChild(t.el)}if(e.hasRespondentNav){i=SM.Views.create(SM.RespondentNavView,{model:this.survey});this.el.appendChild(i.el)}}},_onCountUpdate:function(e){var t=e.data.self;t.render()},_onShownListChange:function(e){var t=e.data.self;t.render()},_onSelectedViewLoaded:function(e){var t=e.data.self;t.render()}});SM.StatsHeaderView=SM.Views.register({__NAME:"statsHeaderView",__templateID:"analyze-stats-header-template",__model:"survey",__init:function(e){this.bindModel(this.survey,"respondentCounts.changed",{self:this},this._onCountChange)},__beforeRender:function(e){var t=this.survey.respondentCounts,i=this.survey.isFiltered(),s=this.survey.anviews.currentView,n=s.hasCompareRule(),r=s.hasFilterRule(),a=n&&r;return{totalContext:Globalize.format(t.total_context,"n0"),isFiltered:i,compareRule:n,filterRule:r,hasBoth:a,failedCount:t.failed,total:Globalize.format(t.total,"n0"),encryptedID:this.survey.encryptedID}},__afterRender:function(){var e=this.$el.find("[global-share-menu]");if(this._shouldShowShareBtn()){e.append(SM.Views.create(SM.ShareAllBtnView,{survey:this.survey,noBorder:true}).el)}if(this._shouldShowExportBtn()){e.append(SM.Views.create(SM.ExportAllBtnView,{model:this.survey,noBorder:true,buttonName:"ExportStatsHeaderButton"}).el)}},_onCountChange:function(e){var t=e.data.self;t.render()},_shouldShowShareBtn:function(){return SM.App.isSharingEnabled()},_shouldShowExportBtn:function(){return this.survey.isExportEnabled()},_shouldShowMerveysBtn:function(){return this.survey.isMergedSurvey}});SM.QuotasHeaderView=SM.Views.register({__NAME:"quotasHeaderView",__templateID:"analyze-quotas-header-template",__model:"quotas",__init:function(e){var t=this;this.$el.accordion();this.$el.on({"accordion.beforeOpen":function(e){t.$el.find("#progress-bar-main").hide();t.$el.find(".q").show()},"accordion.afterClose":function(e){t.$el.find(".q").hide();t.$el.find("#progress-bar-main").show()}})},__beforeRender:function(e){this.quotaList=SM.Models.create("QuotaList",{quota_data:e});return{totalContext:Globalize.format(this.quotaList.totalContext,"n0"),total:Globalize.format(this.quotaList.total,"n0"),totalPercent:Globalize.formatPercent(this.quotaList.percent,0),numQuotas:Globalize.format(this.quotaList.numQuotas,"n0")}},__afterRender:function(){var e=this;this.$el.find(".accordion").accordion();this.$el.find(".q").popout();this.$el.find(".q").hide();this.$el.find(".progress-bar").css("width",this.quotaList.percent*100+"%");var t=SM.Views.create(SM.QuotaListView,{model:e.quotaList});if(this.quotaList.percent===1){var i="#A7C23D";this.$el.find(".progress-bar").css("background-color",i)}var s=this.$el.find("#QuotasViewContainer");s.append(t.$el)}});SM.QuotaView=SM.Views.register({__NAME:"quotaView",__templateID:"analyze-quotas-template",__model:"quota",__init:function(e){var t=this},__beforeRender:function(e){this.quota_data=e.model;return{totalContext:Globalize.format(this.quota_data.totalContext,"n0"),total:Globalize.format(this.quota_data.total,"n0"),percent:Globalize.formatPercent(this.quota_data.percent,0),quota_name:this.quota_data.label}},__afterRender:function(){this.$el.find(".progress-bar").css("width",Globalize.formatPercent(this.quota_data.percent,2));if(this.quota_data.percent==1){var e="#A7C23D";this.$el.find(".progress-bar").css("background-color",e)}}});SM.QuotaListView=SM.Views.register({__NAME:"quotaListView",__templateID:"analyze-quotas-list-template",__model:"quotaList",__init:function(e){var t=this},__afterRender:function(){var e=this.$el;$.each(this.quotaList.quota_list,function(t,i){var s=SM.Views.create(SM.QuotaView,{model:i});e.append(s.$el)})}});SM.ModeTabsView=SM.Views.register({__NAME:"modeTabsView",__templateID:"analyze-mode-tabs-template",__model:"survey",__beforeRender:function(){return{isSummaryMode:this.survey.state.isSummaryMode(),isBrowseMode:this.survey.state.isBrowseMode(),isTrendMode:this.survey.state.isTrendMode(),displayBrowseTab:this._displayBrowseTab(),displayTrendTab:this._displayTrendsTab(),summaryTabURL:this._summaryTabURL(),browseTabURL:this._browseTabURL(),trendsTabURL:this._trendsTabURL(),isDebug:SM.DEBUG}},__afterRender:function(){var e=this.$el.find("[sm-tab-text]");e.each(function(e,t){var i=$(t),s=i.text(),n="",r=s.match(/[^\s]+/g);$.each(r,function(e,t){n+=t;if(e===r.length-1){return false}if(r[e+1].length<=3){n+=" "}else{n+="<br/>"}});i.html(n)})},__init:function(){this.$el.on(SM.Event.CLICK,"#mode_tab_trends",{self:this},this._onTrendsTabClick)},_onTrendsTabClick:function(e){var t=e.data.self,i;if(!t.survey.owner.hasTrends()){e.preventDefault();i=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"trends-upgrade-dialog-template"});i.open()}},_displayBrowseTab:function(){if(SM.App.isSharingApp()){return SM.App.sharedView.isBrowseTabEnabled()}else{return SM.DISPLAY_BROWSE_TAB}},_displayTrendsTab:function(){if(SM.App.isSharingApp()){return SM.App.sharedView.isTrendsTabEnabled()}else{return SM.DISPLAY_TREND_TAB}},_buildTabURL:function(e){var t=new Uri(e);return t.toString()},_summaryTabURL:function(){var e;if(SM.App.isSharingApp()){e=SM.App.sharedView.sharedPagePath()}else{e="/analyze/"+this.survey.encryptedID}return this._buildTabURL(e)},_browseTabURL:function(){var e;if(SM.App.isSharingApp()){e=SM.App.sharedView.sharedPagePath()+"browse/"}else{e="/analyze/browse/"+this.survey.encryptedID}return this._buildTabURL(e)},_trendsTabURL:function(){var e;if(SM.App.isSharingApp()){e=SM.App.sharedView.sharedPagePath()+"data-trends/"}else{e="/analyze/data-trends/"+this.survey.encryptedID}return this._buildTabURL(e)}});SM.AnalyzeHeaderView=SM.Views.register({__NAME:"AnalyzeHeaderView",__model:"survey",__templateID:"analyze-header-container-template",__afterRender:function(){this._renderStatsHeaderView();if(this._shouldRenderQuotasHeaderView()){this._renderQuotasHeaderView()}this._renderModeTabsView()},_renderStatsHeaderView:function(){var e=SM.Views.create(SM.StatsHeaderView,{model:this.survey});this.el.appendChild(e.el)},_renderQuotasHeaderView:function(){var e=SM.Views.create(SM.QuotasHeaderView,{model:this.survey.quotas});this.el.appendChild(e.el)},_renderModeTabsView:function(){var e=SM.Views.create(SM.ModeTabsView,{model:this.survey});this.el.appendChild(e.el)},_shouldRenderQuotasHeaderView:function(){return this.survey.quotas&&!!this.survey.quotas.equations}});SM.AnalyzeMainView=SM.Views.register({__NAME:"analyzeMainView",__model:"survey",__templateID:"analyze-main-column-template",__create:function(e){this.userIsOverResponseLimit=this.survey.owner.isOverResponseLimit(this.survey.respondentCounts.total)},__beforeRender:function(){return{isOverResponseLimit:this.userIsOverResponseLimit}},__afterRender:function(){if(this._shouldRenderResponseLimitUpgradeView()){this._renderResponseLimitUpgradeView()}if(this._shouldRenderProfilerDriverView()){this._renderProfilerDriverView()}this._renderAnalyzeHeaderView();this._renderContentNavView();this._renderAnalyzeContentWrapperView();if(this.survey.state.isSummaryMode()&&!SM.App.isSharingApp()){this.survey.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_LOADED,{self:this},this._onDataSegmentLoaded)}},_renderAnalyzeHeaderView:function(){var e=SM.Views.create(SM.AnalyzeHeaderView,{model:this.survey});this.el.appendChild(e.el)},_renderContentNavView:function(){var e=SM.Views.create(SM.ContentNavView,{model:this.survey});this.el.appendChild(e.el)},_renderAnalyzeContentWrapperView:function(){var e=SM.Views.create(SM.AnalyzeContentWrapperView,{model:this.survey});this.el.appendChild(e.el)},_renderResponseLimitUpgradeView:function(){var e=SM.Views.create(SM.ResponseLimitUpgradeView,{model:this.survey,classes:"sm-corner-a spacer-mbl",linkSource:"wall_responselimit&ut_source2=new_analyze"});this.el.appendChild(e.el)},_renderProfilerDriverView:function(){var e=SM.Views.create(SM.ProfilerDriverView,{model:this.survey});this.el.appendChild(e.el)},_onDataSegmentLoaded:function(e){var t=e.data.self;t.$el.find(".profiler-driver-ctnr").hide()},_shouldRenderResponseLimitUpgradeView:function(){if(SM.App.isSharingApp()){return false}else{return this.userIsOverResponseLimit}},_shouldRenderProfilerDriverView:function(){if(!this.survey.state.isSummaryMode()||SM.App.isSharingApp()){return false}return this.survey.isProfilerDriverEnabled()}});SM.FunctionListItemSaveView=SM.Views.register({__NAME:"FunctionListItem.SaveView",__templateID:"functionlist-save-template",__defaults:{visible:false,hasSaveBtn:true},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit).on(SM.Event.CLICK,"[view-save-btn]",{self:this},this._publishSave).on(SM.Event.CLICK,"[view-revert-btn]",{self:this},this._publishRevert)},_onFormSubmit:function(e){var t=e.data.self;e.preventDefault();t.$el.find("[view-save-btn]").click()},_publishSave:function(e){var t=e.data.self;e.preventDefault();t.trigger("saveClicked");t.__settings.visible=false;t.render()},_publishRevert:function(e){var t=e.data.self;e.preventDefault();t.trigger("revertClicked");t.__settings.visible=false;t.render()}});SM.FunctionListItemDeleteView=SM.Views.register({__NAME:"FunctionListItem.DeleteView",__templateID:"functionlist-delete-template",__defaults:{visible:false,hasCancel:true},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit);this.$el.on(SM.Event.CLICK,"[view-delete-btn]",{self:this},this._publishDelete);this.$el.on(SM.Event.CLICK,"[view-delete-cancel-btn]",{self:this},this._publishCancel)},__beforeRender:function(){return{visible:this.__settings.visible,hasCancel:this.__settings.hasCancel}},__afterRender:function(e){if(this.__settings.visible){this.$el.removeClass("hide")}},open:function(){this.__settings.visible=true;this.render();this.$el.find("[view-delete-btn]").focus()},close:function(){this.__settings.visible=false;this.render()},_publishDelete:function(e){var t=e.data.self;e.preventDefault();t.close();t.trigger("deleteClicked")},_onFormSubmit:function(e){var t=e.data.self;e.preventDefault();t.$el.find("[view-delete-btn]").click()},_publishCancel:function(e){var t=e.data.self;t.close();t.trigger("cancelClicked")}});SM.FunctionListItemRenameView=SM.Views.register({__NAME:"FunctionListItem.RenameView",__templateID:"functionlist-rename-template",__defaults:{placeholder:"",visible:false},__init:function(){this.$el.on("submit","form",{self:this},this._onFormSubmit).on(SM.Event.CLICK,"[rename-save-btn]",{self:this},this._publishRename).on(SM.Event.CLICK,"[rename-cancel-btn]",{self:this},this._publishCancel).on(SM.Event.KEYUP,"[rename-text]",{self:this},this._onRename)},__beforeRender:function(){return{placeholder:this.__settings.placeholder,visible:this.__settings.visible}},__afterRender:function(e){if(this.__settings.visible){this.$el.removeClass("hide")}this.$el.find("[rename-text]").select().focus()},_onFormSubmit:function(e){var t=e.data.self;e.preventDefault();t.$el.find("[rename-save-btn]").click()},_publishRename:function(e){var t=e.data.self,i;e.preventDefault();i=$.trim(t.$el.find("[rename-text]").val());if(i.length>0){t.trigger({type:"Renamed",newName:i});t.close()}},_publishCancel:function(e){var t=e.data.self;t.trigger("Canceled");t.close()},open:function(){this.__settings.visible=true;this.render()},close:function(){this.__settings.visible=false;this.render()},_onRename:function(e){var t=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){t._publishCancel(e);e.preventDefault()}}});SM.AnViewListView=SM.Views.register({__NAME:"AnViewList",__model:"anviews",__templateID:"anview-list-template",__init:function(){this.anviews.on("viewAdded",{self:this},this._onViewCreate)},__destroy:function(){this.anviews.off("viewAdded",this._onViewCreate)},__afterRender:function(e){this._cacheElements();var t=this.anviews.viewList.length,i,s=this.$viewList.get(0),n=this.anviews.get("selectedViewID"),r,a=0;i=this.anviews.defaultView;r=i.ID===n;s.appendChild(SM.Views.create(SM.AnView,{model:i,isSelected:r,isSelectable:!r,isBasicUser:this.anviews.survey.owner.isBasic()}).el);for(;a<t;a++){i=this.anviews.viewList[a];if(!i.isDefault){r=i.ID===n;this.$viewList.get(0).appendChild(SM.Views.create(SM.AnView,{model:i,isSelected:r,isSelectable:!r,isBasicUser:this.anviews.survey.owner.isBasic()}).el)}}this.saveAsView=SM.Views.create(SM.AnViewSaveAsView,{model:this.anviews.survey,disabled:!this.anviews.currentView.get("isDirty"),buttonName:"saveAsButton"});this.el.appendChild(this.saveAsView.el);this.$saveAsBtn=this.$el.find(".saveas-btn")},_onViewCreate:function(e){var t=e.data.self;SM.Bi.anViewCreate(e.anViewModel);t.$viewList.get(0).appendChild(SM.Views.create(SM.AnView,{model:e.anViewModel,showMenu:false,isSelected:false,isLoading:true,isDisabled:true,isSelectable:false,isBasicUser:t.anviews.survey.owner.isBasic()}).el)},_cacheElements:function(){this.$viewList=this.$el.find("ul.view-item-list");return this}});SM.BaseAccordionHeadingView={__NAME:"AccordionHeadingView",__templateID:"accordion-heading-view",__defaults:{number:0,isOpen:false,title:null,isLoading:false},__setters:{isOpen:function(e,t){e.__settings.isOpen=t}}};SM.ExportHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"exportJobs",_title:"Exports",__init:function(e){this.bindModel(this.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoadedChanged);this.bindModel(this.exportJobs.poller,"isActive.changed",{self:this},this._onPollerActiveChanged);this.bindModel(this.exportJobs,"jobAdded",{self:this},this._onJobAdded);this.bindModel(this.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobDeleted",{self:this},this._onJobDeleted)},__setters:{isOpen:function(e,t){e.__settings.isOpen=t;if(t===true&&!e.exportJobs.get("isLoaded")){e.exportJobs.fetchJobs()}}},__beforeRender:function(e){var t=!this.__settings.isOpen&&this.exportJobs.poller.get("isActive");return{isOpen:this.__settings.isOpen,isLoading:t,title:Globalize.localize(this._title),number:this.exportJobs.list?this.exportJobs.list.length:null}},_onJobAdded:function(e){var t=e.data.self;t.$el.closest(".accordion").data("accordion").open("ExportListContainer");t.__settings.isOpen=true},_onJobDeleted:function(e){e.data.self.render()},_onExportJobsLoadedChanged:function(e){e.data.self.render()},_onPollerActiveChanged:function(e){e.data.self.render()}});SM.SavedViewsHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"anviews",__init:function(){this.bindModel(this.anviews,"sizeChanged",{self:this},this._onSizeChanged)},__beforeRender:function(e){return{isLoading:this.__settings.isLoading,title:Globalize.localize("Saved Views"),number:this.anviews.viewList.length}},_onSizeChanged:function(e){e.data.self.render()}});SM.BenchmarkingHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"benchmarkRollups",__init:function(){this.bindModel(this.benchmarkRollups,"sizeChanged",{self:this},this._onSizeChanged)},__beforeRender:function(e){return{isLoading:this.__settings.isLoading,title:Globalize.localize("Benchmarking")}},_onSizeChanged:function(e){e.data.self.render()}});SM.AnViewSaveAsView=SM.Views.register({__NAME:"AnViewSaveAsView",__model:"survey",__templateID:"viewlist-saveas-template",__defaults:{isOpen:false,warn:false,disabled:true},__init:function(){this.bindModel(this.survey.anviews.currentView,"isDirty.changed",{self:this},this._onIsDirtyChanged);this.bindModel(this.survey.anviews,"nextSelectedViewID.changed",{self:this},this._onNextViewIDChanged);this.$el.on(SM.Event.CLICK,"[saveas-btn]",{self:this},this._onSaveAsBtnClick).on("submit","form",{self:this},this._onSubmit).on(SM.Event.CLICK,"[save-new-btn]",{self:this},this._onSaveNewBtnClick).on(SM.Event.CLICK,"[cancel-btn]",{self:this},this._onCancelSaveAs).on(SM.Event.KEYUP,"input[type='text']",{self:this},this._onNameKeyup)},__beforeRender:function(e){var t=this.survey,i=t.getSelectedView();e={isOpen:this.__settings.isOpen,disabled:this.__settings.disabled,warn:this.__settings.warn,isBasic:t.owner.isBasic(),viewName:i.isDefault?Globalize.localize("Saved View"):i.name+", "+Globalize.format(new Date,"D")};return e},__afterRender:function(e){if(this.__settings.isOpen){this.$newName=this.$el.find("input");this.$newName.focus();this.$newName.select()}},_onNextViewIDChanged:function(e){var t=e.data.self,i=e.value,s=t.survey.getSelectedView().ID===t.survey.anviews.defaultView.ID;if(s&&i!==null){t.__settings.warn=true;t.render()}},_onSaveAsBtnClick:function(e){var t=e.data.self,i;e.preventDefault();if(t.survey.owner.isBasic()){i=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});i.open()}else if(!t.__settings.disabled){t.__settings.isOpen=true;t.render()}},_onNameKeyup:function(e){var t=e.data.self;if(e.which===SM.KeyCodes.ESCAPE){e.preventDefault();t.$el.find("[cancel-btn]").click()}},_onSubmit:function(e){var t=e.data.self;e.preventDefault();t.$el.find("[save-new-btn]").click()},_onSaveNewBtnClick:function(e){var t=e.data.self,i;SM.Bi.uiTrigger=t.__settings.buttonName;e.preventDefault();i=$.trim(t.$newName.val());if(i.length===0){return}t.survey.anviews.saveCurrentViewAs(i);t.__settings.isOpen=false;t.__settings.warn=false;t.__settings.disabled=true;t.render()},_onCancelSaveAs:function(e){var t=e.data.self;t.survey.anviews.set("nextSelectedViewID",null);t.__settings.isOpen=false;t.__settings.warn=false;t.render()},_onIsDirtyChanged:function(e){var t=e.data.self,i=e.value;if(i){t.__settings.disabled=false}else{t.__settings.disabled=true;t.__settings.isOpen=false;t.__settings.warn=false}t.render()}});SM.AnView=SM.Views.register({__model:"anViewModel",__NAME:"AnView",__templateID:"anview-item-template",__defaults:{isLoading:false,isSelected:false,isDirty:false,isBasicUser:true,isDisabled:false,isSelectable:true,deleteMode:false,renameMode:false},__init:function(){var e=this,t=this.anViewModel;this.bindModel(t,"isLoaded.set",{self:this},this._onLoadedSet);this.bindModel(t,"selected.changed",{self:this},this._onSelectedChange);this.bindModel(t,"isDirty.changed",{self:this},this._onIsDirtyChanged);this.bindModel(t,"copySuccess",{self:this},this._onViewReady);this.bindModel(t,"createSuccess",{self:this},this._onViewReady);this.bindModel(t,"loadFailed.set",{self:this},this._onLoadFail);this.bindModel(t.anviews,"nextSelectedViewID.changed",{self:this},this._onNextViewIDChanged);this.bindModel(t.anviews.currentView,"isSaving.changed",{self:this},this._onCurrentViewSavingChanged);this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onSelect);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.RenameView.Renamed":function(t){SM.Bi.uiTrigger="renameViewItemMenu";SM.Bi.anViewRename(e.anViewModel);e.__settings.renameMode=false;e.__settings.isSelectable=!e.__settings.isSelected;e.anViewModel.name=t.newName;e.anViewModel.save();e.render()},"FunctionListItem.DeleteView.deleteClicked":function(t){SM.Bi.uiTrigger="deleteViewItemMenu";SM.Bi.anViewDelete(e.anViewModel);e.anViewModel.anviews.deleteView(e.anViewModel);e.$el.remove()},"FunctionListItem.RenameView.Canceled":function(t){e.__settings.isSelectable=!e.__settings.isSelected;e.__settings.renameMode=false;e.render()},"FunctionListItem.DeleteView.cancelClicked":function(t){e.__settings.isSelectable=!e.__settings.isSelected;e.__settings.deleteMode=false;e.render()},"FunctionListItem.SaveView.saveClicked":function(t){SM.Bi.uiTrigger="saveViewItemButton";SM.Bi.anViewSave(e.anViewModel.anviews.getSelectedView());e.anViewModel.anviews.currentView.commitChanges()},"FunctionListItem.SaveView.revertClicked":function(t){SM.Bi.uiTrigger="revertViewItemButton";SM.Bi.anViewRevert(e.anViewModel);e.anViewModel.anviews.currentView.revert()}},{self:this})},__beforeRender:function(e){var t=this.__settings.isDisabled||!this.anViewModel.isDefault&&this.__settings.isBasicUser,i=this.anViewModel.isDefault,s=this.anViewModel.get("isDirty"),n=s||this.__settings.isLoading||this.__settings.renameMode||this.__settings.deleteMode||!this.anViewModel.anviews.survey.isExportEnabled()&&i||this.anViewModel.get("loadFailed");this.__settings.isSelectable=!t&&this.__settings.isSelectable;return{name:this.anViewModel.name,isDefault:i,isLoading:this.__settings.isLoading,isSelected:this.__settings.isSelected,isSelectable:this.__settings.isSelectable,deleteMode:this.__settings.deleteMode,showMenu:!n,isDisabled:t,renameMode:this.__settings.renameMode&&!s,isDirty:s,loadFailed:this.anViewModel.get("loadFailed")}},__afterRender:function(e){var t=this.$el.children(".list-item"),i=null;if(e.showMenu){this.$el.find("a.btn-menu-down").actionMenu({menuView:"AnViewMenuView",isDefault:this.anViewModel.isDefault,isBasic:this.__settings.isBasicUser,exportsEnabled:this.anViewModel.anviews.survey.isExportEnabled(),sharingEnabled:SM.App.isSharingEnabled()})}else{if(this.__settings.renameMode){i=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:e.name});i.open()}else if(this.__settings.deleteMode){i=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true})}else if(this.anViewModel.get("isDirty")){i=SM.Views.create(SM.FunctionListItemSaveView,{visible:true,warn:this.anViewModel.anviews.get("nextSelectedViewID"),hasSaveBtn:!this.anViewModel.isDefault});this.saveView=i}if(i){t.prepend(i.el)}}},_onIsDirtyChanged:function(e){var t=e.data.self;t.render()},_onNextViewIDChanged:function(e){var t=e.data.self,i=e.viewID;if(t.anViewModel===t.anViewModel.anviews.getSelectedView()){t.render()}},_onSelectedChange:function(e){var t=e.data.self,i=t.anViewModel.get("selected");t.__settings.isSelected=i;t.__settings.isLoading=i;t.__settings.isSelectable=!i;t.render()},_onLoadedSet:function(e){var t=e.data.self;if(t.anViewModel.get("isLoaded")){t.__settings.isLoading=false;t.render()}},_onCurrentViewSavingChanged:function(e){var t=e.data.self;t.__settings.isSelectable=!e.value},_onViewReady:function(e){var t=e.data.self,i=t.anViewModel.ID===t.anViewModel.anviews.get("selectedViewID");t.__settings.isLoading=false;t.__settings.isDisabled=false;t.__settings.isSelectable=!i;t.render()},_onSelect:function(e){var t=e.data.self,i=t.anViewModel.anviews,s=t.anViewModel.anviews.survey,n;e.preventDefault();SM.Bi.anViewSelect(t.anViewModel);if(t.__settings.isSelectable){
i.set("selectedViewID",t.anViewModel.ID)}else if(s.owner.isBasic()){n=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});n.open()}},_onCurrentReset:function(e){var t=e.data.AnView;if(t.anViewModel.isDefault){t.__settings.isSelected=true;t.__settings.isLoading=true;t.render()}else if(t.__settings.isSelected){t.__settings.isSelected=false;t.render()}},_onLoadFail:function(e){e.data.self.render()},_onMenuAction:function(e){var t=e.data.self;t[e.action]()},_menuRenameClick:function(){this.__settings.isSelectable=false;this.__settings.renameMode=true;this.render()},_menuCopyClick:function(){SM.Bi.uiTrigger="copyViewItemMenu";this.anViewModel.anviews.copyView(this.anViewModel);this.render()},_menuUpgradeClick:function(){var e=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"saved-views-upgrade-dialog-template"});e.open()},_menuShareClick:function(){SM.Bi.uiTrigger="shareViewItemMenu";SM.AnalyzeApp.SharedViewsRouter.newSharedView({view:this.anViewModel})},_menuExportClick:function(){var e=this,t=this.anViewModel.anviews.survey,i;if(t.owner.isBasic()){i=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"export-upgrade-dialog-template"});i.open()}else{if(t.owner.get("hipaaEnabled")){i=SM.Views.create(SM.HipaaExportWarningView,{model:t,jobType:"export",onContinueClick:function(){e._createExportDialog(t)}});i.open()}else{e._createExportDialog(t)}}},_createExportDialog:function(e){var t,i;t=e.exportJobs.createJob({email:e.currentUserEmail,export_type:"summary",export_data:{respondent_id:"all"}});t.sourceView=this.anViewModel;i=SM.Views.create(SM.ExportDialogView,{model:t,viewSelectMode:this.anViewModel.isCurrent});e.exportJobs.fetchJobs();i.open()},_menuDeleteClick:function(){this.__settings.isSelectable=false;this.__settings.deleteMode=true;this.render()}});SM.AnViewMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"AnViewMenuView",__templateID:"anview-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.ExportAllBtnView=SM.Views.register({__NAME:"ExportAllBtnView",__model:"survey",__templateID:"export-all-btn-view-template",__init:function(){this.$el.actionMenu({menuView:"ExportAllMenuView",exportEnabled:this.survey.owner.hasExports(),singleMode:this.__settings.singleMode,disallowResponses:this.__settings.disallowResponses,hasChartView:this.__settings.hasChartView}).on("actionMenu.actionSelected",{self:this},this._onMenuAction).on("click",{self:this},function(e){var t=e.data.self;SM.Bi.uiTrigger=t.__settings.buttonName});if(this.survey.anviews.currentView.hasCompareRule()&&this.survey.anviews.currentView.compareRule.isRA){this._disableDotNETExports()}else if(this.survey.anviews.currentView.hasFilterRule()&&this.survey.anviews.currentView.hasRAFilterSelected()){this._disableDotNETExports()}else{this._enableDotNETExports()}this.question=this.__settings.question},__beforeRender:function(){return{noBorder:this.__settings.noBorder,singleMode:this.__settings.singleMode,disallowResponses:this.__settings.disallowResponses}},__afterRender:function(e){this.$el.find(".q").popout()},_disableDotNETExports:function(){var e=this;e.survey.config.export_formats_enabled.full.excel=false;e.survey.config.export_formats_enabled.full.excel_plus=false;e.survey.config.export_formats_enabled.full.spss=false;e.survey.config.export_formats_enabled.full.gss=false;e.survey.config.export_formats_enabled.summary.excel=false;e.survey.config.export_formats_enabled.summary.csv=false},_enableDotNETExports:function(){var e=this;e.survey.config.export_formats_enabled.full.excel=e.survey.config.export_formats_enabled_server_side.full.excel;e.survey.config.export_formats_enabled.full.excel_plus=e.survey.config.export_formats_enabled_server_side.full.excel_plus;e.survey.config.export_formats_enabled.full.spss=e.survey.config.export_formats_enabled_server_side.full.spss;e.survey.config.export_formats_enabled.full.gss=e.survey.config.export_formats_enabled_server_side.full.gss;e.survey.config.export_formats_enabled.summary.excel=e.survey.config.export_formats_enabled_server_side.summary.excel;e.survey.config.export_formats_enabled.summary.csv=e.survey.config.export_formats_enabled_server_side.summary.csv},_onMenuAction:function(e){var t,i=e.data.self,s=e.action,n=i.survey,r=s==="individual";if(s==="individual"){s="full"}if(n.owner.isBasic()){var a="export-upgrade-dialog-template";if(i.__settings.singleMode){switch(s){case"summary":a="export-single-upgrade-dialog-template";break;case"chart":a="export-chart-upgrade-dialog-template";break}}t=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:a});t.open()}else{if(n.owner.get("hipaaEnabled")){t=SM.Views.create(SM.HipaaExportWarningView,{model:n,jobType:"export",onContinueClick:function(){i._createExportDialog(n,s,r)}});t.open()}else{i._createExportDialog(n,s,r)}}},_createExportDialog:function(e,t,i){var s,n,r,a=e.anviews.currentView;n={email:e.currentUserEmail,export_type:t,export_data:{respondent_id:"all"}};if(this.question!==undefined){n.export_data.question_id=this.question.ID;n.questionNumber=this.question.position;if(t==="chart"){n.format="png"}}r=e.exportJobs.createJob(n);r.sourceView=a;s=SM.Views.create(SM.ExportDialogView,{model:r,viewSelectMode:true,disallowResponses:this.__settings.disallowResponses,individualResponseMode:i,hasChartView:this.__settings.hasChartView,question:this.question});e.exportJobs.fetchJobs();s.open()}});SM.NewExportBtnView=SM.Views.extend(SM.ExportAllBtnView,{__NAME:"NewExportBtnView",__templateID:"new-export-btn-view-template"});SM.ExportAllMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"ExportAllMenuView",__templateID:"export-all-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.ExportJobListView=SM.Views.register({__NAME:"ExportJobListView",__model:"exportJobs",__templateID:"export-job-list-template",__init:function(){var e=this;this.$el.on(SM.Event.CLICK,".upgrade-message a[learn-more]",function(e){e.preventDefault();var t=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"export-upgrade-dialog-template"});t.open()});this.bindModel(this.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);this.bindModel(this.exportJobs,"jobAdded",{self:this},this._onJobAdded);this.bindModel(this.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoaded);this.bindModel(this.exportJobs,"isUnavailable.set",{self:this},this._onExportJobsUnavailable);this.bindModel(this.exportJobs,"clickedExportPreferenceUpgradeTrigger",{self:this},this._exportPreferenceUpgradeTrigger)},__beforeRender:function(){return{isLoaded:this.exportJobs.get("isLoaded"),exportsIsUnavailable:this.exportJobs.isUnavailable,upgradeRequired:this.exportJobs.survey.owner.isBasic()}},__afterRender:function(e){var t=this,i=this.exportJobs.survey.owner,s=this.$el.children(".exported-jobs-list"),n=[],r,a;if(i.isBasic()){this.el.appendChild(SM.Template.renderHTML("export-upgrade-message-template"));return}if(this.exportJobs.get("isLoaded")){if(this.exportJobs.list.length===0){r=SM.Views.create(SM.ExportNullStateView,{model:this.exportJobs.survey});s.append(r.$el)}else{$.each(this.exportJobs.list,function(e,t){if(t&&t.exportData){r=SM.Views.create(SM.ExportJobView,{model:t,upgradeRequired:i.isBasic()});s.append(r.$el)}else if(t){SM.log("Removing export that wasn't deleted properly type: "+t.type+"Job format: "+t.format);this.exportJobs.deleteJob(t)}});this.$el.find("[export-btn]").append(SM.Views.create(SM.NewExportBtnView,{model:this.exportJobs.survey,noBorder:true,buttonName:"ExportAccordionButton"}).el)}}else if(this.exportJobs.isUnavailable){a=SM.Template.render("exports-unavailable-template",{requestID:this.exportJobs.unavailableErrorID});this.$el.html(a)}},_onExportJobsUnavailable:function(e){if(e.value){e.data.self.render()}},_onExportDialogOpen:function(e){var t=e.data.ExportJobListView,i=SM.Views.create(SM.ExportDialogView,{model:e.exportJob,viewModel:e.view||t.exportJobs.survey.anviews.currentView,viewSelectMode:!e.view,tab:e.exportType||"summary"});i.open()},_onJobAdded:function(e){var t=e.data.self;t.render()},_onJobDeleted:function(e){var t=e.job,i=e.data.self,s=i.exportJobs.survey.owner.hasExports();if(i.exportJobs.list.length===0&&s){i.render()}},_onExportJobsLoaded:function(e){e.data.self.render()},_exportPreferenceUpgradeTrigger:function(e){var t=e.data.self,i=e.upgradeTemplate,s;s=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:i});s.open()}});SM.ExportJobView=SM.Views.register({__NAME:"ExportJobView",__model:"exportJob",__templateID:"export-job-template",__defaults:{detailsOn:false,renameMode:false,upgradeRequired:true},__init:function(){var e=this;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onSelect);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.DeleteView.deleteClicked":function(t){if(e.exportJob.isNew()){e.exportJob.exportJobs.cancelJob(e.exportJob)}else{e.exportJob.exportJobs.deleteJob(e.exportJob)}},"FunctionListItem.DeleteView.cancelClicked":function(t){e.__settings.deleteMode=false;e.render()}},{self:this});this.bindModel(this.exportJob,"deleted",{self:this},this._onDelete);this.bindModel(this.exportJob,"isCancelled.changed",{self:this},this._onDelete);this.bindModel(this.exportJob,"status.changed",{self:this},this._onStatusChanged)},_readableFormat:{excel:"xls",pdf:"pdf",html:"html",spss:"spss",excel_plus:"xls+",csv:"csv",ppt:"ppt",png:"png",gss:"drive"},_readableFormatDesc:{excel:"XLS",pdf:"PDF",html:"HTML",spss:"SPSS",excel_plus:"XLS+",csv:"CSV",ppt:"PPT",png:"PNG",gss:"Google Sheet"},__beforeRender:function(e){var t=this.exportJob,i=this._shortenDisplayName(t.jobInfo.view_name)||"",s=this._shortenDisplayName(t.name),n=t.type==="full",r=this._readableFormat[t.format],a=this._readableFormatDesc[t.format],o=this.__settings.upgradeRequired,l=t.type==="chart",u=l||n&&t.format!=="pdf",d,h;d=t.jobInfo.pages;h=t.jobInfo.questions;return{job:t,jobName:s,pages:d,questions:h,jobFormat:r,jobFormatDesc:a,fullExport:n,createDate:t.toDateString(t.createDate),endDate:t.toDateString(t.expirationDate),jobFailed:t.failed(),detailsOn:this.__settings.detailsOn,inProgress:t.pending(),viewName:i,upgradeRequired:this.__settings.upgradeRequired,summaryMode:u,deleteMode:this.__settings.deleteMode,chartMode:l,singleMode:t.get("isSingleQuestionMode"),questionNumber:t.exportData.questionNumber}},__afterRender:function(e){var t,i=this.$el.find(".list-item");if(this.__settings.deleteMode){t=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});i.prepend(t.$el)}else{this.$el.find("a.btn-menu-down").actionMenu({menuView:"ExportJobMenuView",detailsOn:e.detailsOn,isDisabled:this.__settings.isDisabled,jobFailed:e.jobFailed,job:e.job})}},_onStatusChanged:function(e){var t=e.data.self,i=t.exportJob.NOTIFICATION_MESSAGES,s,n;if(t.exportJob.done()){n=i[t.exportJob.status];message=t.exportJob.isDrive()?"A link to Google Drive will appear under EXPORTS for 14 days.":"Export files will appear under EXPORTS for 14 days.";s=SM.Notifications.success({title:Globalize.localize(n),message:Globalize.localize(message),duration:2e4,classes:"export-job-success-notification",tabMessage:Globalize.localize("Export complete"),content:SM.Template.render("export-job-notification-download-link-template",{job:t.exportJob})});s.$el.on("click",".download-btn",function(e){var t=$(e.target).attr("link");var i=$(e.target).attr("target");e.preventDefault();if(i=="_blank"){window.open(t)}else{window.location=t}s.close()})}else if(t.exportJob.failed()){n=i[t.exportJob.status];s=SM.Notifications.error({title:Globalize.localize(n),classes:"export-job-failed-notification",tabMessage:Globalize.localize("Export failed"),content:SM.Template.render("export-job-notification-error-message-template",{job:t.exportJob,exportTooLarge:t.exportJob.get("status")===t.exportJob.STATUS.TOO_LARGE_ERROR}),duration:1e4})}e.data.self.render()},_onSelect:function(e){var t=e.data.self,i=t.exportJob;e.preventDefault();if(!t.__settings.deleteMode){if(i.done()){if(t.exportJob.isDrive()){window.open(i.downloadLink)}else{window.location=i.downloadLink}}else{t._menuDetailsClick()}}},_onDelete:function(e){var t=e.data.self;t.$el.remove()},_onMenuAction:function(e){var t=e.data.self;t[e.action]()},_menuDetailsClick:function(){this.__settings.detailsOn=!this.__settings.detailsOn;this.render()},_menuDownloadClick:function(){},_menuDisabledDownloadClick:function(){},_menuRetryClick:function(){},_menuDeleteClick:function(){this.__settings.deleteMode=true;this.render()},_shortenDisplayName:function(e){if(!!e&&e.length>25){e=e.substring(0,20)+"..."}return e}});SM.ExportJobMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"ExportJobMenuView",__templateID:"export-job-menu-template"});SM.ExportDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"ExportJobDialogView",__model:"exportJob",__templateID:"export-dialog-view",__defaults:{viewSelectMode:false,responseSelectMode:false,confirmDisabled:true,isModal:true,width:750,disallowResponses:false,individualResponseMode:false},__init:function(e){var t=this,i=t.exportJob.exportJobs.survey.owner;this.viewID=e.viewID;this.errors={};this.$el.on(SM.Event.CLICK,"div .confirm-btn",{self:this},this._onConfirm).on(SM.Event.CLICK,"div .cancel-btn",{self:this},this._closeDialog).on(SM.Event.CLICK,"ul li a.export-summary-tab",{self:this},this._onSummaryTabClick).on(SM.Event.CLICK,"a[edit-view-select]",{self:this},this._onEditViewSelection).on(SM.Event.CLICK,"ul li a.all-response-tab",{self:this},this._onAllResponseTabClick).on(SM.Event.CLICK,"input[type='radio'][value='current']",{self:this,view:"currentView"},this._onEditViewSelection).on(SM.Event.CLICK,"input[type='radio'][value='original']",{self:this,view:"defaultView"},this._onEditViewSelection).on({formatClicked:function(e,i){t.buttonsView.render()}});this.bindModel(this.exportJob.exportJobs,"jobDeleted",{self:this},this._onJobDeleted);this.bindModel(this.exportJob.exportJobs,"jobCancelled",{self:this},this._onJobDeleted);this.bindModel(this.exportJob.exportJobs,"isLoaded.changed",{self:this},this._onExportJobsLoadedChanged);this.bindModel(this.exportJob.exportJobs,"jobStatusChanged",{self:this},this._onJobStatusChanged);this.bindModel(this.exportJob.exportJobs,"isUnavailable.set",{self:this},this._onExportJobsUnavailable);this.bindModel(this.exportJob.exportJobs,"clickedExportPreferenceUpgradeTrigger",{self:this},this._closeDialog)},__onAfterClose:function(){this.$el.remove()},_onJobStatusChanged:function(e){var t=e.data.self;if(e.job.type==="full"&&!e.job.pending()){t.render()}},_onJobDeleted:function(e){var t=e.data.self;if(!t.exportJob.exportJobs.hasFullExportPending()){t.render()}},_onExportJobsLoadedChanged:function(e){var t=e.data.self;t.render()},_hasNoMatchingResponses:function(){return!this.exportJob.exportJobs.survey.hasFilteredRespondents()||this.__settings.question&&this.__settings.question.getRollup().summary.answered===0&&!this.__settings.question.hasRandomAssignment()},__beforeRender:function(){var e=this.exportJob,t=e.exportJobs,i=e.type===e.TYPE.SUMMARY_EXPORT,s={viewModel:this.exportJob.sourceView,viewSelectMode:this.__settings.viewSelectMode,responseSelectMode:this.__settings.responseSelectMode,fullExportsInProgress:!i&&t.hasFullExportPending(),exportsLoaded:t.get("isLoaded"),exportsIsUnavailable:t.isUnavailable,isAllowedToExport:!t.isNotAllowedToExport(),singleMode:e.get("isSingleQuestionMode"),disallowResponses:this.__settings.disallowResponses};s[e.type+"Mode"]=true;return s},__afterRender:function(){var e,t=this.exportJob,i=t.exportJobs,s=i.survey,n=t.type===t.TYPE.SUMMARY_EXPORT,r=t.type===t.TYPE.CHART_EXPORT,a=!n&&i.hasFullExportPending(),o={model:t,hasChartView:this.__settings.hasChartView,question:this.__settings.question};SM.DialogView.__afterRender.call(this);if(i.isAvailable()){if(i.isNotAllowedToExport()){e=SM.Template.render("retry-export-warning");this.$el.children("section").append(e)}else{if(a){this.panel=SM.Views.create(SM.FullExportPendingListView,{model:i});this.$el.children("section").append(this.panel.el)}else if(this._hasNoMatchingResponses()){this.panel=SM.Views.create(SM.ExportDialogNoMatchingResponsesView,{survey:s});this.$el.find("div.current-panel").append(this.panel.$el)}else{if(n){this.panel=SM.Views.create(SM.ExportDialogSummaryView,o)}else if(r){this.panel=SM.Views.create(SM.ChartExportDialogView,o)}else{this.panel=SM.Views.create(SM.ExportDialogAllResponseView,{model:t,individualResponseMode:this.__settings.individualResponseMode})}this.$el.find("div.current-panel").append(this.panel.$el)}this.buttonsView=SM.Views.create(SM.ExportDialogButtonView,{model:t,dialogDisabled:a||this._hasNoMatchingResponses(),exportsLoaded:i.get("isLoaded")});this.$el.find(".buttons-wrapper").append(this.buttonsView.$el)}}else{e=SM.Template.render("exports-unavailable-template",{requestID:i.unavailableErrorID});this.$el.children("section").html(e)}this.$el.find(".q").popout()},_onExportJobsUnavailable:function(e){if(e.value){e.data.self.render()}},_onEditViewSelection:function(e){var t=e.data.self,i=e.data.view;t.exportJob.sourceView=t.exportJob.exportJobs.survey.anviews.get(i)},_onSummaryTabClick:function(e){var t=e.data.self;e.preventDefault();t.exportJob.type=t.exportJob.TYPE.SUMMARY_EXPORT;t.exportJob.format=undefined;t.render()},_onAllResponseTabClick:function(e){var t=e.data.self;e.preventDefault();t.exportJob.type=t.exportJob.TYPE.ALL_EXPORT;t.exportJob.format=undefined;t.render()},_closeDialog:function(e){e.preventDefault();e.data.self.close()},_onConfirm:function(e){var t=e.data.self,i;e.preventDefault();if(t.exportJob.format!==undefined){if(t.panel.validate()){t.close();if(t.exportJob.format==="gss"&&t.exportJob.exportJobs.requiresDriveAuth()){window.SM.authPendingDialogViewInstance=t;i=window.open("/analyze/export/drive/auth-req/?state=launch")}else{t.close();t.exportJob.finalizeExportData();t.exportJob.exportJobs.addJob(t.exportJob)}}else{t.panel.render()}}},onAuthEstablished:function(){this.exportJob.exportJobs.onAuthEstablished(this.exportJob)},onAuthFailed:function(){var e="There was a problem exporting your data",t=SM.Notifications.error({title:Globalize.localize(e),classes:"export-job-failed-notification",tabMessage:Globalize.localize("Export failed"),content:SM.Template.render("export-job-notification-error-message-template",{job:this.exportJob,exportTooLarge:false}),duration:1e4})}});SM.FullExportPendingListView=SM.Views.register({__NAME:"FullExportPendingListView",__templateID:"pending-full-exports-list-template",__model:"exportJobs",__afterRender:function(){var e=this,t=e.$el.find("ul"),i=this.exportJobs.getPendingFullExports();$.each(i,function(e,i){var s=SM.Views.create(SM.FullExportPendingView,{model:i});t.append(s.el)})}});SM.FullExportPendingView=SM.Views.register({__NAME:"FullExportPendingView",__templateID:"pending-full-export-template",__model:"exportJob",__init:function(){var e=this;this.$el.on("click","[cancel-btn]",{self:this},this._onCancelClick);this.bindModel(this.exportJob,"isCancelled.changed",{self:this},this._onDeleteJob);this.bindModel(this.exportJob,"deleted",{self:this},this._onDeleteJob)},__beforeRender:function(){return{job:this.exportJob}},_onDeleteJob:function(e){var t=e.data.self;t.$el.remove()},_onCancelClick:function(e){var t=e.data.self,i=t.exportJob,s=i.exportJobs;e.preventDefault();if(i.isNew()){s.cancelJob(i)}else{s.deleteJob(i)}}});SM.ExportDialogButtonView=SM.Views.register({__NAME:"ExportDialogButtonView",__model:"exportJob",__settings:{dialogDisabled:false,exportsLoaded:true},__templateID:"export-dialog-button-view",__beforeRender:function(){var e=this.exportJob.exportJobs.survey.owner,t=this.exportJob,i=t.format;return{dialogDisabled:this.__settings.dialogDisabled,upgradeRequired:!e.canExport(this.exportJob.format),confirmDisabled:t.format===undefined,exportsLoaded:this.__settings.exportsLoaded,exportType:i,isPPT:i===t.FORMAT.PPT,isSPSS:i===t.FORMAT.SPSS}},__defaults:{confirmDisabled:true}});SM.BaseExportDialogPanelView={__model:"exportJob",__templateID:"export-panel-view",__init:function(e){var t=this,i=this.exportJob.exportJobs.survey.config.export_formats_enabled;this.$el.on({emailEnter:function(e,i){t.exportJob.email=i},filenameEnter:function(e,i){t.exportJob.name=i},formatClicked:function(e,s){if(i[t.exportJob.type][s]){if(t.exportJob.format===s){t.exportJob.set("format",undefined)}else{t.exportJob.set("format",s)}t.render();t.$el.find(".error-msg").hide()}},useOneExcelSheetChanged:function(e,i){t.exportJob.set("questionDisplay",i)}})},_addTextInputs:function(){var e=this.errors||{},t=this.exportJob,i;this.exportJob.name=this.exportJob.generateFileName();i=SM.Views.create(SM.ExportDialogTextInputView,{label:Globalize.localize("File Name"),preferenceType:"filename",textValue:this.exportJob.name,error:e.filename,isPPT:!!!e.filename&&t.format===t.FORMAT.PPT});this.el.appendChild(i.el)},__beforeRender:function(e){var t={format:this.exportJob.format,isSingleMode:this.exportJob.get("isSingleQuestionMode"),chartMode:this.exportJob.type==="chart",summaryMode:this.exportJob.type===this.exportJob.TYPE.SUMMARY_EXPORT};if(t.format){t[t.format+"Selected"]=true}else{t.selectType=null}return t},__afterRender:function(e){var t=0,i=this._exportFormats.length,s=this.exportJob.type,n=this.exportJob.exportJobs.survey.config.export_formats_enabled[s],r=this.exportJob.format,a=this.$el.find("tr").get(0);for(;t<i;t++){a.appendChild(SM.Views.create(SM.ExportDialogFormatView,{isSelected:this._exportFormats[t]===this.exportJob.format,format:this._exportFormats[t],isDisabled:!n[this._exportFormats[t]]}).el)}if(r){this.renderPreferences(this);this._addTextInputs()}this.$el.find(".q").popout()},validate:function(){var e=/\S+@\S+\.\S+/,t=/\S+/,i=$.trim(SM.String.htmlStrip(this.exportJob.name)),s=SM.String.htmlStrip(this.exportJob.email),n;this.errors={};if(!i.length){i=this.exportJob.generateFileName()}n=i.lastIndexOf(".");if(n!==-1){i=i.substr(0,n)}else{i=i}if(i.length>250){this.errors.filename=Globalize.localize("Max filename length is 250 characters")+".";return false}if(!t.test(i)){this.errors.filename=Globalize.localize("Please enter a valid filename")+".";return false}this.exportJob.email=s;this.exportJob.name=this.exportJob.generateFileName(i);return true}};SM.ExportDialogNoMatchingResponsesView=SM.Views.register({__NAME:"ExportDialogNoMatchingResponsesView",__templateID:"export-panel-view-no-matching-responses",__beforeRender:function(e){var t={surveyHasRespondents:e.survey.hasRespondents()};return t}});SM.ExportDialogSummaryView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ExportDialogSummaryView",__init:function(e){var t=this,i;SM.BaseExportDialogPanelView.__init.call(this,e);this.$el.on({pdfOrientationChanged:function(e,i){t.exportJob.set("pdfOrientation",i)},pdfPaperSizeChanged:function(e,i){t.exportJob.set("pdfPaperSize",i)},includeOpenendedChanged:function(e,i){t.exportJob.set("includeOpenended",i)},useNonBrandedTemplateChanged:function(e,i){t.exportJob.set("useNonBrandedTemplate",i)},forcedPageBreakChanged:function(e,i){t.exportJob.set("forcedPageBreak",i)}})},__afterRender:function(e){var t=this.exportJob.type,i=this.exportJob.exportJobs.survey.config.export_formats_enabled[t];i.ppt=this.isPPTExportEnabled();SM.BaseExportDialogPanelView.__afterRender.call(this,e)},isPPTExportEnabled:function(){var e=this.exportJob.get("isSingleQuestionMode"),t=this.exportJob.exportJobs.survey.anviews.currentView,i,s;if(t.hasRACompareSelected()){return false}else if(e){i=this.__settings.question;return this.exportJob.canExportQuestionInPPT(i)}return true},hasEnabledOpenEndedInExports:function(){return!SM.SharedAnalyzeApp||!SM.SharedAnalyzeApp.data.shared_view.hide_open_ended},_exportFormats:["pdf","ppt","excel","csv"],renderPreferences:function(){var e=[],t,i=this.exportJob,s=this;t=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});e.push(t);if(i.format===i.FORMAT.PDF){t=SM.Views.create(SM.ExportDialogPdfInputView,{model:this.exportJob});e.push(t)}if(i.format===i.FORMAT.EXCEL){t=SM.Views.create(SM.ExportDialogXlsSheetChoiceView,{model:this.exportJob});e.push(t)}if(i.format!==i.FORMAT.PPT){if(s.hasEnabledOpenEndedInExports()){e.push(SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"includeOpenended",isChecked:this.__settings.hasChartView===false,label:Globalize.localize("Include open-ended responses"),isUpgradeTrigger:false}))}}else{t=SM.Views.create(SM.ExportDialogChartAndOrTableChoiceView,{model:i});e.push(t);t=SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"useNonBrandedTemplate",isChecked:false,label:Globalize.localize("Hide SurveyMonkey Branding"),isUpgradeTrigger:!i.exportJobs.survey.owner.canHideExportBranding(),upgradeTemplate:"export-hide-branding-upgrade-dialog-template",exportJobs:i.exportJobs});e.push(t)}_.each(e,function(e){s.$el.append(e.$el)});if(s.__settings.hasChartView===false){s.exportJob.set("includeOpenended",true)}}});SM.ChartExportDialogView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ChartExportDialogView",__init:function(e){var t=this;SM.BaseExportDialogPanelView.__init.call(this,e);this.exportJob.initExport()},__afterRender:function(e){SM.BaseExportDialogPanelView.__afterRender.call(this,e);this.$el.find(".disabled .folded").hide()},renderPreferences:function(){var e=[],t,i=this;t=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});e.push(t);$.each(e,function(e,t){i.$el.append(t.$el)})},_exportFormats:["png","","",""]});SM.ExportDialogAllResponseView=SM.Views.extend(SM.BaseExportDialogPanelView,{__NAME:"ExportDialogAllResponseView",_exportFormats:["excel","excel_plus","gss","spss","pdf"],__defaults:{individualResponseMode:false},__init:function(e){var t=this;SM.BaseExportDialogPanelView.__init.call(this,e);this.$el.on({xlsColumnChoiceChanged:function(e,i){t.exportJob.set("columnSetting",i)},xlsCellChoiceChanged:function(e,i){t.exportJob.set("cellType",i)},pdfPaperSizeChanged:function(e,i){t.exportJob.set("pdfPaperSize",i)},respondentChanged:function(e,i){t.render()},forcedPageBreakChanged:function(e,i){t.exportJob.set("forcedPageBreak",i)}});if(this.__settings.individualResponseMode){t.$el.trigger("formatClicked","pdf")}},renderPreferences:function(){var e=[],t=this.exportJob,i,s=t.respondentID!=="all",n=this;i=SM.Views.create(SM.ExportDialogDataFilterView,{model:this.exportJob});e.push(i);if(t.format==="excel"){i=SM.Views.create(SM.ExportDialogXlsColumnCellChoiceView,{model:t});e.push(i)}if(t.format==="pdf"){i=SM.Views.create(SM.ExportDialogResponseSelectView,{model:this.exportJob,responseSelectMode:s});e.push(i);i=SM.Views.create(SM.ExportDialogPdfInputView,{model:this.exportJob,onlyPaperSize:true});e.push(i)}$.each(e,function(e,t){n.$el.append(t.$el)})}});SM.ExportDialogCheckboxInputView=SM.Views.register({__NAME:"ExportDialogCheckboxInputView",__templateID:"export-dialog-preference-checkbox",__defaults:{type:null,label:null,isChecked:false,isUpgradeTrigger:false,isDisabled:false,upgradeTemplate:null,exportJobs:null},__init:function(){var e=this,t;this.$el.on(SM.Event.CLICK,function(){if(e.__settings.isUpgradeTrigger){t=e.__settings.exportJobs;t._trigger({type:"clickedExportPreferenceUpgradeTrigger",upgradeTemplate:e.__settings.upgradeTemplate})}else if(!e.__settings.isDisabled){e.__settings.isChecked=!e.__settings.isChecked;e.$el.trigger(e.__settings.type+"Changed",e.__settings.isChecked);e.render()}})},__beforeRender:function(){return{type:this.__settings.type,isChecked:this.__settings.isChecked,checkboxLabel:this.__settings.label,isUpgradeTrigger:this.__settings.isUpgradeTrigger,isDisabled:this.__settings.isDisabled}}});SM.ExportDialogTextInputView=SM.Views.register({__NAME:"ExportDialogTextInputView",__templateID:"export-dialog-text-input",__init:function(){var e=this;this.$el.on(SM.Event.KEYUP,"input",function(){e.$el.trigger(e.__settings.preferenceType+"Enter",$(this).val())})},__defaults:{textValue:null,label:null,isLastSection:false,preferenceType:null}});SM.ExportDialogDataFilterView=SM.Views.register({__NAME:"ExportDialogDataFilterView",__model:"exportJob",__templateID:"export-data-filter-view",__init:function(){return},__beforeRender:function(){var e=this.exportJob,t={viewModel:this.exportJob.sourceView,viewSelectMode:true,singleMode:e.get("isSingleQuestionMode"),localizedQuestionLabel:Globalize.localize("Question")+" #"+e.questionNumber};return t}});SM.ExportDialogPdfInputView=SM.Views.register({__NAME:"ExportDialogPdfInputView",__model:"exportJob",__templateID:"export-dialog-pdf-input-template",__defaults:{onlyPaperSize:false},__init:function(){var e=this;this.$el.on("selectMenu.change","a[orientation]",function(t){e.$el.trigger("pdfOrientationChanged",t.value)}).on("selectMenu.change","a[paper-size]",function(t){e.$el.trigger("pdfPaperSizeChanged",t.value)})},__beforeRender:function(){var e={onlyPaperSize:this.__settings.onlyPaperSize};return e},__afterRender:function(){this.renderPreferences();this.$el.find("a[orientation]").selectMenu({selectedValue:this.exportJob.get("pdfOrientation"),options:[{text:Globalize.localize("Portrait (Vertical)"),value:"portrait"},{text:Globalize.localize("Landscape (Horizontal)"),value:"landscape"}]});this.$el.find("a[paper-size]").selectMenu({selectedValue:this.exportJob.get("pdfPaperSize"),options:[{text:Globalize.localize('Letter (8.5" x 11")'),value:"letter"},{text:Globalize.localize('Legal (8.5" x 14")'),value:"legal"},{text:Globalize.localize("A4 (210mm \xd7 297mm)"),value:"A4"}]})},renderPreferences:function(){var e=this,t=this.exportJob,i=t.get("isSingleQuestionMode"),s=t.type===t.TYPE.SUMMARY_EXPORT,n="Start each question on a new page",r="Start each response on a new page",a;a=SM.Views.create(SM.ExportDialogCheckboxInputView,{type:"forcedPageBreak",isChecked:true,label:Globalize.localize(s?n:r),isUpgradeTrigger:false,isDisabled:this.isPageBreakPreferenceDisabled()});e.$el.append(a.$el)},isPageBreakPreferenceDisabled:function(){var e=this.exportJob,t=e.type,i=t===e.TYPE.SUMMARY_EXPORT,s=t===e.TYPE.ALL_EXPORT,n=e.get("isSingleQuestionMode"),r=e.get("isSingleResponseMode");if(n&&i){return true}else if(r&&s){return true}return false}});SM.ExportDialogResponseSelectView=SM.Views.register({__NAME:"ExportDialogResponseSelectView",__model:"exportJob",__templateID:"export-dialog-response-select-template",__defaults:{responseSelectMode:false},__init:function(){var e=this;this.$el.on("change","input[type='radio'][name='response']",{self:this},this._onEditResponseSelection)},__beforeRender:function(){var e=this.exportJob,t=e.exportData.respondent_id!=="all",i={responseSelectMode:this.__settings.responseSelectMode,individualResponse:t,respondentID:e.respondentID,respondentNumber:e.respondentNumber,singleRespondentID:this.__NAME+this.__uid+"radio-single-respondent",allRespondentsID:this.__NAME+this.__uid+"radio-all-respondents"};return i},_onEditResponseSelection:function(e){var t=e.data.self;t.exportJob.exportData.respondent_id=e.currentTarget.value;t.exportJob.name=t.exportJob.generateFileName();t.$el.trigger("respondentChanged",e.currentTarget.value)}});SM.ExportDialogXlsSheetChoiceView=SM.Views.register({__NAME:"ExportDialogXlsSheetChoiceView",__templateID:"export-dialog-xls-sheet-choice-view",__model:"exportJob",__init:function(){var e=this;this.$el.on(SM.Event.CLICK,"input",function(){e.$el.trigger("useOneExcelSheetChanged",$(this).val())})},__beforeRender:function(){return{singleMode:this.exportJob.get("isSingleQuestionMode")}}});SM.ExportDialogXlsColumnCellChoiceView=SM.Views.register({__NAME:"ExportDialogXlsColumnCellChoiceView",__model:"exportJob",__templateID:"export-dialog-xls-column-cell-choice-view",__init:function(){var e=this;this.$el.on("selectMenu.change","a[column]",function(t){e.$el.trigger("xlsColumnChoiceChanged",t.value)}).on("selectMenu.change","a[cell]",function(t){
e.$el.trigger("xlsCellChoiceChanged",t.value)})},__afterRender:function(){this.$el.find("a[column]").selectMenu({options:[{text:Globalize.localize("Condensed"),value:"condensed"},{text:Globalize.localize("Expanded"),value:"expanded"}],selectedValue:this.exportJob.exportData.column_setting});this.$el.find("a[cell]").selectMenu({options:[{text:Globalize.localize("Actual Answer Text"),value:"actual_choice_text"},{text:Globalize.localize("Numerical Value (1-n)"),value:"numerical_value"}],selectedValue:this.exportJob.exportData.cell_type})}});SM.ExportDialogChartAndOrTableChoiceView=SM.Views.register({__NAME:"ExportDialogChartAndOrTableChoiceView",__model:"exportJob",__templateID:"export-dialog-chart-and-or-table-choice-view",__init:function(){var e=this;this.$el.on("change","input[type='radio'][name='chart-and-or-table']",{self:this},this._onEditChartAndOrTableSelection)},_onEditChartAndOrTableSelection:function(e){var t=e.data.self,i=e.currentTarget.value,s=t.exportJob.exportData;switch(i){case"chart-and-table":s.include_charts=true;s.include_tables=true;break;case"chart-only":s.include_charts=true;s.include_tables=false;break;case"table-only":s.include_charts=false;s.include_tables=true;break}}});SM.ExportDialogFormatView=SM.Views.register({__templateID:"export-dialog-format-view",__NAME:"ExportDialogFormatView",__init:function(e){var t=this;this.$el.on(SM.Event.CLICK,function(e){if(!t.__settings.isDisabled){t.$el.trigger("formatClicked",t.__settings.format)}})},styleMap:{csv:{ext:".csv",icon:"\xbc",labelColor:"exp-green",iconClass:"smf-icon icon",description:"Opens in most analytics software"},excel:{ext:".xls",icon:"\xbc",labelColor:"exp-green",iconClass:"smf-icon icon",description:"Opens in Microsoft Excel"},excel_plus:{ext:".xls+",icon:"\xbc",labelColor:"exp-green",iconClass:"smf-icon icon",description:"Open in advanced statistical and analytical software"},rdb:{ext:".rdb",icon:"\xbc",labelColor:"exp-purple",iconClass:"smf-icon icon",description:"Provides a separate file for each database table"},spss:{ext:"spss",icon:"\xbc",labelColor:"exp-red",iconClass:"smf-icon icon",description:"Open in your SPSS analytical software"},gss:{ext:"drive",icon:"N",labelColor:"exp-blue",iconClass:"smf-icon-2 gss-icon",description:"Downloads directly to Google Sheets"},html:{ext:".html",icon:"\xdc",labelColor:"exp-purple",iconClass:"smf-icon icon",description:"Ideal for posting directly to a website"},png:{ext:".png",icon:"\xdc",labelColor:"exp-orange",iconClass:"smf-icon icon",description:"Best for adding charts as images to presentations"},pdf:{ext:".pdf",icon:"\xdc",labelColor:"exp-red",iconClass:"smf-icon icon",description:"Ideal for sharing and printing"},ppt:{ext:".ppt",icon:"\xdc",labelColor:"exp-light-purple",iconClass:"smf-icon icon",description:"Ideal for presenting in Microsoft PowerPoint"},pdf_chart:{ext:".pdf",icon:"\xdc",labelColor:"exp-red",iconClass:"smf-icon icon",description:"Ideal for sharing and opening on all computers"}},__defaults:{isSelected:false,isDisabled:false,format:null},__beforeRender:function(){var e=SM.Object.copy(this.styleMap[this.__settings.format]);e.description=Globalize.localize(e.description);e.isSelected=this.__settings.isSelected;e.format=this.__settings.format;e.isDisabled=this.__settings.isDisabled;return e}});SM.AnalyzeWarningDialogView=SM.Views.deepExtend(SM.DialogView,{__NAME:"AnalyzeWarningDialogView",__model:"survey",__defaults:{width:800},__create:function(e){var t=this;t.onContinueClick=e.onContinueClick},__init:function(e){var t=this;this.$el.on(SM.Event.CLICK,".continue-btn",{self:this},this._onContinueClick)},_onContinueClick:function(e){var t=e.data.self;t.onContinueClick()}});SM.HipaaExportWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"HipaaExportWarningView",__templateID:"hipaa-export-warning",__model:"survey",__defaults:{jobType:"export",width:800},__beforeRender:function(){var e=this.__settings.jobType,t={};t[e+"Mode"]=true;return t}});SM.QuotaEditWarningView=SM.Views.deepExtend(SM.AnalyzeWarningDialogView,{__NAME:"QuotaEditWarningView",__templateID:"quota-edit-warning",__defaults:{width:600,isModal:true}});SM.BenchmarkActionMenu={actionMenu:function(e,t,i,s,n,r,a){var o=i.segmentList.survey,l=i.isDefault(),u=i.isLegacy(),d=i.isDerived(),h=d||u?false:i.segmentList.findDerived(i),c=o.owner.hasBenchmarkingRestricted(),f=o.getTemplateName(),p=o.isTMBCTemplate(),m={menuView:"BenchmarkMenuView",user_id:o.currentUserID,surveyId:o.ID,isDefault:l,hasPaid:c,hasDownload:c,buy:l||!u,isTMBC:p,toStore:!p,isNPS:o.isNPSTemplate(),source:s,segment:i,position:{collision:"none none"}},g,S,w,v,M,y,b;m.questionID="0";if(s==="segment"){if(!p){m.top25=c&&!h&&(l||!u&&!d);m.remove=d||u}}else if(s==="question"){m.top25=false;m.remove=false;m.questionID=e.question.ID;m.source2="&ut_source2=question_menu";if(c){m.viewList=[];_.each(i.segmentList.segmentList,function(e,t){if(e!==i){m.viewList.push({segmentName:e.name(),segmentId:e.id()||e.segmentId()})}})}}if(!!f){m.templateName="&Template="+f}if(a&&a.length>0){m.parentEl=a[0]}t.actionMenu(m);t.on({"actionMenu.actionSelected":this._onMenuAction},{self:this,owner:e});this._useRefCount=r;if(r){e._menuCt=0}this._dataSegment=i;if(n){v=t.data("actionMenu");M=v.get("menuView");if(n.pageX||n.pageY){y=n.pageX;b=n.pageY}else if(n.clientX||n.clientY){y=n.clientX+document.body.scrollLeft+document.documentElement.scrollLeft;b=n.clientY+document.body.scrollTop+document.documentElement.scrollTop}M.$el.css({left:y+"px",top:b+"px"})}},_canNotify:function(e){if(this._useRefCount){e._menuCt=e._menuCt+1;return e._menuCt===1}return true},_onMenuAction:function(e){var t=e.data.self,i=e.data.owner,s,n,r,a,o,l,u,d,h,c=e.actionMenu.get("toStore"),f=e.actionMenu.get("isTMBC");var _=function(e){if(c){window.location.href=s}else{window.open(s,"_blank")}};e.preventDefault();e.stopPropagation();if(!t._canNotify(i)){return}if(e.action==="_menuAboutSMBClick"||e.action==="_menuBuyMoreClick"){s=e.$action.attr("link");n=e.actionMenu.get("source");if(n===""){n="unknown"}r="0";o=e.actionMenu.get("segment").segmentList.survey;d=o.isNPSTemplate();if(n==="question"){r=e.actionMenu.get("questionID");u=o.getQuestion(r);if(u){d=u.isNPS()}}if(e.action==="_menuBuyMoreClick"){l=e.actionMenu.get("hasPaid");h=o.getTemplateName();if(!f){s=s+"?userid="+e.actionMenu.get("user_id")+"&surveyID="+o.ID+"&qbcat="+h+"&source="+(l?"analyze_paid":"analyze_QPQP")+"&ut_source="+"analyze"}SM.Bi.benchmarkingBuyMore(r,"benchmarking_buy_menu_action",n,s,l,d).done(_).fail(_)}else{SM.Bi.benchmarkingAbout(r,n,s,d);window.open(s,"_blank")}}else if(t[e.action]){t[e.action](e)}else if(i&&i[e.action]){i[e.action]()}},_menuDownloadCSV:function(e){var t=e.data.owner,i=t.dataSegment?t.dataSegment:e.actionMenu.get("segment"),s=e.actionMenu.get("source"),n=e.actionMenu.get("questionID");i.downloadCSV();SM.Bi.benchmarkingDownloadCSV(n,i.segmentId(),s)},_menuShowTop25Click:function(e){var t=e.actionMenu.get("segment");t.segmentList.addDerivedSegment(t,"top25")},_menuViewClick:function(e){var t=e.actionMenu.get("segment"),i=$(e.actionMenu._menu._$options[e.actionMenu._menu._currentIndex]),s=i.attr("segment-id"),n=t.segmentList.findSegmentById(s);if(n){SM.API.logSetUiTrigger("action_menu");t.segmentList.selectSegment(n,t.getCanonicalName(),"question")}},_menuUpgradeClick:function(){var e=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"data-segment-upgrade-dialog-template"});e.open()}};SM.BenchmarkMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"BenchmarkMenuView",__templateID:"data-segment-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.DataSegmentView=SM.Views.register({__model:"dataSegment",__NAME:"DataSegmentView",__templateID:"data-segment-item-template",__defaults:{isSelectable:true,isSelected:false,deleteMode:false},__init:function(){var e=this,t=this.dataSegment;this.$el.on(SM.Event.CLICK,".list-item",{self:this},this._onDataSegmentClicked);this.$el.on({"DataSegmentItem.DeleteView.deleteClicked":this._onDeleteClicked,"DataSegmentItem.DeleteView.cancelClicked":this._onCancelClicked},{self:this})},__beforeRender:function(e){var t=this.dataSegment.segmentList,i=this.dataSegment.isFake(),s=this.dataSegment.isDefault(),n=s&&this.dataSegment.isSelected()&&t.countSelected()===1,r=this.get("deleteMode")||this.dataSegment.isFake();return{segmentId:this.dataSegment.segmentId(),name:this.dataSegment.name(),isSelected:this.dataSegment.isSelected(),isLocked:n,isDefault:s,isFake:i,deleteMode:this.get("deleteMode"),showMenu:!r}},__afterRender:function(e){var t=this.$el.children(".list-item"),i=null;if(e.showMenu){SM.BenchmarkActionMenu.actionMenu(this,this.$el.find("a.btn-menu-down"),this.dataSegment,"segment")}else{if(this.get("deleteMode")){i=SM.Views.create(SM.DataSegmentDeleteView,{visible:true})}if(i){t.prepend(i.el)}}},_onDataSegmentClicked:function(e){var t=e.data.self,i=t.dataSegment.segmentList.survey,s=i.isCurrentUserAlsoOwner(),n;if(t.dataSegment.isFake()){if(s){n=SM.Views.create(SM.ProfilerMarketingDialogView,{model:i.profiler,type:i.getTemplateType(),triggeredFrom:"accordion",segmentName:t.dataSegment.name()});n.open()}return}if(t.get("isSelectable")&&!t.dataSegment.isSelected()){t.dataSegment.segmentList.toggleSelection(t.dataSegment)}},_menuUpgradeClick:function(){var e=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:"data-segment-upgrade-dialog-template"});e.open()},_menuDeleteClick:function(){this.set("isSelectable",false);this.set("deleteMode",true);this.render()},_onCancelClicked:function(e){var t=e.data.self;t.set("deleteMode",false);t.render()},_onDeleteClicked:function(e){var t=e.data.self;t.dataSegment.segmentList.deleteSegment(t.dataSegment);t.set("isSelectable",true);t.set("deleteMode",false);t.render()}});SM.DataSegmentMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"DataSegmenMenuView",__templateID:"data-segment-menu-template",__afterRender:function(){SM.ActionMenuView.__afterRender.call(this);this.$el.find(".q").popout()}});SM.DataSegmentDeleteView=SM.Views.register({__NAME:"DataSegmentItem.DeleteView",__templateID:"data-segment-delete-template",__defaults:{visible:false,hasCancel:true},__init:function(){this.$el.on(SM.Event.CLICK,"[data-segment-delete-btn]",{self:this},this._publishDelete);this.$el.on(SM.Event.CLICK,"[data-segment-delete-cancel-btn]",{self:this},this._publishCancel)},__beforeRender:function(){return{visible:this.__settings.visible,hasCancel:this.__settings.hasCancel}},__afterRender:function(e){if(this.__settings.visible){this.$el.removeClass("hide")}},open:function(){this.__settings.visible=true;this.render();this.$el.find("[data-segment-delete-btn]").focus()},close:function(){this.__settings.visible=false;this.render()},_publishDelete:function(e){var t=e.data.self;e.preventDefault();t.close();t.trigger("deleteClicked")},_publishCancel:function(e){var t=e.data.self;t.close();t.trigger("cancelClicked")}});SM.DataSegmentContainerView=SM.Views.register({__NAME:"DataSegmentContainerView",__templateID:"data-segment-container-template",__model:"survey",__afterRender:function(){this.dataSegmentBuilderView=SM.Views.create(SM.DataSegmentBuilderView,{model:this.survey.dataSegmentList});this.$el.append(this.dataSegmentBuilderView.$el);this.dataSegmentBuilderView.$el.hide();this.dataSegmentListView=SM.Views.create(SM.DataSegmentListView,{model:this.survey.dataSegmentList});this.$el.append(this.dataSegmentListView.$el);this.inProgressNotification=null},__init:function(){this.survey.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_ERROR,{self:this},this._onDataSegmentError);this.survey.anviews.currentView.on("ruleEdited",{self:this},this._onRuleEdited)},_onDataSegmentError:function(e){var t=e.data.self,i=e.name,s=e.message;if(t.inProgressNotification){t.inProgressNotification.close();t.inProgressNotification=null}t.inProgressNotification=SM.Notifications.error({title:Globalize.localize(i),classes:"data-segment-error-notification",tabMessage:Globalize.localize(s),content:SM.Template.render("data-segment-error-message-template",{message:Globalize.localize(s)}),duration:1e4})},_onRuleEdited:function(e){var t=e.data.self,i=e.ruleModel,s=i.ruleFamily==="compare";if(s){t.render()}}});SM.DataSegmentBuilderView=SM.Views.register({__NAME:"DataSegmentBuilderView",__templateID:"data-segment-builder-template",__model:"dataSegmentList",__beforeRender:function(e){return{segmentChoices:this.dataSegmentList.getQuestionOptions()}},__afterRender:function(){this._$subsegmentChooser=this.$el.find(".subsegment-chooser");this._$subsegmentChooser.hide();this._$percentileChooser=this.$el.find(".data-percentile-chooser");this._$percentileChooser.hide();this._$applyBtn=this.$el.find("[new-segment-apply]");this._$applyBtn.hide()},__init:function(){this.$el.on(SM.Event.CLICK,"[new-segment-cancel]",{self:this},this._onNewSegmentCancelClicked);this.$el.on(SM.Event.CLICK,"[new-segment-apply]",{self:this},this._onNewSegmentApplyClicked);this.$el.on(SM.Event.CHANGE,"[segment-choice-list]",{self:this},this._onSegmentChoiceChanged);this.$el.on(SM.Event.CHANGE,"[subsegment-choice-list]",{self:this},this._onSubsegmentChoiceChanged);this.$el.on(SM.Event.CHANGE,"[segment-percentile-list]",{self:this},this._onPercentileChoiceChanged);this.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_LOADED,{self:this},this._onNewSegmentLoaded)},_onSegmentChoiceChanged:function(e){var t=e.data.self,i=$(e.target),s=i.val(),n={};e.preventDefault();e.stopPropagation();if(s===""||s==="all"){t._$subsegmentChooser.hide();if(s==="all"){t._$percentileChooser.show();t._$applyBtn.show()}else{t._$percentileChooser.hide();t._$applyBtn.hide()}}else{n.subsegmentChoices=t.dataSegmentList.getOptionOptions(s);t._$subsegmentChooser.html(SM.Template.render("subsegment-chooser-template",n));t._$subsegmentChooser.show();t._$percentileChooser.hide();t._$applyBtn.hide()}},_onSubsegmentChoiceChanged:function(e){var t=e.data.self,i=$(e.target),s=i.val(),n={};e.preventDefault();e.stopPropagation();if(s===""){t._$percentileChooser.hide();t._$applyBtn.hide()}else{t._$percentileChooser.show();t._$applyBtn.show()}},_onPercentileChoiceChanged:function(e){var t=e.data.self;e.preventDefault();e.stopPropagation()},_onNewSegmentCancelClicked:function(e){var t=e.data.self,i=t.$el.closest("[data-segment-ctnr]").find("[benchmark-segment-list]");e.preventDefault();e.stopPropagation();t.$el.hide();i.show()},_onNewSegmentLoaded:function(e){var t=e.data.self,i=t.$el.closest("[data-segment-ctnr]").find("[benchmark-segment-list]");i.show();t.$el.hide()},_onNewSegmentApplyClicked:function(e){var t=e.data.self,i=t.$el.find("[segment-choice-list]"),s=i.val(),n=t.$el.find("[subsegment-choice-list]"),r=n.val(),a=t.$el.find("[segment-percentile-list]"),o=parseInt(a.val(),10),l,u;e.preventDefault();e.stopPropagation();if(!!s){u=t.dataSegmentList.createNewSegment(s,r,o);if(!u){t.dataSegmentList._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:Globalize.localize("You have already created a segment for that benchmark."),message:Globalize.localize("Please change your segment choices and try again.")})}}}});SM.DataSegmentListView=SM.Views.register({__model:"dataSegmentList",__templateID:"data-segment-list-template",__NAME:"DataSegmentListView",__init:function(){var e=this;this.$el.on(SM.Event.CLICK,"[new-segment]",{self:this},this._onNewSegmentClicked);this.$el.on(SM.Event.CLICK,"[show-benchmarks-btn]",{self:this},this._onShowBenchmarksClicked);this.$el.on(SM.Event.CLICK,".cta a",{self:this},this._onCTAClicked);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_ADDED,{self:this},this._onDataSegmentAdded);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_DELETED,{self:this},this._onDataSegmentDeleted);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_SELECTION_CHANGED,{self:this},this._onDataSegmentSelectionChanged);this.bindModel(this.dataSegmentList,SM.DataSegmentListModel.DATA_SEGMENT_SHOWN_CHANGED,{self:this},this._onBenchmarkShownChanged);this.dataSegmentList.on(SM.DataSegmentListModel.DATA_SEGMENT_LOADED,{self:this},this._onDataSegmentAdded)},__beforeRender:function(){var e=this.dataSegmentList.survey,t=e.profiler,i=t&&e.canShowBenchmarking()&&!e.shouldShowProfiler(),s=e.anviews.currentView.getCompareRuleSelected();return{benchmarkingDisabled:!this.dataSegmentList.hasBenchmarking(),benchmarkingRestrictedEnabled:this.dataSegmentList.hasRestrictedFeatures(),ctBenchmarks:this.dataSegmentList.getCountOfBenchmarkableQuestions(),showCompleteMsg:!i,isNPS:e.isNPSTemplate(),isSHRM:e.isSHRMTemplate(),isGeneric:e.isGenericTemplate(),userid:this.dataSegmentList.survey.currentUserID,isCompared:s}},__afterRender:function(){var e=this,t=e.$el.find("[default-data-segment]"),i=e.$el.find("[paid-segment]").detach(),s=e.$el.find("[legacy-segment-list]").detach(),n=t,r,a=false,o,l=this.dataSegmentList.hasRestrictedFeatures();if(this.dataSegmentList.hasBenchmarking()){_.each(this.dataSegmentList.segmentList,function(e){var o;if(e.isDefault()){o=SM.Views.create(SM.DataSegmentView,{model:e});t.append(o.$el)}else if(l||e.isFake()){if(e.isLegacy()){if(!a){n.after(s);n=s;a=true}}else{if(!e.isDerived()){r=i.clone();n.after(r);n=r}}o=SM.Views.create(SM.DataSegmentView,{model:e,isSelectable:!e.isFake()});n.append(o.$el)}});this._showOrHideSegmentList();this.$el.find(".q").popout()}},_clearSegmentBuilder:function(){var e=$("[segment-choice-list]"),t=$("[subsegment-choice-list]"),i=$("[segment-percentile-list]"),s=$(".subsegment-chooser"),n=$(".data-percentile-chooser");e.val("");t.val("");i.val("");n.hide();s.hide()},_onNewSegmentClicked:function(e){var t=e.data.self,i,s=t.$el.closest("[data-segment-ctnr]").find("[data-segment-builder]");e.preventDefault();e.stopPropagation();if(t.dataSegmentList.hasRestrictedFeatures){t.$el.hide();t._clearSegmentBuilder();s.show()}},_onCTAClicked:function(e){var t=e.data.self,i=$(e.target),s=i.attr("link"),n=i.attr("source"),r=t.dataSegmentList.survey,a=r.currentUserID,o=r.ID,l=r.owner.hasBenchmarkingRestricted();e.preventDefault();e.stopPropagation();SM.Bi.benchmarkingAbout("0",n,s,r.isNPSTemplate());window.open(s+"?userid="+a+"&surveyID="+o+"&source="+(l?"analyze_paid":"analyze_QPQP"),"_blank")},_onDataSegmentAdded:function(e){var t=e.data.self;SM.log("DataSegmentListView._onDataSegmentAdded - rerendering.");t.render()},_onDataSegmentDeleted:function(e){var t=e.data.self;t.render()},_onDataSegmentSelectionChanged:function(e){var t=e.data.self;SM.log("DataSegmentListView._onDataSegmentSelectionChanged - rerendering.");t.render()},_onBenchmarkShownChanged:function(e){var t=e.data.self;t._showOrHideSegmentList()},_showOrHideSegmentList:function(){var e=this.$el.find("[data-segment-list-messages]"),t=this.$el.find("[data-segment-list-ctnr]"),i=this.dataSegmentList.survey,s=i.profiler,n=this.dataSegmentList.survey.owner,r=s&&i.canShowBenchmarking()&&!i.shouldShowProfiler();if(r){e.hide();t.show()}else{e.show();t.hide()}},_onShowBenchmarksClicked:function(e){var t=e.data.self,i=$(e.target),s=t.dataSegmentList.survey,n=s.isCurrentUserAlsoOwner(),r;var a=function(e){t.dataSegmentList.enableAllBenchmarks(true)};var o=function(e,i,s){var n="Failed to save profile",r="We were unable to save your profile. Please try again later.";SM.Ajax.logError({name:n,message:r});t.dataSegmentList._trigger({type:SM.DataSegmentListModel.DATA_SEGMENT_ERROR,name:n,message:r})};e.preventDefault();e.stopPropagation();if(i.hasClass("disabled")){return}if(!n){if(!s.isProfilerDialogEnabled()){t.dataSegmentList.enableAllBenchmarks(true)}}else if(s.isProfilerDialogEnabled()){r=SM.Views.create(SM.ProfilerDialogView,{model:s.profiler,type:s.getTemplateType(),action_source:"accordion",triggeredFrom:"accordion_complete_profile_button"});r.open()}else if(s.profiler.profileSaved){t.dataSegmentList.enableAllBenchmarks(true)}else{s.profiler.save({done:a,fail:o})}}});SM.ShareAllBtnView=SM.Views.register({__NAME:"ShareAllBtnView",__model:"survey",__templateID:"share-all-btn-view-template",__create:function(e){this.survey=e.survey;_.bindAll(this,"_onClick")},__beforeRender:function(){return{noBorder:this.__settings.noBorder}},__afterRender:function(e){this.$el.find(".q").popout()},__init:function(){this.$el.on("click",{self:this},this._onClick)},_renderSharedViewFormView:function(e){var t,i,s;t=e.$el.find("[shared-view-form-container]");i=SM.Models.create("SharedView",{survey_id:this.survey.ID,view_id:this.survey.anviews.currentView.ID,name:"My Shared View",title:"The Survey Title"});i.survey=this.survey;s=SM.Views.create(SM.SharedViewFormView,{dialogView:e,sharedView:i});t.html(s.el)},_onClick:function(e){var t,i=e.data.self,s=i.survey;e.preventDefault();if(s.owner.get("hipaaEnabled")){t=SM.Views.create(SM.HipaaExportWarningView,{model:s,jobType:"share",onContinueClick:function(){SM.AnalyzeApp.SharedViewsRouter.newSharedView()}});t.open()}else{SM.AnalyzeApp.SharedViewsRouter.newSharedView()}}});SM.SharedViewsKeyHeadingView=SM.Views.extend(SM.BaseAccordionHeadingView,{__model:"anviews",__create:function(e){this.sharedViews=e.sharedViews;this.set("isOpen",true)},__beforeRender:function(e){var t=this,i=t.sharedViews.list.length;return{isLoading:this.__settings.isLoading,title:Globalize.localize("Shared Data"),number:i?i.toString():null}},__init:function(){this.bindModel(this.sharedViews,"isLoaded.changed",{self:this},this._onSharedViewsChanged);this.bindModel(this.sharedViews,"add",{self:this},this._onSharedViewsChanged);this.bindModel(this.sharedViews,"remove",{self:this},this._onSharedViewsChanged)},_onSharedViewsChanged:function(e){e.data.self.render()}});SM.SharedViewListView=SM.Views.register({__NAME:"SharedViewListView",__model:"sharedViewList",__templateID:"shared-view-list-template",__create:function(e){this.survey=e.survey;this.sharedViews=e.sharedViews;_.bindAll(this,"_onSharedViewsLoaded","_onSharedViewAdded","_onSharedViewRemoved")},__beforeRender:function(){return{isLoaded:this.sharedViews.get("isLoaded"),hasScrollbar:this.sharedViews.list.length>5}},__afterRender:function(e){var t=this;if(this.sharedViews.get("isLoaded")){if(this.sharedViews.list.length>0){this._renderSharedViewListItemViews()}else{this._renderNullStateView()}}},__init:function(){this.bindModel(this.sharedViews,"isLoaded.changed",{self:this},this._onSharedViewsLoaded);this.bindModel(this.sharedViews,"add",{self:this},this._onSharedViewAdded);this.bindModel(this.sharedViews,"remove",{self:this},this._onSharedViewRemoved)},_renderNullStateView:function(){var e=SM.Views.create(SM.ShareViewsNullStateView,{model:this.survey});this.$el.append(e.el)},_renderSharedViewListItemViews:function(){var e=this,t;t=_.sortBy(e.sharedViews.list,function(e){return 1-e.id});_.each(t,function(t){var i=SM.Views.create(SM.SharedViewListItemView,{sharedView:t});e.$el.find("[shared-view-list]").append(i.el)})},_onSharedViewsLoaded:function(e){this.render()},_onSharedViewAdded:function(e){var t=this;t.render()},_onSharedViewRemoved:function(e){var t=this;t.render()}});SM.ShareViewsNullStateView=SM.Views.register({__NAME:"SharedViewsNullStateView",__model:"survey",__templateID:"shared-views-null-state-template",__afterRender:function(){this._renderShareAllBtn()},_renderShareAllBtn:function(){var e=this.$el.find("[share-all-btn]");e.replaceWith(SM.Views.create(SM.ShareAllBtnView,{survey:this.survey,noBorder:false}).el)}});SM.SharedViewListItemView=SM.Views.register({__NAME:"SharedViewListItemView",__model:"sharedView",__templateID:"shared-view-list-item-template",__settings:{deleteMode:false,renameMode:false},__create:function(e){this.sharedView=e.sharedView;this.title=Globalize.localize("Click to view shared data");_.bindAll(this,"render","_onSelect","_onActionMenuInit","_onMenuAction","_onDeleteClick","_onCancelDeleteClick","_onRenameClick","_onCancelRenameClick","_setClipboardText")},__beforeRender:function(){var e=this.get("renameMode"),t=this.get("deleteMode");return{sharedView:this.sharedView,deleteMode:t,renameMode:e}},__afterRender:function(){var e=this,t=this.sharedView.get("name"),i=this.get("deleteMode"),s=this.get("renameMode"),n=this.$el.find("[list-item]"),r=this.$el.find("[btn-action-menu]"),a,o;if(i){a=SM.Views.create(SM.FunctionListItemDeleteView,{visible:true});n.prepend(a.$el)}else if(s){o=SM.Views.create(SM.FunctionListItemRenameView,{placeholder:t});o.open();n.prepend(o.$el)}if(s||i){e.$el.removeAttr("title")}else{n.on(SM.Event.CLICK,{self:e},e._onSelect);e.$el.attr("title",e.title)}r.actionMenu({menuView:"SharedViewListItemMenuView",sharedView:this.sharedView}).on("actionMenu.menuInit",this._onActionMenuInit)},__init:function(){var e=this;this.bindModel(this.sharedView,"enabled.changed",{self:this},this.render);this.bindModel(this.sharedView,"saved",{self:this},this.render);this.$el.on({"actionMenu.actionSelected":this._onMenuAction,"FunctionListItem.DeleteView.deleteClicked":this._onDeleteClick,"FunctionListItem.DeleteView.cancelClicked":this._onCancelDeleteClick,"FunctionListItem.RenameView.Renamed":this._onRenameClick,"FunctionListItem.RenameView.Canceled":this._onCancelRenameClick},{self:this})},_onActionMenuInit:function(e){var t=this,i=e.actionMenu,s=i.get("menuView"),n=s.$el.find("[data-action='copy-link']");s.$el.find(".q").popout()},_onSelect:function(e){e.preventDefault();SM.Bi.uiTrigger="sharedViewItem";SM.Bi.sharedViewVisit(this.sharedView);SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView)},_onMenuAction:function(e){e.preventDefault();var t=this;if(e.action==="show-view"){t._onShowViewMenuItemClick()}else if(e.action==="get-link"){t._onGetLinkMenuItemClick()}else if(e.action==="edit-view"){t._onEditViewMenuItemClick()}else if(e.action==="delete-view"){t._onDeleteViewMenuItemClick()}else if(e.action==="rename-view"){t._onRenameViewMenuItemClick()}else if(e.action==="copy-link"){t._onCopyLinkMenuItemClick()}else if(e.action==="toggle-view"){t._onToggleMenuItemClick()}},_onShowViewMenuItemClick:function(){SM.Bi.uiTrigger="viewSharedViewItemMenu";SM.Bi.sharedViewVisit(this.sharedView);SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView)},_onCopyLinkMenuItemClick:function(){SM.Notifications.success({title:Globalize.localize("You copied your sharing web link."),message:Globalize.localize("You can now paste the url into an email or social web site.")})},_onGetLinkMenuItemClick:function(){SM.Bi.uiTrigger="getLinkSharedViewItemMenu";SM.Bi.sharedViewGetWeblink(this.sharedView);SM.AnalyzeApp.SharedViewsRouter.edit(this.sharedView,true)},_onEditViewMenuItemClick:function(){SM.Bi.uiTrigger="editSharedViewItemMenu";SM.AnalyzeApp.SharedViewsRouter.edit(this.sharedView,false)},_onToggleMenuItemClick:function(){SM.Bi.sharedViewToggle(this.sharedView);this.sharedView.toggleEnabled()},_onDeleteViewMenuItemClick:function(){SM.Bi.uiTrigger="deleteSharedViewItemMenu";this.set("deleteMode",true);this.render()},_onDeleteClick:function(e){SM.Bi.sharedViewDelete(this.sharedView);e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.destroy(this.sharedView)},_onCancelDeleteClick:function(e){var t=this;e.preventDefault();t.set("deleteMode",false);t.render()},_onRenameViewMenuItemClick:function(){SM.Bi.uiTrigger="renameSharedViewItemMenu";this.set("renameMode",true);this.render()},_onRenameClick:function(e){var t=this;e.preventDefault();t.sharedView.set("name",e.newName);SM.Bi.sharedViewRename(t.sharedView);t.sharedView.save();t.set("renameMode",false);t.render()},_onCancelRenameClick:function(e){var t=this;e.preventDefault();t.set("renameMode",false);t.render()},_setClipboardText:function(e){return this.sharedView.sharedPageURL()}});SM.SharedViewListItemMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"SharedViewListItemMenuView",__templateID:"shared-view-list-item-menu-template",__create:function(){this.sharedView=this.__settings.sharedView},__beforeRender:function(){return{toggleEnabledText:this.sharedView.isEnabled()?Globalize.localize("Turn sharing off"):Globalize.localize("Turn sharing on"),isEnterpriseShare:this.sharedView.isEnterpriseTeam()}}});SM.SharedViewFormView=SM.Views.register({__NAME:"NewSharedViewView",__templateID:"shared-view-form-template",__create:function(e){this.dialogView=e.dialogView;this.sharedView=e.sharedView;if(!this.sharedView.isNew()){this.selectedShareGroup=this.sharedView.shareGroup()}else{this.selectedShareGroup=null}this.errors=[];this.validations={"#shared_view_title":{type:"presence",message:Globalize.localize("You must enter a title")},"#shared_view_description":{type:"length",max:4e3,message:Globalize.localize("Please enter a description less than 4000 characters")},"#shared_view_password":{type:"length",min:4,max:35,message:Globalize.localize("Please enter a password between 4 and 35 characters"),"if":function(){return $("#edit_shared_view_attrs .share-option-list").hasClass("share-group-password")}}};_.bindAll(this,"_onSelectShareGroup","_onUpgradeTriggerFieldToggle","_onShowUpgradeDialog","_onShareOptionChange","_onSharedViewLinkClick","_setClipboardText","_onBackClick","_onSaveClick","_onCancelClick","_onCopyClick","_onPreviewClick","_onCustomizeClick","_onCustomizeMenuActionSelected","_onCustomizeSaveClick","_onCustomizeCancelClick")},__beforeRender:function(){var e=this.sharedView,t=e.isNew(),i=e.shareGroup();if(t){i=null}return{sharedView:e,shareGroup:i,isSharedPublic:i===e.GROUP_SETTINGS.publicShare,isSharedLink:i===e.GROUP_SETTINGS.linkShare,isSharedPassword:i===e.GROUP_SETTINGS.passwordShare,isSharedEnterprise:i===e.GROUP_SETTINGS.enterpriseShare,title:$("<div></div>").html(e.title).text(),hideOpenEnded:e.hideOpenEnded(),hasCustomTitle:e.hasCustomTitle(),hasCustomName:e.hasCustomTitle(),hasDescription:e.hasDescription(),hasPassword:e.hasPassword(),canHavePassword:e.canHavePassword(),browseTabEnabled:e.isBrowseTabEnabled(),trendsTabEnabled:e.isTrendsTabEnabled(),canHaveTrends:e.canHaveTrends(),sharedPageURL:e.sharedPageURL(),userHasTrends:e.survey.owner.hasTrends(),canCustomizeBranding:e.canCustomizeBranding(),hasHiddenBranding:e.hasHiddenBranding(),isResearchDomain:this.isResearchDomain(e.get("domain")),canCustomizeDomain:e.canCustomizeDomain(),isEnterpriseAccount:e.isEnterpriseAccount(),allowTeamExport:e.allowTeamExport()}},__init:function(){var e=this,t=e.$el;e.$spinner=t.find(".sm-spin");e.form=t.find("form").form({formView:e}).data("form");t.find("[customize-domain-btn]").actionMenu({menuView:"CustomizeSharedViewHostMenuView",parentEl:t,sharedView:e.sharedView});t.on("click",".share-group-list td",e._onSelectShareGroup).on("click",'.upgrade-trigger input[type="checkbox"]',e._onUpgradeTriggerFieldToggle).on("click",".share-option-branding.upgrade-trigger",e._onShowUpgradeDialog).on("click",".option-checkbox",e._onShareOptionChange).on("click","[shared-view-link]",e._onSharedViewLinkClick).on("click","[preview-link]",e._onPreviewClick).on("click","[save-btn]",e._onSaveClick).on("click","[copy-btn]",e._onCopyClick).on("click","[back-btn]",e._onBackClick).on("click","[cancel-btn], [close-btn]",e._onCancelClick).on("click","[customize-btn]",e._onCustomizeClick).on("click","[customize-save-btn]",e._onCustomizeSaveClick).on("click","[customize-cancel-btn]",e._onCustomizeCancelClick).on("actionMenu.actionSelected",e._onCustomizeMenuActionSelected);t.find(".q").popout()},_showUpgradeDialog:function(e){var t=SM.Views.create(SM.DialogView,{width:800,isModal:true,templateID:e}),i=this.$el.parents(".dialog:eq(0)");i.fadeOut(250,function(){t.open()});t.$el.on("dialog.afterClose",function(){i.fadeIn(250)})},_setDefaultsForGroup:function(e){var t=this.sharedView,i=e===t.GROUP_SETTINGS.enterpriseShare;t.set("is_public",e===t.GROUP_SETTINGS.publicShare);t.set("has_password",e===t.GROUP_SETTINGS.passwordShare);t.set("team_only_share",i);t.set("allow_team_export",i&&$("#shared_view_allow_team_export").prop("checked"))},_closeCustomDomainEditor:function(){var e=this,t=e.$el.find(".shared-view-link-container");if(!t.hasClass("not-customizing")){e.$el.find("[shared-view-link]").val(e.sharedView.sharedPageURL());
t.addClass("not-customizing")}},setViewLink:function(e){var t=this,i=t.sharedView;t.$el.toggleClass("view-link",e);if(e){t.$el.parent().siblings(".shared_group_upgrade_message").addClass("hide")}t._removeSocialSharingView();if(e&&!i.isNew()&&i.isSocialShareable()){t._createSocialSharingView()}t.$el.find(".customize-btns").toggleClass("hide",i.isEnterpriseTeam())},isResearchDomain:function(e){var t=this.sharedView.survey.config.research_domain;return e===t},_onSelectShareGroup:function(e){e.stopImmediatePropagation();var t=this,i=t.$el.find(".share-option-list"),s=i.parent(),n=$(e.target).closest("td"),r=n.attr("data-group");if(t.selectedShareGroup===r){return}if(n.hasClass("upgrade-trigger")){var a;if(r===t.sharedView.GROUP_SETTINGS.passwordShare){a="password-sharing-upgrade-dialog-template"}if(a){t._showUpgradeDialog(a)}return}if(t.selectedShareGroup){n.parent().find("td.selected").removeClass("selected");i.removeClass(t.selectedShareGroup)}else{t.$el.find("[save-btn]").removeClass("disabled")}if(r===t.sharedView.GROUP_SETTINGS.enterpriseShare&&$(".share-option-branding").hasClass("hide")){$(".share-option-branding").toggleClass("hide",false)}if(t.selectedShareGroup===t.sharedView.GROUP_SETTINGS.enterpriseShare){t.sharedView.set("domain",t.sharedView.getSelectedDomain());t.$el.find("[shared-view-link]").val(t.sharedView.sharedPageURL());t.sharedView.set("team_only_share",false)}t.selectedShareGroup=r;n.addClass("selected");i.addClass(r);t._setDefaultsForGroup(r);if(s.hasClass("hide")){s.removeClass("hide");$(window).trigger("resize")}},_onUpgradeTriggerFieldToggle:function(e){e.stopImmediatePropagation();$(e.currentTarget).prop("checked",false)},_onShowUpgradeDialog:function(e){this._showUpgradeDialog("hide-logo-sharing-upgrade-dialog-template")},_onShareOptionChange:function(e){var t=$(e.target),i=t.prop("checked"),s=this.sharedView;switch(t.attr("id")){case"shared_view_modes_trends":case"shared_view_modes_browse":s.toggleMode(t.attr("data-mode"),i);break;case"shared_view_hide_open_ended":s.set("hide_open_ended",!i);break;case"shared_view_allow_team_export":s.set("allow_team_export",i);break;case"shared_view_branding":s.setBranding(t.attr("data-branding"),i);break}},_onSharedViewLinkClick:function(e){$(e.target).select()},_onSaveClick:function(e){e.preventDefault();var t=this,i=t.sharedView,s;if(!$(e.target).closest("a").hasClass("disabled")&&t.form.isValid()){if(i.isEnterpriseTeam()){s=new Uri(document.location.href);i.set("domain",s.host())}t._save(function(){t.$el.find("[shared-view-link]").val(i.sharedPageURL());t.setViewLink(true)},function(){})}},_onBackClick:function(e){e.preventDefault();var t=this.$el;this._closeCustomDomainEditor();t.removeClass("view-link");t.parent().siblings(".shared_group_upgrade_message").removeClass("hide");t.find(".twitter-container").empty();t.find(".facebook-container").empty();t.find(".google-plus-container").empty();t.find(".linkedin-container").empty();$(window).trigger("resize")},_onCopyClick:function(e){e.preventDefault();SM.Notifications.success({title:Globalize.localize("You copied your sharing web link."),message:Globalize.localize("You can now paste the url into an email or social web site.")})},_onPreviewClick:function(e){e.preventDefault();SM.AnalyzeApp.SharedViewsRouter.show(this.sharedView)},_onCancelClick:function(e){e.preventDefault();this.dialogView.close()},_onCustomizeClick:function(e){var t=this.$el,i=this.sharedView;e.preventDefault();t.find("[shared-view-link]").val("");t.find(".url-host").text(i.get("domain"));t.find("#share_view_path").text(i.sharedPagePath());t.find(".shared-view-link-container").removeClass("not-customizing")},_onCustomizeSaveClick:function(e){var t=this,i=t.sharedView,s=t.$el.find(".url-host").text(),n=this.isResearchDomain(s);e.preventDefault();if(i.canCustomizeDomain()){i.set("domain",s);if(n){i.setBranding("none",true);$("#shared_view_branding").prop("checked",true)}$(".share-option-branding").toggleClass("hide",n);t._save();t._removeSocialSharingView();t._createSocialSharingView()}t._closeCustomDomainEditor()},_onCustomizeCancelClick:function(e){e.preventDefault();this._closeCustomDomainEditor()},_onCustomizeMenuActionSelected:function(e){var t=this;e.preventDefault();if(!t.sharedView.canCustomizeDomain()&&e.action==="userCannotCustomize"){t._showUpgradeDialog("white-label-sharing-upgrade-dialog-template")}else{t.$el.find(".url-host").text(e.action)}},_removeSocialSharingView:function(e){var t=this;if(t.socialSharingView){t.socialSharingView.destroy();t.$el.find(".social-sharing-buttons-container").remove();t.socialSharingView=null}},_createSocialSharingView:function(e){var t=this;t.socialSharingView=SM.Views.create(SM.SocialSharingButtonsView,{dataUrl:t.sharedView.sharedPageURL(),sharedViewTitle:t.sharedView.title})},_save:function(e,t){var i=this,s;i.$spinner.show();i.sharedView.load(i.form.attrs());SM.Bi.sharedViewSave(this.sharedView);s=this.sharedView.save();$.when(s,{self:this}).done(function(){i.$spinner.hide();if(e){e()}}).fail(function(){i.$spinner.hide();if(t){t()}})},_setClipboardText:function(e){return this.sharedView.sharedPageURL()}});SM.CustomizeSharedViewHostMenuView=SM.Views.deepExtend(SM.ActionMenuView,{__NAME:"CustomizeSharedViewHostMenuView",__templateID:"customize-shared-view-host-menu-template",__create:function(e){this.sharedView=e.sharedView},__beforeRender:function(){var e=new Uri(document.location.href),t=e.getRootDomain(),i=this.sharedView,s=i.getCultureSubdomain(),n=i.survey.owner,r=!(n.isPlatinum()||n.isEnterprisePlatinum()),a,o="",l="";if(!r&&i.groupDomainLinkEnabled()){a=i.get("domain");o=a;l=n.getEnterpriseGroupDomains()}else if(n.isPlatinum()||i.isEnterpriseAccount()){a=e.host();o=this.sharedView.survey.config.research_domain;l=r?"userCannotCustomize":o}if(a.indexOf(s)!==0){a=a.split(".");a[0]=s;a=a.join(".")}return{defaultHost:a,proHost:o,proHostData:l,userCannotCustomize:r,hasDomainOptions:i.groupDomainLinkEnabled()}},__init:function(){SM.ActionMenuView.__init.call(this);this.$el.find(".q").popout()}});SM.SocialSharingButtonsView=SM.Views.register({__NAME:"SocialSharingButtonsView",__templateID:"social-sharing-buttons-template",__create:function(e){this.dataUrl=e.dataUrl;this.sharedViewTitle=e.sharedViewTitle},__beforeRender:function(){return{dataUrl:this.dataUrl,sharedViewTitle:this.sharedViewTitle}},__afterRender:function(){this.loadTwitterShareButton();this.loadFacebookShareButton();this.loadGooglePlusShareButton();this.loadLinkedInShareButton(".linkedin-container");$("#social-sharing-container").append(this.el);try{IN.parse()}catch(e){}},loadTwitterShareButton:function(){try{twttr.widgets.load(this.el)}catch(e){}},loadFacebookShareButton:function(){try{FB.XFBML.parse(this.el)}catch(e){}},loadGooglePlusShareButton:function(){try{gapi.plus.go(this.el)}catch(e){}},loadLinkedInShareButton:function(e){var t='<script type="IN/Share" ';if(!!this.dataUrl){t=t+"data-url="+this.dataUrl}t=t+"></script>";this.$el.find(".linkedin-container").html(t)}});SM.PubSub.subscribe("HTTP_CONFLICT",function(){SM.Notifications.success({expires:false,title:Globalize.localize("New version available!"),message:Globalize.localize("Fresher bananas are available, let us reload this page for you...")});setTimeout(function(){location.reload()},5e3)});SM.BaseApp={ERROR_CODES:{MODELS:"1",VIEWS:"2",ROUTERS:"3"},initializers:{beforeInit:[],afterInit:[]},__beforeInit:function(e){var t=this;SM.Error.init();SM.Tooltips.init();SM.Ajax.init(e.version);SM.API.init(e.survey_id);t._renderLoaderView();t._runInitializers("before",e)},__afterInit:function(e){var t=this;t._runInitializers("after",e)},init:function(e){var t=this;SM.App=t;SM.Browser.support.needsBrowserUpgrade();t.el=e.el;t.version=e.version;t.dataURL=t._setDataURL(e.data_url);t.surveyTitle=e.survey_title;t.JClipboardMovieUrl=e.jclipboard_movie_url;t.dfd=$.Deferred();SM.raHeader="A/B Test";t.__beforeInit(e);if(t.dataURL){_.bindAll(this,"_onSuccess","_onFail","_onAlways","_loadData");SM.Ajax.get(t.dataURL).done(t._onSuccess,function(){t.__afterInit(e)}).fail(t._onFail).always(t._onAlways)}else{t._onAlways()}return t.dfd},_buildSurveyModel:function(e,t){var i=this,s,n;SM.API.setUser(e.current_user.id);i.setCulture(e.survey_data);s=SM.Models.create("Survey",{survey_data:e.survey_data,npsEnabled:e.config.nps_enabled,mode:e.analyze_mode,includeOpenEnded:e.include_openended||t.includeOpenEnded});s.loadAnalyzeState({mode:e.analyze_mode,pageIndex:e.page_index});s.loadConfig(e.config);s.loadOwner(e.owner);n=s.owner;s.loadCurrentUser(e.current_user);s.loadViews({viewMap:e.views,currentViewID:e.current_view_id,defaultViewID:e.default_view_id,selectedViewID:e.selected_view_id});if(t.loadSharedViews){s.loadSharedViews(e.shared_views)}if(t.loadExportJobs){s.loadExportJobs(e.exportjob_list)}if(e.respondent_data.status===0){s.set("respondentCounts",e.respondent_data.data.respondent_counts)}else{s.set("respondentCounts",{failed:true})}if(s.state.isBrowseMode()){s.loadRespondents(e.respondent_data)}else if(s.state.isSummaryMode()){if(!this.isSharingApp()){if(e.profiler_data.status!==0||e.segment_data.status!==0){s.owner.benchmarkingEnabled=false;n=null}s.dataSegmentList=SM.Models.create("DataSegmentList",{survey:s,defaultView:s.anviews.defaultView,benchmarkQuestions:e.survey_data.benchmark_questions,segmentData:e.segment_data});s.loadBenchmarkRollups(e.benchmark_data);s.profiler=SM.Models.create("Profiler",{parent:s,user:n,profiler_data:e.profiler_data,basePath:"/analyze",webapp:"anweb",source:"profilerDialog",showHeading:true,disableOrgAC:false,showDefaultCB:false,showOptInCB:true,disableAccordion:true,showQuestionText:false,openIfInvalid:true,hasCollectorProfile:s.hasProfiledCollector()});s.driverState=SM.Models.create("DriverState",{survey:s,driverState:s.anviews.defaultView.getDriverState()});if(s.isTMBCTemplate()){s.tmbc=SM.Models.create("TMBC",{survey:s,tmbcData:e.driver_data,wasEdited:!s.validateTMBCTemplate()})}s.loadDriverRollups(e.benchmark_data)}s.loadQuestionRollups(e.respondent_data)}else if(s.state.isTrendMode()){s.loadSurveyTrends(e.respondent_data)}return s},_renderLoaderView:function(){var e=this;e._loaderView=SM.Views.create(SM.AnalyzeLoaderView,{isFixed:true});e.el.appendChild(e._loaderView.el);e._loaderView.show()},_setDataURL:function(e){var t=new Uri(e);t.setProtocol("https");t.addQueryParam("utc_offset",SM.Date.utcOffset().toString());t=t.toString();SM.log("data.js URL: "+t);return t},_handleLoadingError:function(e){var t=SM.Template.renderHTML("content-load-error-template",{requestID:e.requestID,errorCode:e.errorCode,classes:"analyze-failed-load mod-no-header"});$(this.el).html(t)},_onSuccess:function(e){this.data=e;this._loadData(e);this.dfd.resolve()},_onFail:function(e){this._handleLoadingError({requestID:e.request_id,encryptedSurveyID:e.survey_id_encryption});this.dfd.reject()},_onAlways:function(){this._loaderView.hide()},_runInitializers:function(e,t){var i;if(_.isEmpty(this.initializers)){return}i=this.initializers[e+"Init"];if(i.length){_.each(i,function(e){e.call(this,SM.App,t)})}},isSharingApp:function(){return false},isExportApp:function(){return false},isMerveysApp:function(){return this.survey.isMergedSurvey},isSharingEnabled:function(){return this.survey.isSharingEnabled()&&this.survey.owner.hasSharing()},isDebug:function(){return!!SM.DEBUG},setCulture:function(){var e=Globalize.getSmartlingCulture();Globalize.culture(e);Globalize.addCultureInfo(e,{messages:SM.translations})}};SM.AnalyzeApp=SM.Object.deepExtend(SM.BaseApp,{_loadData:function(e){var t=this;if("is_merge_completed"in e.survey_data&&!e.survey_data.is_merge_completed){window.location.href="/analyze/merve/design-tool/"+e.survey_id_encryption;return}try{t._initConstants(e);t.survey=t.survey=t._buildSurveyModel(e,{includeOpenEnded:true,loadSharedViews:true,loadExportJobs:true})}catch(i){t.dfd.reject();t._handleLoadingError({errorCode:t.ERROR_CODES.MODELS,encryptedSurveyID:e.survey_id_encryption});SM.Error.log(i,"AnalyzeApp failed to initialize models");return}try{t._initRouters()}catch(i){t.dfd.reject();t._handleLoadingError({errorCode:t.ERROR_CODES.ROUTERS,encryptedSurveyID:e.survey_id_encryption});SM.Error.log(i,"AnalyzeApp failed to initialize routers");return}try{t._render(t.survey)}catch(i){t.dfd.reject();t._handleLoadingError({errorCode:t.ERROR_CODES.VIEWS,encryptedSurveyID:e.survey_id_encryption});SM.Error.log(i,"AnalyzeApp failed to render");return}try{$(".sidetab").sideTab()}catch(i){t.dfd.reject();SM.Error.log(i,"AnalyzeApp sidetabs/tours failed")}ANALYZE.walkme.hasResponses=t.survey.hasRespondents()},_initConstants:function(e){SM.DISPLAY_BROWSE_TAB=e.display_browse_tab;SM.DISPLAY_TREND_TAB=e.display_trend_tab},_initRouters:function(){this.SharedViewsRouter=new SM.SharedViewsRouter({survey:this.survey})},_render:function(e){this._renderMainView(e);this._renderSecondaryView(e)},_renderMainView:function(e){var t=SM.Views.create(SM.AnalyzeMainView,{model:e});this.el.appendChild(t.el)},_renderSecondaryView:function(e){var t=SM.Views.create(SM.AnalyzeSecondaryView,{model:e});this.el.appendChild(t.el)}});SM.AnalyzeApp.initializers.beforeInit.push(function(e,t){});